{
  "spec": {
    "title": "Privacy-Preserving Attribution: Level 1",
    "url": "https://www.w3.org/TR/privacy-preserving-attribution/"
  },
  "algorithms": [
    {
      "name": "clear impressions for a conversion site",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#clear-impressions-for-a-conversion-site",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"clear-impressions-for-a-conversion-site\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">clear impressions for a conversion site</dfn>,\ngiven an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin\" id=\"ref-for-concept-origin③\">origin</a> <var>origin</var>,\nrun these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>origin</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple\" id=\"ref-for-concept-origin-tuple\">tuple origin</a> with a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin-scheme\" id=\"ref-for-concept-origin-scheme\">scheme</a> of <code>https</code>,\nreturn.</p>"
        },
        {
          "html": "<p>Let <var>site</var> be the value returned\nby invoking <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain\">obtain a registrable domain</a>,\npassing the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin-host\" id=\"ref-for-concept-origin-host\">host</a> part of the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple\" id=\"ref-for-concept-origin-tuple①\">origin tuple</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate\">For each</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression\" id=\"ref-for-impression②④\">impression</a> <var>impression</var> of\nthe <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-store\" id=\"ref-for-impression-store⑤\">impression store</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>impression</var> has an <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-intermediary-site\" id=\"ref-for-impression-intermediary-site\">Intermediary Site</a> equal to <var>site</var>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove\">remove</a> <var>impression</var> from the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-store\" id=\"ref-for-impression-store⑥\">impression store</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>impression</var> has a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites\">Conversion Sites</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets④\">set</a>\nthat does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain①\">contain</a> the value <var>site</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①\">continue</a>.</p>"
            },
            {
              "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size\">size</a> of <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites①\">Conversion Sites</a>\nis greater than one,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove①\">remove</a> <var>site</var> from <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites②\">Conversion Sites</a>\nand <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue②\">continue</a>.</p>"
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove②\">remove</a> <var>impression</var> from the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-store\" id=\"ref-for-impression-store⑦\">impression store</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "parse a site",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#parse-a-site",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"parse-a-site\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">parse a site</dfn>,\nreturning either <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site⑨\">site</a> or failure,\ngiven a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①\">string</a> <var>input</var>,\nrun these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>host</var> be the value returned by invoking <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-host-parser\" id=\"ref-for-concept-host-parser\">host parser</a>,\npassing <var>input</var>.</p>"
        },
        {
          "html": "<p>If <var>host</var> is failure, return failure.</p>"
        },
        {
          "html": "<p>Let <var>site</var> be the value returned by <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain①\">obtain a registrable domain</a>,\npassing <var>host</var>.</p>"
        },
        {
          "html": "<p>If <var>site</var> is null, return failure.</p>"
        },
        {
          "html": "<p>Return a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#scheme-and-host\" id=\"ref-for-scheme-and-host①\">scheme-and-host</a> tuple of (\"<code>https</code>\", <var>site</var>).</p>"
        }
      ]
    },
    {
      "name": "deduct privacy budget",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#deduct-privacy-budget",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"deduct-privacy-budget\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">deduct privacy budget</dfn>\ngiven a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#privacy-budget-key\" id=\"ref-for-privacy-budget-key①\">privacy budget key</a> <var>key</var>,\n<a href=\"https://webidl.spec.whatwg.org/#idl-double\" id=\"a38011ce0\">double</a> <var>epsilon</var>,\ninteger <var>sensitivity</var>,\nand integer <var>globalSensitivity</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#privacy-budget-store\" id=\"ref-for-privacy-budget-store④\">privacy budget store</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists\">contain</a> <var>key</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set\">set</a>\nits value of <var>key</var> to be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent⑨\">user agent</a>-defined value,\nplus 1000.</p>"
        },
        {
          "html": "<p>Let <var>currentValue</var> be the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-get\" id=\"ref-for-map-get\">getting the value</a> of <var>key</var>\nin the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#privacy-budget-store\" id=\"ref-for-privacy-budget-store⑤\">privacy budget store</a>.</p>"
        },
        {
          "html": "<p>Let <var>deductionFp</var> be <var>epsilon</var> * <var>sensitivity</var> / <var>globalSensitivity</var>.</p>"
        },
        {
          "html": "<p>If <var>deductionFp</var> is negative or greater than 4294,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set①\">set</a> the value of <var>key</var> in the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#privacy-budget-store\" id=\"ref-for-privacy-budget-store⑥\">privacy budget store</a> to 0\nand return false.</p>"
        },
        {
          "html": "<p>Let <var>deduction</var> be <var>deductionFp</var> * 1000000, rounded towards positive Infinity.</p>"
        },
        {
          "html": "<p>If <var>deduction</var> is greater than <var>currentValue</var>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set②\">set</a> the value of <var>key</var> in the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#privacy-budget-store\" id=\"ref-for-privacy-budget-store⑦\">privacy budget store</a> to 0\nand return false.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set③\">Set</a> the value of <var>key</var> in the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#privacy-budget-store\" id=\"ref-for-privacy-budget-store⑧\">privacy budget store</a>\nto <var>currentValue</var> − <var>deduction</var>\nand return true.</p>"
        }
      ]
    },
    {
      "name": "get the current epoch",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#get-the-current-epoch",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-current-epoch\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the current epoch</dfn>\ngiven a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site①⑦\">site</a> <var>site</var>,\nand <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-moment\" id=\"ref-for-dfn-moment⑤\">moment</a> <var>t</var>,\nreturning an <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#epoch-index\" id=\"ref-for-epoch-index⑥\">epoch index</a>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>period</var> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-duration\" id=\"ref-for-dfn-duration②\">duration</a> of one <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#privacy-budget-epoch\" id=\"ref-for-privacy-budget-epoch①②\">epoch</a>.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#epoch-start-store\" id=\"ref-for-epoch-start-store③\">epoch start store</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①\">contain</a> <var>site</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set④\">set</a>\nits value to <var>t</var>, minus a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-duration\" id=\"ref-for-dfn-duration③\">duration</a>\nthat is randomly selected\nfrom between 0 (inclusive) and <var>period</var> (exclusive).</p>"
        },
        {
          "html": "<p>Let <var>start</var> be the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-get\" id=\"ref-for-map-get①\">getting the value</a> of <var>site</var>\nfrom the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#epoch-start-store\" id=\"ref-for-epoch-start-store④\">epoch start store</a>.</p>"
        },
        {
          "html": "<p>Let <var>elapsed</var> be (<var>t</var> − <var>start</var>) / <var>period</var>.</p>"
        },
        {
          "html": "<p>Return <var>elapsed</var> as an integer, rounded towards negative Infinity.</p>"
        }
      ]
    },
    {
      "name": "get the starting epoch for attribution",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#get-the-starting-epoch-for-attribution",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-starting-epoch-for-attribution\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the starting epoch for attribution</dfn>\ngiven <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site②④\">site</a> <var>site</var>,\nreturning an <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#epoch-index\" id=\"ref-for-epoch-index⑧\">epoch index</a>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>startEpoch</var> be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent①⑥\">user agent</a>-defined value\nfor the earliest <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#epoch-index\" id=\"ref-for-epoch-index⑨\">epoch index</a>\nthat is supported for attribution.</p>"
        },
        {
          "html": "If the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#last-browsing-history-clear\" id=\"ref-for-last-browsing-history-clear④\">last browsing history clear</a> is set,\nperform the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>clearEpoch</var> be the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#get-the-current-epoch\" id=\"ref-for-get-the-current-epoch③\">get the current epoch</a>\nwith <var>site</var> and the value of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#last-browsing-history-clear\" id=\"ref-for-last-browsing-history-clear⑤\">last browsing history clear</a>.</p>"
            },
            {
              "html": "<p>Set <var>clearEpoch</var> to <var>clearEpoch</var> + 2.</p>"
            },
            {
              "html": "<p>If <var>clearEpoch</var> is greater than <var>startEpoch</var>,\nreturn <var>clearEpoch</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>startEpoch</var>.</p>"
        }
      ]
    },
    {
      "name": "PrivateAttribution/saveImpression(options)",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattribution-saveimpression",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"PrivateAttribution\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-privateattribution-saveimpression\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>saveImpression(<var>options</var>)</code></dfn> method steps are:\n\n\n    \n    <p class=\"advisement\"><a class=\"idl-code\" data-link-type=\"method\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattribution-saveimpression\" id=\"ref-for-dom-privateattribution-saveimpression①⑦\">saveImpression()</a>\ndoes not return a status indicating whether the impression was recorded.\nThis minimizes the ability to detect when the Private Attribution\nAPI is <a href=\"https://www.w3.org/TR/privacy-preserving-attribution/#opt-out\">disabled</a>. Similarly, resolution of the returned promise is\nnot predicated on saving <var>impression</var> to the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-store\" id=\"ref-for-impression-store①③\">impression store</a> in order to\navoid timing <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#side-channels\" id=\"ref-for-side-channels\">side channels</a> related to the number of existing impressions and\nwhether the API is enabled.\n\n</p>",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm\">relevant realm</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global\">relevant global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window\">associated Document</a> is not\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use\" id=\"ref-for-allowed-to-use\">allowed to use</a> the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/permissions-policy-1/#policy-controlled-feature\" id=\"ref-for-policy-controlled-feature①\">policy-controlled feature</a> named\n\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-permissionpolicy-save-impression\" id=\"ref-for-dom-permissionpolicy-save-impression\">save-impression</a></code>\", return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with\">a promise rejected with</a>\na <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#notallowederror\" id=\"ref-for-notallowederror\">\"NotAllowedError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException\">DOMException</a></code> in <var>realm</var>.</p>"
        },
        {
          "html": "<p>Let <var>settings</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#relevant-settings-object\" id=\"ref-for-relevant-settings-object③\">relevant settings object</a>.</p>"
        },
        {
          "html": "Collect the implicit API inputs from <var>settings</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>timestamp</var> be <var>settings</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-eso-current-wall-time\" id=\"ref-for-dfn-eso-current-wall-time\">current wall time</a>.</p>"
            },
            {
              "html": "<p>The <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-site\" id=\"ref-for-impression-site⑥\">impression site</a> <var>site</var> is set to the result of\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#obtain-a-site\" id=\"ref-for-obtain-a-site\">obtaining a site</a> from the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin②\">top-level origin</a>.</p>"
            },
            {
              "html": "The <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#intermediary-site\" id=\"ref-for-intermediary-site⑤\">intermediary site</a> <var>intermediarySite</var> is set to",
              "rationale": "/^otherwise(\\,| )/i",
              "steps": [
                {
                  "html": "<p>a value of <code>undefined</code> if the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin\" id=\"ref-for-concept-origin④\">origin</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#same-site\" id=\"ref-for-same-site②\">same site</a>\n with the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin③\">top-level origin</a>,</p>"
                },
                {
                  "html": "<p>otherwise, the result of\n <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#obtain-a-site\" id=\"ref-for-obtain-a-site①\">obtaining a site</a>\n from <var>settings</var>’ <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin\">origin</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "Validate the page-supplied API inputs:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-lifetimedays\" id=\"ref-for-dom-privateattributionimpressionoptions-lifetimedays②\">lifetimeDays</a></code> is 0,\nreturn <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror\">RangeError</a></code> in <var>realm</var>.</p>"
            },
            {
              "html": "<p>Clamp <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-lifetimedays\" id=\"ref-for-dom-privateattributionimpressionoptions-lifetimedays③\">lifetimeDays</a></code> to\nthe <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent①⑧\">user agent</a>’s upper limit.</p>"
            },
            {
              "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size①\">size</a> of\n<var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-conversionsites\" id=\"ref-for-dom-privateattributionimpressionoptions-conversionsites①\">conversionSites</a></code> is\ngreater than an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined①\">implementation-defined</a> maximum value, return\n<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror①\">RangeError</a></code> in <var>realm</var>.</p>"
            },
            {
              "html": "<p>Let <var>conversionSites</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets⑦\">set</a> that is the result\nof invoking <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#parse-a-site\" id=\"ref-for-parse-a-site\">parse a site</a>\nfor each value in <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-conversionsites\" id=\"ref-for-dom-privateattributionimpressionoptions-conversionsites②\">conversionSites</a></code>.</p>"
            },
            {
              "html": "<p>If any result in <var>conversionSites</var> is failure, return\n<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#syntaxerror\" id=\"ref-for-syntaxerror\">\"SyntaxError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①\">DOMException</a></code> in <var>realm</var>.</p>"
            }
          ]
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel\">in parallel</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>Construct <var>impression</var> as a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression\" id=\"ref-for-impression②⑤\">saved impression</a> comprising:</p>\n        <dl>\n         <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-match-value\" id=\"ref-for-impression-match-value\">Match Value</a>\n         </dt><dd data-md=\"\">\n          <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-matchvalue\" id=\"ref-for-dom-privateattributionimpressionoptions-matchvalue③\">matchValue</a></code></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-impression-site\" id=\"ref-for-impression-impression-site①\">Impression Site</a>\n         </dt><dd data-md=\"\">\n          <p><var>site</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-intermediary-site\" id=\"ref-for-impression-intermediary-site②\">Intermediary Site</a>\n         </dt><dd data-md=\"\">\n          <p><var>intermediarySite</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites⑤\">Conversion Sites</a>\n         </dt><dd data-md=\"\">\n          <p><var>conversionSites</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-timestamp\" id=\"ref-for-impression-timestamp①\">Timestamp</a>\n         </dt><dd data-md=\"\">\n          <p><var>timestamp</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-lifetime\" id=\"ref-for-impression-lifetime①\">Lifetime</a>\n         </dt><dd data-md=\"\">\n          <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-lifetimedays\" id=\"ref-for-dom-privateattributionimpressionoptions-lifetimedays④\">lifetimeDays</a></code>,\n multiplied by a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-duration\" id=\"ref-for-dfn-duration④\">duration</a> of one day</p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-histogram-index\" id=\"ref-for-impression-histogram-index\">Histogram Index</a>\n         </dt><dd data-md=\"\">\n          <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-histogramindex\" id=\"ref-for-dom-privateattributionimpressionoptions-histogramindex②\">histogramIndex</a></code></p>\n        </dd></dl>"
            },
            {
              "html": "<p>If the Private Attribution API is <a href=\"https://www.w3.org/TR/privacy-preserving-attribution/#opt-out\">enabled</a>,\n save <var>impression</var> to the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-store\" id=\"ref-for-impression-store①②\">impression store</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>result</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dictdef-privateattributionimpressionresult\" id=\"ref-for-dictdef-privateattributionimpressionresult①\">PrivateAttributionImpressionResult</a></code>.</p>"
        },
        {
          "html": "<p>Return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-resolved-with\" id=\"ref-for-a-promise-resolved-with\">a promise resolved with</a> <var>result</var> in <var>realm</var>.</p>"
        }
      ]
    },
    {
      "name": "PrivateAttribution/measureConversion(options)",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattribution-measureconversion",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"PrivateAttribution\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-privateattribution-measureconversion\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>measureConversion(<var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm①\">relevant realm</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global①\">relevant global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window①\">associated Document</a> is not\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use\" id=\"ref-for-allowed-to-use①\">allowed to use</a> the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/permissions-policy-1/#policy-controlled-feature\" id=\"ref-for-policy-controlled-feature②\">policy-controlled feature</a> named\n\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-permissionpolicy-measure-conversion\" id=\"ref-for-dom-permissionpolicy-measure-conversion\">measure-conversion</a></code>\", return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④\">a promise rejected with</a>\na <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#notallowederror\" id=\"ref-for-notallowederror①\">\"NotAllowedError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②\">DOMException</a></code> in <var>realm</var>.</p>"
        },
        {
          "html": "<p>Let <var>settings</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#relevant-settings-object\" id=\"ref-for-relevant-settings-object④\">relevant settings object</a>.</p>"
        },
        {
          "html": "Collect the implicit API inputs from <var>settings</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>now</var> be <var>settings</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-eso-current-wall-time\" id=\"ref-for-dfn-eso-current-wall-time①\">current wall time</a>.</p>"
            },
            {
              "html": "<p>Let <var>topLevelSite</var> (the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#conversion-site\" id=\"ref-for-conversion-site⑤\">conversion site</a>) be the result of\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#obtain-a-site\" id=\"ref-for-obtain-a-site②\">obtaining a site</a> from the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin④\">top-level origin</a>.</p>"
            },
            {
              "html": "The <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#intermediary-site\" id=\"ref-for-intermediary-site⑥\">intermediary site</a> is set to",
              "rationale": "/^otherwise(\\,| )/i",
              "steps": [
                {
                  "html": "<p>a value of <code>undefined</code> if the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin\" id=\"ref-for-concept-origin⑤\">origin</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#same-site\" id=\"ref-for-same-site③\">same site</a>\n with the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin⑤\">top-level origin</a>,</p>"
                },
                {
                  "html": "<p>otherwise, the result of\n <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#obtain-a-site\" id=\"ref-for-obtain-a-site③\">obtaining a site</a>\n from <var>settings</var>’ <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①\">origin</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>validatedOptions</var> be the result of\n<a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validate-privateattributionconversionoptions\" id=\"ref-for-validate-privateattributionconversionoptions\">validating</a> <var>options</var>,\nreturning <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤\">a promise rejected with</a> any thrown reason.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise\">a new promise</a> in <var>realm</var>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>report</var> be the result of invoking <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#create-an-all-zero-histogram\" id=\"ref-for-create-an-all-zero-histogram\">create an all-zero histogram</a> with\n <var>validatedOptions</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-histogram-size\" id=\"ref-for-validated-conversion-options-histogram-size\">histogram size</a>.</p>"
            },
            {
              "html": "<p>If the Private Attribution API is <a href=\"https://www.w3.org/TR/privacy-preserving-attribution/#opt-out\">enabled</a>, set <var>report</var> to the\n result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#do-attribution-and-fill-a-histogram\" id=\"ref-for-do-attribution-and-fill-a-histogram\">do attribution and fill a histogram</a> with <var>validatedOptions</var>,\n <var>topLevelSite</var>, and <var>now</var>.</p>"
            },
            {
              "html": "<p>Let <var>encryptedReport</var> be the result of encrypting <var>report</var>.</p>"
            },
            {
              "html": "<p>Let <var>result</var> be a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dictdef-privateattributionconversionresult\" id=\"ref-for-dictdef-privateattributionconversionresult①\">PrivateAttributionConversionResult</a></code> with the following items:</p>\n        <dl>\n         <dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionresult-report\" id=\"ref-for-dom-privateattributionconversionresult-report\">report</a></code>\n         </dt><dd data-md=\"\">\n          <p><var>encryptedReport</var></p>\n        </dd></dl>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task\">Queue a task</a> on the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#private-attribution-task-source\" id=\"ref-for-private-attribution-task-source\">Private Attribution task source</a> to\n <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve\">resolve</a> <var>promise</var> with <var>result</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "validate PrivateAttributionConversionOptions",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#validate-privateattributionconversionoptions",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"validate-privateattributionconversionoptions\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">validate <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dictdef-privateattributionconversionoptions\" id=\"ref-for-dictdef-privateattributionconversionoptions②\">PrivateAttributionConversionOptions</a></code></dfn> <var>options</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <a class=\"idl-code\" data-link-type=\"attribute\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattribution-aggregationservices\" id=\"ref-for-dom-privateattribution-aggregationservices⑤\">aggregationServices</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②\">contain</a>\nan <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-entry\" id=\"ref-for-map-entry\">entry</a> with a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-key\" id=\"ref-for-map-key\">key</a> of <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-aggregationservice\" id=\"ref-for-dom-privateattributionconversionoptions-aggregationservice③\">aggregationService</a></code>,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-referenceerror\" id=\"ref-for-exceptiondef-referenceerror\">ReferenceError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-epsilon\" id=\"ref-for-dom-privateattributionconversionoptions-epsilon①\">epsilon</a></code>\nis less than or equal to 0 or is greater than 4294,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror②\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-histogramsize\" id=\"ref-for-dom-privateattributionconversionoptions-histogramsize①\">histogramSize</a></code>\nis 0 or greater than an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined②\">implementation-defined</a> maximum value,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror③\">RangeError</a></code>.</p>"
        },
        {
          "html": "Switch on the value of <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-logic\" id=\"ref-for-dom-privateattributionconversionoptions-logic①\">logic</a></code>:",
          "rationale": ".switch",
          "steps": [
            {
              "operation": "switch",
              "steps": [
                {
                  "case": "\"last-touch\"",
                  "html": "Perform the following steps:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-value\" id=\"ref-for-dom-privateattributionconversionoptions-value①\">value</a></code> is 0,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror④\">RangeError</a></code>.</p>"
                    },
                    {
                      "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-value\" id=\"ref-for-dom-privateattributionconversionoptions-value②\">value</a></code>\nis greater than <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-maxvalue\" id=\"ref-for-dom-privateattributionconversionoptions-maxvalue①\">maxValue</a></code>,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror⑤\">RangeError</a></code>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>lookback</var> be <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-lookbackdays\" id=\"ref-for-dom-privateattributionconversionoptions-lookbackdays②\">lookbackDays</a></code> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#day\" id=\"ref-for-day①\">days</a>\nif it <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists③\">exists</a>, the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined③\">implementation-defined</a> maximum otherwise.</p>"
        },
        {
          "html": "<p>If <var>lookback</var> is 0 <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#day\" id=\"ref-for-day②\">days</a>, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror⑥\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>matchValue</var> be the result of running <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-create\" id=\"ref-for-set-create\">creating a set</a> with\n<var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-matchvalue\" id=\"ref-for-dom-privateattributionconversionoptions-matchvalue②\">matchValue</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>impressionSites</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①①\">set</a> that is the result\nof invoking <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#parse-a-site\" id=\"ref-for-parse-a-site①\">parse a site</a>\nfor each value in <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-impressionsites\" id=\"ref-for-dom-privateattributionconversionoptions-impressionsites②\">impressionSites</a></code>.</p>"
        },
        {
          "html": "<p>If any result in <var>impressionSites</var> is failure, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#syntaxerror\" id=\"ref-for-syntaxerror①\">\"SyntaxError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException③\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>intermediarySites</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①②\">set</a> that is the result\nof invoking <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#parse-a-site\" id=\"ref-for-parse-a-site②\">parse a site</a>\nfor each value in <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-intermediarysites\" id=\"ref-for-dom-privateattributionconversionoptions-intermediarysites②\">intermediarySites</a></code>.</p>"
        },
        {
          "html": "<p>If any result in <var>intermediarySites</var> is failure, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#syntaxerror\" id=\"ref-for-syntaxerror②\">\"SyntaxError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException④\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Return a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options\" id=\"ref-for-validated-conversion-options\">validated conversion options</a> with the following fields:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-aggregation-service\" id=\"ref-for-validated-conversion-options-aggregation-service\">Aggregation Service</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-aggregationservice\" id=\"ref-for-dom-privateattributionconversionoptions-aggregationservice④\">aggregationService</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-epsilon\" id=\"ref-for-validated-conversion-options-epsilon\">Epsilon</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-epsilon\" id=\"ref-for-dom-privateattributionconversionoptions-epsilon②\">epsilon</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-histogram-size\" id=\"ref-for-validated-conversion-options-histogram-size①\">Histogram Size</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-histogramsize\" id=\"ref-for-dom-privateattributionconversionoptions-histogramsize②\">histogramSize</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-lookback\" id=\"ref-for-validated-conversion-options-lookback\">Lookback</a>\n       </dt><dd data-md=\"\">\n        <p><var>lookback</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-match-value\" id=\"ref-for-validated-conversion-options-match-value\">Match Value</a>\n       </dt><dd data-md=\"\">\n        <p><var>matchValue</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-impression-sites\" id=\"ref-for-validated-conversion-options-impression-sites\">Impression Sites</a>\n       </dt><dd data-md=\"\">\n        <p><var>impressionSites</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-intermediary-sites\" id=\"ref-for-validated-conversion-options-intermediary-sites\">Intermediary Sites</a>\n       </dt><dd data-md=\"\">\n        <p><var>intermediarySites</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-logic\" id=\"ref-for-validated-conversion-options-logic\">Logic</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-logic\" id=\"ref-for-dom-privateattributionconversionoptions-logic②\">logic</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-value\" id=\"ref-for-validated-conversion-options-value\">Value</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-value\" id=\"ref-for-dom-privateattributionconversionoptions-value③\">value</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-max-value\" id=\"ref-for-validated-conversion-options-max-value\">Max Value</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionconversionoptions-maxvalue\" id=\"ref-for-dom-privateattributionconversionoptions-maxvalue②\">maxValue</a></code></p>\n      </dd></dl>"
        }
      ]
    },
    {
      "name": "do attribution and fill a histogram",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#do-attribution-and-fill-a-histogram",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"do-attribution-and-fill-a-histogram\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">do attribution and fill a histogram</dfn>, given\n  <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options\" id=\"ref-for-validated-conversion-options①\">validated conversion options</a> <var>options</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site②⑦\">site</a> <var>topLevelSite</var>,\n  and <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-moment\" id=\"ref-for-dfn-moment⑦\">moment</a> <var>now</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>matchedImpressions</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty\">empty</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①③\">set</a>.</p>"
        },
        {
          "html": "<p>Let <var>currentEpoch</var> be the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#get-the-current-epoch\" id=\"ref-for-get-the-current-epoch⑤\">get the current epoch</a>\nwith <var>topLevelSite</var> and <var>now</var>.</p>"
        },
        {
          "html": "<p>Let <var>startEpoch</var> be the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#get-the-starting-epoch-for-attribution\" id=\"ref-for-get-the-starting-epoch-for-attribution\">get the starting epoch for attribution</a>\nwith <var>topLevelSite</var>.</p>"
        },
        {
          "html": "For each <var>epoch</var> from <var>startEpoch</var> to <var>currentEpoch</var>, inclusive:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>impressions</var> be the result of invoking <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#common-matching-logic\" id=\"ref-for-common-matching-logic①\">common matching logic</a>\nwith <var>options</var>, <var>topLevelSite</var>, <var>epoch</var>, and <var>now</var>.</p>"
            },
            {
              "html": "If <var>impressions</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty①\">is not empty</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>key</var> be a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#privacy-budget-key\" id=\"ref-for-privacy-budget-key③\">privacy budget key</a> whose items are <var>epoch</var> and <var>topLevelSite</var>.</p>"
                },
                {
                  "html": "<p>Let <var>budgetOk</var> be the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#deduct-privacy-budget\" id=\"ref-for-deduct-privacy-budget①\">deduct privacy budget</a>\nwith <var>key</var>, <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-epsilon\" id=\"ref-for-validated-conversion-options-epsilon①\">epsilon</a>,\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-value\" id=\"ref-for-validated-conversion-options-value①\">value</a>,\nand <var>options</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-max-value\" id=\"ref-for-validated-conversion-options-max-value①\">max value</a>.</p>"
                },
                {
                  "html": "<p>If <var>budgetOk</var> is true, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-extend\" id=\"ref-for-set-extend\">extend</a> <var>matchedImpressions</var> with <var>impressions</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>If <var>matchedImpressions</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty②\">is empty</a>, return the result of invoking\n<a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#create-an-all-zero-histogram\" id=\"ref-for-create-an-all-zero-histogram①\">create an all-zero histogram</a> with\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-histogram-size\" id=\"ref-for-validated-conversion-options-histogram-size②\">histogram size</a>.</p>"
        },
        {
          "html": "Switch on <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-logic\" id=\"ref-for-validated-conversion-options-logic①\">logic</a>:",
          "rationale": ".switch",
          "steps": [
            {
              "operation": "switch",
              "steps": [
                {
                  "case": "\"last-touch\"",
                  "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#fill-a-histogram-with-last-touch-attribution\" id=\"ref-for-fill-a-histogram-with-last-touch-attribution\">fill a histogram with last-touch attribution</a> with <var>matchedImpressions</var>,\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-histogram-size\" id=\"ref-for-validated-conversion-options-histogram-size③\">histogram size</a>, and\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-value\" id=\"ref-for-validated-conversion-options-value②\">value</a>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "create an all-zero histogram",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#create-an-all-zero-histogram",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"create-an-all-zero-histogram\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create an all-zero histogram</dfn>, given an integer <var>size</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list\">list</a> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size②\">size</a> <var>size</var>, whose <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item\">items</a> are all 0.</p>"
        }
      ]
    },
    {
      "name": "common matching logic",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#common-matching-logic",
      "html": "To perform <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"common-matching-logic\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">common matching logic</dfn>, given\n<a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options\" id=\"ref-for-validated-conversion-options②\">validated conversion options</a> <var>options</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site②⑧\">site</a> <var>topLevelSite</var>,\n<a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#epoch-index\" id=\"ref-for-epoch-index①①\">epoch index</a> <var>epoch</var>, and <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-moment\" id=\"ref-for-dfn-moment⑧\">moment</a> <var>now</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>matching</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty③\">empty</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①④\">set</a>.</p>"
        },
        {
          "html": "<p>If the number of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#day\" id=\"ref-for-day③\">days</a> since the end of <var>epoch</var> exceeds <var>options</var>’\n<a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-lookback\" id=\"ref-for-validated-conversion-options-lookback①\">lookback</a>, return <var>matching</var>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①\">For each</a> <var>impression</var> in the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-store\" id=\"ref-for-impression-store①④\">impression store</a> for the <var>epoch</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>now</var> is after <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-timestamp\" id=\"ref-for-impression-timestamp②\">timestamp</a> plus <var>impression</var>’s\n<a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-lifetime\" id=\"ref-for-impression-lifetime②\">lifetime</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue③\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>now</var> is after <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-timestamp\" id=\"ref-for-impression-timestamp③\">timestamp</a> plus <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-lookback\" id=\"ref-for-validated-conversion-options-lookback②\">lookback</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue④\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites⑥\">conversion sites</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty④\">is not empty</a>\nand <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain②\">does not contain</a> <var>topLevelSite</var>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑤\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-match-value\" id=\"ref-for-validated-conversion-options-match-value①\">match value</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty⑤\">is not empty</a>\nand <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain③\">does not contain</a> <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-match-value\" id=\"ref-for-impression-match-value①\">match value</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑥\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#validated-conversion-options-impression-sites\" id=\"ref-for-validated-conversion-options-impression-sites①\">impression sites</a>\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty⑥\">is not empty</a> and\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain④\">does not contain</a> <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-impression-site\" id=\"ref-for-impression-impression-site②\">impression site</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑦\">continue</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append\">Append</a> <var>impression</var> to <var>matching</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>matching</var>.</p>"
        }
      ]
    },
    {
      "name": "fill a histogram with last-touch attribution",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#fill-a-histogram-with-last-touch-attribution",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"fill-a-histogram-with-last-touch-attribution\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">fill a histogram with last-touch attribution</dfn>, given a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①⑤\">set</a> of\n  <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression\" id=\"ref-for-impression②⑥\">impressions</a> <var>matchedImpressions</var>, an integer <var>histogramSize</var>, and an integer <var>value</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert\">Assert</a>: <var>matchedImpressions</var> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty⑦\">not empty</a>.</p>"
        },
        {
          "html": "<p>Let <var>impression</var> be the value in <var>matchedImpressions</var> with the most recent\n<a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-timestamp\" id=\"ref-for-impression-timestamp④\">timestamp</a>.</p>"
        },
        {
          "html": "<p>Let <var>histogram</var> be the result of invoking <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#create-an-all-zero-histogram\" id=\"ref-for-create-an-all-zero-histogram②\">create an all-zero histogram</a>\nwith <var>histogramSize</var>.</p>"
        },
        {
          "html": "<p>Let <var>index</var> be <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#impression-histogram-index\" id=\"ref-for-impression-histogram-index①\">histogram index</a>.</p>"
        },
        {
          "html": "<p>If <var>index</var> is less than <var>histogram</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size③\">size</a>, set <var>histogram</var>[<var>index</var>] to <var>value</var>.</p>"
        },
        {
          "html": "<p>Return <var>histogram</var>.</p>"
        }
      ]
    },
    {
      "name": "parse a Save-Impression header",
      "href": "https://www.w3.org/TR/privacy-preserving-attribution/#parse-a-save-impression-header",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"parse-a-save-impression-header\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">parse a <code>Save-Impression</code> header</dfn> given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#header-value\" id=\"ref-for-header-value\">header value</a>\n<var>input</var>, run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>dict</var> be the result of <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#text-parse\" id=\"ref-for-text-parse\">parsing structured fields</a>\nwith <var>input_bytes</var> set to <var>input</var> and\n<var>field_type</var> set to \"<code>dictionary</code>\".</p>"
        },
        {
          "html": "<p>If parsing failed, return an error.</p>"
        },
        {
          "html": "<p>If <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#save-impression-histogram-index\" id=\"ref-for-save-impression-histogram-index\">histogram-index</a></code>\"] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists④\">exist</a> or\nis not an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#integer\" id=\"ref-for-integer③\">integer</a> or is less than 0, return an error.</p>"
        },
        {
          "html": "<p>Let <var>histogramIndex</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#save-impression-histogram-index\" id=\"ref-for-save-impression-histogram-index①\">histogram-index</a></code>\"].</p>"
        },
        {
          "html": "<p>Let <var>conversionSites</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#save-impression-conversion-sites\" id=\"ref-for-save-impression-conversion-sites\">conversion-sites</a></code>\"]\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default\">with default</a> an empty <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#inner-list\" id=\"ref-for-inner-list①\">inner list</a>.</p>"
        },
        {
          "html": "<p>If any of <var>conversionSites</var>’ <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item①\">items</a> is not a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#string\" id=\"ref-for-string③\">string</a>, return an error.</p>"
        },
        {
          "html": "<p>Let <var>matchValue</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#save-impression-match-value\" id=\"ref-for-save-impression-match-value\">match-value</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default①\">with default</a> 0.</p>"
        },
        {
          "html": "<p>If <var>matchValue</var> is not an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#integer\" id=\"ref-for-integer④\">integer</a> or is less than 0, return an error.</p>"
        },
        {
          "html": "<p>Let <var>lifetimeDays</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#save-impression-lifetime-days\" id=\"ref-for-save-impression-lifetime-days\">lifetime-days</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default②\">with default</a> 30.</p>"
        },
        {
          "html": "<p>If <var>lifetimeDays</var> is not an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#integer\" id=\"ref-for-integer⑤\">integer</a> or is less than or equal to 0, return an error.</p>"
        },
        {
          "html": "<p>Return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dictdef-privateattributionimpressionoptions\" id=\"ref-for-dictdef-privateattributionimpressionoptions②\">PrivateAttributionImpressionOptions</a></code> with the following items:</p>\n      <dl>\n       <dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-histogramindex\" id=\"ref-for-dom-privateattributionimpressionoptions-histogramindex④\">histogramIndex</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>histogramIndex</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-matchvalue\" id=\"ref-for-dom-privateattributionimpressionoptions-matchvalue⑤\">matchValue</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>matchValue</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-conversionsites\" id=\"ref-for-dom-privateattributionimpressionoptions-conversionsites④\">conversionSites</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>conversionSites</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/privacy-preserving-attribution/#dom-privateattributionimpressionoptions-lifetimedays\" id=\"ref-for-dom-privateattributionimpressionoptions-lifetimedays⑥\">lifetimeDays</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>lifetimeDays</var></p>\n      </dd></dl>"
        }
      ]
    }
  ]
}