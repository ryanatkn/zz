{
  "spec": {
    "title": "Portals",
    "url": "https://wicg.github.io/portals/"
  },
  "algorithms": [
    {
      "name": "portal-browsing-context-activate",
      "href": "https://wicg.github.io/portals/#activate-a-portal-browsing-context",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert\">Assert</a>: The <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state②\">portal state</a> of <var>predecessorBrowsingContext</var> is \"<code>none</code>\".</p>"
        },
        {
          "html": "<p>If <var>successorBrowsingContext</var>’s only entry in its <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/history.html#session-history\" id=\"ref-for-session-history\">session history</a> is the initial <code>about:blank</code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document\">Document</a></code>, then wait until either this is no longer true, or <var>successorBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element②\">host element</a> becomes null.</p>"
        },
        {
          "html": "If <var>successorBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element③\">host element</a> is null, then:",
          "rationale": "queue",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-task-source\" id=\"ref-for-portal-task-source\">portal task source</a> given <var>predecessorBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-window\" id=\"ref-for-active-window\">active window</a> to <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#reject\" id=\"ref-for-reject\">reject</a> <var>promise</var> with an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#invalidstateerror\" id=\"ref-for-invalidstateerror\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#idl-DOMException\" id=\"ref-for-idl-DOMException\">DOMException</a></code>.</p>"
            },
            {
              "html": "<p>Return.</p>"
            }
          ]
        },
        {
          "html": "<p>Set the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element④\">host element</a> of <var>successorBrowsingContext</var> to null.</p>\n       <p>User agents <em>should</em>, however, attempt to preserve the rendering of the\nguest browsing context until <var>predecessorBrowsingContext</var> has been replaced\nwith <var>successorBrowsingContext</var> in the rendering.</p>"
        },
        {
          "html": "<p>Set the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state③\">portal state</a> of <var>predecessorBrowsingContext</var> to \"<code>orphaned</code>\".</p>"
        },
        {
          "html": "<p>Update the user interface to replace <var>predecessorBrowsingContext</var> with <var>successorBrowsingContext</var> (e.g., by updating the tab/window contents and browser chrome).</p>"
        },
        {
          "html": "<p>Let <var>successorWindow</var> be <var>successorBrowsingContext</var>’s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#windowproxy\" id=\"ref-for-windowproxy\">WindowProxy</a></code>'s [[Window]] internal slot value.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-task-source\" id=\"ref-for-portal-task-source①\">portal task source</a> given <var>successorWindow</var> to run the\nfollowing steps:",
          "rationale": "assert",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①\">Assert</a>: The <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state④\">portal state</a> of <var>successorBrowsingContext</var> is \"<code>portal</code>\".</p>"
            },
            {
              "html": "<p>Set the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state⑤\">portal state</a> of <var>successorBrowsingContext</var> to \"<code>none</code>\".</p>"
            },
            {
              "html": "<p>Let <var>targetRealm</var> be <var>successorWindow</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-global-object-realm\" id=\"ref-for-concept-global-object-realm\">realm</a>.</p>"
            },
            {
              "html": "<p>Let <var>dataClone</var> be null.</p>"
            },
            {
              "html": "If <var>serializeWithTransferResult</var> is given and <var>successorBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-document\" id=\"ref-for-active-document\">active document</a>'s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-document-origin\" id=\"ref-for-concept-document-origin\">origin</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/origin.html#same-origin\" id=\"ref-for-same-origin\">same origin</a> with <var>sourceOrigin</var>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>deserializeRecord</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structureddeserializewithtransfer\" id=\"ref-for-structureddeserializewithtransfer\">StructuredDeserializeWithTransfer</a>(<var>serializeWithTransferResult</var>, <var>targetRealm</var>),\nand set <var>dataClone</var> to <var>deserializeRecord</var>.[[Deserialized]].</p>\n           <p>If this throws an exception, catch it and do nothing.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>event</var> be the result of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-create\" id=\"ref-for-concept-event-create\">creating an event</a> using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/portals/#portalactivateevent\" id=\"ref-for-portalactivateevent\">PortalActivateEvent</a></code> and <var>targetRealm</var>.</p>"
            },
            {
              "html": "<p>Initialize <var>event</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#dom-event-type\" id=\"ref-for-dom-event-type\">type</a></code> attribute to <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://wicg.github.io/portals/#eventdef-window-portalactivate\" id=\"ref-for-eventdef-window-portalactivate①\">portalactivate</a></code>.</p>"
            },
            {
              "html": "<p>Initialize <var>event</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/portals/#dom-portalactivateevent-data\" id=\"ref-for-dom-portalactivateevent-data\">data</a></code> attribute to <var>dataClone</var>.</p>"
            },
            {
              "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-predecessor-browsing-context\" id=\"ref-for-portalactivateevent-predecessor-browsing-context\">predecessor browsing context</a> to <var>predecessorBrowsingContext</var>.</p>"
            },
            {
              "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-successor-window\" id=\"ref-for-portalactivateevent-successor-window\">successor window</a> to <var>successorWindow</var>.</p>"
            },
            {
              "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-activation-promise\" id=\"ref-for-portalactivateevent-activation-promise\">activation promise</a> to <var>promise</var>, if it is given, and null otherwise.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-dispatch\" id=\"ref-for-concept-event-dispatch\">Dispatch</a> <var>event</var> to <var>successorWindow</var>.</p>"
            },
            {
              "html": "<p>Let <var>adoptedPredecessorElement</var> be <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-adopted-predecessor-element\" id=\"ref-for-portalactivateevent-adopted-predecessor-element\">adopted predecessor element</a>.</p>"
            },
            {
              "html": "If <var>adoptedPredecessorElement</var> is not null, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>adoptedPredecessorElement</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-just-adopted-flag\" id=\"ref-for-htmlportalelement-just-adopted-flag\">just-adopted flag</a> to false.</p>"
                },
                {
                  "html": "<p>If <var>adoptedPredecessorElement</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#may-have-a-guest-browsing-context\" id=\"ref-for-may-have-a-guest-browsing-context\">may not have a guest browsing context</a> and\nits <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context\">guest browsing context</a> is not null, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#a-browsing-context-is-discarded\" id=\"ref-for-a-browsing-context-is-discarded\">discard</a> it.</p>"
                }
              ]
            },
            {
              "html": "Otherwise:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>promise</var> is given, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-task-source\" id=\"ref-for-portal-task-source②\">portal task source</a> given <var>predecessorBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-window\" id=\"ref-for-active-window①\">active window</a> to resolve <var>promise</var> with undefined.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#close-a-browsing-context\" id=\"ref-for-close-a-browsing-context②\">Close</a> <var>predecessorBrowsingContext</var>.</p>\n           <p>The user agent <em>should not</em> ask the user for confirmation during the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#prompt-to-unload-a-document\" id=\"ref-for-prompt-to-unload-a-document\">prompt to unload</a> step (and so the browsing context should be <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#a-browsing-context-is-discarded\" id=\"ref-for-a-browsing-context-is-discarded②\">discarded</a>).</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "portal-browsing-context-adopt-predecessor",
      "href": "https://wicg.github.io/portals/#adopt-the-predecessor-browsing-context",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>document</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window\" id=\"ref-for-concept-document-window\">document</a> of <var>successorWindow</var>.</p>"
        },
        {
          "html": "<p>Let <var>portalElement</var> be the result of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-create-element\" id=\"ref-for-concept-create-element\">creating an element</a> given <var>document</var>, <code>portal</code>, and the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#html-namespace\" id=\"ref-for-html-namespace\">HTML namespace</a>.</p>"
        },
        {
          "html": "<p>Set <var>portalElement</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-just-adopted-flag\" id=\"ref-for-htmlportalelement-just-adopted-flag②\">just-adopted flag</a> to true.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②\">Assert</a>: <var>portalElement</var> is an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/portals/#htmlportalelement\" id=\"ref-for-htmlportalelement\">HTMLPortalElement</a></code>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task③\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-task-source\" id=\"ref-for-portal-task-source③\">portal task source</a> given <var>predecessorBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-window\" id=\"ref-for-active-window②\">active window</a> to run the following steps:",
          "rationale": "assert",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert③\">Assert</a>: The <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state⑥\">portal state</a> of <var>predecessorBrowsingContext</var> is \"<code>orphaned</code>\".</p>"
            },
            {
              "html": "<p>Set the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state⑦\">portal state</a> of <var>predecessorBrowsingContext</var> to \"<code>portal</code>\", and\nset the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element⑤\">host element</a> of <var>predecessorBrowsingContext</var> to <var>portalElement</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>portalElement</var>.</p>"
        }
      ]
    },
    {
      "name": "htmlportalelement-activate",
      "href": "https://wicg.github.io/portals/#dom-htmlportalelement-activate",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>portalBrowsingContext</var> be the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context②\">guest browsing context</a> of <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this\">this</a>.</p>"
        },
        {
          "html": "<p>If <var>portalBrowsingContext</var> is null, throw an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#invalidstateerror\" id=\"ref-for-invalidstateerror①\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#idl-DOMException\" id=\"ref-for-idl-DOMException①\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>predecessorBrowsingContext</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc\" id=\"ref-for-concept-document-bc\">browsing context</a> of <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this①\">this</a>'s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-node-document\" id=\"ref-for-concept-node-document①\">node document</a>.</p>"
        },
        {
          "html": "<p>If <var>predecessorBrowsingContext</var> is null, throw an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#invalidstateerror\" id=\"ref-for-invalidstateerror②\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#idl-DOMException\" id=\"ref-for-idl-DOMException②\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state⑨\">portal state</a> of <var>predecessorBrowsingContext</var> is not \"<code>none</code>\",\nthrow an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#invalidstateerror\" id=\"ref-for-invalidstateerror③\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#idl-DOMException\" id=\"ref-for-idl-DOMException③\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>serializeWithTransferResult</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structuredserializewithtransfer\" id=\"ref-for-structuredserializewithtransfer\">StructuredSerializeWithTransfer</a>(<var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/portals/#dom-portalactivateoptions-data\" id=\"ref-for-dom-portalactivateoptions-data\">data</a></code>\"], <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#dom-postmessageoptions-transfer\" id=\"ref-for-dom-postmessageoptions-transfer\">transfer</a></code>\"]).\nRethrow any exceptions.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects\">promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>sourceOrigin</var> be <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this②\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object\">relevant settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin\">origin</a>.</p>"
        },
        {
          "html": "<p>Run the steps to <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#activate-a-portal-browsing-context\" id=\"ref-for-activate-a-portal-browsing-context②\">activate</a> <var>portalBrowsingContext</var> in place of <var>predecessorBrowsingContext</var> with <var>sourceOrigin</var>, <var>serializeWithTransferResult</var>,\nand <var>promise</var>.</p>"
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "htmlportalelement-postmessage",
      "href": "https://wicg.github.io/portals/#dom-htmlportalelement-postmessage",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>portalBrowsingContext</var> be the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context③\">guest browsing context</a> of <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this③\">this</a>.</p>"
        },
        {
          "html": "<p>If <var>portalBrowsingContext</var> is null, throw an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#invalidstateerror\" id=\"ref-for-invalidstateerror④\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#idl-DOMException\" id=\"ref-for-idl-DOMException④\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>sourceOrigin</var> be <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this④\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①\">relevant settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①\">origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>transfer</var> be <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#dom-postmessageoptions-transfer\" id=\"ref-for-dom-postmessageoptions-transfer①\">transfer</a></code>\"].</p>"
        },
        {
          "html": "<p>Let <var>serializeWithTransferResult</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structuredserializewithtransfer\" id=\"ref-for-structuredserializewithtransfer①\">StructuredSerializeWithTransfer</a>(<var>message</var>, <var>transfer</var>). Rethrow any exceptions.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task④\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-task-source\" id=\"ref-for-portal-task-source④\">portal task source</a> given <var>portalBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-window\" id=\"ref-for-active-window③\">active\nwindow</a> to run the following steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>portalBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-document\" id=\"ref-for-active-document①\">active document</a>'s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-document-origin\" id=\"ref-for-concept-document-origin①\">origin</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/origin.html#same-origin\" id=\"ref-for-same-origin①\">same origin</a> with <var>sourceOrigin</var>, then abort these steps.</p>"
            },
            {
              "html": "<p>Let <var>origin</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/origin.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin\">serialization</a> of <var>sourceOrigin</var>.</p>"
            },
            {
              "html": "<p>Let <var>targetWindow</var> be <var>portalBrowsingContext</var>’s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#windowproxy\" id=\"ref-for-windowproxy①\">WindowProxy</a></code>'s [[Window]] internal slot value.</p>"
            },
            {
              "html": "<p>Let <var>portalHost</var> be the <var>targetWindow</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-host-object\" id=\"ref-for-portal-host-object\">portal host object</a>.</p>"
            },
            {
              "html": "<p>Let <var>targetRealm</var> be the <var>targetWindow</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-global-object-realm\" id=\"ref-for-concept-global-object-realm①\">realm</a>.</p>"
            },
            {
              "html": "<p>Let <var>deserializeRecord</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structureddeserializewithtransfer\" id=\"ref-for-structureddeserializewithtransfer①\">StructuredDeserializeWithTransfer</a>(<var>serializeWithTransferResult</var>, <var>targetRealm</var>).</p>\n         <p>If this throws an exception, catch it, <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire\">fire an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://wicg.github.io/portals/#eventdef-portalhost-messageerror\" id=\"ref-for-eventdef-portalhost-messageerror\">messageerror</a></code> at <var>portalHost</var> using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#messageevent\" id=\"ref-for-messageevent\">MessageEvent</a></code> with the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-origin\" id=\"ref-for-dom-messageevent-origin\">origin</a></code> attribute initialized to <var>origin</var> and the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-source\" id=\"ref-for-dom-messageevent-source\">source</a></code> attribute initialized to <var>portalHost</var>,\nthen abort these steps.</p>"
            },
            {
              "html": "<p>Let <var>messageClone</var> be <var>deserializeRecord</var>.[[Deserialized]].</p>"
            },
            {
              "html": "<p>Let <var>newPorts</var> be a new <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#dfn-frozen-array-type\" id=\"ref-for-dfn-frozen-array-type\">frozen array</a> consisting of all <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#messageport\" id=\"ref-for-messageport\">MessagePort</a></code> objects in <var>deserializeRecord</var>.[[TransferredValues]], if any, maintaining their relative order.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire①\">Fire an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://wicg.github.io/portals/#eventdef-portalhost-message\" id=\"ref-for-eventdef-portalhost-message\">message</a></code> at <var>portalHost</var> using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#messageevent\" id=\"ref-for-messageevent①\">MessageEvent</a></code>, with the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-origin\" id=\"ref-for-dom-messageevent-origin①\">origin</a></code> attribute\ninitialized to <var>origin</var>, the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-source\" id=\"ref-for-dom-messageevent-source①\">source</a></code> attribute initialized to <var>portalHost</var>, the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-data\" id=\"ref-for-dom-messageevent-data\">data</a></code> attribute\ninitialized to <var>messageClone</var>, and the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-ports\" id=\"ref-for-dom-messageevent-ports\">ports</a></code> attribute initialized to <var>newPorts</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "htmlportalelement-may-have-guest-browsing-context",
      "href": "https://wicg.github.io/portals/#may-have-a-guest-browsing-context",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-node-document\" id=\"ref-for-concept-node-document②\">node document</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#browsing-context\" id=\"ref-for-browsing-context③\">browsing context</a> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#top-level-browsing-context\" id=\"ref-for-top-level-browsing-context①\">top-level browsing context</a>, then return false.</p>"
        },
        {
          "html": "<p>If <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-node-document\" id=\"ref-for-concept-node-document③\">node document</a>'s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-document-url\" id=\"ref-for-concept-document-url\">URL</a>'s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme\">scheme</a> is not an <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#http-scheme\" id=\"ref-for-http-scheme\">HTTP(S) scheme</a>, then return false.</p>"
        },
        {
          "html": "<p>If <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-node-document\" id=\"ref-for-concept-node-document④\">node document</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/origin.html#active-sandboxing-flag-set\" id=\"ref-for-active-sandboxing-flag-set\">active sandboxing flag set</a> is not empty,\nthen return false.</p>"
        },
        {
          "html": "<p>If <var>element</var> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#browsing-context-connected\" id=\"ref-for-browsing-context-connected①\">browsing-context connected</a>, then return true.</p>"
        },
        {
          "html": "<p>If <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-just-adopted-flag\" id=\"ref-for-htmlportalelement-just-adopted-flag③\">just-adopted flag</a> is true, then return true.</p>"
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "htmlportalelement-close",
      "href": "https://wicg.github.io/portals/#close-a-portal-element",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context④\">guest browsing context</a> is not null, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#close-a-browsing-context\" id=\"ref-for-close-a-browsing-context③\">close</a> it.</p>\n       <p>The user agent <em>should not</em> ask the user for confirmation during the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#prompt-to-unload-a-document\" id=\"ref-for-prompt-to-unload-a-document①\">prompt to unload</a> step (and so the browsing context should be <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#a-browsing-context-is-discarded\" id=\"ref-for-a-browsing-context-is-discarded③\">discarded</a>).</p>"
        }
      ]
    },
    {
      "name": "htmlportalelement-setsourceurl",
      "href": "https://wicg.github.io/portals/#set-the-source-url-of-a-portal-element",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert④\">Assert</a>: <var>element</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#may-have-a-guest-browsing-context\" id=\"ref-for-may-have-a-guest-browsing-context①\">may have a guest browsing context</a>.</p>"
        },
        {
          "html": "<p>Let <var>hostBrowsingContext</var> be <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-node-document\" id=\"ref-for-concept-node-document⑤\">node document</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#browsing-context\" id=\"ref-for-browsing-context④\">browsing context</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑤\">Assert</a>: <var>hostBrowsingContext</var> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#top-level-browsing-context\" id=\"ref-for-top-level-browsing-context②\">top-level browsing context</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#close-a-portal-element\" id=\"ref-for-close-a-portal-element\">Close</a> <var>element</var>.</p>"
        },
        {
          "html": "<p>If <var>element</var> has no <code><a data-link-type=\"element-sub\" href=\"https://wicg.github.io/portals/#element-attrdef-portal-src\" id=\"ref-for-element-attrdef-portal-src①\">src</a></code> attribute specified, or its value is the empty string,\nthen return.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/urls-and-fetching.html#parse-a-url\" id=\"ref-for-parse-a-url\">Parse</a> the value of the <code><a data-link-type=\"element-sub\" href=\"https://wicg.github.io/portals/#element-attrdef-portal-src\" id=\"ref-for-element-attrdef-portal-src②\">src</a></code> attribute. If that is not successful,\nthen return.</p>\n       <p>Otherwise, let <var>url</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/urls-and-fetching.html#resulting-url-record\" id=\"ref-for-resulting-url-record\">resulting URL record</a>.</p>"
        },
        {
          "html": "<p class=\"assertion\">Assert: <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context⑤\">guest browsing context</a> is null.</p>"
        },
        {
          "html": "<p>Let <var>guestBrowsingContext</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-new-top-level-browsing-context\" id=\"ref-for-creating-a-new-top-level-browsing-context\">creating a new top-level browsing context</a>.</p>"
        },
        {
          "html": "<p>Set the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state①⓪\">portal state</a> of <var>guestBrowsingContext</var> to \"<code>portal</code>\", and set the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element⑦\">host element</a> of <var>guestBrowsingContext</var> to <var>element</var>.</p>"
        },
        {
          "html": "<p>Let <var>resource</var> be a new <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request\">request</a> whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url\">url</a> is <var>url</var> and whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer-policy\" id=\"ref-for-concept-request-referrer-policy\">referrer policy</a> is the current state of <var>element</var>’s <code><a data-link-type=\"element-sub\" href=\"https://wicg.github.io/portals/#element-attrdef-portal-referrerpolicy\" id=\"ref-for-element-attrdef-portal-referrerpolicy①\">referrerpolicy</a></code> content attribute.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate\" id=\"ref-for-navigate\">Navigate</a> <var>guestBrowsingContext</var> to <var>resource</var>.</p>"
        }
      ]
    },
    {
      "html": "Whenever a <code><a data-link-type=\"element\" href=\"https://wicg.github.io/portals/#elementdef-portal\" id=\"ref-for-elementdef-portal①⑤\">portal</a></code> element <var>element</var> has its <code><a data-link-type=\"element-sub\" href=\"https://wicg.github.io/portals/#element-attrdef-portal-src\" id=\"ref-for-element-attrdef-portal-src④\">src</a></code> attribute set,\n  changed, or removed, run the following steps:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>If <var>element</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#may-have-a-guest-browsing-context\" id=\"ref-for-may-have-a-guest-browsing-context②\">may have a guest browsing context</a>, then <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#set-the-source-url-of-a-portal-element\" id=\"ref-for-set-the-source-url-of-a-portal-element①\">set the source URL</a> of <var>element</var>.</p>"
        }
      ]
    },
    {
      "html": "Whenever a <code><a data-link-type=\"element\" href=\"https://wicg.github.io/portals/#elementdef-portal\" id=\"ref-for-elementdef-portal①⑥\">portal</a></code> element <var>element</var> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#becomes-browsing-context-connected\" id=\"ref-for-becomes-browsing-context-connected\">becomes\n  browsing-context connected</a>, run the following steps:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>If <var>element</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#may-have-a-guest-browsing-context\" id=\"ref-for-may-have-a-guest-browsing-context③\">may not have a guest browsing context</a>, then abort these steps.</p>"
        },
        {
          "html": "<p>If <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context⑥\">guest browsing context</a> is not null, then abort these steps.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#set-the-source-url-of-a-portal-element\" id=\"ref-for-set-the-source-url-of-a-portal-element②\">Set the source URL</a> of <var>element</var>.</p>"
        }
      ]
    },
    {
      "html": "Whenever a <code><a data-link-type=\"element\" href=\"https://wicg.github.io/portals/#elementdef-portal\" id=\"ref-for-elementdef-portal①⑧\">portal</a></code> element <var>element</var> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#becomes-browsing-context-disconnected\" id=\"ref-for-becomes-browsing-context-disconnected\">becomes\n  browsing-context connected</a>, run the following steps:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>If <var>element</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#may-have-a-guest-browsing-context\" id=\"ref-for-may-have-a-guest-browsing-context④\">may not have a guest browsing context</a> and its <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context⑦\">guest browsing context</a> is not null, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#a-browsing-context-is-discarded\" id=\"ref-for-a-browsing-context-is-discarded④\">discard</a> it.</p>"
        }
      ]
    },
    {
      "html": "Whenever a <code><a data-link-type=\"element\" href=\"https://wicg.github.io/portals/#elementdef-portal\" id=\"ref-for-elementdef-portal②⓪\">portal</a></code> element <var>element</var> is <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-node-adopt-ext\" id=\"ref-for-concept-node-adopt-ext\">adopted</a>, run the following steps:",
      "rationale": "let",
      "steps": [
        {
          "html": "<p>Let <var>guestBrowsingContext</var> be <var>element</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context⑧\">guest browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>guestBrowsingContext</var> is null, then abort these steps.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#a-browsing-context-is-discarded\" id=\"ref-for-a-browsing-context-is-discarded⑤\">Discard</a> <var>guestBrowsingContext</var>.</p>"
        }
      ]
    },
    {
      "html": "Whenever a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document②\">Document</a></code> object <var>document</var> whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc\" id=\"ref-for-concept-document-bc①\">browsing context</a> is a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-browsing-context\" id=\"ref-for-portal-browsing-context⑨\">portal browsing context</a> is marked as <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/parsing.html#completely-loaded\" id=\"ref-for-completely-loaded\">completely loaded</a>, run the following steps as part of\n  the queued task:",
      "rationale": "let",
      "steps": [
        {
          "html": "<p>Let <var>element</var> be <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc\" id=\"ref-for-concept-document-bc②\">browsing context</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element⑧\">host element</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire②\">Fire an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://html.spec.whatwg.org/multipage/indices.html#event-load\" id=\"ref-for-event-load\">load</a></code> at <var>element</var>.</p>"
        }
      ]
    },
    {
      "name": "htmlportalelement-activation-behavior",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>portalBrowsingContext</var> be the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context①①\">guest browsing context</a> of <var>el</var>.</p>"
        },
        {
          "html": "<p>If <var>portalBrowsingContext</var> is null, return.</p>"
        },
        {
          "html": "<p>Let <var>predecessorBrowsingContext</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc\" id=\"ref-for-concept-document-bc③\">browsing context</a> of <var>el</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-node-document\" id=\"ref-for-concept-node-document⑥\">node\ndocument</a>.</p>"
        },
        {
          "html": "<p>If <var>predecessorBrowsingContext</var> is null, return.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state①①\">portal state</a> of <var>predecessorBrowsingContext</var> is not \"<code>none</code>\", return.</p>"
        },
        {
          "html": "<p>Let <var>sourceOrigin</var> be <var>el</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②\">relevant settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②\">origin</a>.</p>"
        },
        {
          "html": "<p>Run the steps to <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#activate-a-portal-browsing-context\" id=\"ref-for-activate-a-portal-browsing-context③\">activate</a> <var>portalBrowsingContext</var> in place of <var>predecessorBrowsingContext</var> with <var>sourceOrigin</var>.</p>"
        }
      ]
    },
    {
      "name": "window-portalhost",
      "href": "https://wicg.github.io/portals/#dom-window-portalhost",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>context</var> be <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this⑤\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#window-bc\" id=\"ref-for-window-bc\">browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>context</var> is null or the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state①②\">portal state</a> of <var>context</var> is not \"<code>portal</code>\", then return null.</p>"
        },
        {
          "html": "<p>Return <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this⑥\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-host-object\" id=\"ref-for-portal-host-object②\">portal host object</a>.</p>"
        }
      ]
    },
    {
      "name": "portalhost-postmessage",
      "href": "https://wicg.github.io/portals/#dom-portalhost-postmessage",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>browsingContext</var> be <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this⑦\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#window-bc\" id=\"ref-for-window-bc①\">browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>browsingContext</var> has a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state①③\">portal state</a> other than \"<code>portal</code>\", throw an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#invalidstateerror\" id=\"ref-for-invalidstateerror⑤\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#idl-DOMException\" id=\"ref-for-idl-DOMException⑤\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>sourceOrigin</var> be <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this⑧\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③\">relevant settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin③\">origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>transfer</var> be <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#dom-postmessageoptions-transfer\" id=\"ref-for-dom-postmessageoptions-transfer②\">transfer</a></code>\"].</p>"
        },
        {
          "html": "<p>Let <var>serializeWithTransferResult</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structuredserializewithtransfer\" id=\"ref-for-structuredserializewithtransfer②\">StructuredSerializeWithTransfer</a>(<var>message</var>, <var>transfer</var>). Rethrow any exceptions.</p>"
        },
        {
          "html": "<p>Let <var>hostElement</var> be the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element⑨\">host element</a> of <var>browsingContext</var>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-an-element-task\" id=\"ref-for-queue-an-element-task\">Queue an element task</a> on the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-task-source\" id=\"ref-for-portal-task-source⑤\">portal task source</a> given <var>hostElement</var> to run the following steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>browsingContext</var> is not the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#htmlportalelement-guest-browsing-context\" id=\"ref-for-htmlportalelement-guest-browsing-context①②\">guest browsing context</a> of <var>hostElement</var>, then abort these steps.</p>"
            },
            {
              "html": "<p>Let <var>targetSettings</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object④\">relevant settings object</a> of <var>hostElement</var>.</p>"
            },
            {
              "html": "<p>If <var>targetSettings</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin④\">origin</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/origin.html#same-origin\" id=\"ref-for-same-origin②\">same origin</a> with <var>sourceOrigin</var>, then abort these steps.</p>"
            },
            {
              "html": "<p>Let <var>origin</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/origin.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin①\">serialization</a> of <var>sourceOrigin</var>.</p>"
            },
            {
              "html": "<p>Let <var>targetRealm</var> be <var>targetSettings</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object's-realm\" id=\"ref-for-environment-settings-object's-realm\">realm</a>.</p>"
            },
            {
              "html": "<p>Let <var>deserializeRecord</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structureddeserializewithtransfer\" id=\"ref-for-structureddeserializewithtransfer②\">StructuredDeserializeWithTransfer</a>(<var>serializeWithTransferResult</var>, <var>targetRealm</var>).</p>\n         <p>If this throws an exception, catch it, <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire③\">fire an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://wicg.github.io/portals/#eventdef-htmlportalelement-messageerror\" id=\"ref-for-eventdef-htmlportalelement-messageerror\">messageerror</a></code> at <var>element</var> using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#messageevent\" id=\"ref-for-messageevent④\">MessageEvent</a></code> with the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-origin\" id=\"ref-for-dom-messageevent-origin②\">origin</a></code> attribute initialized to <var>origin</var> and the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-source\" id=\"ref-for-dom-messageevent-source②\">source</a></code> attribute initialized to <var>element</var>.</p>"
            },
            {
              "html": "<p>Let <var>messageClone</var> be <var>deserializeRecord</var>.[[Deserialized]].</p>"
            },
            {
              "html": "<p>Let <var>newPorts</var> be a new <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#dfn-frozen-array-type\" id=\"ref-for-dfn-frozen-array-type①\">frozen array</a> consisting of all <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#messageport\" id=\"ref-for-messageport①\">MessagePort</a></code> objects in <var>deserializeRecord</var>.[[TransferredValues]], if any, maintaining their relative order.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire④\">Fire an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://wicg.github.io/portals/#eventdef-htmlportalelement-message\" id=\"ref-for-eventdef-htmlportalelement-message\">message</a></code> at the <var>element</var> using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#messageevent\" id=\"ref-for-messageevent⑤\">MessageEvent</a></code>, with the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-origin\" id=\"ref-for-dom-messageevent-origin③\">origin</a></code> attribute\ninitialized to <var>origin</var>, the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-source\" id=\"ref-for-dom-messageevent-source③\">source</a></code> attribute initialized to <var>element</var>, the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-data\" id=\"ref-for-dom-messageevent-data①\">data</a></code> attribute\ninitialized to <var>messageClone</var>, and the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-ports\" id=\"ref-for-dom-messageevent-ports①\">ports</a></code> attribute initialized to <var>newPorts</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "portalactivateevent-event-constructing-steps",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-predecessor-browsing-context\" id=\"ref-for-portalactivateevent-predecessor-browsing-context①\">predecessor browsing context</a> to null.</p>"
        },
        {
          "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-successor-window\" id=\"ref-for-portalactivateevent-successor-window①\">successor window</a> to null.</p>"
        },
        {
          "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-adopted-predecessor-element\" id=\"ref-for-portalactivateevent-adopted-predecessor-element①\">adopted predecessor element</a> to null.</p>"
        }
      ]
    },
    {
      "name": "portalactivateevent-adoptpredecessor",
      "href": "https://wicg.github.io/portals/#dom-portalactivateevent-adoptpredecessor",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this⑨\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-adopted-predecessor-element\" id=\"ref-for-portalactivateevent-adopted-predecessor-element②\">adopted predecessor element</a> is not null, throw an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#invalidstateerror\" id=\"ref-for-invalidstateerror⑥\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://heycam.github.io/webidl/#idl-DOMException\" id=\"ref-for-idl-DOMException⑥\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>predecessorBrowsingContext</var> be <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this①⓪\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-predecessor-browsing-context\" id=\"ref-for-portalactivateevent-predecessor-browsing-context②\">predecessor browsing context</a>.</p>"
        },
        {
          "html": "<p>Let <var>successorWindow</var> be <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this①①\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-successor-window\" id=\"ref-for-portalactivateevent-successor-window②\">successor window</a>.</p>"
        },
        {
          "html": "<p>Run the steps to <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#adopt-the-predecessor-browsing-context\" id=\"ref-for-adopt-the-predecessor-browsing-context④\">adopt the predecessor browsing context</a> <var>predecessorBrowsingContext</var> in <var>successorWindow</var>,\nand let <var>adoptedPredecessorElement</var> be the result.</p>"
        },
        {
          "html": "<p>Set <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this①②\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-adopted-predecessor-element\" id=\"ref-for-portalactivateevent-adopted-predecessor-element③\">adopted predecessor element</a> to <var>adoptedPredecessorElement</var>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://heycam.github.io/webidl/#this\" id=\"ref-for-this①③\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portalactivateevent-activation-promise\" id=\"ref-for-portalactivateevent-activation-promise②\">activation promise</a> is not null, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task⑤\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-task-source\" id=\"ref-for-portal-task-source⑥\">portal task source</a> given <var>predecessorBrowsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-window\" id=\"ref-for-active-window④\">active window</a> to resolve it with undefined.</p>"
        },
        {
          "html": "<p>Return <var>adoptedPredecessorElement</var>.</p>"
        }
      ]
    },
    {
      "name": "process a navigate response patch",
      "html": "In <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#process-a-navigate-response\" id=\"ref-for-process-a-navigate-response\">process a navigate response</a>, append the following after the step which\n    establishes the value of <var>failure</var>, but before the step which uses it to display an error page:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "then:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>browsingContext</var>’s only entry in its <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/history.html#session-history\" id=\"ref-for-session-history③\">session history</a> is the initial <code>about:blank</code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document④\">Document</a></code>, then:",
              "rationale": "close",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#close-a-portal-element\" id=\"ref-for-close-a-portal-element①\">Close</a> <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element①⓪\">host element</a>.</p>"
                },
                {
                  "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-discarding-steps\" id=\"ref-for-environment-discarding-steps\">environment discarding steps</a> for <var>navigationParam</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-reserved-environment\" id=\"ref-for-navigation-params-reserved-environment\">reserved environment</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Return.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "process a navigate URL scheme patch",
      "html": "In <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#process-a-navigate-url-scheme\" id=\"ref-for-process-a-navigate-url-scheme\">process a navigate URL scheme</a>, insert the following step before the step\n    which displays inline content:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Otherwise, if <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state①⑥\">portal state</a> is not \"<code>none</code>\", then <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#close-a-portal-element\" id=\"ref-for-close-a-portal-element②\">close</a> <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#host-element\" id=\"ref-for-host-element①①\">host element</a>.</p>"
        }
      ]
    },
    {
      "name": "allowed to download patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>initiator browsing context</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state①⑦\">portal state</a> is not \"<code>none</code>\", then\nreturn false.</p>"
        },
        {
          "html": "<p>If <var>instantiator browsing context</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-state\" id=\"ref-for-portal-state①⑧\">portal state</a> is not \"<code>none</code>\", then\nreturn false.</p>"
        }
      ]
    },
    {
      "name": "portal-src pre-request check",
      "html": "Given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request①\">request</a> <var>request</var> and a policy <var>policy</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>name</var> be the result of executing <a href=\"https://www.w3.org/TR/CSP3/#effective-directive-for-a-request\">Content Security Policy §6.7.1 Get the effective directive for request</a> on <var>request</var>.</p>"
        },
        {
          "html": "<p>If the result of executing <a href=\"https://www.w3.org/TR/CSP3/#should-directive-execute\">Content Security Policy §6.7.4 Should fetch directive execute</a> on <var>name</var>, <code>portal-src</code> and <var>policy</var> is \"<code>No</code>\", return \"<code>Allowed</code>\".</p>"
        },
        {
          "html": "<p>If the result of executing <a href=\"https://www.w3.org/TR/CSP3/#match-request-to-source-list\">Content Security Policy §6.6.2.3 Does request match source list?</a> on <var>request</var>, this directive’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-csp/#directive-value\" id=\"ref-for-directive-value\">value</a>, and <var>policy</var> is \"<code>Does Not Match</code>\", return \"<code>Blocked</code>\".</p>"
        },
        {
          "html": "<p>Return \"<code>Allowed</code>\".</p>"
        }
      ]
    },
    {
      "name": "portal-src post-request check",
      "html": "Given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request②\">request</a> <var>request</var>, a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response\">response</a> <var>response</var>, and a policy <var>policy</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>name</var> be the result of executing <a href=\"https://www.w3.org/TR/CSP3/#effective-directive-for-a-request\">Content Security Policy §6.7.1 Get the effective directive for request</a> on <var>request</var>.</p>"
        },
        {
          "html": "<p>If the result of executing <a href=\"https://www.w3.org/TR/CSP3/#should-directive-execute\">Content Security Policy §6.7.4 Should fetch directive execute</a> on <var>name</var>, <code>portal-src</code> and <var>policy</var> is \"<code>No</code>\", return \"<code>Allowed</code>\".</p>"
        },
        {
          "html": "<p>If the result of executing <a href=\"https://www.w3.org/TR/CSP3/#match-response-to-source-list\">Content Security Policy §6.6.2.4 Does response to request match source list?</a> on <var>response</var>, <var>request</var>,\nthis directive’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-csp/#directive-value\" id=\"ref-for-directive-value①\">value</a>, and <var>policy</var> is \"<code>Does Not Match</code>\", return\n\"<code>Blocked</code>\".</p>"
        },
        {
          "html": "<p>Return \"<code>Allowed</code>\".</p>"
        }
      ]
    },
    {
      "html": "The algorithm in <a href=\"https://www.w3.org/TR/CSP3/#directive-fallback-list\">Content Security Policy §6.7.3 Get fetch directive fallback list</a> needs updating to account for the new <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-src\" id=\"ref-for-portal-src②\">portal-src</a> fetch directive. Add a new case to step 1:",
      "rationale": ".switch",
      "steps": [
        {
          "operation": "switch",
          "steps": [
            {
              "case": "\"portal-src\"",
              "html": "",
              "rationale": "return",
              "steps": [
                {
                  "html": "<p>Return « \"<code>portal-src</code>\", \"<code>prefetch-src</code>\", \"<code>default-src</code>\" ».</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "fetch-metadata-set-mode",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Where the algorithm checks whether <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client\">reserved client</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context\">target\nbrowsing context</a> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#nested-browsing-context\" id=\"ref-for-nested-browsing-context④\">nested browsing context</a>, check instead whether it is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#nested-browsing-context\" id=\"ref-for-nested-browsing-context⑤\">nested\nbrowsing context</a> or a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/portals/#portal-browsing-context\" id=\"ref-for-portal-browsing-context①⑥\">portal browsing context</a>.</p>"
        }
      ]
    }
  ]
}