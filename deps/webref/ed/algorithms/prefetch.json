{
  "spec": {
    "title": "Prefetch",
    "url": "https://wicg.github.io/nav-speculation/prefetch.html"
  },
  "algorithms": [
    {
      "name": "Conflicting credentials exist",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#conflicting-credentials-exist",
      "html": "<dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"conflicting-credentials-exist\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">Conflicting credentials exist</dfn> for <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response\">response</a> <var>response</var> given <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable\">navigable</a> <var>navigable</var> and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#network-partition-key\" id=\"ref-for-network-partition-key\">network partition key</a> <var>sourcePartitionKey</var> if the following steps return true:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>hypotheticalEnvironment</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-a-reserved-client\" id=\"ref-for-create-a-reserved-client\">creating a reserved client</a> given <var>navigable</var>, <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-url\" id=\"ref-for-concept-response-url\">URL</a>, and null.</p>"
        },
        {
          "html": "<p>Let <var>hypotheticalPartitionKey</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#determine-the-network-partition-key\" id=\"ref-for-determine-the-network-partition-key\">determining the network partition key</a> given <var>hypotheticalEnvironment</var>.</p>"
        },
        {
          "html": "<p>If <var>hypotheticalPartitionKey</var> is equal to <var>sourcePartitionKey</var> or there are no <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#credentials\" id=\"ref-for-credentials\">credentials</a> associated with <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-url\" id=\"ref-for-concept-response-url①\">URL</a> and <var>hypotheticalPartitionKey</var>, then return false.</p>"
        },
        {
          "html": "<p>Let <var>loadingModes</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prerendering.html#get-the-supported-loading-modes\" id=\"ref-for-get-the-supported-loading-modes\">getting the supported loading modes</a> for <var>response</var>.</p>"
        },
        {
          "html": "<p>If <var>loadingModes</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain\">contains</a> `<code><a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prerendering.html#supports-loading-mode-uncredentialed-prefetch\" id=\"ref-for-supports-loading-mode-uncredentialed-prefetch\">uncredentialed-prefetch</a></code>` then return true.</p>"
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "redirect chain/update the response",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#redirect-chain-update-the-response",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"redirect chain\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"redirect-chain-update-the-response\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">update the response</dfn> for a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#redirect-chain\" id=\"ref-for-redirect-chain\">redirect chain</a> <var>redirectChain</var> given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request①\">request</a> <var>request</var> and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response②\">response</a> <var>response</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert\">Assert</a>: <var>redirectChain</var> is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-empty\" id=\"ref-for-list-empty\">empty</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①\">Assert</a>: <var>redirectChain</var>’s last element’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-request\" id=\"ref-for-exchange-record-request\">request</a> is the same as <var>request</var> and its <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-response\" id=\"ref-for-exchange-record-response\">response</a> is null.</p>"
        },
        {
          "html": "<p>Set <var>redirectChain</var>’s last element’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-response\" id=\"ref-for-exchange-record-response①\">response</a> to <var>response</var>.</p>"
        }
      ]
    },
    {
      "name": "prefetch record/matches a URL",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-matches-a-url",
      "html": "A <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record②\">prefetch record</a> <var>prefetchRecord</var> <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"prefetch record\" data-dfn-type=\"dfn\" data-export=\"\" id=\"prefetch-record-matches-a-url\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">matches a URL</dfn> given a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url①\">URL</a> <var>url</var> if the following algorithm returns true:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url\">URL</a> is equal to <var>url</var>, return true.</p>"
        },
        {
          "html": "If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-response\" id=\"ref-for-prefetch-record-response\">response</a> is not null:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>searchVariance</var> be the result of <a data-link-type=\"dfn\" href=\"https://httpwg.org/http-extensions/draft-ietf-httpbis-no-vary-search.html#name-obtain-a-url-search-varianc\" id=\"ref-for-name-obtain-a-url-search-varianc\">obtaining a URL search variance</a> given <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-redirect-chain\" id=\"ref-for-prefetch-record-redirect-chain①\">redirect chain</a>[0]'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-response\" id=\"ref-for-exchange-record-response③\">response</a>.</p>\n        <p class=\"advisement\">It is important that we check the 0th response, not the last response (i.e. not <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-response\" id=\"ref-for-prefetch-record-response①\">response</a>), because the prefetch record’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url①\">URL</a> is that of the first request/response pair, and so it is only that first response’s `<code><a data-link-type=\"http-header\" href=\"https://httpwg.org/http-extensions/draft-ietf-httpbis-no-vary-search.html#name-http-header-field-definitio\" id=\"ref-for-name-http-header-field-definitio\">No-Vary-Search</a></code>` header that should impact matching.\n</p>"
            },
            {
              "html": "<p>If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url②\">URL</a> and <var>url</var> are <a data-link-type=\"dfn\" href=\"https://httpwg.org/http-extensions/draft-ietf-httpbis-no-vary-search.html#name-comparing\" id=\"ref-for-name-comparing\">equivalent modulo search variance</a> given <var>searchVariance</var>, return true.</p>"
            }
          ]
        },
        {
          "html": "<p>Otherwise, return false.</p>"
        }
      ]
    },
    {
      "name": "prefetch record/is expected to match a URL",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-is-expected-to-match-a-url",
      "html": "A <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record③\">prefetch record</a> <var>prefetchRecord</var> <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"prefetch record\" data-dfn-type=\"dfn\" data-export=\"\" id=\"prefetch-record-is-expected-to-match-a-url\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">is expected to match a URL</dfn> given a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url②\">URL</a> <var>url</var> if the following algorithm returns true:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>prefetchRecord</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-matches-a-url\" id=\"ref-for-prefetch-record-matches-a-url\">matches a URL</a> given <var>url</var>, return true.</p>"
        },
        {
          "html": "If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-response\" id=\"ref-for-prefetch-record-response②\">response</a> is null:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>searchVariance</var> be <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-no-vary-search-hint\" id=\"ref-for-prefetch-record-no-vary-search-hint\">No-Vary-Search hint</a>.</p>"
            },
            {
              "html": "<p>If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url③\">URL</a> and <var>url</var> are <a data-link-type=\"dfn\" href=\"https://httpwg.org/http-extensions/draft-ietf-httpbis-no-vary-search.html#name-comparing\" id=\"ref-for-name-comparing①\">equivalent modulo search variance</a> given <var>searchVariance</var>, return true.</p>"
            }
          ]
        },
        {
          "html": "<p>Otherwise, return false.</p>"
        }
      ]
    },
    {
      "name": "prefetch record/cancel and discard",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-cancel-and-discard",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"prefetch record\" data-dfn-type=\"dfn\" data-export=\"\" id=\"prefetch-record-cancel-and-discard\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">cancel and discard</dfn> a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record④\">prefetch record</a> <var>prefetchRecord</var> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document①\">Document</a></code> <var>document</var>, perform the following steps.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②\">Assert</a>: <var>prefetchRecord</var> is in <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#document-prefetch-records\" id=\"ref-for-document-prefetch-records①\">prefetch records</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert③\">Assert</a>: <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state\">state</a> is not \"<code>canceled</code>\".</p>"
        },
        {
          "html": "<p>Set <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state①\">state</a> to \"<code>canceled</code>\".</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-abort\" id=\"ref-for-fetch-controller-abort\">Abort</a> <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-fetch-controller\" id=\"ref-for-prefetch-record-fetch-controller①\">fetch controller</a>. </p>"
        },
        {
          "html": "<p>If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable\" id=\"ref-for-prefetch-record-prerendering-traversable\">prerendering traversable</a> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#traversable-navigable\" id=\"ref-for-traversable-navigable\">traversable navigable</a>, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#destroy-a-top-level-traversable\" id=\"ref-for-destroy-a-top-level-traversable\">destroy</a> it.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove\">Remove</a> <var>prefetchRecord</var> from <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#document-prefetch-records\" id=\"ref-for-document-prefetch-records②\">prefetch records</a>.</p>"
        }
      ]
    },
    {
      "name": "prefetch record/complete",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-complete",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"prefetch record\" data-dfn-type=\"dfn\" data-export=\"\" id=\"prefetch-record-complete\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">complete</dfn> a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record⑤\">prefetch record</a> <var>prefetchRecord</var> given <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document②\">Document</a></code> <var>document</var>, perform the following steps.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert④\">Assert</a>: <var>document</var> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active\">fully active</a>.</p>"
        },
        {
          "html": "<p>Let <var>currentTime</var> be the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-high-resolution-time\" id=\"ref-for-dfn-current-high-resolution-time\">current high resolution time</a> for the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global\">relevant global object</a> of <var>document</var>.</p>"
        },
        {
          "html": "<p>Let <var>expiryTime</var> be <var>currentTime</var> + 300000 (i.e., five minutes).</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove①\">Remove</a> all elements of <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#document-prefetch-records\" id=\"ref-for-document-prefetch-records③\">prefetch records</a> which have the same <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url④\">URL</a> as <var>prefetchRecord</var> and whose <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state②\">state</a> equals \"<code>completed</code>\".</p>"
        },
        {
          "html": "<p>Set <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state③\">state</a> to \"<code>completed</code>\" and <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-expiry-time\" id=\"ref-for-prefetch-record-expiry-time①\">expiry time</a> to <var>expiryTime</var>.</p>"
        }
      ]
    },
    {
      "name": "find a matching complete prefetch record",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#find-a-matching-complete-prefetch-record",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"find-a-matching-complete-prefetch-record\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">find a matching complete prefetch record</dfn> given a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-traversable\" id=\"ref-for-top-level-traversable\">top-level traversable</a> <var>navigable</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params\" id=\"ref-for-source-snapshot-params\">source snapshot params</a> <var>sourceSnapshotParams</var>, and <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url③\">URL</a> <var>url</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>exactRecord</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>inexactRecord</var> be null.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate\">For each</a> <var>record</var> of <var>sourceSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#source-snapshot-params-prefetch-records\" id=\"ref-for-source-snapshot-params-prefetch-records\">prefetch records</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state④\">state</a> is not \"<code>completed</code>\", then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue\">continue</a>.</p>"
            },
            {
              "html": "If <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url⑤\">URL</a> is equal to <var>url</var>:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>exactRecord</var> to <var>record</var>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break\">Break</a>.</p>"
                }
              ]
            },
            {
              "html": "If <var>inexactRecord</var> is null and <var>record</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-matches-a-url\" id=\"ref-for-prefetch-record-matches-a-url①\">matches a URL</a> given <var>url</var>:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>inexactRecord</var> to <var>record</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>recordToUse</var> be <var>exactRecord</var> if <var>exactRecord</var> is not null, otherwise <var>inexactRecord</var>.</p>"
        },
        {
          "html": "If <var>recordToUse</var> is not null:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>currentTime</var> be the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-high-resolution-time\" id=\"ref-for-dfn-current-high-resolution-time①\">current high resolution time</a> for <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document\">active document</a>.</p>"
            },
            {
              "html": "<p>If <var>recordToUse</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-expiry-time\" id=\"ref-for-prefetch-record-expiry-time②\">expiry time</a> is less than <var>currentTime</var>, return null.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①\">For each</a> <var>exchangeRecord</var> of <var>recordToUse</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-redirect-chain\" id=\"ref-for-prefetch-record-redirect-chain②\">redirect chain</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#conflicting-credentials-exist\" id=\"ref-for-conflicting-credentials-exist\">conflicting credentials exist</a> for <var>exchangeRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-response\" id=\"ref-for-exchange-record-response④\">response</a> given <var>navigable</var> and <var>recordToUse</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-source-partition-key\" id=\"ref-for-prefetch-record-source-partition-key\">source partition key</a>, return null.</p>"
                }
              ]
            },
            {
              "html": "<p>Return <var>recordToUse</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return null.</p>"
        }
      ]
    },
    {
      "name": "wait for a matching prefetch record",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#wait-for-a-matching-prefetch-record",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"wait-for-a-matching-prefetch-record\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">wait for a matching prefetch record</dfn> given a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-traversable\" id=\"ref-for-top-level-traversable①\">top-level traversable</a> <var>navigable</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params\" id=\"ref-for-source-snapshot-params①\">source snapshot params</a> <var>sourceSnapshotParams</var>, and <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url④\">URL</a> <var>url</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑤\">Assert</a>: this is running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel\">in parallel</a>.</p>"
        },
        {
          "html": "<p>Let <var>cutoffTime</var> be null.</p>"
        },
        {
          "html": "While true:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>completeRecord</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#find-a-matching-complete-prefetch-record\" id=\"ref-for-find-a-matching-complete-prefetch-record\">finding a matching complete prefetch record</a> given <var>navigable</var>, <var>sourceSnapshotParams</var>, and <var>url</var>.</p>"
            },
            {
              "html": "<p>If <var>completeRecord</var> is not null, return <var>completeRecord</var>.</p>"
            },
            {
              "html": "<p>Let <var>potentialRecords</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②\">list</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②\">For each</a> <var>record</var> of <var>sourceSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#source-snapshot-params-prefetch-records\" id=\"ref-for-source-snapshot-params-prefetch-records①\">prefetch records</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If all of the following are true, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append\">append</a> <var>record</var> to <var>potentialRecords</var>:</p>\n          <ul>\n           <li data-md=\"\">\n            <p><var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state⑤\">state</a> is \"<code>ongoing</code>\".</p>\n           </li><li data-md=\"\">\n            <p><var>record</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-is-expected-to-match-a-url\" id=\"ref-for-prefetch-record-is-expected-to-match-a-url\">is expected to match a URL</a> given <var>url</var>.</p>\n           </li><li data-md=\"\">\n            <p><var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-expiry-time\" id=\"ref-for-prefetch-record-expiry-time③\">expiry time</a> is greater than the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-high-resolution-time\" id=\"ref-for-dfn-current-high-resolution-time②\">current high resolution time</a> for <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window\">active window</a>.</p>\n           </li><li data-md=\"\">\n            <p><var>cutoffTime</var> is null or <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-start-time\" id=\"ref-for-prefetch-record-start-time\">start time</a> is less than <var>cutoffTime</var>.</p>\n          </li></ul>"
                }
              ]
            },
            {
              "html": "<p>If <var>potentialRecords</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty①\">is empty</a>, return null.</p>"
            },
            {
              "html": "<p>Wait until the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state⑥\">state</a> of any element of <var>sourceSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#source-snapshot-params-prefetch-records\" id=\"ref-for-source-snapshot-params-prefetch-records②\">prefetch records</a> changes.</p>"
            },
            {
              "html": "<p>If <var>cutoffTime</var> is null and any element of <var>potentialRecords</var> has a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state⑦\">state</a> that is not \"<code>ongoing</code>\", set <var>cutoffTime</var> to the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-high-resolution-time\" id=\"ref-for-dfn-current-high-resolution-time③\">current high resolution time</a> for <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①\">active window</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "prefetch record/still being speculated",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-still-being-speculated",
      "html": "A <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record⑥\">prefetch record</a> <var>prefetchRecord</var> is <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"prefetch record\" data-dfn-type=\"dfn\" data-export=\"\" id=\"prefetch-record-still-being-speculated\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">still being speculated</dfn>, given a list of <a data-link-type=\"dfn\" href=\"https://whatpr.org/html/11426/speculative-loading.html#speculative-load-candidate\" id=\"ref-for-speculative-load-candidate\">speculative load candidates</a> <var>candidates</var>, if the following steps return true:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate③\">For each</a> <var>candidate</var> of <var>candidates</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>prefetchRecord</var> does not <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-matches-a-url\" id=\"ref-for-prefetch-record-matches-a-url②\">match a URL</a> given <var>candidate</var>’s <a data-link-type=\"dfn\" href=\"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-url\" id=\"ref-for-sl-candidate-url\">URL</a>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>candidate</var> is a <a data-link-type=\"dfn\" href=\"https://whatpr.org/html/11426/speculative-loading.html#prefetch-candidate\" id=\"ref-for-prefetch-candidate\">prefetch candidate</a> and <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-anonymization-policy\" id=\"ref-for-prefetch-record-anonymization-policy\">anonymization policy</a> does not equal <var>candidate</var>’s <a data-link-type=\"dfn\" href=\"https://whatpr.org/html/11426/speculative-loading.html#sl-candidate-anonymization-policy\" id=\"ref-for-sl-candidate-anonymization-policy\">anonymization policy</a>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue②\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>candidate</var> is a <a data-link-type=\"dfn\" href=\"https://whatpr.org/html/11426/speculative-loading.html#prerender-candidate\" id=\"ref-for-prerender-candidate\">prerender candidate</a> and <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable\" id=\"ref-for-prefetch-record-prerendering-traversable①\">prerendering traversable</a> is null, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue③\">continue</a>.</p>"
            },
            {
              "html": "<p>Return true.</p>"
            }
          ]
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "has a matching prefetch record",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#has-a-matching-prefetch-record",
      "html": "A <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document③\">Document</a></code> <var>document</var> <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"has-a-matching-prefetch-record\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">has a matching prefetch record</dfn> given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record⑦\">prefetch record</a> <var>recordUnderConsideration</var> and an optional boolean <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"has a matching prefetch record\" data-dfn-type=\"dfn\" data-export=\"\" id=\"has-a-matching-prefetch-record-checkprerender\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><var>checkPrerender</var></dfn> (default false) if the following algorithm returns true:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate④\">For each</a> <var>record</var> of <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#document-prefetch-records\" id=\"ref-for-document-prefetch-records④\">prefetch records</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-state\" id=\"ref-for-prefetch-record-state⑧\">state</a> is \"<code>canceled</code>\", then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue④\">continue</a>.</p>"
            },
            {
              "html": "If <var>checkPrerender</var> is true:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable\" id=\"ref-for-prefetch-record-prerendering-traversable②\">prerendering traversable</a> is null, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑤\">continue</a>.</p>"
                },
                {
                  "html": "<p>If <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-target-navigable-name-hint\" id=\"ref-for-prefetch-record-prerendering-target-navigable-name-hint\">prerendering target navigable name hint</a> is not equal to <var>recordUnderConsideration</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-target-navigable-name-hint\" id=\"ref-for-prefetch-record-prerendering-target-navigable-name-hint①\">prerendering target navigable name hint</a>, then the user agent may <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑥\">continue</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>recordNVS</var> be null.</p>"
            },
            {
              "html": "<p>If <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-response\" id=\"ref-for-prefetch-record-response③\">response</a> is not null, then set <var>recordNVS</var> to the result of <a data-link-type=\"dfn\" href=\"https://httpwg.org/http-extensions/draft-ietf-httpbis-no-vary-search.html#name-obtain-a-url-search-varianc\" id=\"ref-for-name-obtain-a-url-search-varianc①\">obtaining a URL search variance</a> given <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-response\" id=\"ref-for-prefetch-record-response④\">response</a>.</p>"
            },
            {
              "html": "<p>Otherwise, set <var>recordNVS</var> to <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-no-vary-search-hint\" id=\"ref-for-prefetch-record-no-vary-search-hint①\">No-Vary-Search hint</a>.</p>"
            },
            {
              "html": "<p>If <var>recordUnderConsideration</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-no-vary-search-hint\" id=\"ref-for-prefetch-record-no-vary-search-hint②\">No-Vary-Search hint</a> is not equal to <var>recordNVS</var>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑦\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>recordUnderConsideration</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url⑥\">URL</a> and <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url⑦\">URL</a> are <a data-link-type=\"dfn\" href=\"https://httpwg.org/http-extensions/draft-ietf-httpbis-no-vary-search.html#name-comparing\" id=\"ref-for-name-comparing②\">equivalent modulo search variance</a> given <var>recordUnderConsideration</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-no-vary-search-hint\" id=\"ref-for-prefetch-record-no-vary-search-hint③\">No-Vary-Search hint</a>, then return true.</p>"
            }
          ]
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "create navigation params from a prefetch record",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#create-navigation-params-from-a-prefetch-record",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"create-navigation-params-from-a-prefetch-record\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create navigation params from a prefetch record</dfn> given a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-traversable\" id=\"ref-for-top-level-traversable②\">top-level traversable</a> <var>navigable</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-2\" id=\"ref-for-document-state-2\">document state</a> <var>documentState</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-id\" id=\"ref-for-navigation-id\">navigation id</a> <var>navigationId</var>, a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/navigation-timing/#dom-navigationtimingtype\" id=\"ref-for-dom-navigationtimingtype\">NavigationTimingType</a></code> <var>navTimingType</var>, a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request②\">request</a> <var>request</var>, a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record⑧\">prefetch record</a> <var>record</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#target-snapshot-params\" id=\"ref-for-target-snapshot-params\">target snapshot params</a> <var>targetSnapshotParams</var>, and a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params\" id=\"ref-for-source-snapshot-params②\">source snapshot params</a> <var>sourceSnapshotParams</var>, perform the following steps.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>responseOrigin</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>responseCOOP</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>coopEnforcementResult</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-a-cross-origin-opener-policy-enforcement-result-for-navigation\" id=\"ref-for-create-a-cross-origin-opener-policy-enforcement-result-for-navigation\">creating a cross-origin opener policy enforcement result for navigation</a> given <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①\">active document</a> and <var>documentState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-initiator-origin\" id=\"ref-for-document-state-initiator-origin\">initiator origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>finalSandboxFlags</var> be an empty <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set\" id=\"ref-for-sandboxing-flag-set\">sandboxing flag set</a>.</p>"
        },
        {
          "html": "<p>Let <var>responsePolicyContainer</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>urlList</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list③\">list</a>.</p>"
        },
        {
          "html": "<p>Let <var>response</var> be <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-response\" id=\"ref-for-prefetch-record-response⑤\">response</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑤\">For each</a> <var>exchangeRecord</var> in <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-redirect-chain\" id=\"ref-for-prefetch-record-redirect-chain③\">redirect chain</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>redirectChainRequest</var> be <var>exchangeRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-request\" id=\"ref-for-exchange-record-request①\">request</a>.</p>"
            },
            {
              "html": "<p>Let <var>redirectChainResponse</var> be <var>exchangeRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-response\" id=\"ref-for-exchange-record-response⑤\">response</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append①\">Append</a> <var>redirectChainRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url\">URL</a> to <var>urlList</var>.</p>"
            },
            {
              "html": "<p>Set <var>responsePolicyContainer</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response\" id=\"ref-for-creating-a-policy-container-from-a-fetch-response\">creating a policy container from a fetch response</a> given <var>redirectChainResponse</var> and <var>redirectChainRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client\">reserved client</a>.</p>"
            },
            {
              "html": "<p>Set <var>finalSandboxFlags</var> to the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-union\" id=\"ref-for-set-union\">union</a> of <var>targetSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#target-snapshot-params-sandbox\" id=\"ref-for-target-snapshot-params-sandbox\">sandboxing flags</a> and <var>responsePolicyContainer</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#policy-container-csp-list\" id=\"ref-for-policy-container-csp-list\">CSP list</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#csp-derived-sandboxing-flags\" id=\"ref-for-csp-derived-sandboxing-flags\">CSP-derived sandboxing flags</a>.</p>"
            },
            {
              "html": "<p>Set <var>responseOrigin</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#determining-the-origin\" id=\"ref-for-determining-the-origin\">determining the origin</a> given <var>redirectChainResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-url\" id=\"ref-for-concept-response-url②\">URL</a>, <var>finalSandboxFlags</var>, <var>documentState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-initiator-origin\" id=\"ref-for-document-state-initiator-origin①\">initiator origin</a>, and null.</p>"
            },
            {
              "html": "<p>Set <var>responseCOOP</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-coop\" id=\"ref-for-obtain-coop\">obtaining a cross-origin opener policy</a> given <var>redirectChainResponse</var> and <var>redirectChainRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①\">reserved client</a>.</p>"
            },
            {
              "html": "<p>Set <var>coopEnforcementResult</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#coop-enforce\" id=\"ref-for-coop-enforce\">enforcing a response’s cross-origin opener policy</a> given <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-bc\" id=\"ref-for-nav-bc\">active browsing context</a>, <var>redirectChainResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-url\" id=\"ref-for-concept-response-url③\">URL</a>, <var>responseOrigin</var>, <var>responseCOOP</var>, <var>coopEnforcementResult</var>, and <var>redirectChainRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer\" id=\"ref-for-concept-request-referrer\">referrer</a>.</p>"
            },
            {
              "html": "<p>If <var>finalSandboxFlags</var> is not empty and <var>responseCOOP</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#coop-struct-value\" id=\"ref-for-coop-struct-value\">value</a> is \"<code>unsafe-none</code>\", then set <var>response</var> to an appropriate <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error①\">network error</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break①\">break</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>request</var>’s  <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①\">URL</a> is not equal to <var>urlList</var>[0], then insert <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url②\">URL</a> into <var>urlList</var> after the 0th <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item\">item</a>.</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url-list\" id=\"ref-for-concept-request-url-list\">URL list</a> to <var>urlList</var>.</p>"
        },
        {
          "html": "<p><span id=\"prefetch-activation-client-creation\"></span>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client②\">reserved client</a> to the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-a-reserved-client\" id=\"ref-for-create-a-reserved-client①\">creating a reserved client</a> given <var>navigable</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑤\">URL</a>.</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client④\">reserved client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker\">active service worker</a> to <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-redirect-chain\" id=\"ref-for-prefetch-record-redirect-chain⑤\">redirect chain</a>’s last item’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-request\" id=\"ref-for-exchange-record-request③\">request</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client⑤\">reserved client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker①\">active service worker</a>.</p>"
        },
        {
          "html": "<p>Let <var>resultPolicyContainer</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#determining-navigation-params-policy-container\" id=\"ref-for-determining-navigation-params-policy-container\">determining navigation params policy container</a> given <var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-response\" id=\"ref-for-prefetch-record-response⑥\">response</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-url\" id=\"ref-for-concept-response-url④\">URL</a>, <var>documentState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-history-policy-container\" id=\"ref-for-document-state-history-policy-container\">history policy container</a>, <var>sourceSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params-policy-container\" id=\"ref-for-source-snapshot-params-policy-container\">source policy container</a>, null, and <var>responsePolicyContainer</var>.</p>"
        },
        {
          "html": "If <var>response</var> is not a network error, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>Optionally, set <var>response</var> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-clone\" id=\"ref-for-concept-response-clone\">clone</a> of <var>response</var>.</p>"
            },
            {
              "html": "<p>If the user agent did not perform the previous optional step, then it must <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove②\">remove</a> <var>record</var> from <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document②\">active document</a>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#document-prefetch-records\" id=\"ref-for-document-prefetch-records⑤\">prefetch records</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params\" id=\"ref-for-navigation-params①\">navigation params</a>, with:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-id\" id=\"ref-for-navigation-params-id\">id</a>\n       </dt><dd data-md=\"\">\n        <p><var>navigationId</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-request\" id=\"ref-for-navigation-params-request\">request</a>\n       </dt><dd data-md=\"\">\n        <p><var>request</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-response\" id=\"ref-for-navigation-params-response\">response</a>\n       </dt><dd data-md=\"\">\n        <p><var>response</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-origin\" id=\"ref-for-navigation-params-origin\">origin</a>\n       </dt><dd data-md=\"\">\n        <p><var>responseOrigin</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-policy-container\" id=\"ref-for-navigation-params-policy-container\">policy container</a>\n       </dt><dd data-md=\"\">\n        <p><var>resultPolicyContainer</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-sandboxing\" id=\"ref-for-navigation-params-sandboxing\">final sandboxing flag set</a>\n       </dt><dd data-md=\"\">\n        <p><var>finalSandboxFlags</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-coop\" id=\"ref-for-navigation-params-coop\">cross-origin opener policy</a>\n       </dt><dd data-md=\"\">\n        <p><var>responseCOOP</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-coop-enforcement-result\" id=\"ref-for-navigation-params-coop-enforcement-result\">COOP enforcement result</a>\n       </dt><dd data-md=\"\">\n        <p><var>coopEnforcementResult</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-reserved-environment\" id=\"ref-for-navigation-params-reserved-environment\">reserved environment</a>\n       </dt><dd data-md=\"\">\n        <p><var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client⑥\">reserved client</a></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-navigable\" id=\"ref-for-navigation-params-navigable\">navigable</a>\n       </dt><dd data-md=\"\">\n        <p><var>navigable</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-nav-timing-type\" id=\"ref-for-navigation-params-nav-timing-type\">navigation timing type</a>\n       </dt><dd data-md=\"\">\n        <p><var>navTimingType</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-fetch-controller\" id=\"ref-for-navigation-params-fetch-controller\">fetch controller</a>\n       </dt><dd data-md=\"\">\n        <p><var>record</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-fetch-controller\" id=\"ref-for-prefetch-record-fetch-controller②\">fetch controller</a></p>\n        \n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-commit-early-hints\" id=\"ref-for-navigation-params-commit-early-hints\">commit early hints</a>\n       </dt><dd data-md=\"\">\n        <p>null</p>\n        \n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#navigation-params-delivery-type\" id=\"ref-for-navigation-params-delivery-type\">delivery type</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>navigational-prefetch</code>\"</p>\n      </dd></dl>"
        }
      ]
    },
    {
      "name": "prefetch IP anonymization policy/requires anonymity",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#prefetch-ip-anonymization-policy-requires-anonymity",
      "html": "A <a data-link-type=\"dfn\" href=\"https://whatpr.org/html/11426/speculative-loading.html#prefetch-ip-anonymization-policy\" id=\"ref-for-prefetch-ip-anonymization-policy①\">prefetch IP anonymization policy</a> <var>policy</var> <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"prefetch IP anonymization policy\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"prefetch-ip-anonymization-policy-requires-anonymity\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">requires anonymity</dfn> for <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request③\">request</a> <var>request</var> if the following steps return true:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>policy</var> is a <a data-link-type=\"dfn\" href=\"https://whatpr.org/html/11426/speculative-loading.html#cross-origin-prefetch-ip-anonymization-policy\" id=\"ref-for-cross-origin-prefetch-ip-anonymization-policy\">cross-origin prefetch IP anonymization policy</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑦\">URL</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin\">origin</a> is the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin\">same</a> as <var>policy</var>’s <a data-link-type=\"dfn\" href=\"https://whatpr.org/html/11426/speculative-loading.html#copiap-origin\" id=\"ref-for-copiap-origin\">origin</a>, then return false.</p>"
            },
            {
              "html": "<p>Return true.</p>"
            }
          ]
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑥\">Assert</a>: <var>policy</var> is null.</p>"
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "create a reserved client",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#create-a-reserved-client",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"create-a-reserved-client\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create a reserved client</dfn> given a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable①\">navigable</a> <var>navigable</var>, a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url⑤\">URL</a> <var>url</var> and an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque\" id=\"ref-for-concept-origin-opaque①\">opaque origin</a> or null <var>isolationOrigin</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>topLevelCreationURL</var> be <var>url</var>.</p>"
        },
        {
          "html": "<p>Let <var>topLevelOrigin</var> be null.</p>"
        },
        {
          "html": "If <var>isolationOrigin</var> is not null, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>topLevelCreationURL</var> to <code>about:blank</code>.</p>"
            },
            {
              "html": "<p>Set <var>topLevelOrigin</var> to <var>isolationOrigin</var>.</p>"
            }
          ]
        },
        {
          "html": "Otherwise, if <var>navigable</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-traversable\" id=\"ref-for-top-level-traversable③\">top-level traversable</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>parentEnvironment</var> be <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-parent\" id=\"ref-for-nav-parent\">parent</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document③\">active document</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object\">relevant settings object</a>.</p>"
            },
            {
              "html": "<p>Set <var>topLevelCreationURL</var> to <var>parentEnvironment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-creation-url\" id=\"ref-for-concept-environment-top-level-creation-url\">top-level creation URL</a>.</p>"
            },
            {
              "html": "<p>Set <var>topLevelOrigin</var> to <var>parentEnvironment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin\">top-level origin</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment\" id=\"ref-for-environment③\">environment</a> whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id\" id=\"ref-for-concept-environment-id①\">id</a> is a unique opaque string, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context\">target browsing context</a> is <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-bc\" id=\"ref-for-nav-bc①\">active browsing context</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url\">creation URL</a> is <var>url</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-creation-url\" id=\"ref-for-concept-environment-top-level-creation-url①\">top-level creation URL</a> is <var>topLevelCreationURL</var>, and <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin①\">top-level origin</a> is <var>topLevelOrigin</var>.</p>"
        }
      ]
    },
    {
      "name": "create a cross-origin opener policy enforcement result for navigation",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#create-a-cross-origin-opener-policy-enforcement-result-for-navigation",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"create-a-cross-origin-opener-policy-enforcement-result-for-navigation\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create a cross-origin opener policy enforcement result for navigation</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document⑨\">Document</a></code> <var>activeDocument</var> and an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin\">origin</a> <var>initiatorOrigin</var>, return a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#coop-enforcement-result\" id=\"ref-for-coop-enforcement-result\">cross-origin opener policy enforcement result</a> with",
      "rationale": "To <dfn>"
    },
    {
      "name": "create a navigation request",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#create-a-navigation-request",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"create-a-navigation-request\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create a navigation request</dfn> given a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-entry\" id=\"ref-for-session-history-entry\">session history entry</a> <var>entry</var>, an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②\">environment settings object</a> <var>fetchClient</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable-container\" id=\"ref-for-navigable-container\">navigable container</a> or null <var>container</var>, and a boolean <var>hasTransientActivation</var>, perform the following steps.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>documentResource</var> be <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-resource\" id=\"ref-for-document-state-resource\">resource</a>.</p>"
        },
        {
          "html": "<p>Let <var>request</var> be a new <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request④\">request</a>, with</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑧\">url</a>\n       </dt><dd data-md=\"\">\n        <p><var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-url\" id=\"ref-for-she-url\">URL</a></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-policy-container\" id=\"ref-for-concept-request-policy-container\">policy container</a>\n       </dt><dd data-md=\"\">\n        <p><var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state①\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-history-policy-container\" id=\"ref-for-document-state-history-policy-container①\">history policy container</a></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client\">client</a>\n       </dt><dd data-md=\"\">\n        <p><var>fetchClient</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination\">destination</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>document</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-credentials-mode\" id=\"ref-for-concept-request-credentials-mode\">credentials mode</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>include</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-use-url-credentials-flag\" id=\"ref-for-concept-request-use-url-credentials-flag\">use-URL-credentials flag</a>\n       </dt><dd data-md=\"\">\n        <p>set</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-redirect-mode\" id=\"ref-for-concept-request-redirect-mode\">redirect mode</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>manual</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-mode\" id=\"ref-for-concept-request-mode\">mode</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>navigate</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer\" id=\"ref-for-concept-request-referrer①\">referrer</a>\n       </dt><dd data-md=\"\">\n        <p><var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state②\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-request-referrer\" id=\"ref-for-document-state-request-referrer\">request referrer</a></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer-policy\" id=\"ref-for-concept-request-referrer-policy\">referrer policy</a>\n       </dt><dd data-md=\"\">\n        <p><var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state③\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-request-referrer-policy\" id=\"ref-for-document-state-request-referrer-policy\">request referrer policy</a></p>\n      </dd></dl>"
        },
        {
          "html": "If <var>documentResource</var> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#post-resource\" id=\"ref-for-post-resource\">POST resource</a>, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method\">method</a> to <code>`POST`</code>.</p>"
            },
            {
              "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-body\" id=\"ref-for-concept-request-body\">body</a> to <var>documentResource</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#post-resource-request-body\" id=\"ref-for-post-resource-request-body\">request body</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-set\" id=\"ref-for-concept-header-list-set\">Set</a> <code>`Content-Type`</code> to <var>documentResource</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#post-resource-request-content-type\" id=\"ref-for-post-resource-request-content-type\">request content-type</a> in <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list\">header list</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state④\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-reload-pending\" id=\"ref-for-document-state-reload-pending\">reload pending</a> is true, then set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reload-navigation-flag\" id=\"ref-for-concept-request-reload-navigation-flag\">reload-navigation flag</a>.</p>"
        },
        {
          "html": "<p>Otherwise, if <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state⑤\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-ever-populated\" id=\"ref-for-document-state-ever-populated\">ever populated</a> is true, then set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-history-navigation-flag\" id=\"ref-for-concept-request-history-navigation-flag\">history-navigation flag</a>.</p>"
        },
        {
          "html": "<p>If <var>hasTransientActivation</var> is true, then set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-user-activation\" id=\"ref-for-request-user-activation\">user-activation</a> to true.</p>"
        },
        {
          "html": "If <var>container</var> is non-null:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>container</var> has a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#browsing-context-scope-origin\" id=\"ref-for-browsing-context-scope-origin\">browsing context scope origin</a>, then set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin\">origin</a> to that <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#browsing-context-scope-origin\" id=\"ref-for-browsing-context-scope-origin①\">browsing context scope origin</a>.</p>"
            },
            {
              "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination①\">destination</a> and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-initiator-type\" id=\"ref-for-request-initiator-type\">initiator type</a> to <var>container</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-element-local-name\" id=\"ref-for-concept-element-local-name\">local name</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>request</var>.</p>"
        }
      ]
    },
    {
      "name": "attempt to populate the history entry's document",
      "html": "In <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#attempt-to-populate-the-history-entry's-document\" id=\"ref-for-attempt-to-populate-the-history-entry's-document\">attempt to populate the history entry’s document</a>, replace the step which invokes <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching\" id=\"ref-for-create-navigation-params-by-fetching③\">create navigation params by fetching</a> with the following:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>request</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-a-navigation-request\" id=\"ref-for-create-a-navigation-request\">creating a navigation request</a> given <var>entry</var>, <var>sourceSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params-client\" id=\"ref-for-source-snapshot-params-client\">fetch client</a>, <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-container\" id=\"ref-for-nav-container\">container</a>, and <var>sourceSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params-activation\" id=\"ref-for-source-snapshot-params-activation\">has transient activation</a>.</p>"
            },
            {
              "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-replaces-client-id\" id=\"ref-for-concept-request-replaces-client-id\">replaces client id</a> to <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document④\">active document</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id\" id=\"ref-for-concept-environment-id②\">id</a>.</p>"
            },
            {
              "html": "<p>Let <var>prefetched</var> be false.</p>"
            },
            {
              "html": "If <var>documentResource</var> is null and <var>navigable</var> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-traversable\" id=\"ref-for-top-level-traversable④\">top-level traversable</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>prefetchRecord</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#wait-for-a-matching-prefetch-record\" id=\"ref-for-wait-for-a-matching-prefetch-record①\">waiting for a matching prefetch record</a> given <var>navigable</var>, <var>sourceSnapshotParams</var>, and <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-url\" id=\"ref-for-she-url②\">URL</a>.</p>"
                },
                {
                  "html": "If <var>prefetchRecord</var> is not null:",
                  "rationale": "set",
                  "steps": [
                    {
                      "html": "<p>Set <var>navigationParams</var> to the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-navigation-params-from-a-prefetch-record\" id=\"ref-for-create-navigation-params-from-a-prefetch-record①\">creating navigation params from a prefetch record</a> given <var>navigable</var>, <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state⑥\">document state</a>, <var>navigationId</var>, <var>navTimingType</var>, <var>request</var>, <var>prefetchRecord</var>, <var>targetSnapshotParams</var>, and <var>sourceSnapshotParams</var>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#copy-prefetch-cookies\" id=\"ref-for-copy-prefetch-cookies\">Copy prefetch cookies</a> given <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-isolated-partition-key\" id=\"ref-for-prefetch-record-isolated-partition-key\">isolated partition key</a> and <var>navigationParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-reserved-environment\" id=\"ref-for-navigation-params-reserved-environment①\">reserved environment</a>.</p>"
                    },
                    {
                      "html": "<p>Set <var>prefetched</var> to true.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>If <var>prefetched</var> is false, then set <var>navigationParams</var> to the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-navigation-params-by-fetching\" id=\"ref-for-create-navigation-params-by-fetching④\">creating navigation params by fetching</a> given <var>request</var>, <var>entry</var>, <var>navigable</var>, <var>sourceSnapshotParams</var>, <var>targetSnapshotParams</var>, <var>cspNavigationType</var>, <var>navigationId</var>, and <var>navTimingType</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "create navigation params by fetching",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#create-navigation-params-by-fetching",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"create-navigation-params-by-fetching\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create navigation params by fetching</dfn> given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request⑤\">request</a> <var>request</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-entry\" id=\"ref-for-session-history-entry①\">session history entry</a> <var>entry</var>, a navigable <var>navigable</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params\" id=\"ref-for-source-snapshot-params④\">source snapshot params</a> <var>sourceSnapshotParams</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#target-snapshot-params\" id=\"ref-for-target-snapshot-params①\">target snapshot params</a> <var>targetSnapshotParams</var>, a string <var>cspNavigationType</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-id\" id=\"ref-for-navigation-id①\">navigation ID</a> or null <var>navigationId</var>, a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/navigation-timing/#dom-navigationtimingtype\" id=\"ref-for-dom-navigationtimingtype①\">NavigationTimingType</a></code> <var>navTimingType</var>, and an optional <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record①①\">prefetch record</a> <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"create-navigation-params-by-fetching-prefetchRecord\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><var>prefetchRecord</var></dfn>, perform the following steps.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑦\">Assert</a>: this is running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①\">in parallel</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑧\">Assert</a>: <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑨\">URL</a> is <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-url\" id=\"ref-for-she-url③\">URL</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑨\">Assert</a>: <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-mode\" id=\"ref-for-concept-request-mode①\">mode</a> is \"<code>navigate</code>\".</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⓪\">Assert</a>: <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-redirect-mode\" id=\"ref-for-concept-request-redirect-mode①\">redirect mode</a> is \"<code>manual</code>\".</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①①\">Assert</a>: <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client⑦\">reserved client</a> is null.</p>"
        },
        {
          "html": "<p>Let <var>response</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>responseOrigin</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>fetchController</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>coopEnforcementResult</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-a-cross-origin-opener-policy-enforcement-result-for-navigation\" id=\"ref-for-create-a-cross-origin-opener-policy-enforcement-result-for-navigation①\">creating a cross-origin opener policy enforcement result for navigation</a> given <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document⑤\">active document</a> and <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state⑦\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-initiator-origin\" id=\"ref-for-document-state-initiator-origin②\">initiator origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>finalSandboxFlags</var> be an empty <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set\" id=\"ref-for-sandboxing-flag-set①\">sandboxing flag set</a>.</p>"
        },
        {
          "html": "<p>Let <var>responsePolicyContainer</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>responseCOOP</var> be a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#cross-origin-opener-policy\" id=\"ref-for-cross-origin-opener-policy\">cross-origin opener policy</a>.</p>"
        },
        {
          "html": "<p>Let <var>locationURL</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>currentURL</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-current-url\" id=\"ref-for-concept-request-current-url\">current URL</a>.</p>"
        },
        {
          "html": "<p>Let <var>commitEarlyHints</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>isolationOrigin</var> be null.</p>"
        },
        {
          "html": "If <var>prefetchRecord</var> was given:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>isolationSite</var> be <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-isolated-partition-key\" id=\"ref-for-prefetch-record-isolated-partition-key①\">isolated partition key</a>[0].</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①②\">Assert</a>: <var>isolationSite</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque\" id=\"ref-for-concept-origin-opaque②\">opaque origin</a>.</p>"
            },
            {
              "html": "<p>Set <var>isolationOrigin</var> to <var>isolationSite</var>.</p>"
            }
          ]
        },
        {
          "html": "While true:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client⑧\">reserved client</a> is not null and <var>currentURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①\">origin</a> is not the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin②\">same</a> as <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client⑨\">reserved client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url①\">creation URL</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②\">origin</a>, then:",
              "rationale": "run",
              "steps": [
                {
                  "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-discarding-steps\" id=\"ref-for-environment-discarding-steps\">environment discarding steps</a> for <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①⓪\">reserved client</a>.</p>"
                },
                {
                  "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①①\">reserved client</a> to null.</p>"
                },
                {
                  "html": "<p>Set <var>commitEarlyHints</var> to null.</p>"
                }
              ]
            },
            {
              "html": "If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①②\">reserved client</a> is null, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①③\">reserved client</a> to the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-a-reserved-client\" id=\"ref-for-create-a-reserved-client②\">creating a reserved client</a> given <var>navigable</var>, <var>currentURL</var> and <var>isolationOrigin</var>.</p>"
                },
                {
                  "html": "<p>If <var>prefetchRecord</var> was given, then set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①④\">reserved client</a>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#environment-is-navigational-prefetch-client\" id=\"ref-for-environment-is-navigational-prefetch-client\">is navigational prefetch client</a> to true.</p>"
                }
              ]
            },
            {
              "html": "<p>If the result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-csp/#should-block-navigation-request\" id=\"ref-for-should-block-navigation-request\">should navigation request of type be blocked by Content Security Policy?</a> given <var>request</var> and <var>cspNavigationType</var> is \"<code>Blocked</code>\", then set <var>response</var> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error②\">network error</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break②\">break</a>. <a data-link-type=\"biblio\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#biblio-csp\" title=\"Content Security Policy Level 3\">[CSP]</a></p>"
            },
            {
              "html": "If <var>prefetchRecord</var> was given, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>purpose</var> be a <a data-link-type=\"dfn\" href=\"https://www.rfc-editor.org/rfc/rfc9651.html#name-lists\" id=\"ref-for-name-lists\">List</a> containing the <a data-link-type=\"dfn\" href=\"https://www.rfc-editor.org/rfc/rfc9651.html#name-tokens\" id=\"ref-for-name-tokens\">Token</a> <code>prefetch</code>.</p>"
                },
                {
                  "html": "If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-anonymization-policy\" id=\"ref-for-prefetch-record-anonymization-policy①\">anonymization policy</a> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-ip-anonymization-policy-requires-anonymity\" id=\"ref-for-prefetch-ip-anonymization-policy-requires-anonymity\">requires anonymity</a> for <var>request</var>, then:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add a parameter whose key is \"<a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#sec-purpose-prefetch-anonymous-client-ip\" id=\"ref-for-sec-purpose-prefetch-anonymous-client-ip\"><code>anonymous-client-ip</code></a>\" and whose value is true to the <code>prefetch</code> token in <var>purpose</var>.</p>"
                    },
                    {
                      "html": "<p>The user agent must use a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-connection\" id=\"ref-for-concept-connection\">connection</a> which anonymizes the client IP address (e.g., using a proxy) when fetching <var>request</var>, or set <var>response</var> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error③\">network error</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break③\">break</a>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable\" id=\"ref-for-prefetch-record-prerendering-traversable③\">prerendering traversable</a> is not null, then add a parameter whose key is \"<a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#sec-purpose-prefetch-prerender\" id=\"ref-for-sec-purpose-prefetch-prerender\"><code>prerender</code></a>\" and whose value is true to the <code>prefetch</code> token in <var>purpose</var>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header\" id=\"ref-for-concept-header-list-set-structured-header\">Set a structured field value</a> given (`<code><a data-link-type=\"http-header\" href=\"https://fetch.spec.whatwg.org/#http-sec-purpose\" id=\"ref-for-http-sec-purpose\">Sec-Purpose</a></code>`, <var>purpose</var>) in <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list①\">header list</a>.</p>"
                },
                {
                  "html": "If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-current-url\" id=\"ref-for-concept-request-current-url①\">current URL</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin③\">origin</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-site\" id=\"ref-for-same-site\">same site</a> with <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url⑧\">URL</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin④\">origin</a>, then:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>tags</var> be a <a data-link-type=\"dfn\" href=\"https://www.rfc-editor.org/rfc/rfc9651.html#name-lists\" id=\"ref-for-name-lists①\">List</a> composed by mapping each <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item①\">item</a> in <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-tags\" id=\"ref-for-prefetch-record-tags\">tags</a>, sending <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string②\">strings</a> to <a data-link-type=\"dfn\" href=\"https://www.rfc-editor.org/rfc/rfc9651.html#name-strings\" id=\"ref-for-name-strings\">Strings</a> and null to the <a data-link-type=\"dfn\" href=\"https://www.rfc-editor.org/rfc/rfc9651.html#name-tokens\" id=\"ref-for-name-tokens①\">Token</a> <code>null</code>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header\" id=\"ref-for-concept-header-list-set-structured-header①\">Set a structured field value</a> given (`<code><a data-link-type=\"http-header\" href=\"https://whatpr.org/html/11426/speculative-loading.html#sec-speculation-tags\" id=\"ref-for-sec-speculation-tags\">Sec-Speculation-Tags</a></code>`, <var>tags</var>) in <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list②\">header list</a>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-current-url\" id=\"ref-for-concept-request-current-url②\">current URL</a> is not <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-url\" id=\"ref-for-potentially-trustworthy-url\">potentially trustworthy</a>, then set <var>response</var> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error④\">network error</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break④\">break</a>.</p>"
                },
                {
                  "html": "<p>Let <var>proposedPartitionKey</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#determine-the-network-partition-key\" id=\"ref-for-determine-the-network-partition-key①\">determining the network partition key</a> given <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①⑤\">reserved client</a>.</p>"
                },
                {
                  "html": "<p>If <var>proposedPartitionKey</var> is not equal to <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-source-partition-key\" id=\"ref-for-prefetch-record-source-partition-key①\">source partition key</a> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer-policy\" id=\"ref-for-concept-request-referrer-policy①\">referrer policy</a> is not in the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#list-of-sufficiently-strict-speculative-navigation-referrer-policies\" id=\"ref-for-list-of-sufficiently-strict-speculative-navigation-referrer-policies\">list of sufficiently strict speculative navigation referrer policies</a>, then set <var>response</var> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑤\">network error</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break⑤\">break</a>.</p>"
                },
                {
                  "html": "<p>If <var>request</var> cannot be fetched given <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-anonymization-policy\" id=\"ref-for-prefetch-record-anonymization-policy②\">anonymization policy</a> for an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined②\">implementation-defined</a> reason, then set <var>response</var> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑥\">network error</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break⑥\">break</a>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append②\">Append</a> a new <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record\" id=\"ref-for-exchange-record①\">exchange record</a> whose <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-request\" id=\"ref-for-exchange-record-request④\">request</a> is <var>request</var> and <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-response\" id=\"ref-for-exchange-record-response⑥\">response</a> is null to <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-redirect-chain\" id=\"ref-for-prefetch-record-redirect-chain⑥\">redirect chain</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Set <var>response</var> to null.</p>"
            },
            {
              "html": "Let <var>processEarlyHintsResponse</var> be the following algorithm given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response④\">response</a> <var>earlyResponse</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>prefetchRecord</var> was given and <var>commitEarlyHints</var> is null, then set <var>commitEarlyHints</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/semantics.html#process-early-hint-headers\" id=\"ref-for-process-early-hint-headers\">processing early hint headers</a> given <var>earlyResponse</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①⑥\">reserved client</a>. </p>"
                }
              ],
              "additional": [
                {
                  "html": "Let <var>processResponse</var> be the following algorithm given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response⑤\">response</a> <var>fetchedResponse</var>:",
                  "rationale": "set",
                  "steps": [
                    {
                      "html": "<p>Set <var>response</var> to <var>fetchedResponse</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-process-the-next-manual-redirect\" id=\"ref-for-fetch-controller-process-the-next-manual-redirect\">process the next manual redirect</a> for <var>fetchController</var>.</p>"
            },
            {
              "html": "<p>Wait until either <var>response</var> is non-null, or <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#ongoing-navigation\" id=\"ref-for-ongoing-navigation\">ongoing navigation</a> changes to no longer equal <var>navigationId</var>.</p>\n        <p>If the latter condition occurs, then <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-abort\" id=\"ref-for-fetch-controller-abort①\">abort</a> <var>fetchController</var>, and return. Otherwise, proceed onward. </p>"
            },
            {
              "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-body\" id=\"ref-for-concept-request-body①\">body</a> is null, then set <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state⑧\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-resource\" id=\"ref-for-document-state-resource①\">resource</a> to null.</p>"
            },
            {
              "html": "<p>Set <var>responsePolicyContainer</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response\" id=\"ref-for-creating-a-policy-container-from-a-fetch-response①\">creating a policy container from a fetch response</a> given <var>response</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①⑦\">reserved client</a>.</p>"
            },
            {
              "html": "<p>Set <var>finalSandboxFlags</var> to the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-union\" id=\"ref-for-set-union①\">union</a> of <var>targetSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#target-snapshot-params-sandbox\" id=\"ref-for-target-snapshot-params-sandbox①\">sandboxing flags</a> and <var>responsePolicyContainer</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#policy-container-csp-list\" id=\"ref-for-policy-container-csp-list①\">CSP list</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#csp-derived-sandboxing-flags\" id=\"ref-for-csp-derived-sandboxing-flags①\">CSP-derived sandboxing flags</a>.</p>"
            },
            {
              "html": "<p>Set <var>responseOrigin</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#determining-the-origin\" id=\"ref-for-determining-the-origin①\">determining the origin</a> given <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-url\" id=\"ref-for-concept-response-url⑤\">URL</a>, <var>finalSandboxFlags</var>, <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state⑨\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-initiator-origin\" id=\"ref-for-document-state-initiator-origin③\">initiator origin</a>, and null.</p>"
            },
            {
              "html": "If <var>navigable</var> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-traversable\" id=\"ref-for-top-level-traversable⑥\">top-level traversable</a>, and <var>prefetchRecord</var> was not given:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>responseCOOP</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-coop\" id=\"ref-for-obtain-coop①\">obtaining a cross-origin opener policy</a> given <var>response</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①⑧\">reserved client</a>.</p>"
                },
                {
                  "html": "<p>Set <var>coopEnforcementResult</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#coop-enforce\" id=\"ref-for-coop-enforce①\">enforcing a response’s cross-origin opener policy</a> given <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-bc\" id=\"ref-for-nav-bc②\">active browsing context</a>, <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①⓪\">URL</a>, <var>responseOrigin</var>, <var>responseCOOP</var>, <var>coopEnforcementResult</var>, and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer\" id=\"ref-for-concept-request-referrer②\">referrer</a>.</p>"
                },
                {
                  "html": "<p>If <var>finalSandboxFlags</var> is not empty and <var>responseCOOP</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#coop-struct-value\" id=\"ref-for-coop-struct-value①\">value</a> is not \"<code>unsafe-none</code>\", then set <var>response</var> to an appropriate <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑦\">network error</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break⑦\">break</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>If <var>response</var> is not a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑧\">network error</a>, <var>navigable</var> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#child-navigable\" id=\"ref-for-child-navigable\">child navigable</a>, and the result of performing a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#cross-origin-resource-policy-check\" id=\"ref-for-cross-origin-resource-policy-check\">cross-origin resource policy check</a> with <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-container-document\" id=\"ref-for-nav-container-document\">container document</a>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-document-origin\" id=\"ref-for-concept-document-origin②\">origin</a>, <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-container-document\" id=\"ref-for-nav-container-document①\">container document</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②\">relevant settings object</a>, <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination②\">destination</a>, <var>response</var>, and true is <strong>blocked</strong>, then set <var>response</var> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑨\">network error</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break⑧\">break</a>.</p>"
            },
            {
              "html": "If <var>prefetchRecord</var> was given, then:",
              "rationale": "update",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#redirect-chain-update-the-response\" id=\"ref-for-redirect-chain-update-the-response\">Update the response</a> for its <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-redirect-chain\" id=\"ref-for-prefetch-record-redirect-chain⑦\">redirect chain</a> given <var>request</var> and <var>response</var>.</p>"
                },
                {
                  "html": "<p>If <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#conflicting-credentials-exist\" id=\"ref-for-conflicting-credentials-exist①\">conflicting credentials exist</a> for <var>response</var> given <var>navigable</var> and <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-source-partition-key\" id=\"ref-for-prefetch-record-source-partition-key②\">source partition key</a>, then set <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-had-conflicting-credentials\" id=\"ref-for-prefetch-record-had-conflicting-credentials\">had conflicting credentials</a> to true.</p>"
                }
              ]
            },
            {
              "html": "<p>Set <var>locationURL</var> to <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-location-url\" id=\"ref-for-concept-response-location-url\">location URL</a> given <var>currentURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-fragment\" id=\"ref-for-concept-url-fragment\">fragment</a>.</p>"
            },
            {
              "html": "<p>If <var>locationURL</var> is failure or null, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break⑨\">break</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①③\">Assert</a>: <var>locationURL</var> is a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url⑥\">URL</a>.</p>"
            },
            {
              "html": "<p>Set <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-serialized-state\" id=\"ref-for-she-serialized-state\">serialized state</a> to <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structuredserializeforstorage\" id=\"ref-for-structuredserializeforstorage\">StructuredSerializeForStorage</a>(null).</p>"
            },
            {
              "html": "<p>Let <var>oldDocState</var> be <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state①⓪\">document state</a>.</p>"
            },
            {
              "html": "<p>Set <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state①①\">document state</a> to a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-2\" id=\"ref-for-document-state-2①\">document state</a>, with:</p>\n        <dl>\n         <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-history-policy-container\" id=\"ref-for-document-state-history-policy-container②\">history policy container</a>\n         </dt><dd data-md=\"\">\n          <p>a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#clone-a-policy-container\" id=\"ref-for-clone-a-policy-container\">clone</a> of <var>oldDocState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-history-policy-container\" id=\"ref-for-document-state-history-policy-container③\">history policy container</a></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-request-referrer\" id=\"ref-for-document-state-request-referrer①\">request referrer</a>\n         </dt><dd data-md=\"\">\n          <p><var>oldDocState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-request-referrer\" id=\"ref-for-document-state-request-referrer②\">request referrer</a></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-request-referrer-policy\" id=\"ref-for-document-state-request-referrer-policy①\">request referrer policy</a>\n         </dt><dd data-md=\"\">\n          <p><var>oldDocState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-request-referrer-policy\" id=\"ref-for-document-state-request-referrer-policy②\">request referrer policy</a></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-origin\" id=\"ref-for-document-state-origin\">origin</a>\n         </dt><dd data-md=\"\">\n          <p><var>oldDocState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-origin\" id=\"ref-for-document-state-origin①\">origin</a></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-resource\" id=\"ref-for-document-state-resource②\">resource</a>\n         </dt><dd data-md=\"\">\n          <p><var>oldDocState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-resource\" id=\"ref-for-document-state-resource③\">resource</a></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-ever-populated\" id=\"ref-for-document-state-ever-populated①\">ever populated</a>\n         </dt><dd data-md=\"\">\n          <p><var>oldDocState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-ever-populated\" id=\"ref-for-document-state-ever-populated②\">ever populated</a></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-nav-target-name\" id=\"ref-for-document-state-nav-target-name\">navigable target name</a>\n         </dt><dd data-md=\"\">\n          <p><var>oldDocState</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-nav-target-name\" id=\"ref-for-document-state-nav-target-name①\">navigable target name</a></p>\n        </dd></dl>"
            },
            {
              "html": "If <var>locationURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme①\">scheme</a> is not an <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#http-scheme\" id=\"ref-for-http-scheme\">HTTP(S) scheme</a>, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state①②\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-resource\" id=\"ref-for-document-state-resource④\">resource</a> to null.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break①⓪\">Break</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Set <var>currentURL</var> to <var>locationURL</var>.</p>"
            },
            {
              "html": "<p>Set <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-url\" id=\"ref-for-she-url④\">URL</a> to <var>currentURL</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>locationURL</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①①\">URL</a> whose <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme②\">scheme</a> is not a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-scheme\" id=\"ref-for-fetch-scheme①\">fetch scheme</a>, then return a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#non-fetch-scheme-navigation-params\" id=\"ref-for-non-fetch-scheme-navigation-params\">non-fetch scheme navigation params</a>, with:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#non-fetch-scheme-params-initiator-origin\" id=\"ref-for-non-fetch-scheme-params-initiator-origin\">initiator origin</a>\n       </dt><dd data-md=\"\">\n        <p><var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-current-url\" id=\"ref-for-concept-request-current-url③\">current URL</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin⑤\">origin</a></p>\n      </dd></dl>"
        },
        {
          "html": "<p>If any of the following are true:</p>\n      <ul>\n       <li data-md=\"\">\n        <p><var>response</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error①⓪\">network error</a>;</p>\n       </li><li data-md=\"\">\n        <p><var>locationURL</var> is failure; or</p>\n       </li><li data-md=\"\">\n        <p><var>locationURL</var> is a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url⑦\">URL</a> whose <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme③\">scheme</a> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-scheme\" id=\"ref-for-fetch-scheme②\">fetch scheme</a></p>\n      </li></ul>\n        then return null."
        },
        {
          "html": "<p>Let <var>resultPolicyContainer</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#determining-navigation-params-policy-container\" id=\"ref-for-determining-navigation-params-policy-container①\">determining navigation params policy container</a> given <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-url\" id=\"ref-for-concept-response-url⑥\">URL</a>, <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state①③\">document state</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-history-policy-container\" id=\"ref-for-document-state-history-policy-container④\">history policy container</a>, <var>sourceSnapshotParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params-policy-container\" id=\"ref-for-source-snapshot-params-policy-container①\">source policy container</a>, null, and <var>responsePolicyContainer</var>.</p>"
        },
        {
          "html": "<p>Return a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params\" id=\"ref-for-navigation-params⑥\">navigation params</a>, with:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-id\" id=\"ref-for-navigation-params-id①\">id</a>\n       </dt><dd data-md=\"\">\n        <p><var>navigationId</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-request\" id=\"ref-for-navigation-params-request①\">request</a>\n       </dt><dd data-md=\"\">\n        <p><var>request</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-response\" id=\"ref-for-navigation-params-response①\">response</a>\n       </dt><dd data-md=\"\">\n        <p><var>response</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-origin\" id=\"ref-for-navigation-params-origin①\">origin</a>\n       </dt><dd data-md=\"\">\n        <p><var>responseOrigin</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-policy-container\" id=\"ref-for-navigation-params-policy-container①\">policy container</a>\n       </dt><dd data-md=\"\">\n        <p><var>resultPolicyContainer</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-sandboxing\" id=\"ref-for-navigation-params-sandboxing①\">final sandboxing flag set</a>\n       </dt><dd data-md=\"\">\n        <p><var>finalSandboxFlags</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-coop\" id=\"ref-for-navigation-params-coop①\">cross-origin opener policy</a>\n       </dt><dd data-md=\"\">\n        <p><var>responseCOOP</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-coop-enforcement-result\" id=\"ref-for-navigation-params-coop-enforcement-result①\">COOP enforcement result</a>\n       </dt><dd data-md=\"\">\n        <p><var>coopEnforcementResult</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-reserved-environment\" id=\"ref-for-navigation-params-reserved-environment②\">reserved environment</a>\n       </dt><dd data-md=\"\">\n        <p><var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client①⑨\">reserved client</a></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-navigable\" id=\"ref-for-navigation-params-navigable①\">navigable</a>\n       </dt><dd data-md=\"\">\n        <p><var>navigable</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-nav-timing-type\" id=\"ref-for-navigation-params-nav-timing-type①\">navigation timing type</a>\n       </dt><dd data-md=\"\">\n        <p><var>navTimingType</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-fetch-controller\" id=\"ref-for-navigation-params-fetch-controller③\">fetch controller</a>\n       </dt><dd data-md=\"\">\n        <p><var>fetchController</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-commit-early-hints\" id=\"ref-for-navigation-params-commit-early-hints①\">commit early hints</a>\n       </dt><dd data-md=\"\">\n        <p><var>commitEarlyHints</var></p>\n      </dd></dl>"
        }
      ]
    },
    {
      "name": "obtain a browsing context to use for a navigation response",
      "html": "Modify <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-browsing-context-navigation\" id=\"ref-for-obtain-browsing-context-navigation\">obtain a browsing context to use for a navigation response</a>’s step which checks if <var>sourceOrigin</var> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-site\" id=\"ref-for-same-site①\">same site</a> with <var>destinationOrigin</var> by inserting the following substep:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>navigationParams</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#navigation-params-delivery-type\" id=\"ref-for-navigation-params-delivery-type②\">delivery type</a> is \"<code>prefetch</code>\", then optionally set <var>swapGroup</var> to true.</p>"
        }
      ]
    },
    {
      "name": "clear prefetch cache",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#clear-prefetch-cache",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"clear-prefetch-cache\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">clear prefetch cache</dfn> given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin①\">origin</a> <var>origin</var>:",
      "rationale": "for",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑥\">For each</a> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-top\" id=\"ref-for-nav-top\">top-level traversable</a> <var>traversable</var> of the user agent’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-traversable-set\" id=\"ref-for-top-level-traversable-set\">top-level traversable set</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>navigables</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#inclusive-descendant-navigables\" id=\"ref-for-inclusive-descendant-navigables\">inclusive descendant navigables</a> of <var>traversable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document⑥\">active document</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑦\">For each</a> <var>navigable</var> in <var>navigables</var>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>activeDocument</var> be the <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document⑦\">active document</a>.</p>"
                },
                {
                  "html": "<p>If <var>activeDocument</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-document-origin\" id=\"ref-for-concept-document-origin③\">origin</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin③\">same origin</a> with <var>origin</var>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑧\">continue</a>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑧\">For each</a> <var>prefetchRecord</var> in <var>activeDocument</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#document-prefetch-records\" id=\"ref-for-document-prefetch-records⑦\">prefetch records</a>:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-prerendering-traversable\" id=\"ref-for-prefetch-record-prerendering-traversable④\">prerendering traversable</a> is not null, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑨\">continue</a>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-cancel-and-discard\" id=\"ref-for-prefetch-record-cancel-and-discard①\">Cancel and discard</a> <var>prefetchRecord</var> given <var>activeDocument</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "start a referrer-initiated navigational prefetch",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#start-a-referrer-initiated-navigational-prefetch",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"start-a-referrer-initiated-navigational-prefetch\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">start a referrer-initiated navigational prefetch</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document①⓪\">Document</a></code> <var>document</var> and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record\" id=\"ref-for-prefetch-record①②\">prefetch record</a> <var>prefetchRecord</var>, perform the following steps.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①④\">Assert</a>: <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#node-navigable\" id=\"ref-for-node-navigable\">node navigable</a> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-traversable\" id=\"ref-for-top-level-traversable⑦\">top-level traversable</a>.</p>"
        },
        {
          "html": "<p>If <var>document</var> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#has-a-matching-prefetch-record\" id=\"ref-for-has-a-matching-prefetch-record\">has a matching prefetch record</a> given <var>prefetchRecord</var>, then return.</p>"
        },
        {
          "html": "<p>Let <var>sourceSnapshotParams</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#snapshotting-source-snapshot-params\" id=\"ref-for-snapshotting-source-snapshot-params①\">snapshotting source snapshot params</a> given <var>document</var>.</p>"
        },
        {
          "html": "<p>Let <var>targetSnapshotParams</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#snapshotting-target-snapshot-params\" id=\"ref-for-snapshotting-target-snapshot-params\">snapshotting target snapshot params</a> given <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#node-navigable\" id=\"ref-for-node-navigable①\">node navigable</a>.</p>"
        },
        {
          "html": "<p>Set <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-source-partition-key\" id=\"ref-for-prefetch-record-source-partition-key③\">source partition key</a> to the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#determine-the-network-partition-key\" id=\"ref-for-determine-the-network-partition-key②\">determining the network partition key</a> given <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑤\">Assert</a>: <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url⑨\">URL</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme④\">scheme</a> is an <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#http-scheme\" id=\"ref-for-http-scheme①\">HTTP(S) scheme</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append③\">Append</a> <var>prefetchRecord</var> to <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#document-prefetch-records\" id=\"ref-for-document-prefetch-records⑧\">prefetch records</a>.</p>"
        },
        {
          "html": "<p>Set <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-start-time\" id=\"ref-for-prefetch-record-start-time①\">start time</a> to the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-high-resolution-time\" id=\"ref-for-dfn-current-high-resolution-time④\">current high resolution time</a> for the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global①\">relevant global object</a> of <var>document</var>.</p>"
        },
        {
          "html": "<p>Let <var>referrerPolicy</var> be <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-referrer-policy\" id=\"ref-for-prefetch-record-referrer-policy\">referrer policy</a> if <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-referrer-policy\" id=\"ref-for-prefetch-record-referrer-policy①\">referrer policy</a> is not the empty string, and <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container\" id=\"ref-for-concept-document-policy-container\">policy container</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#policy-container-referrer-policy\" id=\"ref-for-policy-container-referrer-policy\">referrer policy</a> otherwise.</p>"
        },
        {
          "html": "<p>Let <var>documentState</var> be a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-2\" id=\"ref-for-document-state-2②\">document state</a> with</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-request-referrer-policy\" id=\"ref-for-document-state-request-referrer-policy③\">request referrer policy</a>\n       </dt><dd data-md=\"\">\n        <p><var>referrerPolicy</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#document-state-initiator-origin\" id=\"ref-for-document-state-initiator-origin④\">initiator origin</a>\n       </dt><dd data-md=\"\">\n        <p><var>document</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-document-origin\" id=\"ref-for-concept-document-origin④\">origin</a></p>\n      </dd></dl>"
        },
        {
          "html": "<p>Let <var>entry</var> be a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-entry\" id=\"ref-for-session-history-entry②\">session history entry</a> with</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-url\" id=\"ref-for-she-url⑤\">URL</a>\n       </dt><dd data-md=\"\">\n        <p><var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-url\" id=\"ref-for-prefetch-record-url①⓪\">URL</a></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#she-document-state\" id=\"ref-for-she-document-state①④\">document state</a>\n       </dt><dd data-md=\"\">\n        <p><var>documentState</var></p>\n      </dd></dl>"
        },
        {
          "html": "<p>Let <var>request</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-a-navigation-request\" id=\"ref-for-create-a-navigation-request①\">creating a navigation request</a> given <var>entry</var>, <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object④\">relevant settings object</a>, <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#node-navigable\" id=\"ref-for-node-navigable②\">node navigable</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-container\" id=\"ref-for-nav-container①\">container</a>, and false.</p>"
        },
        {
          "html": "<p>Let <var>global</var> be <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global②\">relevant global object</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②\">In parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>navigationParams</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-navigation-params-by-fetching\" id=\"ref-for-create-navigation-params-by-fetching⑥\">creating navigation params by fetching</a> given <var>request</var>, <var>entry</var>, <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#node-navigable\" id=\"ref-for-node-navigable③\">node navigable</a>, <var>sourceSnapshotParams</var>, <var>targetSnapshotParams</var>, \"<code>other</code>\", null (navigationId), \"<code>navigate</code>\", and <a href=\"https://wicg.github.io/nav-speculation/prefetch.html#create-navigation-params-by-fetching-prefetchRecord\" id=\"ref-for-create-navigation-params-by-fetching-prefetchRecord\"><i>prefetchRecord</i></a> <var>prefetchRecord</var>.</p>"
            },
            {
              "html": "<p>If <var>navigationParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-response\" id=\"ref-for-navigation-params-response②\">response</a> does not <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#supports-prefetch\" id=\"ref-for-supports-prefetch\">support prefetch</a>, then set <var>navigationParams</var> to null.</p>"
            },
            {
              "html": "<p>If <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-had-conflicting-credentials\" id=\"ref-for-prefetch-record-had-conflicting-credentials①\">had conflicting credentials</a> is true, then set <var>navigationParams</var> to null.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\" id=\"ref-for-networking-task-source\">networking task source</a>, given <var>global</var>, to:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>navigationParams</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params\" id=\"ref-for-navigation-params⑦\">navigation params</a>, then <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-cancel-and-discard\" id=\"ref-for-prefetch-record-cancel-and-discard②\">cancel and discard</a> <var>prefetchRecord</var> given <var>document</var> and abort these steps.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑥\">Assert</a>: <var>navigationParams</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-response\" id=\"ref-for-navigation-params-response③\">response</a> is the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#exchange-record-response\" id=\"ref-for-exchange-record-response⑦\">response</a> of <var>prefetchRecord</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-redirect-chain\" id=\"ref-for-prefetch-record-redirect-chain⑧\">redirect chain</a>’s last element.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/nav-speculation/prefetch.html#prefetch-record-complete\" id=\"ref-for-prefetch-record-complete\">Complete</a> <var>prefetchRecord</var> given <var>document</var>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "supports prefetch",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#supports-prefetch",
      "html": "A <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response⑦\">response</a> <var>response</var> <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"supports-prefetch\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">supports prefetch</dfn> if the following steps return true:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>status</var> be <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status\">status</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑦\">Assert</a>: <var>status</var> is not a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#redirect-status\" id=\"ref-for-redirect-status\">redirect status</a>.</p>"
        },
        {
          "html": "<p>If <var>status</var> is not an <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#ok-status\" id=\"ref-for-ok-status\">ok status</a>, then return false.</p>"
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "copy prefetch cookies",
      "href": "https://wicg.github.io/nav-speculation/prefetch.html#copy-prefetch-cookies",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"copy-prefetch-cookies\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">copy prefetch cookies</dfn> given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#network-partition-key\" id=\"ref-for-network-partition-key④\">network partition key</a> <var>isolatedPartitionKey</var> and an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment\" id=\"ref-for-environment④\">environment</a> <var>environment</var>, perform the following steps.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>isolatedCookieStore</var> be the cookie store associated with <var>isolatedPartitionKey</var>.</p>"
        },
        {
          "html": "For each <a data-link-type=\"dfn\" data-refhint-key=\"574eb588\" href=\"https://httpwg.org/specs/rfc6265.html#storage-model\" id=\"ref-for-storage-model①\">cookie</a> <var>cookie</var> in <var>isolatedCookieStore</var>.",
          "rationale": "remove",
          "steps": [
            {
              "html": "<p>Remove <var>cookie</var> from <var>isolatedCookieStore</var>.</p>"
            },
            {
              "html": "<p>A user agent may ignore a cookie in its entirety. If so, continue.</p>"
            },
            {
              "html": "<p>Let <var>topLevelSite</var> be null.</p>"
            },
            {
              "html": "If <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context①\">target browsing context</a> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context\" id=\"ref-for-top-level-browsing-context\">top-level browsing context</a>:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>topLevelSite</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site\" id=\"ref-for-obtain-a-site\">obtaining a site</a> given <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple\" id=\"ref-for-concept-origin-tuple\">tuple origin</a> (\"<code>https</code>\", <var>cookie</var>’s domain, null, null).</p>"
                }
              ]
            },
            {
              "html": "Otherwise:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>topLevelOrigin</var> be <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin②\">top-level origin</a>.</p>"
                },
                {
                  "html": "<p>If <var>topLevelOrigin</var> is null, then set <var>topLevelOrigin</var> to <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-creation-url\" id=\"ref-for-concept-environment-top-level-creation-url②\">top-level creation URL</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin⑦\">origin</a>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑧\">Assert</a>: <var>topLevelOrigin</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin②\">origin</a>.</p>"
                },
                {
                  "html": "<p>Set <var>topLevelSite</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site\" id=\"ref-for-obtain-a-site①\">obtaining a site</a> given <var>topLevelOrigin</var>.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>secondKey</var> be null or an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined③\">implementation-defined</a> value.</p>"
            },
            {
              "html": "<p>Let <var>destinationPartitionKey</var> be (<var>topLevelSite</var>, <var>secondKey</var>).</p>"
            },
            {
              "html": "<p>Let <var>cookieStore</var> be the cookie store associated with <var>destinationPartitionKey</var>.</p>"
            },
            {
              "html": "<p>Let <var>newCookie</var> be a copy of <var>cookie</var>.</p>"
            },
            {
              "html": "<p>Set <var>newCookie</var>’s creation-time and last-access-time to the current date and time.</p>"
            },
            {
              "html": "If <var>cookieStore</var> contains a cookie <var>existingCookie</var> with the same name, domain and path as the newly created cookie:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set the creation-time of <var>newCookie</var> to <var>existingCookie</var>’s creation-time.</p>"
                },
                {
                  "html": "<p>Remove <var>existingCookie</var> from <var>cookieStore</var>.</p>"
                }
              ]
            },
            {
              "html": "<p>Insert <var>newCookie</var> into <var>cookieStore</var>.</p>"
            }
          ]
        }
      ]
    }
  ]
}