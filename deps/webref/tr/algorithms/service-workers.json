{
  "spec": {
    "title": "Service Workers",
    "url": "https://www.w3.org/TR/service-workers/"
  },
  "algorithms": [
    {
      "html": "Each <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client④\">service worker client</a> has the following <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-discarding-steps\" id=\"ref-for-environment-discarding-steps\">environment discarding steps</a>:",
      "rationale": "set",
      "steps": [
        {
          "html": "<p>Set <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-client-discarded-flag\" id=\"ref-for-service-worker-client-discarded-flag\">discarded flag</a>.</p>"
        }
      ]
    },
    {
      "name": "service-worker-creation-algorithm",
      "href": "https://www.w3.org/TR/service-workers/#get-the-service-worker-object",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>objectMap</var> be <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#environment-settings-object-service-worker-object-map\" id=\"ref-for-environment-settings-object-service-worker-object-map\">service worker object map</a>.</p>"
        },
        {
          "html": "If <var>objectMap</var>[<var>serviceWorker</var>] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists\">exist</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>serviceWorkerObj</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworker\" id=\"ref-for-serviceworker⑨\">ServiceWorker</a></code> in <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object's-realm\" id=\"ref-for-environment-settings-object's-realm\">Realm</a>, and associate it with <var>serviceWorker</var>.</p>"
            },
            {
              "html": "<p>Set <var>serviceWorkerObj</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworker-state\" id=\"ref-for-dom-serviceworker-state①\">state</a></code> to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state④\">state</a>.</p>"
            },
            {
              "html": "<p>Set <var>objectMap</var>[<var>serviceWorker</var>] to <var>serviceWorkerObj</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>objectMap</var>[<var>serviceWorker</var>].</p>"
        }
      ]
    },
    {
      "name": "service-worker-postmessage",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworker-postmessage",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorker\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-serviceworker-postmessage\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>postMessage(<var>message</var>, <var>transfer</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>options</var> be «[ \"transfer\" → <var>transfer</var> ]».</p>"
        },
        {
          "html": "<p>Invoke <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworker-postmessage-message-options\" id=\"ref-for-dom-serviceworker-postmessage-message-options①\">postMessage(message, options)</a></code> with <var>message</var> and <var>options</var> as the arguments.</p>"
        }
      ]
    },
    {
      "name": "service-worker-postmessage-options",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworker-postmessage-message-options",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorker\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"postMessage(message, options)|postMessage(message)\" id=\"dom-serviceworker-postmessage-message-options\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>postMessage(<var>message</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>serviceWorker</var> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker\" id=\"ref-for-dfn-service-worker⑤①\">service worker</a> represented by <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this\">this</a>.</p>"
        },
        {
          "html": "<p>Let <var>incumbentSettings</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#incumbent-settings-object\" id=\"ref-for-incumbent-settings-object\">incumbent settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>incumbentGlobal</var> be <var>incumbentSettings</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global\" id=\"ref-for-concept-settings-object-global③\">global object</a>.</p>"
        },
        {
          "html": "<p>Let <var>serializeWithTransferResult</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structuredserializewithtransfer\" id=\"ref-for-structuredserializewithtransfer\">StructuredSerializeWithTransfer</a>(<var>message</var>, <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#dom-structuredserializeoptions-transfer\" id=\"ref-for-dom-structuredserializeoptions-transfer\">transfer</a></code>\"]). Rethrow any exceptions.</p>"
        },
        {
          "html": "<p>If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#should-skip-event\" id=\"ref-for-should-skip-event\">Should Skip Event</a> algorithm with \"message\" and <var>serviceWorker</var> is true, then return.</p>"
        },
        {
          "html": "Run these substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel\">in parallel</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-service-worker\" id=\"ref-for-run-service-worker\">Run Service Worker</a> algorithm with <var>serviceWorker</var> is <em>failure</em>, then return.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①\">Queue a task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source\">DOM manipulation task source</a> to run the following steps:",
              "rationale": "let",
              "steps": [
                {
                  "html": "Let <var>source</var> be determined by switching on the type of <var>incumbentGlobal</var>:",
                  "rationale": ".switch",
                  "steps": [
                    {
                      "operation": "switch",
                      "steps": [
                        {
                          "case": "ServiceWorkerGlobalScope",
                          "html": "The result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object\">getting the service worker object</a> that represents <var>incumbentGlobal</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker\">service worker</a> in the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object\">relevant settings object</a> of <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object\">global object</a>."
                        },
                        {
                          "case": "Window",
                          "html": "a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#windowclient\" id=\"ref-for-windowclient\">WindowClient</a></code> object that represents <var>incumbentGlobal</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①\">relevant settings object</a>."
                        },
                        {
                          "case": "Otherwise",
                          "html": "a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#client\" id=\"ref-for-client\">Client</a></code> object that represents <var>incumbentGlobal</var>’s associated worker"
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "<p>Let <var>origin</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin\">serialization</a> of <var>incumbentSettings</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①\">origin</a>.</p>"
                },
                {
                  "html": "<p>Let <var>destination</var> be the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope\" id=\"ref-for-serviceworkerglobalscope②\">ServiceWorkerGlobalScope</a></code> object associated with <var>serviceWorker</var>.</p>"
                },
                {
                  "html": "<p>Let <var>deserializeRecord</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structureddeserializewithtransfer\" id=\"ref-for-structureddeserializewithtransfer\">StructuredDeserializeWithTransfer</a>(<var>serializeWithTransferResult</var>, <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-global-object-realm\" id=\"ref-for-concept-global-object-realm\">Realm</a>).</p>\n            <p>If this throws an exception, let <var>e</var> be the result of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-create\" id=\"ref-for-concept-event-create\">creating an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://www.w3.org/TR/service-workers/#eventdef-serviceworkerglobalscope-messageerror\" id=\"ref-for-eventdef-serviceworkerglobalscope-messageerror①\">messageerror</a></code>, using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#extendablemessageevent\" id=\"ref-for-extendablemessageevent\">ExtendableMessageEvent</a></code>, with the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-extendablemessageevent-origin\" id=\"ref-for-dom-extendablemessageevent-origin\">origin</a></code> attribute initialized to <var>origin</var> and the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-extendablemessageevent-source\" id=\"ref-for-dom-extendablemessageevent-source\">source</a></code> attribute initialized to <var>source</var>.</p>"
                },
                {
                  "html": "Else:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>messageClone</var> be <var>deserializeRecord</var>.[[Deserialized]].</p>"
                    },
                    {
                      "html": "<p>Let <var>newPorts</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-frozen-array-type\" id=\"ref-for-dfn-frozen-array-type\">frozen array</a> consisting of all <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#messageport\" id=\"ref-for-messageport\">MessagePort</a></code> objects in <var>deserializeRecord</var>.[[TransferredValues]], if any, maintaining their relative order.</p>"
                    },
                    {
                      "html": "<p>Let <var>e</var> be the result of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-create\" id=\"ref-for-concept-event-create①\">creating an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://www.w3.org/TR/service-workers/#eventdef-serviceworkerglobalscope-message\" id=\"ref-for-eventdef-serviceworkerglobalscope-message①\">message</a></code>, using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#extendablemessageevent\" id=\"ref-for-extendablemessageevent①\">ExtendableMessageEvent</a></code>, with the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-extendablemessageevent-origin\" id=\"ref-for-dom-extendablemessageevent-origin①\">origin</a></code> attribute initialized to <var>origin</var>, the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-extendablemessageevent-source\" id=\"ref-for-dom-extendablemessageevent-source①\">source</a></code> attribute initialized to <var>source</var>, the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-extendablemessageevent-data\" id=\"ref-for-dom-extendablemessageevent-data\">data</a></code> attribute initialized to <var>messageClone</var>, and the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-extendablemessageevent-ports\" id=\"ref-for-dom-extendablemessageevent-ports\">ports</a></code> attribute initialized to <var>newPorts</var>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-dispatch\" id=\"ref-for-concept-event-dispatch②\">Dispatch</a> <var>e</var> at <var>destination</var>.</p>"
                },
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-service-worker-extended-events-set\" id=\"ref-for-update-service-worker-extended-events-set\">Update Service Worker Extended Events Set</a> with <var>serviceWorker</var> and <var>e</var>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "service-worker-registration-creation-algorithm",
      "href": "https://www.w3.org/TR/service-workers/#get-the-service-worker-registration-object",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>objectMap</var> be <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#environment-settings-object-service-worker-registration-object-map\" id=\"ref-for-environment-settings-object-service-worker-registration-object-map\">service worker registration object map</a>.</p>"
        },
        {
          "html": "If <var>objectMap</var>[<var>registration</var>] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①\">exist</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>registrationObject</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerregistration\" id=\"ref-for-serviceworkerregistration⑤\">ServiceWorkerRegistration</a></code> in <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object's-realm\" id=\"ref-for-environment-settings-object's-realm①\">Realm</a>.</p>"
            },
            {
              "html": "<p>Set <var>registrationObject</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerregistration-service-worker-registration\" id=\"ref-for-serviceworkerregistration-service-worker-registration\">service worker registration</a> to <var>registration</var>.</p>"
            },
            {
              "html": "<p>Set <var>registrationObject</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-installing\" id=\"ref-for-dom-serviceworkerregistration-installing①\">installing</a></code> attribute to null.</p>"
            },
            {
              "html": "<p>Set <var>registrationObject</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-waiting\" id=\"ref-for-dom-serviceworkerregistration-waiting①\">waiting</a></code> attribute to null.</p>"
            },
            {
              "html": "<p>Set <var>registrationObject</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-active\" id=\"ref-for-dom-serviceworkerregistration-active①\">active</a></code> attribute to null.</p>"
            },
            {
              "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker③\">installing worker</a> is not null, then set <var>registrationObject</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-installing\" id=\"ref-for-dom-serviceworkerregistration-installing②\">installing</a></code> attribute to the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object①\">getting the service worker object</a> that represents <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker④\">installing worker</a> in <var>environment</var>.</p>"
            },
            {
              "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker②\">waiting worker</a> is not null, then set <var>registrationObject</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-waiting\" id=\"ref-for-dom-serviceworkerregistration-waiting②\">waiting</a></code> attribute to the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object②\">getting the service worker object</a> that represents <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker③\">waiting worker</a> in <var>environment</var>.</p>"
            },
            {
              "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑦\">active worker</a> is not null, then set <var>registrationObject</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-active\" id=\"ref-for-dom-serviceworkerregistration-active②\">active</a></code> attribute to the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object③\">getting the service worker object</a> that represents <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑧\">active worker</a> in <var>environment</var>.</p>"
            },
            {
              "html": "<p>Set <var>objectMap</var>[<var>registration</var>] to <var>registrationObject</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>objectMap</var>[<var>registration</var>].</p>"
        }
      ]
    },
    {
      "name": "service-worker-registration-update",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-update",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerRegistration\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-serviceworkerregistration-update\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>update()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>registration</var> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerregistration-service-worker-registration\" id=\"ref-for-serviceworkerregistration-service-worker-registration④\">service worker registration</a>.</p>"
        },
        {
          "html": "<p>Let <var>newestWorker</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-newest-worker\" id=\"ref-for-get-newest-worker\">Get Newest Worker</a> algorithm passing <var>registration</var> as its argument.</p>"
        },
        {
          "html": "<p>If <var>newestWorker</var> is null, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with\">a promise rejected with</a> an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException\">DOMException</a></code> and abort these steps.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global\">relevant global object</a> <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope\" id=\"ref-for-serviceworkerglobalscope③\">ServiceWorkerGlobalScope</a></code> object, and <var>globalObject</var>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state⑤\">state</a> is \"<code>installing</code>\", return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①\">a promise rejected with</a> an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror①\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①\">DOMException</a></code> and abort these steps.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects\">promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>job</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-job\" id=\"ref-for-create-job\">Create Job</a> with <em>update</em>, <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key②\">storage key</a>, <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-url\" id=\"ref-for-dfn-scope-url⑥\">scope url</a>, <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url①\">script url</a>, <var>promise</var>, and <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-worker-type\" id=\"ref-for-dfn-job-worker-type\">worker type</a> to <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-type\" id=\"ref-for-dfn-type\">type</a>.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#schedule-job\" id=\"ref-for-schedule-job\">Schedule Job</a> with <var>job</var>.</p>"
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "navigator-service-worker-unregister",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-unregister",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerRegistration\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-serviceworkerregistration-unregister\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>unregister()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>registration</var> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerregistration-service-worker-registration\" id=\"ref-for-serviceworkerregistration-service-worker-registration⑤\">service worker registration</a>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise\">a new promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>job</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-job\" id=\"ref-for-create-job①\">Create Job</a> with <em>unregister</em>, <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key③\">storage key</a>, <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-url\" id=\"ref-for-dfn-scope-url⑦\">scope url</a>, null, <var>promise</var>, and <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#schedule-job\" id=\"ref-for-schedule-job①\">Schedule Job</a> with <var>job</var>.</p>"
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "navigator-service-worker-controller",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworkercontainer-controller",
      "html": "<dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerContainer\" data-dfn-type=\"attribute\" data-export=\"\" id=\"dom-serviceworkercontainer-controller\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>controller</code></dfn> attribute <em>must</em> run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>client</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-service-worker-client\" id=\"ref-for-serviceworkercontainer-service-worker-client\">service worker client</a>.</p>"
        },
        {
          "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker①⑧\">active service worker</a> is null, then return null.</p>"
        },
        {
          "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object④\">getting the service worker object</a> that represents <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker①⑨\">active service worker</a> in <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑥\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑤\">relevant settings object</a>.</p>"
        }
      ]
    },
    {
      "name": "navigator-service-worker-ready",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworkercontainer-ready",
      "html": "<dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerContainer\" data-dfn-type=\"attribute\" data-export=\"\" id=\"dom-serviceworkercontainer-ready\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>ready</code></dfn> attribute <em>must</em> run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑦\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-ready-promise\" id=\"ref-for-serviceworkercontainer-ready-promise\">ready promise</a> is null, then set <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑧\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-ready-promise\" id=\"ref-for-serviceworkercontainer-ready-promise①\">ready promise</a> to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①\">a new promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>readyPromise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑨\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-ready-promise\" id=\"ref-for-serviceworkercontainer-ready-promise②\">ready promise</a>.</p>"
        },
        {
          "html": "If <var>readyPromise</var> is pending, run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>client</var> by <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⓪\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-service-worker-client\" id=\"ref-for-serviceworkercontainer-service-worker-client①\">service worker client</a>.</p>"
            },
            {
              "html": "<p>Let <var>storage key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key\">obtain a storage key</a> given client.</p>"
            },
            {
              "html": "<p>Let <var>registration</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-service-worker-registration\" id=\"ref-for-match-service-worker-registration③\">Match Service Worker Registration</a> given <var>storage key</var> and <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url①\">creation URL</a>.</p>"
            },
            {
              "html": "<p>If <var>registration</var> is not null, and <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑨\">active worker</a> is not null, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③\">queue a task</a> on <var>readyPromise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑥\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop\">responsible event loop</a>, using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①\">DOM manipulation task source</a>, to resolve <var>readyPromise</var> with the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-registration-object\" id=\"ref-for-get-the-service-worker-registration-object\">getting the service worker registration object</a> that represents <var>registration</var> in <var>readyPromise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑦\">relevant settings object</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>readyPromise</var>.</p>"
        }
      ]
    },
    {
      "name": "navigator-service-worker-register",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworkercontainer-register",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerContainer\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"register(scriptURL, options)|register(scriptURL)\" id=\"dom-serviceworkercontainer-register\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>register(<var>scriptURL</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>p</var> be a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects②\">promise</a>.</p>"
        },
        {
          "html": "<p>Set <var>scriptURL</var> to the result of invoking <a data-link-type=\"abstract-op\" href=\"https://www.w3.org/TR/trusted-types/#abstract-opdef-get-trusted-type-compliant-string\" id=\"ref-for-abstract-opdef-get-trusted-type-compliant-string\">Get Trusted Type compliant string</a> with <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/trusted-types/#trustedscripturl\" id=\"ref-for-trustedscripturl①\">TrustedScriptURL</a></code>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①①\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global②\">relevant global object</a>, <var>scriptURL</var>, \"ServiceWorkerContainer register\", and \"script\".</p>"
        },
        {
          "html": "<p>Let <var>client</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①②\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-service-worker-client\" id=\"ref-for-serviceworkercontainer-service-worker-client②\">service worker client</a>.</p>"
        },
        {
          "html": "<p>Let <var>scriptURL</var> be the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser\">parsing</a> <var>scriptURL</var> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①③\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑧\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#api-base-url\" id=\"ref-for-api-base-url\">API base URL</a>.</p>"
        },
        {
          "html": "<p>Let <var>scopeURL</var> be null.</p>"
        },
        {
          "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-registrationoptions-scope\" id=\"ref-for-dom-registrationoptions-scope\">scope</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②\">exists</a>, set <var>scopeURL</var> to the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser①\">parsing</a> <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-registrationoptions-scope\" id=\"ref-for-dom-registrationoptions-scope①\">scope</a></code>\"] with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①④\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑨\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#api-base-url\" id=\"ref-for-api-base-url①\">API base URL</a>.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#start-register\" id=\"ref-for-start-register\">Start Register</a> with <var>scopeURL</var>, <var>scriptURL</var>, <var>p</var>, <var>client</var>, <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url②\">creation URL</a>, <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-registrationoptions-type\" id=\"ref-for-dom-registrationoptions-type\">type</a></code>\"], and <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-registrationoptions-updateviacache\" id=\"ref-for-dom-registrationoptions-updateviacache\">updateViaCache</a></code>\"].</p>"
        },
        {
          "html": "<p>Return <var>p</var>.</p>"
        }
      ]
    },
    {
      "name": "navigator-service-worker-getRegistration",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworkercontainer-getregistration",
      "html": "<dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerContainer\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"getRegistration(clientURL)|getRegistration()\" id=\"dom-serviceworkercontainer-getregistration\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>getRegistration(<var>clientURL</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>client</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⑤\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-service-worker-client\" id=\"ref-for-serviceworkercontainer-service-worker-client③\">service worker client</a>.</p>"
        },
        {
          "html": "<p>Let <var>storage key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key①\">obtain a storage key</a> given <var>client</var>.</p>"
        },
        {
          "html": "<p>Let <var>clientURL</var> be the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser②\">parsing</a> <var>clientURL</var> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⑥\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①⓪\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#api-base-url\" id=\"ref-for-api-base-url②\">API base URL</a>.</p>"
        },
        {
          "html": "<p>If <var>clientURL</var> is failure, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects③\">promise</a> rejected with a <code>TypeError</code>.</p>"
        },
        {
          "html": "<p>Set <var>clientURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-fragment\" id=\"ref-for-concept-url-fragment\">fragment</a> to null.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②\">origin</a> of <var>clientURL</var> is not <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin③\">origin</a>, return a <var>promise</var> rejected with a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects④\">promise</a>.</p>"
        },
        {
          "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>registration</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-service-worker-registration\" id=\"ref-for-match-service-worker-registration④\">Match Service Worker Registration</a> given <var>storage key</var> and <var>clientURL</var>.</p>"
            },
            {
              "html": "<p>If <var>registration</var> is null, resolve <var>promise</var> with undefined and abort these steps.</p>"
            },
            {
              "html": "<p>Resolve <var>promise</var> with the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-registration-object\" id=\"ref-for-get-the-service-worker-registration-object①\">getting the service worker registration object</a> that represents <var>registration</var> in <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①①\">relevant settings object</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "navigator-service-worker-getRegistrations",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworkercontainer-getregistrations",
      "html": "<dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerContainer\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-serviceworkercontainer-getregistrations\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>getRegistrations()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>client</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⑦\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-service-worker-client\" id=\"ref-for-serviceworkercontainer-service-worker-client④\">service worker client</a>.</p>"
        },
        {
          "html": "<p>Let <var>client storage key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key②\">obtain a storage key</a> given <var>client</var>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise②\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>registrations</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②\">list</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate\">For each</a> (<var>storage key</var>, <var>scope</var>) → <var>registration</var> of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map②\">registration map</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>storage key</var> <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-key-equal\" id=\"ref-for-storage-key-equal\">equals</a> <var>client storage key</var>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append\">append</a> <var>registration</var> to <var>registrations</var>.</p>"
                }
              ]
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task④\">Queue a task</a> on <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①②\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①\">responsible event loop</a>, using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②\">DOM manipulation task source</a>, to run the following steps:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>registrationObjects</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list③\">list</a>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①\">For each</a> <var>registration</var> of <var>registrations</var>:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>registrationObj</var> be the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-registration-object\" id=\"ref-for-get-the-service-worker-registration-object②\">getting the service worker registration object</a> that represents <var>registration</var> in <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①③\">relevant settings object</a>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append①\">Append</a> <var>registrationObj</var> to <var>registrationObjects</var>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Resolve <var>promise</var> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-frozen-array\" id=\"ref-for-dfn-create-frozen-array\">a new frozen array of</a> <var>registrationObjects</var> in <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm\">relevant Realm</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "navigation-preload-manager-enable",
      "href": "https://www.w3.org/TR/service-workers/#dom-navigationpreloadmanager-enable",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"NavigationPreloadManager\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-navigationpreloadmanager-enable\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>enable()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise③\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel④\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>registration</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②⓪\">this</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\" id=\"ref-for-dfn-service-worker-registration④①\">service worker registration</a>.</p>"
            },
            {
              "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker①②\">active worker</a> is null, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject\">reject</a> <var>promise</var> with an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror②\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException③\">DOMException</a></code>, and abort these steps.</p>"
            },
            {
              "html": "<p>Set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-navigation-preload-enabled-flag\" id=\"ref-for-service-worker-registration-navigation-preload-enabled-flag\">navigation preload enabled flag</a>.</p>"
            },
            {
              "html": "<p>Resolve <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "navigation-preload-manager-disable",
      "href": "https://www.w3.org/TR/service-workers/#dom-navigationpreloadmanager-disable",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"NavigationPreloadManager\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-navigationpreloadmanager-disable\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>disable()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise④\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel⑤\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>registration</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②①\">this</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\" id=\"ref-for-dfn-service-worker-registration④②\">service worker registration</a>.</p>"
            },
            {
              "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker①③\">active worker</a> is null, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①\">reject</a> <var>promise</var> with an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror③\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException④\">DOMException</a></code>, and abort these steps.</p>"
            },
            {
              "html": "<p>Unset <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-navigation-preload-enabled-flag\" id=\"ref-for-service-worker-registration-navigation-preload-enabled-flag①\">navigation preload enabled flag</a>.</p>"
            },
            {
              "html": "<p>Resolve <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "navigation-preload-manager-setheadervalue",
      "href": "https://www.w3.org/TR/service-workers/#dom-navigationpreloadmanager-setheadervalue",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"NavigationPreloadManager\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-navigationpreloadmanager-setheadervalue\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>setHeaderValue(<var>value</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise⑤\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel⑥\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>registration</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②②\">this</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\" id=\"ref-for-dfn-service-worker-registration④③\">service worker registration</a>.</p>"
            },
            {
              "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker①④\">active worker</a> is null, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject②\">reject</a> <var>promise</var> with an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror④\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑤\">DOMException</a></code>, and abort these steps.</p>"
            },
            {
              "html": "<p>Set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-navigation-preload-header-value\" id=\"ref-for-service-worker-registration-navigation-preload-header-value\">navigation preload header value</a> to <var>value</var>.</p>"
            },
            {
              "html": "<p>Resolve <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "navigation-preload-manager-getstate",
      "href": "https://www.w3.org/TR/service-workers/#dom-navigationpreloadmanager-getstate",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"NavigationPreloadManager\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-navigationpreloadmanager-getstate\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>getState()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise⑥\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel⑦\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>registration</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②③\">this</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\" id=\"ref-for-dfn-service-worker-registration④④\">service worker registration</a>.</p>"
            },
            {
              "html": "<p>Let <var>state</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dictdef-navigationpreloadstate\" id=\"ref-for-dictdef-navigationpreloadstate①\">NavigationPreloadState</a></code> dictionary.</p>"
            },
            {
              "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-navigation-preload-enabled-flag\" id=\"ref-for-service-worker-registration-navigation-preload-enabled-flag②\">navigation preload enabled flag</a> is set, set <var>state</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-navigationpreloadstate-enabled\" id=\"ref-for-dom-navigationpreloadstate-enabled\">enabled</a></code>\"] to true.</p>"
            },
            {
              "html": "<p>Set <var>state</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-navigationpreloadstate-headervalue\" id=\"ref-for-dom-navigationpreloadstate-headervalue\">headerValue</a></code>\"] to <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-navigation-preload-header-value\" id=\"ref-for-service-worker-registration-navigation-preload-header-value①\">navigation preload header value</a>.</p>"
            },
            {
              "html": "<p>Resolve <var>promise</var> with <var>state</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "service-worker-global-scope-skipwaiting",
      "href": "https://www.w3.org/TR/service-workers/#dom-serviceworkerglobalscope-skipwaiting",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerGlobalScope\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-serviceworkerglobalscope-skipwaiting\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>skipWaiting()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects⑤\">promise</a>.</p>"
        },
        {
          "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel⑧\">in parallel</a>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker④\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-skip-waiting-flag\" id=\"ref-for-dfn-skip-waiting-flag①\">skip waiting flag</a>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#try-activate\" id=\"ref-for-try-activate\">Try Activate</a> with <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker⑤\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration⑤\">containing service worker registration</a>.</p>"
            },
            {
              "html": "<p>Resolve <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "Client/type",
      "href": "https://www.w3.org/TR/service-workers/#dom-client-type",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Client\" data-dfn-type=\"attribute\" data-export=\"\" id=\"dom-client-type\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>type</code></dfn> getter steps are:",
      "rationale": "let",
      "steps": [
        {
          "html": "<p>Let <var>client</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③②\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client③\">service worker client</a>.</p>"
        },
        {
          "html": "If <var>client</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object⑥\">environment settings object</a>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>client</var> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-window-client\" id=\"ref-for-dfn-window-client⑨\">window client</a>, return <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-window\" id=\"ref-for-dom-clienttype-window\">\"window\"</a></code>.</p>"
            },
            {
              "html": "<p>Else if <var>client</var> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-dedicatedworker-client\" id=\"ref-for-dfn-dedicatedworker-client①\">dedicated worker client</a>, return <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-worker\" id=\"ref-for-dom-clienttype-worker\">\"worker\"</a></code>.</p>"
            },
            {
              "html": "<p>Else if <var>client</var> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-sharedworker-client\" id=\"ref-for-dfn-sharedworker-client①\">shared worker client</a>, return <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-sharedworker\" id=\"ref-for-dom-clienttype-sharedworker\">\"sharedworker\"</a></code>.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "return",
          "steps": [
            {
              "html": "<p>Return <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-window\" id=\"ref-for-dom-clienttype-window①\">\"window\"</a></code>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "client-postmessage",
      "href": "https://www.w3.org/TR/service-workers/#dom-client-postmessage",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Client\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-client-postmessage\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>postMessage(<var>message</var>, <var>transfer</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>options</var> be «[ \"transfer\" → <var>transfer</var> ]».</p>"
        },
        {
          "html": "<p>Invoke <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-client-postmessage-message-options\" id=\"ref-for-dom-client-postmessage-message-options③\">postMessage(message, options)</a></code> with <var>message</var> and <var>options</var> as the arguments.</p>"
        }
      ]
    },
    {
      "name": "client-postmessage-options",
      "href": "https://www.w3.org/TR/service-workers/#dom-client-postmessage-message-options",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Client\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"postMessage(message, options)|postMessage(message)\" id=\"dom-client-postmessage-message-options\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>postMessage(<var>message</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>contextObject</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③③\">this</a>.</p>"
        },
        {
          "html": "<p>Let <var>sourceSettings</var> be the <var>contextObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①⑥\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>serializeWithTransferResult</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structuredserializewithtransfer\" id=\"ref-for-structuredserializewithtransfer①\">StructuredSerializeWithTransfer</a>(<var>message</var>, <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#dom-structuredserializeoptions-transfer\" id=\"ref-for-dom-structuredserializeoptions-transfer①\">transfer</a></code>\"]). Rethrow any exceptions.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel⑨\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>targetClient</var> be null.</p>"
            },
            {
              "html": "For each <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client②⑦\">service worker client</a> <var>client</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>client</var> is the <var>contextObject</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client④\">service worker client</a>, set <var>targetClient</var> to <var>client</var>, and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break\">break</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>If <var>targetClient</var> is null, return.</p>"
            },
            {
              "html": "<p>Let <var>destination</var> be the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer\" id=\"ref-for-serviceworkercontainer①④\">ServiceWorkerContainer</a></code> object whose associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-service-worker-client\" id=\"ref-for-serviceworkercontainer-service-worker-client⑧\">service worker client</a> is <var>targetClient</var>.</p>"
            },
            {
              "html": "Add a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task\" id=\"ref-for-concept-task③\">task</a> that runs the following steps to <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-client-message-queue\" id=\"ref-for-dfn-client-message-queue⑤\">client message queue</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>origin</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin①\">serialization</a> of <var>sourceSettings</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin④\">origin</a>.</p>"
                },
                {
                  "html": "<p>Let <var>source</var> be the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object⑥\">getting the service worker object</a> that represents <var>contextObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global③\">relevant global object</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker⑥\">service worker</a> in <var>targetClient</var>.</p>"
                },
                {
                  "html": "<p>Let <var>deserializeRecord</var> be <a data-link-type=\"abstract-op\" href=\"https://html.spec.whatwg.org/multipage/structured-data.html#structureddeserializewithtransfer\" id=\"ref-for-structureddeserializewithtransfer①\">StructuredDeserializeWithTransfer</a>(<var>serializeWithTransferResult</var>, <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm①\">relevant Realm</a>).</p>\n            <p>If this throws an exception, catch it, <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire\">fire an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://www.w3.org/TR/service-workers/#service-worker-container-messageerror-event\" id=\"ref-for-service-worker-container-messageerror-event①\">messageerror</a></code> at <var>destination</var>, using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#messageevent\" id=\"ref-for-messageevent\">MessageEvent</a></code>, with the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-origin\" id=\"ref-for-dom-messageevent-origin\">origin</a></code> attribute initialized to <var>origin</var> and the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-source\" id=\"ref-for-dom-messageevent-source\">source</a></code> attribute initialized to <var>source</var>, and then abort these steps.</p>"
                },
                {
                  "html": "<p>Let <var>messageClone</var> be <var>deserializeRecord</var>.[[Deserialized]].</p>"
                },
                {
                  "html": "<p>Let <var>newPorts</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-frozen-array-type\" id=\"ref-for-dfn-frozen-array-type①\">frozen array</a> consisting of all <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/web-messaging.html#messageport\" id=\"ref-for-messageport①\">MessagePort</a></code> objects in <var>deserializeRecord</var>.[[TransferredValues]], if any.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-dispatch\" id=\"ref-for-concept-event-dispatch③\">Dispatch an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://html.spec.whatwg.org/multipage/indices.html#event-message\" id=\"ref-for-event-message\">message</a></code> at <var>destination</var>, using <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#messageevent\" id=\"ref-for-messageevent①\">MessageEvent</a></code>, with the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-origin\" id=\"ref-for-dom-messageevent-origin①\">origin</a></code> attribute initialized to <var>origin</var>, the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-source\" id=\"ref-for-dom-messageevent-source①\">source</a></code> attribute initialized to <var>source</var>, the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-data\" id=\"ref-for-dom-messageevent-data\">data</a></code> attribute initialized to <var>messageClone</var>, and the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/comms.html#dom-messageevent-ports\" id=\"ref-for-dom-messageevent-ports\">ports</a></code> attribute initialized to <var>newPorts</var>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "client-focus",
      "href": "https://www.w3.org/TR/service-workers/#dom-windowclient-focus",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"WindowClient\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-windowclient-focus\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>focus()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If no <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window③\">Window</a></code> in this <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑧\">origin</a> has <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation\" id=\"ref-for-transient-activation\">transient activation</a>, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects⑥\">promise</a> rejected with an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidaccesserror\" id=\"ref-for-invalidaccesserror\">InvalidAccessError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑥\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>serviceWorkerEventLoop</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/multipage/executable-code-and-execution-contexts.html#surrounding-agent\" id=\"ref-for-surrounding-agent\">surrounding agent</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-agent-event-loop\" id=\"ref-for-concept-agent-event-loop\">event loop</a>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects⑦\">promise</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task⑤\">Queue a task</a> to run the following steps on <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③⑦\">this</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client⑤\">service worker client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop②\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source\" id=\"ref-for-user-interaction-task-source\">user interaction task source</a>:",
          "rationale": "run",
          "steps": [
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#focusing-steps\" id=\"ref-for-focusing-steps\">focusing steps</a> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③⑧\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-browsing-context\" id=\"ref-for-dfn-service-worker-client-browsing-context\">browsing context</a>.</p>"
            },
            {
              "html": "<p>Let <var>frameType</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-frame-type\" id=\"ref-for-get-frame-type\">Get Frame Type</a> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③⑨\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-browsing-context\" id=\"ref-for-dfn-service-worker-client-browsing-context①\">browsing context</a>.</p>"
            },
            {
              "html": "<p>Let <var>visibilityState</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④⓪\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-browsing-context\" id=\"ref-for-dfn-service-worker-client-browsing-context②\">browsing context</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①\">active document</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/page-visibility/#dom-document-visibilitystate\" id=\"ref-for-dom-document-visibilitystate①\">visibilityState</a></code> attribute value.</p>"
            },
            {
              "html": "<p>Let <var>focusState</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#has-focus-steps\" id=\"ref-for-has-focus-steps\">has focus steps</a> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④①\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-browsing-context\" id=\"ref-for-dfn-service-worker-client-browsing-context③\">browsing context</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document②\">active document</a>.</p>"
            },
            {
              "html": "<p>Let <var>ancestorOriginsList</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④②\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-browsing-context\" id=\"ref-for-dfn-service-worker-client-browsing-context④\">browsing context</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document③\">active document</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global④\">relevant global object</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#location\" id=\"ref-for-location\">Location</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-location-ancestor-origins-list\" id=\"ref-for-concept-location-ancestor-origins-list\">ancestor origins list</a>’s associated list.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task⑥\">Queue a task</a> to run the following steps on <var>serviceWorkerEventLoop</var> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source③\">DOM manipulation task source</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>windowClient</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-window-client\" id=\"ref-for-create-window-client\">Create Window Client</a> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④③\">this</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client⑥\">service worker client</a>, <var>frameType</var>, <var>visibilityState</var>, <var>focusState</var>, and <var>ancestorOriginsList</var>.</p>"
                },
                {
                  "html": "<p>If <var>windowClient</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-focusstate\" id=\"ref-for-dfn-service-worker-client-focusstate①\">focus state</a> is true, resolve <var>promise</var> with <var>windowClient</var>.</p>"
                },
                {
                  "html": "<p>Else, reject <var>promise</var> with a <code>TypeError</code>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "client-navigate",
      "href": "https://www.w3.org/TR/service-workers/#dom-windowclient-navigate",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"WindowClient\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-windowclient-navigate\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>navigate(url)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>url</var> be the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser③\">parsing</a> <var>url</var> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④④\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①⑦\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#api-base-url\" id=\"ref-for-api-base-url③\">API base URL</a>.</p>"
        },
        {
          "html": "<p>If <var>url</var> is failure, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects⑧\">promise</a> rejected with a <code>TypeError</code>.</p>"
        },
        {
          "html": "<p>If <var>url</var> is <code>about:blank</code>, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects⑨\">promise</a> rejected with a <code>TypeError</code>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④⑤\">this</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client⑦\">service worker client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker②①\">active service worker</a> is not <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④⑥\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global⑤\">relevant global object</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker⑦\">service worker</a>, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①⓪\">promise</a> rejected with a <code>TypeError</code>.</p>"
        },
        {
          "html": "<p>Let <var>serviceWorkerEventLoop</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object\" id=\"ref-for-current-global-object\">current global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop⑥\">event loop</a>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①①\">promise</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task⑦\">Queue a task</a> to run the following steps on <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④⑦\">this</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client⑧\">service worker client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop③\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source\" id=\"ref-for-user-interaction-task-source①\">user interaction task source</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>browsingContext</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④⑧\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-browsing-context\" id=\"ref-for-dfn-service-worker-client-browsing-context⑤\">browsing context</a>.</p>"
            },
            {
              "html": "<p>If <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window①\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active\">fully active</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task⑧\">queue a task</a> to reject <var>promise</var> with a <code>TypeError</code>, on <var>serviceWorkerEventLoop</var> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source④\">DOM manipulation task source</a>, and abort these steps.</p>"
            },
            {
              "html": "<p><em>HandleNavigate</em>: <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate\" id=\"ref-for-navigate④\">Navigate</a> <var>browsingContext</var> to <var>url</var>, using <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window②\">associated document</a>, with <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#exceptions-enabled\" id=\"ref-for-exceptions-enabled\">exceptionsEnabled</a> true.</p>"
            },
            {
              "html": "<p>If the algorithm steps invoked in the step labeled <em>HandleNavigate</em> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw\">throws</a> an exception, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task⑨\">queue a task</a> to reject <var>promise</var> with the exception, on <var>serviceWorkerEventLoop</var> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑤\">DOM manipulation task source</a>, and abort these steps.</p>"
            },
            {
              "html": "<p>Let <var>frameType</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-frame-type\" id=\"ref-for-get-frame-type①\">Get Frame Type</a> with <var>browsingContext</var>.</p>"
            },
            {
              "html": "<p>Let <var>visibilityState</var> be <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document④\">active document</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/page-visibility/#dom-document-visibilitystate\" id=\"ref-for-dom-document-visibilitystate②\">visibilityState</a></code> attribute value.</p>"
            },
            {
              "html": "<p>Let <var>focusState</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#has-focus-steps\" id=\"ref-for-has-focus-steps①\">has focus steps</a> with <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document⑤\">active document</a>.</p>"
            },
            {
              "html": "<p>Let <var>ancestorOriginsList</var> be <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document⑥\">active document</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global⑥\">relevant global object</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#location\" id=\"ref-for-location①\">Location</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-location-ancestor-origins-list\" id=\"ref-for-concept-location-ancestor-origins-list①\">ancestor origins list</a>’s associated list.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①⓪\">Queue a task</a> to run the following steps on <var>serviceWorkerEventLoop</var> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑥\">DOM manipulation task source</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>browsingContext</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window④\">Window</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object⑦\">environment settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url④\">creation URL</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①\">origin</a> is not the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin③\">same</a> as the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker⑧\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin⑤\">origin</a>, resolve <var>promise</var> with null and abort these steps.</p>"
                },
                {
                  "html": "<p>Let <var>windowClient</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-window-client\" id=\"ref-for-create-window-client①\">Create Window Client</a> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④⑨\">this</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client⑨\">service worker client</a>, <var>frameType</var>, <var>visibilityState</var>, <var>focusState</var>, and <var>ancestorOriginsList</var>.</p>"
                },
                {
                  "html": "<p>Resolve <var>promise</var> with <var>windowClient</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "clients-get",
      "href": "https://www.w3.org/TR/service-workers/#dom-clients-get",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Clients\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-clients-get\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>get(<var>id</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①②\">promise</a>.</p>"
        },
        {
          "html": "Run these substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①⓪\">in parallel</a>:",
          "rationale": "for",
          "steps": [
            {
              "html": "For each <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client②⑧\">service worker client</a> <var>client</var> where the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key③\">obtain a storage key</a> given <var>client</var> <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-key-equal\" id=\"ref-for-storage-key-equal①\">equals</a> the associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker⑨\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration⑥\">containing service worker registration</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key④\">storage key</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id\" id=\"ref-for-concept-environment-id①\">id</a> is not <var>id</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue\">continue</a>.</p>"
                },
                {
                  "html": "<p>Wait for either <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-execution-ready-flag\" id=\"ref-for-concept-environment-execution-ready-flag\">execution ready flag</a> to be set or for <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-client-discarded-flag\" id=\"ref-for-service-worker-client-discarded-flag②\">discarded flag</a> to be set.</p>"
                },
                {
                  "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-execution-ready-flag\" id=\"ref-for-concept-environment-execution-ready-flag①\">execution ready flag</a> is set, then invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#resolve-get-client-promise\" id=\"ref-for-resolve-get-client-promise\">Resolve Get Client Promise</a> with <var>client</var> and <var>promise</var>, and abort these steps.</p>"
                }
              ]
            },
            {
              "html": "<p>Resolve <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "clients-matchall",
      "href": "https://www.w3.org/TR/service-workers/#dom-clients-matchall",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Clients\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"matchAll(options)|matchAll()\" id=\"dom-clients-matchall\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>matchAll(<var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise⑦\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①①\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>targetClients</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list④\">list</a>.</p>"
            },
            {
              "html": "For each <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client②⑨\">service worker client</a> <var>client</var> where the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key④\">obtain a storage key</a> given <var>client</var> <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-key-equal\" id=\"ref-for-storage-key-equal②\">equals</a> the associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①⓪\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration⑦\">containing service worker registration</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key⑤\">storage key</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-execution-ready-flag\" id=\"ref-for-concept-environment-execution-ready-flag②\">execution ready flag</a> is unset or <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-client-discarded-flag\" id=\"ref-for-service-worker-client-discarded-flag③\">discarded flag</a> is set, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①\">continue</a>.</p>"
                },
                {
                  "html": "<p>If <var>client</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context\" id=\"ref-for-secure-context\">secure context</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue②\">continue</a>.</p>"
                },
                {
                  "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clientqueryoptions-includeuncontrolled\" id=\"ref-for-dom-clientqueryoptions-includeuncontrolled\">includeUncontrolled</a></code>\"] is false, and if <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker②②\">active service worker</a> is not the associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①①\">service worker</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue③\">continue</a>.</p>"
                },
                {
                  "html": "<p>Add <var>client</var> to <var>targetClients</var>.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>matchedWindowData</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑤\">list</a>.</p>"
            },
            {
              "html": "<p>Let <var>matchedClients</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑥\">list</a>.</p>"
            },
            {
              "html": "For each <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client③⓪\">service worker client</a> <var>client</var> in <var>targetClients</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clientqueryoptions-type\" id=\"ref-for-dom-clientqueryoptions-type\">type</a></code>\"] is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-window\" id=\"ref-for-dom-clienttype-window②\">\"window\"</a></code> or <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-all\" id=\"ref-for-dom-clienttype-all\">\"all\"</a></code>, and <var>client</var> is not an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object⑧\">environment settings object</a> or is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-window-client\" id=\"ref-for-dfn-window-client①⓪\">window client</a>, then:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>windowData</var> be «[ \"client\" → <var>client</var>, \"ancestorOriginsList\" → a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑦\">list</a> ]».</p>"
                    },
                    {
                      "html": "<p>Let <var>browsingContext</var> be null.</p>"
                    },
                    {
                      "html": "<p>Let <var>isClientEnumerable</var> be true.</p>"
                    },
                    {
                      "html": "<p>If <var>client</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object⑨\">environment settings object</a>, set <var>browsingContext</var> to <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global\" id=\"ref-for-concept-settings-object-global⑥\">global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context\" id=\"ref-for-browsing-context⑥\">browsing context</a>.</p>"
                    },
                    {
                      "html": "<p>Else, set <var>browsingContext</var> to <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context\">target browsing context</a>.</p>"
                    },
                    {
                      "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①①\">Queue a task</a> <var>task</var> to run the following substeps on <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop⑦\">event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source\" id=\"ref-for-user-interaction-task-source②\">user interaction task source</a>:",
                      "rationale": "if",
                      "steps": [
                        {
                          "html": "<p>If <var>browsingContext</var> has been <a data-link-type=\"dfn\" href=\"https://wicg.github.io/page-lifecycle/#discarded\" id=\"ref-for-discarded\">discarded</a>, then set <var>isClientEnumerable</var> to false and abort these steps.</p>"
                        },
                        {
                          "html": "<p>If <var>client</var> is a window client and <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window③\">associated document</a> is not <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document⑦\">active document</a>, then set <var>isClientEnumerable</var> to false and abort these steps.</p>"
                        },
                        {
                          "html": "<p>Set <var>windowData</var>[\"<code>frameType</code>\"] to the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-frame-type\" id=\"ref-for-get-frame-type②\">Get Frame Type</a> with <var>browsingContext</var>.</p>"
                        },
                        {
                          "html": "<p>Set <var>windowData</var>[\"<code>visibilityState</code>\"] to <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document⑧\">active document</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/page-visibility/#dom-document-visibilitystate\" id=\"ref-for-dom-document-visibilitystate③\">visibilityState</a></code> attribute value.</p>"
                        },
                        {
                          "html": "<p>Set <var>windowData</var>[\"<code>focusState</code>\"] to the result of running the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#has-focus-steps\" id=\"ref-for-has-focus-steps②\">has focus steps</a> with <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document⑨\">active document</a> as the argument.</p>"
                        },
                        {
                          "html": "<p>If <var>client</var> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-window-client\" id=\"ref-for-dfn-window-client①①\">window client</a>, then set <var>windowData</var>[\"<code>ancestorOriginsList</code>\"] to <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①⓪\">active document</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global⑦\">relevant global object</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#location\" id=\"ref-for-location②\">Location</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-location-ancestor-origins-list\" id=\"ref-for-concept-location-ancestor-origins-list②\">ancestor origins list</a>’s associated list.</p>"
                        }
                      ]
                    },
                    {
                      "html": "<p>Wait for <var>task</var> to have executed.</p>"
                    },
                    {
                      "html": "If <var>isClientEnumerable</var> is true, then:",
                      "rationale": "add",
                      "steps": [
                        {
                          "html": "<p>Add <var>windowData</var> to <var>matchedWindowData</var>.</p>"
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "Else if <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clientqueryoptions-type\" id=\"ref-for-dom-clientqueryoptions-type①\">type</a></code>\"] is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-worker\" id=\"ref-for-dom-clienttype-worker①\">\"worker\"</a></code> or <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-all\" id=\"ref-for-dom-clienttype-all①\">\"all\"</a></code> and <var>client</var> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-dedicatedworker-client\" id=\"ref-for-dfn-dedicatedworker-client②\">dedicated worker client</a>, or <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clientqueryoptions-type\" id=\"ref-for-dom-clientqueryoptions-type②\">type</a></code>\"] is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-sharedworker\" id=\"ref-for-dom-clienttype-sharedworker①\">\"sharedworker\"</a></code> or <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-clienttype-all\" id=\"ref-for-dom-clienttype-all②\">\"all\"</a></code> and <var>client</var> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-sharedworker-client\" id=\"ref-for-dfn-sharedworker-client②\">shared worker client</a>, then:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add <var>client</var> to <var>matchedClients</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①②\">Queue a task</a> to run the following steps on <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①⑧\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop④\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑦\">DOM manipulation task source</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>clientObjects</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑧\">list</a>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②\">For each</a> <var>windowData</var> in <var>matchedWindowData</var>:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>windowClient</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-window-client\" id=\"ref-for-create-window-client②\">Create Window Client</a> algorithm with <var>windowData</var>[\"<code>client</code>\"], <var>windowData</var>[\"<code>frameType</code>\"], <var>windowData</var>[\"<code>visibilityState</code>\"], <var>windowData</var>[\"<code>focusState</code>\"], and <var>windowData</var>[\"<code>ancestorOriginsList</code>\"] as the arguments.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append②\">Append</a> <var>windowClient</var> to <var>clientObjects</var>.</p>"
                    }
                  ]
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate③\">For each</a> <var>client</var> in <var>matchedClients</var>:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>clientObject</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-client\" id=\"ref-for-create-client\">Create Client</a> algorithm with <var>client</var> as the argument.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append③\">Append</a> <var>clientObject</var> to <var>clientObjects</var>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Sort <var>clientObjects</var> such that:</p>\n            <ul>\n             <li data-md=\"\">\n              <p><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#windowclient\" id=\"ref-for-windowclient⑧\">WindowClient</a></code> objects whose <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-browsing-context\" id=\"ref-for-dfn-service-worker-client-browsing-context⑥\">browsing context</a> has been <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#focusing-steps\" id=\"ref-for-focusing-steps①\">focused</a> are placed first, sorted in the most recently <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#focusing-steps\" id=\"ref-for-focusing-steps②\">focused</a> order.</p>\n             </li><li data-md=\"\">\n              <p><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#windowclient\" id=\"ref-for-windowclient⑨\">WindowClient</a></code> objects whose <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-browsing-context\" id=\"ref-for-dfn-service-worker-client-browsing-context⑦\">browsing context</a> has never been <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#focusing-steps\" id=\"ref-for-focusing-steps③\">focused</a> are placed next, sorted in their <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client①⓪\">service worker client</a>’s creation order.</p>\n             </li><li data-md=\"\">\n              <p><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#client\" id=\"ref-for-client⑦\">Client</a></code> objects whose associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client①①\">service worker client</a> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-worker-client\" id=\"ref-for-dfn-worker-client①⓪\">worker client</a> are placed next, sorted in their <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client①②\">service worker client</a>’s creation order.</p>\n            </li></ul>"
                },
                {
                  "html": "<p>Resolve <var>promise</var> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-frozen-array\" id=\"ref-for-dfn-create-frozen-array①\">a new frozen array of</a> <var>clientObjects</var> in <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm②\">relevant Realm</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "clients-openwindow",
      "href": "https://www.w3.org/TR/service-workers/#dom-clients-openwindow",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Clients\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-clients-openwindow\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>openWindow(<var>url</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>url</var> be the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser④\">parsing</a> <var>url</var> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤⓪\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①⑨\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#api-base-url\" id=\"ref-for-api-base-url④\">API base URL</a>.</p>"
        },
        {
          "html": "<p>If <var>url</var> is failure, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①③\">promise</a> rejected with a <code>TypeError</code>.</p>"
        },
        {
          "html": "<p>If <var>url</var> is <code>about:blank</code>, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①④\">promise</a> rejected with a <code>TypeError</code>.</p>"
        },
        {
          "html": "<p>If no <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window⑤\">Window</a></code> in this <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑨\">origin</a> has <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation\" id=\"ref-for-transient-activation①\">transient activation</a>, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①⑤\">promise</a> rejected with an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidaccesserror\" id=\"ref-for-invalidaccesserror①\">InvalidAccessError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑦\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>serviceWorkerEventLoop</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object\" id=\"ref-for-current-global-object①\">current global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop⑧\">event loop</a>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①⑥\">promise</a>.</p>"
        },
        {
          "html": "Run these substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①②\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>newContext</var> be a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context\" id=\"ref-for-top-level-browsing-context\">top-level browsing context</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①③\">Queue a task</a> to run the following steps on <var>newContext</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window⑥\">Window</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①⓪\">environment settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop⑤\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source\" id=\"ref-for-user-interaction-task-source③\">user interaction task source</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p><em>HandleNavigate</em>: <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate\" id=\"ref-for-navigate⑤\">Navigate</a> <var>newContext</var> to <var>url</var> with <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#exceptions-enabled\" id=\"ref-for-exceptions-enabled①\">exceptionsEnabled</a> true, and <i><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-hh\" id=\"ref-for-navigation-hh\">historyHandling</a></i> \"<code>replace</code>\".</p>"
                },
                {
                  "html": "<p>If the algorithm steps invoked in the step labeled <em>HandleNavigate</em> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①\">throws</a> an exception, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①④\">queue a task</a> to reject <var>promise</var> with the exception, on <var>serviceWorkerEventLoop</var> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑧\">DOM manipulation task source</a>, and abort these steps.</p>"
                },
                {
                  "html": "<p>Let <var>frameType</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-frame-type\" id=\"ref-for-get-frame-type③\">Get Frame Type</a> with <var>newContext</var>.</p>"
                },
                {
                  "html": "<p>Let <var>visibilityState</var> be <var>newContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①①\">active document</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/page-visibility/#dom-document-visibilitystate\" id=\"ref-for-dom-document-visibilitystate④\">visibilityState</a></code> attribute value.</p>"
                },
                {
                  "html": "<p>Let <var>focusState</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#has-focus-steps\" id=\"ref-for-has-focus-steps③\">has focus steps</a> with <var>newContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①②\">active document</a> as the argument.</p>"
                },
                {
                  "html": "<p>Let <var>ancestorOriginsList</var> be <var>newContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①③\">active document</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global⑧\">relevant global object</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#location\" id=\"ref-for-location③\">Location</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-location-ancestor-origins-list\" id=\"ref-for-concept-location-ancestor-origins-list③\">ancestor origins list</a>’s associated list.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①⑤\">Queue a task</a> to run the following steps on <var>serviceWorkerEventLoop</var> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑨\">DOM manipulation task source</a>:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key⑤\">obtain a storage key</a> given <var>newContext</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window⑦\">Window</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①①\">environment settings object</a> is not <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-key-equal\" id=\"ref-for-storage-key-equal③\">equal</a> to the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①②\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration⑧\">containing service worker registration</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key⑥\">storage key</a>, then resolve <var>promise</var> with null and abort these steps.</p>"
                    },
                    {
                      "html": "<p>Let <var>client</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-window-client\" id=\"ref-for-create-window-client③\">Create Window Client</a> with <var>newContext</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window⑧\">Window</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①②\">environment settings object</a>, <var>frameType</var>, <var>visibilityState</var>, <var>focusState</var>, and <var>ancestorOriginsList</var> as the arguments.</p>"
                    },
                    {
                      "html": "<p>Resolve <var>promise</var> with <var>client</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "clients-claim",
      "href": "https://www.w3.org/TR/service-workers/#dom-clients-claim",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Clients\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-clients-claim\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>claim()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①③\">service worker</a> is not an <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker①⑥\">active worker</a>, return a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①⑦\">promise</a> rejected with an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror⑤\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑧\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects①⑧\">promise</a>.</p>"
        },
        {
          "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①③\">in parallel</a>:",
          "rationale": "for",
          "steps": [
            {
              "html": "For each <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client③①\">service worker client</a> <var>client</var> where the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key⑥\">obtain a storage key</a> given <var>client</var> <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-key-equal\" id=\"ref-for-storage-key-equal④\">equals</a> the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①④\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration⑨\">containing service worker registration</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key⑦\">storage key</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-execution-ready-flag\" id=\"ref-for-concept-environment-execution-ready-flag③\">execution ready flag</a> is unset or <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-client-discarded-flag\" id=\"ref-for-service-worker-client-discarded-flag④\">discarded flag</a> is set, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue④\">continue</a>.</p>"
                },
                {
                  "html": "<p>If <var>client</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context\" id=\"ref-for-secure-context①\">secure context</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑤\">continue</a>.</p>"
                },
                {
                  "html": "<p>Let <var>storage key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key⑦\">obtain a storage key</a> given <var>client</var>.</p>"
                },
                {
                  "html": "<p>Let <var>registration</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-service-worker-registration\" id=\"ref-for-match-service-worker-registration⑤\">Match Service Worker Registration</a> given <var>storage key</var> and <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url⑤\">creation URL</a>.</p>"
                },
                {
                  "html": "<p>If <var>registration</var> is not the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①⑤\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration①⓪\">containing service worker registration</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑥\">continue</a>.</p>"
                },
                {
                  "html": "If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker②③\">active service worker</a> is not the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①⑦\">service worker</a>, then:",
                  "rationale": "invoke",
                  "steps": [
                    {
                      "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#handle-service-worker-client-unload\" id=\"ref-for-handle-service-worker-client-unload\">Handle Service Worker Client Unload</a> with <var>client</var> as the argument.</p>"
                    },
                    {
                      "html": "<p>Set <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker②④\">active service worker</a> to <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①⑧\">service worker</a>.</p>"
                    },
                    {
                      "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#notify-controller-change\" id=\"ref-for-notify-controller-change\">Notify Controller Change</a> algorithm with <var>client</var> as the argument.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Resolve <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "add-lifetime-promise",
      "href": "https://www.w3.org/TR/service-workers/#extendableevent-add-lifetime-promise",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>event</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#dom-event-istrusted\" id=\"ref-for-dom-event-istrusted\">isTrusted</a></code> attribute is false, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw②\">throw</a> an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror⑥\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑨\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>If <var>event</var> is not <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-active\" id=\"ref-for-extendableevent-active\">active</a>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw③\">throw</a> an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror⑦\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⓪\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Add <var>promise</var> to <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-extend-lifetime-promises\" id=\"ref-for-extendableevent-extend-lifetime-promises①\">extend lifetime promises</a>.</p>"
        },
        {
          "html": "<p>Increment <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-pending-promises-count\" id=\"ref-for-extendableevent-pending-promises-count②\">pending promises count</a> by one.</p>"
        },
        {
          "html": "Upon <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment\">fulfillment</a> or <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection\">rejection</a> of <var>promise</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask\" id=\"ref-for-queue-a-microtask\">queue a microtask</a> to run these substeps:",
          "rationale": "decrement",
          "steps": [
            {
              "html": "<p>Decrement <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-pending-promises-count\" id=\"ref-for-extendableevent-pending-promises-count④\">pending promises count</a> by one.</p>"
            },
            {
              "html": "If <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-pending-promises-count\" id=\"ref-for-extendableevent-pending-promises-count⑤\">pending promises count</a> is 0, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>registration</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object\" id=\"ref-for-current-global-object②\">current global object</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker①⑨\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration①②\">containing service worker registration</a>.</p>"
                },
                {
                  "html": "<p>If <var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration-unregistered\" id=\"ref-for-dfn-service-worker-registration-unregistered②\">unregistered</a>, invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#try-clear-registration\" id=\"ref-for-try-clear-registration\">Try Clear Registration</a> with <var>registration</var>.</p>"
                },
                {
                  "html": "<p>If <var>registration</var> is not null, invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#try-activate\" id=\"ref-for-try-activate①\">Try Activate</a> with <var>registration</var>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "InstallEvent/addRoutes(rules)",
      "href": "https://www.w3.org/TR/service-workers/#dom-installevent-addroutes",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"InstallEvent\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-installevent-addroutes\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>addRoutes(<var>rules</var>)</code></dfn> method steps are:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>If <var>rules</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dictdef-routerrule\" id=\"ref-for-dictdef-routerrule③\">RouterRule</a></code> dictionary, set <var>rules</var> to « <var>rules</var> ».</p>"
        },
        {
          "html": "<p>Let <var>serviceWorker</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object\" id=\"ref-for-current-global-object③\">current global object</a>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker②⓪\">service worker</a>.</p>"
        },
        {
          "html": "For each <var>rule</var> of <var>rules</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#verify-router-condition\" id=\"ref-for-verify-router-condition\">Verify Router Condition</a> algorithm with <var>rule</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routerrule-condition\" id=\"ref-for-dom-routerrule-condition\">condition</a></code>\"] and <var>serviceWorker</var> returns false, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>If <var>rule</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routerrule-source\" id=\"ref-for-dom-routerrule-source\">source</a></code>\"] is either of \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourceenum-fetch-event\" id=\"ref-for-dom-routersourceenum-fetch-event\">fetch-event</a></code>\" or \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourceenum-race-network-and-fetch-handler\" id=\"ref-for-dom-routersourceenum-race-network-and-fetch-handler①\">race-network-and-fetch-handler</a></code>\", and <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-event-types-to-handle\" id=\"ref-for-dfn-set-of-event-types-to-handle\">set of event types to handle</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain\">contain</a> <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://www.w3.org/TR/service-workers/#service-worker-global-scope-fetch-event\" id=\"ref-for-service-worker-global-scope-fetch-event③\">fetch</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①\">TypeError</a></code>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>lifetimePromise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects②④\">promise</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-add-lifetime-promise\" id=\"ref-for-extendableevent-add-lifetime-promise①\">Add lifetime promise</a> <var>lifetimePromise</var> to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤②\">this</a>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects②⑤\">promise</a>.</p>"
        },
        {
          "html": "<p>Upon <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment①\">fulfillment</a> or <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection①\">rejection</a> of <var>promise</var>, resolve <var>lifetimePromise</var> with undefined.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-enqueue\" id=\"ref-for-queue-enqueue\">Enqueue</a> the following steps to <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-service-worker-queue\" id=\"ref-for-service-worker-service-worker-queue\">[[service worker queue]]</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>allRules</var> be a copy of <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-list-of-router-rules\" id=\"ref-for-service-worker-list-of-router-rules\">list of router rules</a>.</p>"
            },
            {
              "html": "For each <var>rule</var> of <var>rules</var>:",
              "rationale": "append",
              "steps": [
                {
                  "html": "<p>Append <var>rule</var> to <var>allRules</var>.</p>"
                }
              ]
            },
            {
              "html": "<p>If running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#check-router-registration-limit\" id=\"ref-for-check-router-registration-limit\">Check Router Registration Limit</a> with <var>allRules</var> returns false, reject <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>Set <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-list-of-router-rules\" id=\"ref-for-service-worker-list-of-router-rules①\">list of router rules</a> to <var>allRules</var>.</p>"
            },
            {
              "html": "<p>Let <var>serviceWorkerEventLoop</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object\" id=\"ref-for-current-global-object④\">current global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop⑨\">event loop</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①⑥\">Queue a task</a> to run the following steps on <var>serviceWorkerEventLoop</var> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⓪\">DOM manipulation task source</a>:",
              "rationale": "resolve",
              "steps": [
                {
                  "html": "<p>Resolve <var>promise</var> with undefined.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "fetch-event-respondwith",
      "href": "https://www.w3.org/TR/service-workers/#dom-fetchevent-respondwith",
      "html": "<dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"FetchEvent\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-fetchevent-respondwith\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>respondWith(<var>r</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>event</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤③\">this</a>.</p>"
        },
        {
          "html": "<p>If <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#dispatch-flag\" id=\"ref-for-dispatch-flag①\">dispatch flag</a> is unset, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw④\">throw</a> an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror⑧\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①①\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>If <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-respond-with-entered-flag\" id=\"ref-for-fetchevent-respond-with-entered-flag\">respond-with entered flag</a> is set, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑤\">throw</a> an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror⑨\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①②\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-add-lifetime-promise\" id=\"ref-for-extendableevent-add-lifetime-promise②\">Add lifetime promise</a> <var>r</var> to <var>event</var>.</p>"
        },
        {
          "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#stop-propagation-flag\" id=\"ref-for-stop-propagation-flag\">stop propagation flag</a> and <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#stop-immediate-propagation-flag\" id=\"ref-for-stop-immediate-propagation-flag\">stop immediate propagation flag</a>.</p>"
        },
        {
          "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-respond-with-entered-flag\" id=\"ref-for-fetchevent-respond-with-entered-flag①\">respond-with entered flag</a>.</p>"
        },
        {
          "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-wait-to-respond-flag\" id=\"ref-for-fetchevent-wait-to-respond-flag\">wait to respond flag</a>.</p>"
        },
        {
          "html": "<p>Let <var>targetRealm</var> be <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm③\">relevant Realm</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection②\">Upon rejection</a> of <var>r</var>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-respond-with-error-flag\" id=\"ref-for-fetchevent-respond-with-error-flag\">respond-with error flag</a>.</p>"
            },
            {
              "html": "<p>Unset <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-wait-to-respond-flag\" id=\"ref-for-fetchevent-wait-to-respond-flag①\">wait to respond flag</a>.</p>"
            }
          ]
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment②\">Upon fulfillment</a> of <var>r</var> with <var>response</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>response</var> is not a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#response\" id=\"ref-for-response③\">Response</a></code> object, then set the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-respond-with-error-flag\" id=\"ref-for-fetchevent-respond-with-error-flag①\">respond-with error flag</a>.</p>"
            },
            {
              "html": "Else:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>bytes</var> be an empty byte sequence.</p>"
                },
                {
                  "html": "<p>Let <var>end-of-body</var> be false.</p>"
                },
                {
                  "html": "<p>Let <var>done</var> be false.</p>"
                },
                {
                  "html": "<p>Let <var>potentialResponse</var> be a copy of <var>response</var>’s associated <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-response\" id=\"ref-for-concept-response-response\">response</a>, except for its <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body\">body</a>.</p>"
                },
                {
                  "html": "If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body①\">body</a> is non-null, run these substeps:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>reader</var> be the result of <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-get-a-reader\" id=\"ref-for-readablestream-get-a-reader\">getting a reader</a> from <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body②\">body</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-body-stream\" id=\"ref-for-concept-body-stream\">stream</a>.</p>"
                    },
                    {
                      "html": "Let <var>pullAlgorithm</var> be an action that runs these steps:",
                      "rationale": "let",
                      "steps": [
                        {
                          "html": "<p>Let <var>readRequest</var> be a new <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#read-request\" id=\"ref-for-read-request\">read request</a> with the following <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#struct-item\" id=\"ref-for-struct-item①\">items</a>:</p>\n                <dl>\n                 <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#read-request-chunk-steps\" id=\"ref-for-read-request-chunk-steps\">chunk steps</a>, given <var>chunk</var>\n                 </dt><dd data-md=\"\">\n                  \n                 </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#read-request-close-steps\" id=\"ref-for-read-request-close-steps\">close steps</a>\n                 </dt><dd data-md=\"\">\n                  \n                 </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#read-request-error-steps\" id=\"ref-for-read-request-error-steps\">error steps</a>\n                 </dt><dd data-md=\"\">\n                  \n                </dd></dl>",
                          "rationale": "assert",
                          "steps": [
                            {
                              "html": "<p class=\"assertion\">Assert: <var>chunk</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-Uint8Array\" id=\"ref-for-idl-Uint8Array\">Uint8Array</a></code>.</p>"
                            },
                            {
                              "html": "<p>Append the bytes represented by <var>chunk</var> to <var>bytes</var>.</p>"
                            },
                            {
                              "html": "<p>Increment <var>potentialResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body-info\" id=\"ref-for-concept-response-body-info\">body info</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-timing-info-encoded-body-size\" id=\"ref-for-fetch-timing-info-encoded-body-size\">encoded size</a> by <var>bytes</var>’s <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#buffersource-byte-length\" id=\"ref-for-buffersource-byte-length\">byte length</a>.</p>"
                            },
                            {
                              "html": "<p>Increment <var>potentialResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body-info\" id=\"ref-for-concept-response-body-info①\">body info</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-timing-info-decoded-body-size\" id=\"ref-for-fetch-timing-info-decoded-body-size\">decoded size</a> by <var>bytes</var>’s <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#buffersource-byte-length\" id=\"ref-for-buffersource-byte-length①\">byte length</a>.</p>"
                            },
                            {
                              "html": "<p>Perform ! <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-detacharraybuffer\" id=\"ref-for-sec-detacharraybuffer\">DetachArrayBuffer</a>(<var>chunk</var>.[[ViewedArrayBuffer]]).</p>"
                            }
                          ],
                          "additional": [
                            {
                              "html": "",
                              "rationale": "set",
                              "steps": [
                                {
                                  "html": "<p>Set <var>end-of-body</var> to true.</p>"
                                }
                              ]
                            },
                            {
                              "html": "",
                              "rationale": "error",
                              "steps": [
                                {
                                  "html": "<p><a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-error\" id=\"ref-for-readablestream-error\">error</a> <var>newStream</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③\">TypeError</a></code>.</p>"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestreamdefaultreader-read-a-chunk\" id=\"ref-for-readablestreamdefaultreader-read-a-chunk\">Read a chunk</a> from <var>reader</var> given <var>readRequest</var>.</p>"
                        }
                      ]
                    },
                    {
                      "html": "<p>Let <var>cancelAlgorithm</var> be an action that <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestreamdefaultreader-cancel\" id=\"ref-for-readablestreamdefaultreader-cancel\">cancels</a> <var>reader</var>.</p>"
                    },
                    {
                      "html": "<p>Let <var>highWaterMark</var> be a non-negative, non-NaN number, chosen by the user agent.</p>"
                    },
                    {
                      "html": "<p>Let <var>sizeAlgorithm</var> be an algorithm that accepts a <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#chunk\" id=\"ref-for-chunk\">chunk</a> object and returns a non-negative, non-NaN, non-infinite number, chosen by the user agent.</p>"
                    },
                    {
                      "html": "<p>Let <var>newStream</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://streams.spec.whatwg.org/#readablestream\" id=\"ref-for-readablestream\">ReadableStream</a></code>, <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-set-up\" id=\"ref-for-readablestream-set-up\">set up</a> with the <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-set-up-pullalgorithm\" id=\"ref-for-readablestream-set-up-pullalgorithm\">pullAlgorithm</a> <var>pullAlgorithm</var>, the <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-set-up-cancelalgorithm\" id=\"ref-for-readablestream-set-up-cancelalgorithm\">cancelAlgorithm</a> <var>cancelAlgorithm</var>, the <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-set-up-highwatermark\" id=\"ref-for-readablestream-set-up-highwatermark\">highWaterMark</a> <var>highWaterMark</var>, and <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-set-up-sizealgorithm\" id=\"ref-for-readablestream-set-up-sizealgorithm\">sizeAlgorithm</a> <var>sizeAlgorithm</var>, in <var>targetRealm</var>.</p>"
                    },
                    {
                      "html": "<p>Set <var>potentialResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body③\">body</a> to a new <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-body\" id=\"ref-for-concept-body\">body</a> whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-body-stream\" id=\"ref-for-concept-body-stream①\">stream</a> is <var>newStream</var>.</p>"
                    },
                    {
                      "html": "Run these subsubsteps repeatedly <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①④\">in parallel</a> while <var>done</var> is false:",
                      "rationale": "if",
                      "steps": [
                        {
                          "html": "<p>If <var>newStream</var> is <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-errored\" id=\"ref-for-readablestream-errored\">errored</a>, then set <var>done</var> to true.</p>"
                        },
                        {
                          "html": "<p>Otherwise, if <var>bytes</var> is empty and <var>end-of-body</var> is true, then <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-close\" id=\"ref-for-readablestream-close\">close</a> <var>newStream</var> and set <var>done</var> to true.</p>"
                        },
                        {
                          "html": "Otherwise, if <var>bytes</var> is not empty, run these subsubsubsteps:",
                          "rationale": "let",
                          "steps": [
                            {
                              "html": "<p>Let <var>chunk</var> be a subsequence of <var>bytes</var> starting from the beginning of <var>bytes</var>.</p>"
                            },
                            {
                              "html": "<p>Remove <var>chunk</var> from <var>bytes</var>.</p>"
                            },
                            {
                              "html": "<p>Let <var>buffer</var> be an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-ArrayBuffer\" id=\"ref-for-idl-ArrayBuffer\">ArrayBuffer</a></code> object created in <var>targetRealm</var> and containing <var>chunk</var>.</p>"
                            },
                            {
                              "html": "<p><a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-enqueue\" id=\"ref-for-readablestream-enqueue\">Enqueue</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-Uint8Array\" id=\"ref-for-idl-Uint8Array①\">Uint8Array</a></code> object created in <var>targetRealm</var> and wrapping <var>buffer</var> to <var>newStream</var>.</p>"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "<p>Set <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-potential-response\" id=\"ref-for-fetchevent-potential-response\">potential response</a> to <var>potentialResponse</var>.</p>"
                }
              ]
            },
            {
              "html": "<p>Unset <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-wait-to-respond-flag\" id=\"ref-for-fetchevent-wait-to-respond-flag②\">wait to respond flag</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "cache-match",
      "href": "https://www.w3.org/TR/service-workers/#dom-cache-match",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Cache\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"match(request, options)|match(request)\" id=\"dom-cache-match\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>match(<var>request</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise⑧\">a new promise</a>.</p>"
        },
        {
          "html": "Run these substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①⑤\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>p</var> be the result of running the algorithm specified in <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cache-matchall\" id=\"ref-for-dom-cache-matchall①\">matchAll(request, options)</a></code> method with <var>request</var> and <var>options</var>.</p>"
            },
            {
              "html": "<p>Wait until <var>p</var> settles.</p>"
            },
            {
              "html": "If <var>p</var> rejects with an exception, then:",
              "rationale": "reject",
              "steps": [
                {
                  "html": "<p>Reject <var>promise</var> with that exception.</p>"
                }
              ]
            },
            {
              "html": "Else if <var>p</var> resolves with an array, <var>responses</var>, then:",
              "rationale": "if",
              "steps": [
                {
                  "html": "If <var>responses</var> is an empty array, then:",
                  "rationale": "resolve",
                  "steps": [
                    {
                      "html": "<p>Resolve <var>promise</var> with undefined.</p>"
                    }
                  ]
                },
                {
                  "html": "Else:",
                  "rationale": "resolve",
                  "steps": [
                    {
                      "html": "<p>Resolve <var>promise</var> with the first element of <var>responses</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "cache-matchall",
      "href": "https://www.w3.org/TR/service-workers/#dom-cache-matchall",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Cache\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"matchAll(request, options)|matchAll(request)|matchAll()\" id=\"dom-cache-matchall\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>matchAll(<var>request</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>r</var> be null.</p>"
        },
        {
          "html": "If the optional argument <var>request</var> is not omitted, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>request</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request③\">Request</a></code> object, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>r</var> to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request\">request</a>.</p>"
                },
                {
                  "html": "<p>If <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method\">method</a> is not `<code>GET</code>` and <var>options</var>.ignoreMethod is false, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-resolved-with\" id=\"ref-for-a-promise-resolved-with①\">a promise resolved with</a> an empty array.</p>"
                }
              ]
            },
            {
              "html": "Else if <var>request</var> is a string, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>r</var> to the associated <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request①\">request</a> of the result of invoking the initial value of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request④\">Request</a></code> as constructor with <var>request</var> as its argument. If this <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑥\">throws</a> an exception, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④\">a promise rejected with</a> that exception.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤⑦\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm④\">relevant realm</a>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise⑨\">a new promise</a>.</p>"
        },
        {
          "html": "Run these substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①⑥\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>responses</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①⓪\">list</a>.</p>"
            },
            {
              "html": "If the optional argument <var>request</var> is omitted, then:",
              "rationale": "for",
              "steps": [
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate④\">For each</a> <var>requestResponse</var> of the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-request-response-list\" id=\"ref-for-dfn-relevant-request-response-list\">relevant request response list</a>:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add a copy of <var>requestResponse</var>’s response to <var>responses</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "Else:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>requestResponses</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#query-cache\" id=\"ref-for-query-cache\">Query Cache</a> with <var>r</var> and <var>options</var>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑤\">For each</a> <var>requestResponse</var> of <var>requestResponses</var>:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add a copy of <var>requestResponse</var>’s response to <var>responses</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑥\">For each</a> <var>response</var> of <var>responses</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-type\" id=\"ref-for-concept-response-type\">type</a> is \"<code>opaque</code>\" and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#cross-origin-resource-policy-check\" id=\"ref-for-cross-origin-resource-policy-check\">cross-origin resource policy check</a> with <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②⓪\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin⑧\">origin</a>, <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②①\">relevant settings object</a>, \"\", and <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-internal-response\" id=\"ref-for-concept-internal-response\">internal response</a> returns <b>blocked</b>, then reject <var>promise</var> with a <code>TypeError</code> and abort these steps.</p>"
                }
              ]
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①⑦\">Queue a task</a>, on <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②②\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop⑥\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①①\">DOM manipulation task source</a>, to perform the following steps:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>responseList</var> be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①①\">list</a>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑦\">For each</a> <var>response</var> of <var>responses</var>:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#response\" id=\"ref-for-response⑨\">Response</a></code> object associated with <var>response</var> and a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#headers\" id=\"ref-for-headers\">Headers</a></code> object whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-headers-guard\" id=\"ref-for-concept-headers-guard\">guard</a> is \"<code>immutable</code>\" to <var>responseList</var>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Resolve <var>promise</var> with a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-frozen-array-type\" id=\"ref-for-dfn-frozen-array-type②\">frozen array</a> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-frozen-array\" id=\"ref-for-dfn-create-frozen-array②\">created</a> from <var>responseList</var>, in <var>realm</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "cache-add",
      "href": "https://www.w3.org/TR/service-workers/#dom-cache-add",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Cache\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-cache-add\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>add(<var>request</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>requests</var> be an array containing only <var>request</var>.</p>"
        },
        {
          "html": "<p>Let <var>responseArrayPromise</var> be the result of running the algorithm specified in <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cache-addall\" id=\"ref-for-dom-cache-addall①\">addAll(requests)</a></code> passing <var>requests</var> as the argument.</p>"
        },
        {
          "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-perform-steps-once-promise-is-settled\" id=\"ref-for-dfn-perform-steps-once-promise-is-settled\">reacting</a> to <var>responseArrayPromise</var> with a fulfillment handler that returns undefined.</p>"
        }
      ]
    },
    {
      "name": "cache-addAll",
      "href": "https://www.w3.org/TR/service-workers/#dom-cache-addall",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Cache\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-cache-addall\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>addAll(<var>requests</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>responsePromises</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①②\">list</a>.</p>"
        },
        {
          "html": "<p>Let <var>requestList</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①③\">list</a>.</p>"
        },
        {
          "html": "For each <var>request</var> whose type is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request⑤\">Request</a></code> in <var>requests</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>r</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request②\">request</a>.</p>"
            },
            {
              "html": "<p>If <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①\">url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme\">scheme</a> is not one of \"<code>http</code>\" and \"<code>https</code>\", or <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method①\">method</a> is not `<code>GET</code>`, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤\">a promise rejected with</a> a <code>TypeError</code>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>fetchControllers</var> be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①④\">list</a> of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller\" id=\"ref-for-fetch-controller\">fetch controllers</a>.</p>"
        },
        {
          "html": "For each <var>request</var> in <var>requests</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>r</var> be the associated <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request③\">request</a> of the result of invoking the initial value of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request⑥\">Request</a></code> as constructor with <var>request</var> as its argument. If this <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑦\">throws</a> an exception, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥\">a promise rejected with</a> that exception.</p>"
            },
            {
              "html": "If <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url②\">url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme①\">scheme</a> is not one of \"<code>http</code>\" and \"<code>https</code>\", then:",
              "rationale": "for",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑧\">For each</a> <var>fetchController</var> of <var>fetchControllers</var>, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-abort\" id=\"ref-for-fetch-controller-abort\">abort</a> <var>fetchController</var>.</p>"
                },
                {
                  "html": "<p>Return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑦\">a promise rejected with</a> a <code>TypeError</code>.</p>"
                }
              ]
            },
            {
              "html": "<p>If <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global\" id=\"ref-for-concept-settings-object-global⑦\">global object</a> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope\" id=\"ref-for-serviceworkerglobalscope①③\">ServiceWorkerGlobalScope</a></code> object, set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-service-workers-mode\" id=\"ref-for-request-service-workers-mode\">service-workers mode</a> to \"<code>none</code>\".</p>"
            },
            {
              "html": "<p>Set <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-initiator\" id=\"ref-for-concept-request-initiator\">initiator</a> to \"<code>fetch</code>\" and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination\">destination</a> to \"<code>subresource</code>\".</p>"
            },
            {
              "html": "<p>Add <var>r</var> to <var>requestList</var>.</p>"
            },
            {
              "html": "<p>Let <var>responsePromise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①⓪\">a new promise</a>.</p>"
            },
            {
              "html": "To <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#process-response\" id=\"ref-for-process-response\">processResponse</a> for <var>response</var>, run these substeps:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-type\" id=\"ref-for-concept-response-type①\">type</a> is \"<code>error</code>\", or <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status\">status</a> is not an <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#ok-status\" id=\"ref-for-ok-status\">ok status</a> or is <code>206</code>, reject <var>responsePromise</var> with a <code>TypeError</code>.</p>"
                },
                {
                  "html": "Else if <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list\">header list</a> contains a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header\" id=\"ref-for-concept-header\">header</a> <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-name\" id=\"ref-for-concept-header-name\">named</a> `<code>Vary</code>`, then:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>fieldValues</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①⑤\">list</a> containing the elements corresponding to the <a data-link-type=\"dfn\" href=\"https://tools.ietf.org/html/rfc7230#section-3.2\" id=\"ref-for-section-3.2\">field-values</a> of the <a data-link-type=\"dfn\" href=\"https://tools.ietf.org/html/rfc7231#section-7.1.4\" id=\"ref-for-section-7.1.4\">Vary</a> header.</p>"
                    },
                    {
                      "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑨\">For each</a> <var>fieldValue</var> of <var>fieldValues</var>:",
                      "rationale": "if",
                      "steps": [
                        {
                          "html": "If <var>fieldValue</var> matches \"<code>*</code>\", then:",
                          "rationale": "reject",
                          "steps": [
                            {
                              "html": "<p>Reject <var>responsePromise</var> with a <code>TypeError</code>.</p>"
                            },
                            {
                              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①⓪\">For each</a> <var>fetchController</var> of <var>fetchControllers</var>, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-abort\" id=\"ref-for-fetch-controller-abort①\">abort</a> <var>fetchController</var>.</p>"
                            },
                            {
                              "html": "<p>Abort these steps.</p>"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ],
              "additional": [
                {
                  "html": "To <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-processresponseendofbody\" id=\"ref-for-fetch-processresponseendofbody\">processResponseEndOfBody</a> for <var>response</var>, run these substeps:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-aborted\" id=\"ref-for-concept-response-aborted\">aborted flag</a> is set, reject <var>responsePromise</var> with an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#aborterror\" id=\"ref-for-aborterror\">AbortError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①③\">DOMException</a></code> and abort these steps.</p>"
                    },
                    {
                      "html": "<p>Resolve <var>responsePromise</var> with <var>response</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Add <var>responsePromise</var> to <var>responsePromises</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>p</var> be the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#waiting-for-all-promise\" id=\"ref-for-waiting-for-all-promise\">getting a promise to wait for all</a> of <var>responsePromises</var>.</p>"
        },
        {
          "html": "Return the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-perform-steps-once-promise-is-settled\" id=\"ref-for-dfn-perform-steps-once-promise-is-settled①\">reacting</a> to <var>p</var> with a fulfillment handler that, when called with argument <var>responses</var>, performs the following substeps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>operations</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①⑥\">list</a>.</p>"
            },
            {
              "html": "<p>Let <var>index</var> be zero.</p>"
            },
            {
              "html": "For each <var>response</var> in <var>responses</var>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>operation</var> be a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation\" id=\"ref-for-dfn-cache-batch-operation\">cache batch operation</a>.</p>"
                },
                {
                  "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-type\" id=\"ref-for-dfn-cache-batch-operation-type\">type</a> to \"<code>put</code>\".</p>"
                },
                {
                  "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request\">request</a> to <var>requestList</var>[<var>index</var>].</p>"
                },
                {
                  "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-response\" id=\"ref-for-dfn-cache-batch-operation-response\">response</a> to <var>response</var>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑤\">Append</a> <var>operation</var> to <var>operations</var>.</p>"
                },
                {
                  "html": "<p>Increment <var>index</var> by one.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤⑧\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm⑤\">relevant realm</a>.</p>"
            },
            {
              "html": "<p>Let <var>cacheJobPromise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①①\">a new promise</a>.</p>"
            },
            {
              "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①⑧\">in parallel</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>errorData</var> be null.</p>"
                },
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#batch-cache-operations\" id=\"ref-for-batch-cache-operations\">Batch Cache Operations</a> with <var>operations</var>. If this <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑧\">throws</a> an exception, set <var>errorData</var> to the exception.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①⑧\">Queue a task</a>, on <var>cacheJobPromise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②③\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop⑦\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①②\">DOM manipulation task source</a>, to perform the following substeps:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>errorData</var> is null, resolve <var>cacheJobPromise</var> with undefined.</p>"
                    },
                    {
                      "html": "<p>Else, reject <var>cacheJobPromise</var> with a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\" id=\"ref-for-dfn-create-exception\">new</a> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-exception\" id=\"ref-for-dfn-exception\">exception</a> with <var>errorData</var>, in <var>realm</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Return <var>cacheJobPromise</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "cache-put",
      "href": "https://www.w3.org/TR/service-workers/#dom-cache-put",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Cache\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-cache-put\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>put(<var>request</var>, <var>response</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>innerRequest</var> be null.</p>"
        },
        {
          "html": "<p>If <var>request</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request⑦\">Request</a></code> object, then set <var>innerRequest</var> to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request④\">request</a>.</p>"
        },
        {
          "html": "Else:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>requestObj</var> be the result of invoking <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request⑧\">Request</a></code>’s constructor with <var>request</var> as its argument. If this <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑨\">throws</a> an <var>exception</var>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑧\">a promise rejected with</a> <var>exception</var>.</p>"
            },
            {
              "html": "<p>Set <var>innerRequest</var> to <var>requestObj</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request⑤\">request</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>innerRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url③\">url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme②\">scheme</a> is not one of \"<code>http</code>\" and \"<code>https</code>\", or <var>innerRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method②\">method</a> is not `<code>GET</code>`, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑨\">a promise rejected with</a> a <code>TypeError</code>.</p>"
        },
        {
          "html": "<p>Let <var>innerResponse</var> be <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-response\" id=\"ref-for-concept-response-response①\">response</a>.</p>"
        },
        {
          "html": "<p>If <var>innerResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status①\">status</a> is <code>206</code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①⓪\">a promise rejected with</a> a <code>TypeError</code>.</p>"
        },
        {
          "html": "If <var>innerResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list①\">header list</a> contains a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header\" id=\"ref-for-concept-header①\">header</a> <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-name\" id=\"ref-for-concept-header-name①\">named</a> `<code>Vary</code>`, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>fieldValues</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①⑦\">list</a> containing the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item⑤\">items</a> corresponding to the <a data-link-type=\"dfn\" href=\"https://tools.ietf.org/html/rfc7231#section-7.1.4\" id=\"ref-for-section-7.1.4①\">Vary</a> header’s <a data-link-type=\"dfn\" href=\"https://tools.ietf.org/html/rfc7230#section-3.2\" id=\"ref-for-section-3.2①\">field-values</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①①\">For each</a> <var>fieldValue</var> in <var>fieldValues</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>fieldValue</var> matches \"<code>*</code>\", return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①①\">a promise rejected with</a> a <code>TypeError</code>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>If <var>innerResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body⑤\">body</a> is <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#is-readable-stream-disturbed\" id=\"ref-for-is-readable-stream-disturbed\">disturbed</a> or <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-locked\" id=\"ref-for-readablestream-locked\">locked</a>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①②\">a promise rejected with</a> a <code>TypeError</code>.</p>"
        },
        {
          "html": "<p>Let <var>clonedResponse</var> be a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-clone\" id=\"ref-for-concept-response-clone\">clone</a> of <var>innerResponse</var>.</p>"
        },
        {
          "html": "<p>Let <var>bodyReadPromise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-resolved-with\" id=\"ref-for-a-promise-resolved-with②\">a promise resolved with</a> undefined.</p>"
        },
        {
          "html": "If <var>innerResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body⑥\">body</a> is non-null, run these substeps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>stream</var> be <var>innerResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body⑦\">body</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-body-stream\" id=\"ref-for-concept-body-stream③\">stream</a>.</p>"
            },
            {
              "html": "<p>Let <var>reader</var> be the result of <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-get-a-reader\" id=\"ref-for-readablestream-get-a-reader①\">getting a reader</a> for <var>stream</var>.</p>"
            },
            {
              "html": "<p>Set <var>bodyReadPromise</var> to the result of <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestreamdefaultreader-read-all-bytes\" id=\"ref-for-readablestreamdefaultreader-read-all-bytes\">reading all bytes</a> from <var>reader</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>operations</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①⑧\">list</a>.</p>"
        },
        {
          "html": "<p>Let <var>operation</var> be a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation\" id=\"ref-for-dfn-cache-batch-operation①\">cache batch operation</a>.</p>"
        },
        {
          "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-type\" id=\"ref-for-dfn-cache-batch-operation-type①\">type</a> to \"<code>put</code>\".</p>"
        },
        {
          "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request①\">request</a> to <var>innerRequest</var>.</p>"
        },
        {
          "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-response\" id=\"ref-for-dfn-cache-batch-operation-response①\">response</a> to <var>clonedResponse</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑥\">Append</a> <var>operation</var> to <var>operations</var>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤⑨\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm⑥\">relevant realm</a>.</p>"
        },
        {
          "html": "Return the result of the <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment③\">fulfillment</a> of <var>bodyReadPromise</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>cacheJobPromise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①②\">a new promise</a>.</p>"
            },
            {
              "html": "Return <var>cacheJobPromise</var> and run these steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①⑨\">in parallel</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>errorData</var> be null.</p>"
                },
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#batch-cache-operations\" id=\"ref-for-batch-cache-operations①\">Batch Cache Operations</a> with <var>operations</var>. If this <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⓪\">throws</a> an exception, set <var>errorData</var> to the exception.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①⑨\">Queue a task</a>, on <var>cacheJobPromise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②④\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop⑧\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①③\">DOM manipulation task source</a>, to perform the following substeps:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>errorData</var> is null, resolve <var>cacheJobPromise</var> with undefined.</p>"
                    },
                    {
                      "html": "<p>Else, reject <var>cacheJobPromise</var> with a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\" id=\"ref-for-dfn-create-exception①\">new</a> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-exception\" id=\"ref-for-dfn-exception①\">exception</a> with <var>errorData</var>, in <var>realm</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "cache-delete",
      "href": "https://www.w3.org/TR/service-workers/#dom-cache-delete",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Cache\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"delete(request, options)|delete(request)\" id=\"dom-cache-delete\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>delete(<var>request</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>r</var> be null.</p>"
        },
        {
          "html": "If <var>request</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request⑨\">Request</a></code> object, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>r</var> to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request⑥\">request</a>.</p>"
            },
            {
              "html": "<p>If <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method③\">method</a> is not `<code>GET</code>` and <var>options</var>.ignoreMethod is false, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-resolved-with\" id=\"ref-for-a-promise-resolved-with③\">a promise resolved with</a> false.</p>"
            }
          ]
        },
        {
          "html": "Else if <var>request</var> is a string, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>r</var> to the associated <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request⑦\">request</a> of the result of invoking the initial value of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request①⓪\">Request</a></code> as constructor with <var>request</var> as its argument. If this <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①①\">throws</a> an exception, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①③\">a promise rejected with</a> that exception.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>operations</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①⑨\">list</a>.</p>"
        },
        {
          "html": "<p>Let <var>operation</var> be a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation\" id=\"ref-for-dfn-cache-batch-operation②\">cache batch operation</a>.</p>"
        },
        {
          "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-type\" id=\"ref-for-dfn-cache-batch-operation-type②\">type</a> to \"<code>delete</code>\".</p>"
        },
        {
          "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request②\">request</a> to <var>r</var>.</p>"
        },
        {
          "html": "<p>Set <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-options\" id=\"ref-for-dfn-cache-batch-operation-options\">options</a> to <var>options</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑦\">Append</a> <var>operation</var> to <var>operations</var>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑥⓪\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm⑦\">relevant realm</a>.</p>"
        },
        {
          "html": "<p>Let <var>cacheJobPromise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①③\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②⓪\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>errorData</var> be null.</p>"
            },
            {
              "html": "<p>Let <var>requestResponses</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#batch-cache-operations\" id=\"ref-for-batch-cache-operations②\">Batch Cache Operations</a> with <var>operations</var>. If this <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①②\">throws</a> an exception, set <var>errorData</var> to the exception.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②⓪\">Queue a task</a>, on <var>cacheJobPromise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②⑤\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop⑨\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①④\">DOM manipulation task source</a>, to perform the following substeps:",
              "rationale": "if",
              "steps": [
                {
                  "html": "If <var>errorData</var> is null, then:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>requestResponses</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty\">is not empty</a>, resolve <var>cacheJobPromise</var> with true.</p>"
                    },
                    {
                      "html": "<p>Else, resolve <var>cacheJobPromise</var> with false.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Else, reject <var>cacheJobPromise</var> with a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\" id=\"ref-for-dfn-create-exception②\">new</a> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-exception\" id=\"ref-for-dfn-exception②\">exception</a> with <var>errorData</var>, in <var>realm</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>cacheJobPromise</var>.</p>"
        }
      ]
    },
    {
      "name": "cache-keys",
      "href": "https://www.w3.org/TR/service-workers/#dom-cache-keys",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Cache\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"keys(request, options)|keys(request)|keys()\" id=\"dom-cache-keys\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>keys(<var>request</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>r</var> be null.</p>"
        },
        {
          "html": "If the optional argument <var>request</var> is not omitted, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>request</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request①①\">Request</a></code> object, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>r</var> to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request⑧\">request</a>.</p>"
                },
                {
                  "html": "<p>If <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method④\">method</a> is not `<code>GET</code>` and <var>options</var>.ignoreMethod is false, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-resolved-with\" id=\"ref-for-a-promise-resolved-with④\">a promise resolved with</a> an empty array.</p>"
                }
              ]
            },
            {
              "html": "Else if <var>request</var> is a string, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>r</var> to the associated <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request⑨\">request</a> of the result of invoking the initial value of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request①②\">Request</a></code> as constructor with <var>request</var> as its argument. If this <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①③\">throws</a> an exception, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①④\">a promise rejected with</a> that exception.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑥①\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm⑧\">relevant realm</a>.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①④\">a new promise</a>.</p>"
        },
        {
          "html": "Run these substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②①\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>requests</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②⓪\">list</a>.</p>"
            },
            {
              "html": "If the optional argument <var>request</var> is omitted, then:",
              "rationale": "for",
              "steps": [
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①②\">For each</a> <var>requestResponse</var> of the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-request-response-list\" id=\"ref-for-dfn-relevant-request-response-list①\">relevant request response list</a>:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add <var>requestResponse</var>’s request to <var>requests</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "Else:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>requestResponses</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#query-cache\" id=\"ref-for-query-cache①\">Query Cache</a> with <var>r</var> and <var>options</var>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①③\">For each</a> <var>requestResponse</var> of <var>requestResponses</var>:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add <var>requestResponse</var>’s request to <var>requests</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②①\">Queue a task</a>, on <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②⑥\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①⓪\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑤\">DOM manipulation task source</a>, to perform the following steps:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>requestList</var> be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②①\">list</a>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①④\">For each</a> <var>request</var> of <var>requests</var>:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request①③\">Request</a></code> object associated with <var>request</var> and a new associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#headers\" id=\"ref-for-headers①\">Headers</a></code> object whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-headers-guard\" id=\"ref-for-concept-headers-guard①\">guard</a> is \"<code>immutable</code>\" to <var>requestList</var>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Resolve <var>promise</var> with a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-frozen-array-type\" id=\"ref-for-dfn-frozen-array-type③\">frozen array</a> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-frozen-array\" id=\"ref-for-dfn-create-frozen-array③\">created</a> from <var>requestList</var>, in <var>realm</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "cache-storage-match",
      "href": "https://www.w3.org/TR/service-workers/#dom-cachestorage-match",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"CacheStorage\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"match(request, options)|match(request)\" id=\"dom-cachestorage-match\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>match(<var>request</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-multicachequeryoptions-cachename\" id=\"ref-for-dom-multicachequeryoptions-cachename\">cacheName</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists③\">exists</a>, then:",
          "rationale": "return",
          "steps": [
            {
              "html": "Return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①⑤\">a new promise</a> <var>promise</var> and run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②②\">in parallel</a>:",
              "rationale": "for",
              "steps": [
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate\">For each</a> <var>cacheName</var> → <var>cache</var> of the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-name-to-cache-map\" id=\"ref-for-dfn-relevant-name-to-cache-map\">relevant name to cache map</a>:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-multicachequeryoptions-cachename\" id=\"ref-for-dom-multicachequeryoptions-cachename①\">cacheName</a></code>\"] matches <var>cacheName</var>, then:",
                      "rationale": "resolve",
                      "steps": [
                        {
                          "html": "<p>Resolve <var>promise</var> with the result of running the algorithm specified in <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cache-match\" id=\"ref-for-dom-cache-match②\">match(request, options)</a></code> method of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#cache\" id=\"ref-for-cache①②\">Cache</a></code> interface with <var>request</var> and <var>options</var> (providing <var>cache</var> as thisArgument to the <code>\\[[Call]]</code> internal method of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cache-match\" id=\"ref-for-dom-cache-match③\">match(request, options)</a></code>.)</p>"
                        },
                        {
                          "html": "<p>Abort these steps.</p>"
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "<p>Resolve <var>promise</var> with undefined.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-resolved-with\" id=\"ref-for-a-promise-resolved-with⑤\">a promise resolved with</a> undefined.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate①\">For each</a> <var>cacheName</var> → <var>cache</var> of the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-name-to-cache-map\" id=\"ref-for-dfn-relevant-name-to-cache-map①\">relevant name to cache map</a>:",
              "rationale": "set",
              "steps": [
                {
                  "html": "Set <var>promise</var> to the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-perform-steps-once-promise-is-settled\" id=\"ref-for-dfn-perform-steps-once-promise-is-settled②\">reacting</a> to itself with a fulfillment handler that, when called with argument <var>response</var>, performs the following substeps:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>response</var> is not undefined, return <var>response</var>.</p>"
                    },
                    {
                      "html": "<p>Return the result of running the algorithm specified in <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cache-match\" id=\"ref-for-dom-cache-match④\">match(request, options)</a></code> method of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#cache\" id=\"ref-for-cache①③\">Cache</a></code> interface with <var>request</var> and <var>options</var> as the arguments (providing <var>cache</var> as thisArgument to the <code>\\[[Call]]</code> internal method of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cache-match\" id=\"ref-for-dom-cache-match⑤\">match(request, options)</a></code>.)</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Return <var>promise</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "cache-storage-has",
      "href": "https://www.w3.org/TR/service-workers/#dom-cachestorage-has",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"CacheStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-cachestorage-has\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>has(<var>cacheName</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①⑥\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②③\">in parallel</a>:",
          "rationale": "for",
          "steps": [
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate②\">For each</a> <var>key</var> → <var>value</var> of the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-name-to-cache-map\" id=\"ref-for-dfn-relevant-name-to-cache-map②\">relevant name to cache map</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>cacheName</var> matches <var>key</var>, resolve <var>promise</var> with true and abort these steps.</p>"
                }
              ]
            },
            {
              "html": "<p>Resolve <var>promise</var> with false.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "cache-storage-open",
      "href": "https://www.w3.org/TR/service-workers/#dom-cachestorage-open",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"CacheStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-cachestorage-open\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>open(<var>cacheName</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①⑦\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②④\">in parallel</a>:",
          "rationale": "for",
          "steps": [
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate③\">For each</a> <var>key</var> → <var>value</var> of the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-name-to-cache-map\" id=\"ref-for-dfn-relevant-name-to-cache-map③\">relevant name to cache map</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "If <var>cacheName</var> matches <var>key</var>, then:",
                  "rationale": "resolve",
                  "steps": [
                    {
                      "html": "<p>Resolve <var>promise</var> with a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#cache\" id=\"ref-for-cache①④\">Cache</a></code> object that represents <var>value</var>.</p>"
                    },
                    {
                      "html": "<p>Abort these steps.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Let <var>cache</var> be a new <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-request-response-list\" id=\"ref-for-dfn-request-response-list④\">request response list</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set\">Set</a> the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-name-to-cache-map\" id=\"ref-for-dfn-relevant-name-to-cache-map④\">relevant name to cache map</a>[<var>cacheName</var>] to <var>cache</var>. If this cache write operation failed due to exceeding the granted quota limit, reject <var>promise</var> with a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#quotaexceedederror\" id=\"ref-for-quotaexceedederror\">QuotaExceededError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①④\">DOMException</a></code> and abort these steps.</p>"
            },
            {
              "html": "<p>Resolve <var>promise</var> with a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#cache\" id=\"ref-for-cache①⑤\">Cache</a></code> object that represents <var>cache</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "cache-storage-delete",
      "href": "https://www.w3.org/TR/service-workers/#dom-cachestorage-delete",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"CacheStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-cachestorage-delete\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>delete(<var>cacheName</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be the result of running the algorithm specified in <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cachestorage-has\" id=\"ref-for-dom-cachestorage-has②\">has(cacheName)</a></code> method with <var>cacheName</var>.</p>"
        },
        {
          "html": "Return the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-perform-steps-once-promise-is-settled\" id=\"ref-for-dfn-perform-steps-once-promise-is-settled③\">reacting</a> to <var>promise</var> with a fulfillment handler that, when called with argument <var>cacheExists</var>, performs the following substeps:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>cacheExists</var> is false, then:",
              "rationale": "return",
              "steps": [
                {
                  "html": "<p>Return false.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>cacheJobPromise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①⑧\">a new promise</a>.</p>"
            },
            {
              "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②⑤\">in parallel</a>:",
              "rationale": "remove",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove\">Remove</a> the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-name-to-cache-map\" id=\"ref-for-dfn-relevant-name-to-cache-map⑤\">relevant name to cache map</a>[<var>cacheName</var>].</p>"
                },
                {
                  "html": "<p>Resolve <var>cacheJobPromise</var> with true.</p>"
                }
              ]
            },
            {
              "html": "<p>Return <var>cacheJobPromise</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "cache-storage-keys",
      "href": "https://www.w3.org/TR/service-workers/#dom-cachestorage-keys",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"CacheStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-cachestorage-keys\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>keys()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise①⑨\">a new promise</a>.</p>"
        },
        {
          "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②⑥\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>cacheKeys</var> be the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-getting-the-keys\" id=\"ref-for-map-getting-the-keys③\">getting the keys</a> of the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-name-to-cache-map\" id=\"ref-for-dfn-relevant-name-to-cache-map⑥\">relevant name to cache map</a>.</p>"
            },
            {
              "html": "<p>Resolve <var>promise</var> with <var>cacheKeys</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "ServiceWorkerGlobalScope/importScripts(urls)",
      "href": "https://www.w3.org/TR/service-workers/#importscripts-method",
      "html": "When the <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"ServiceWorkerGlobalScope\" data-dfn-type=\"method\" data-export=\"\" id=\"importscripts-method\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>importScripts(<var>urls</var>)</code></dfn> method is called on a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope\" id=\"ref-for-serviceworkerglobalscope①④\">ServiceWorkerGlobalScope</a></code> object, the user agent <em>must</em> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#import-scripts-into-worker-global-scope\" id=\"ref-for-import-scripts-into-worker-global-scope\">import scripts into worker global scope</a>, given this <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope\" id=\"ref-for-serviceworkerglobalscope①⑤\">ServiceWorkerGlobalScope</a></code> object and <var>urls</var>, and with the following<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#fetching-scripts-perform-fetch\" id=\"ref-for-fetching-scripts-perform-fetch\">perform the fetch hook</a> steps, given the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request⑤\">request</a> <var>request</var>:",
      "rationale": "let",
      "steps": [
        {
          "html": "<p>Let <var>serviceWorker</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client①\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global\" id=\"ref-for-concept-settings-object-global⑧\">global object</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker②④\">service worker</a>.</p>"
        },
        {
          "html": "<p>Let <var>map</var> be <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource-map\" id=\"ref-for-dfn-script-resource-map\">script resource map</a>.</p>"
        },
        {
          "html": "<p>Let <var>url</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url④\">url</a>.</p>"
        },
        {
          "html": "If <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state⑥\">state</a> is not \"<code>parsed</code>\" or \"<code>installing</code>\":",
          "rationale": "return",
          "steps": [
            {
              "html": "<p>Return <var>map</var>[<var>url</var>] if it <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists④\">exists</a> and a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error②\">network error</a> otherwise.</p>"
            }
          ]
        },
        {
          "html": "If <var>map</var>[<var>url</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑤\">exists</a>:",
          "rationale": "append",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append\">Append</a> <var>url</var> to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-used-scripts\" id=\"ref-for-dfn-set-of-used-scripts①\">set of used scripts</a>.</p>"
            },
            {
              "html": "<p>Return <var>map</var>[<var>url</var>].</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>registration</var> be <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration①⑤\">containing service worker registration</a>.</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-service-workers-mode\" id=\"ref-for-request-service-workers-mode①\">service-workers mode</a> to \"<code>none</code>\".</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-cache-mode\" id=\"ref-for-concept-request-cache-mode\">cache mode</a> to \"<code>no-cache</code>\" if any of the following are true:</p>\n        <ul>\n         <li data-md=\"\">\n          <p><var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-update-via-cache\" id=\"ref-for-dfn-update-via-cache①\">update via cache mode</a> is \"<code>none</code>\".</p>\n         </li><li data-md=\"\">\n          <p>The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object\" id=\"ref-for-current-global-object⑤\">current global object</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-force-bypass-cache-for-import-scripts-flag\" id=\"ref-for-serviceworkerglobalscope-force-bypass-cache-for-import-scripts-flag\">force bypass cache for import scripts flag</a> is set.</p>\n         </li><li data-md=\"\">\n          <p><var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-stale\" id=\"ref-for-service-worker-registration-stale\">stale</a>.</p>\n        </li></ul>"
        },
        {
          "html": "<p>Let <var>response</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch⑦\">fetching</a> <var>request</var>.</p>"
        },
        {
          "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-cache-state\" id=\"ref-for-concept-response-cache-state\">cache state</a> is not \"<code>local</code>\", set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-last-update-check-time\" id=\"ref-for-dfn-last-update-check-time②\">last update check time</a> to the current time.</p>"
        },
        {
          "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/urls-and-fetching.html#unsafe-response\" id=\"ref-for-unsafe-response\">unsafe response</a> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-bad-import-script-response\" id=\"ref-for-dfn-bad-import-script-response\">bad import script response</a>, then return a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error③\">network error</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set①\">Set</a> <var>map</var>[<var>url</var>] to <var>response</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append①\">Append</a> <var>url</var> to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-used-scripts\" id=\"ref-for-dfn-set-of-used-scripts②\">set of used scripts</a>.</p>"
        },
        {
          "html": "<p>Set <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-classic-scripts-imported-flag\" id=\"ref-for-dfn-classic-scripts-imported-flag\">classic scripts imported flag</a>.</p>"
        },
        {
          "html": "<p>Return <var>response</var>.</p>"
        }
      ]
    },
    {
      "name": "Create Job",
      "href": "https://www.w3.org/TR/service-workers/#create-job",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>job</var> be a new <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job\" id=\"ref-for-dfn-job①⑨\">job</a>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-type\" id=\"ref-for-dfn-job-type②\">job type</a> to <var>jobType</var>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-storage-key\" id=\"ref-for-job-storage-key\">storage key</a> to <var>storage key</var>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url②\">scope url</a> to <var>scopeURL</var>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url①\">script url</a> to <var>scriptURL</var>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-promise\" id=\"ref-for-dfn-job-promise\">job promise</a> to <var>promise</var>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client\">client</a> to <var>client</var>.</p>"
        },
        {
          "html": "<p>If <var>client</var> is not null, set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-referrer\" id=\"ref-for-job-referrer\">referrer</a> to <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url⑥\">creation URL</a>.</p>"
        },
        {
          "html": "<p>Return <var>job</var>.</p>"
        }
      ]
    },
    {
      "name": "Schedule Job",
      "href": "https://www.w3.org/TR/service-workers/#schedule-job",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>jobQueue</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>jobScope</var> be <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url③\">scope url</a>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-serializer\" id=\"ref-for-concept-url-serializer⑦\">serialized</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-job-queue-map\" id=\"ref-for-dfn-scope-to-job-queue-map\">scope to job queue map</a>[<var>jobScope</var>] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑥\">exist</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set②\">set</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-job-queue-map\" id=\"ref-for-dfn-scope-to-job-queue-map①\">scope to job queue map</a>[<var>jobScope</var>] to a new <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-queue\" id=\"ref-for-dfn-job-queue④\">job queue</a>.</p>"
        },
        {
          "html": "<p>Set <var>jobQueue</var> to <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-job-queue-map\" id=\"ref-for-dfn-scope-to-job-queue-map②\">scope to job queue map</a>[<var>jobScope</var>].</p>"
        },
        {
          "html": "If <var>jobQueue</var> is empty, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-job-queue\" id=\"ref-for-dfn-containing-job-queue\">containing job queue</a> to <var>jobQueue</var>, and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-enqueue\" id=\"ref-for-queue-enqueue①\">enqueue</a> <var>job</var> to <var>jobQueue</var>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-job\" id=\"ref-for-run-job\">Run Job</a> with <var>jobQueue</var>.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>lastJob</var> be the element at the back of <var>jobQueue</var>.</p>"
            },
            {
              "html": "<p>If <var>job</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-equivalent\" id=\"ref-for-dfn-job-equivalent\">equivalent</a> to <var>lastJob</var> and <var>lastJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-promise\" id=\"ref-for-dfn-job-promise①\">job promise</a> has not settled, append <var>job</var> to <var>lastJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-list-of-equivalent-jobs\" id=\"ref-for-dfn-job-list-of-equivalent-jobs\">list of equivalent jobs</a>.</p>"
            },
            {
              "html": "<p>Else, set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-job-queue\" id=\"ref-for-dfn-containing-job-queue①\">containing job queue</a> to <var>jobQueue</var>, and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-enqueue\" id=\"ref-for-queue-enqueue②\">enqueue</a> <var>job</var> to <var>jobQueue</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "Run Job",
      "href": "https://www.w3.org/TR/service-workers/#run-job",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p class=\"assertion\">Assert: <var>jobQueue</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty①\">is not empty</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②②\">Queue a task</a> to run these steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>job</var> be the first <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item⑧\">item</a> in <var>jobQueue</var>.</p>"
            },
            {
              "html": "<p>If <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-type\" id=\"ref-for-dfn-job-type③\">job type</a> is <em>register</em>, run <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#register\" id=\"ref-for-register②\">Register</a> with <var>job</var> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②⑦\">in parallel</a>.</p>"
            },
            {
              "html": "<p>Else if <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-type\" id=\"ref-for-dfn-job-type④\">job type</a> is <em>update</em>, run <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update\" id=\"ref-for-update\">Update</a> with <var>job</var> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②⑧\">in parallel</a>.</p>"
            },
            {
              "html": "<p>Else if <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-type\" id=\"ref-for-dfn-job-type⑤\">job type</a> is <em>unregister</em>, run <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#unregister\" id=\"ref-for-unregister\">Unregister</a> with <var>job</var> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②⑨\">in parallel</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "Finish Job",
      "href": "https://www.w3.org/TR/service-workers/#finish-job",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>jobQueue</var> be <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-job-queue\" id=\"ref-for-dfn-containing-job-queue②\">containing job queue</a>.</p>"
        },
        {
          "html": "<p class=\"assertion\">Assert: the first <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item⑨\">item</a> in <var>jobQueue</var> is <var>job</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-dequeue\" id=\"ref-for-queue-dequeue\">Dequeue</a> from <var>jobQueue</var>.</p>"
        },
        {
          "html": "<p>If <var>jobQueue</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty②\">is not empty</a>, invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-job\" id=\"ref-for-run-job①\">Run Job</a> with <var>jobQueue</var>.</p>"
        }
      ]
    },
    {
      "name": "Resolve Job Promise",
      "href": "https://www.w3.org/TR/service-workers/#resolve-job-promise",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client①\">client</a> is not null, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②③\">queue a task</a>, on <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client②\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①①\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑥\">DOM manipulation task source</a>, to run the following substeps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>convertedValue</var> be null.</p>"
            },
            {
              "html": "<p>If <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-type\" id=\"ref-for-dfn-job-type⑥\">job type</a> is either <em>register</em> or <em>update</em>, set <var>convertedValue</var> to the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-registration-object\" id=\"ref-for-get-the-service-worker-registration-object④\">getting the service worker registration object</a> that represents <var>value</var> in <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client③\">client</a>.</p>"
            },
            {
              "html": "<p>Else, set <var>convertedValue</var> to <var>value</var>, in <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client④\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object's-realm\" id=\"ref-for-environment-settings-object's-realm⑤\">Realm</a>.</p>"
            },
            {
              "html": "<p>Resolve <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-promise\" id=\"ref-for-dfn-job-promise②\">job promise</a> with <var>convertedValue</var>.</p>"
            }
          ]
        },
        {
          "html": "For each <var>equivalentJob</var> in <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-list-of-equivalent-jobs\" id=\"ref-for-dfn-job-list-of-equivalent-jobs①\">list of equivalent jobs</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client⑤\">client</a> is null, continue to the next iteration of the loop.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②④\">Queue a task</a>, on <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client⑥\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①②\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑦\">DOM manipulation task source</a>, to run the following substeps:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>convertedValue</var> be null.</p>"
                },
                {
                  "html": "<p>If <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-type\" id=\"ref-for-dfn-job-type⑦\">job type</a> is either <em>register</em> or <em>update</em>, set <var>convertedValue</var> to the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-registration-object\" id=\"ref-for-get-the-service-worker-registration-object⑤\">getting the service worker registration object</a> that represents <var>value</var> in <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client⑦\">client</a>.</p>"
                },
                {
                  "html": "<p>Else, set <var>convertedValue</var> to <var>value</var>, in <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client⑧\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object's-realm\" id=\"ref-for-environment-settings-object's-realm⑥\">Realm</a>.</p>"
                },
                {
                  "html": "<p>Resolve <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-promise\" id=\"ref-for-dfn-job-promise③\">job promise</a> with <var>convertedValue</var>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "Reject Job Promise",
      "href": "https://www.w3.org/TR/service-workers/#reject-job-promise",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client⑨\">client</a> is not null, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②⑤\">queue a task</a>, on <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client①⓪\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①③\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑧\">DOM manipulation task source</a>, to reject <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-promise\" id=\"ref-for-dfn-job-promise④\">job promise</a> with a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\" id=\"ref-for-dfn-create-exception④\">new</a> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-exception\" id=\"ref-for-dfn-exception③\">exception</a> with <var>errorData</var>, in <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client①①\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object's-realm\" id=\"ref-for-environment-settings-object's-realm⑦\">Realm</a>.</p>"
        },
        {
          "html": "For each <var>equivalentJob</var> in <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-list-of-equivalent-jobs\" id=\"ref-for-dfn-job-list-of-equivalent-jobs②\">list of equivalent jobs</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client①②\">client</a> is null, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑦\">continue</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②⑥\">Queue a task</a>, on <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client①③\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①④\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑨\">DOM manipulation task source</a>, to reject <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-promise\" id=\"ref-for-dfn-job-promise⑤\">job promise</a> with a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\" id=\"ref-for-dfn-create-exception⑤\">new</a> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-exception\" id=\"ref-for-dfn-exception④\">exception</a> with <var>errorData</var>, in <var>equivalentJob</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client①④\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object's-realm\" id=\"ref-for-environment-settings-object's-realm⑧\">Realm</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "Start Register",
      "href": "https://www.w3.org/TR/service-workers/#start-register",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>scriptURL</var> is failure, reject <var>promise</var> with a <code>TypeError</code> and abort these steps.</p>"
        },
        {
          "html": "<p>Set <var>scriptURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-fragment\" id=\"ref-for-concept-url-fragment①\">fragment</a> to null.</p>"
        },
        {
          "html": "<p>If <var>scriptURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme③\">scheme</a> is not one of \"<code>http</code>\" and \"<code>https</code>\", reject <var>promise</var> with a <code>TypeError</code> and abort these steps.</p>"
        },
        {
          "html": "<p>If any of the strings in <var>scriptURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path①\">path</a> contains either <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ascii-case-insensitive\" id=\"ref-for-ascii-case-insensitive\">ASCII case-insensitive</a> \"<code>%2f</code>\" or <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ascii-case-insensitive\" id=\"ref-for-ascii-case-insensitive①\">ASCII case-insensitive</a> \"<code>%5c</code>\", reject <var>promise</var> with a <code>TypeError</code> and abort these steps.</p>"
        },
        {
          "html": "<p>If <var>scopeURL</var> is null, set <var>scopeURL</var> to the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser⑤\">parsing</a> the string \"<code>./</code>\" with <var>scriptURL</var>.</p>"
        },
        {
          "html": "<p>If <var>scopeURL</var> is failure, reject <var>promise</var> with a <code>TypeError</code> and abort these steps.</p>"
        },
        {
          "html": "<p>Set <var>scopeURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-fragment\" id=\"ref-for-concept-url-fragment④\">fragment</a> to null.</p>"
        },
        {
          "html": "<p>If <var>scopeURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme④\">scheme</a> is not one of \"<code>http</code>\" and \"<code>https</code>\", reject <var>promise</var> with a <code>TypeError</code> and abort these steps.</p>"
        },
        {
          "html": "<p>If any of the strings in <var>scopeURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path②\">path</a> contains either <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ascii-case-insensitive\" id=\"ref-for-ascii-case-insensitive②\">ASCII case-insensitive</a> \"<code>%2f</code>\" or <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ascii-case-insensitive\" id=\"ref-for-ascii-case-insensitive③\">ASCII case-insensitive</a> \"<code>%5c</code>\", reject <var>promise</var> with a <code>TypeError</code> and abort these steps.</p>"
        },
        {
          "html": "<p>Let <var>storage key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key⑨\">obtain a storage key</a> given <var>client</var>.</p>"
        },
        {
          "html": "<p>Let <var>job</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-job\" id=\"ref-for-create-job②\">Create Job</a> with <em>register</em>, <var>storage key</var>, <var>scopeURL</var>, <var>scriptURL</var>, <var>promise</var>, and <var>client</var>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-worker-type\" id=\"ref-for-dfn-job-worker-type③\">worker type</a> to <var>workerType</var>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-update-via-cache-mode\" id=\"ref-for-dfn-job-update-via-cache-mode①\">update via cache mode</a> to <var>updateViaCache</var>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-referrer\" id=\"ref-for-job-referrer①\">referrer</a> to <var>referrer</var>.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#schedule-job\" id=\"ref-for-schedule-job②\">Schedule Job</a> with <var>job</var>.</p>"
        }
      ]
    },
    {
      "name": "Register",
      "href": "https://www.w3.org/TR/service-workers/#register",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/secure-contexts/#potentially-trustworthy-origin\" id=\"ref-for-potentially-trustworthy-origin\">potentially trustworthy origin</a> with the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①③\">origin</a> of <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url②\">script url</a> as the argument is <code>Not Trusted</code>, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise\">Reject Job Promise</a> with <var>job</var> and \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror①\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑤\">DOMException</a></code>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "If <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url③\">script url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②\">origin</a> and <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-referrer\" id=\"ref-for-job-referrer②\">referrer</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin③\">origin</a> are not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin④\">same origin</a>, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise①\">Reject Job Promise</a> with <var>job</var> and \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror②\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑥\">DOMException</a></code>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job①\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "If <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url④\">scope url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin④\">origin</a> and <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-referrer\" id=\"ref-for-job-referrer③\">referrer</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin⑤\">origin</a> are not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin⑤\">same origin</a>, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise②\">Reject Job Promise</a> with <var>job</var> and \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror③\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑦\">DOMException</a></code>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job②\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>registration</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-registration\" id=\"ref-for-get-registration\">Get Registration</a> given <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-storage-key\" id=\"ref-for-job-storage-key①\">storage key</a> and <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url⑤\">scope url</a>.</p>"
        },
        {
          "html": "If <var>registration</var> is not null, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>newestWorker</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-newest-worker\" id=\"ref-for-get-newest-worker①\">Get Newest Worker</a> algorithm passing <var>registration</var> as the argument.</p>"
            },
            {
              "html": "If <var>newestWorker</var> is not null, <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url④\">script url</a> <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-equals\" id=\"ref-for-concept-url-equals\">equals</a> <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url②\">script url</a>, <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-worker-type\" id=\"ref-for-dfn-job-worker-type④\">worker type</a> equals <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-type\" id=\"ref-for-dfn-type①\">type</a>, and <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-update-via-cache-mode\" id=\"ref-for-dfn-job-update-via-cache-mode②\">update via cache mode</a>’s value equals <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-update-via-cache\" id=\"ref-for-dfn-update-via-cache③\">update via cache mode</a>, then:",
              "rationale": "invoke",
              "steps": [
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#resolve-job-promise\" id=\"ref-for-resolve-job-promise\">Resolve Job Promise</a> with <var>job</var> and <var>registration</var>.</p>"
                },
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job③\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#set-registration\" id=\"ref-for-set-registration\">Set Registration</a> algorithm with <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-storage-key\" id=\"ref-for-job-storage-key②\">storage key</a>, <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url⑥\">scope url</a>, and <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-update-via-cache-mode\" id=\"ref-for-dfn-job-update-via-cache-mode③\">update via cache mode</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update\" id=\"ref-for-update①\">Update</a> algorithm passing <var>job</var> as the argument.</p>"
        }
      ]
    },
    {
      "name": "Update",
      "href": "https://www.w3.org/TR/service-workers/#update",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>registration</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-registration\" id=\"ref-for-get-registration①\">Get Registration</a> given <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-storage-key\" id=\"ref-for-job-storage-key③\">storage key</a> and <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url⑦\">scope url</a>.</p>"
        },
        {
          "html": "If <var>registration</var> is null, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise③\">Reject Job Promise</a> with <var>job</var> and <code>TypeError</code>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job④\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>newestWorker</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-newest-worker\" id=\"ref-for-get-newest-worker②\">Get Newest Worker</a> algorithm passing <var>registration</var> as the argument.</p>"
        },
        {
          "html": "If <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-type\" id=\"ref-for-dfn-job-type⑧\">job type</a> is <em>update</em>, and <var>newestWorker</var> is not null and its <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url③\">script url</a> does not <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-equals\" id=\"ref-for-concept-url-equals①\">equal</a> <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url⑤\">script url</a>, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise④\">Reject Job Promise</a> with <var>job</var> and <code>TypeError</code>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job⑤\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>hasUpdatedResources</var> be false.</p>"
        },
        {
          "html": "<p>Let <var>updatedResourceMap</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map⑦\">ordered map</a> where the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-getting-the-keys\" id=\"ref-for-map-getting-the-keys④\">keys</a> are <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url①②\">URLs</a> and the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-getting-the-values\" id=\"ref-for-map-getting-the-values③\">values</a> are <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response⑧\">responses</a>.</p>"
        },
        {
          "html": "To <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#fetching-scripts-perform-fetch\" id=\"ref-for-fetching-scripts-perform-fetch①\">perform the fetch hook</a> given <var>request</var>, run the following steps:",
          "rationale": "append",
          "steps": [
            {
              "html": "<p>Append `<code>Service-Worker</code>`/`<code>script</code>` to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list\">header list</a>.</p>"
            },
            {
              "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-cache-mode\" id=\"ref-for-concept-request-cache-mode①\">cache mode</a> to \"<code>no-cache</code>\" if any of the following are true:</p>\n         <ul>\n          <li data-md=\"\">\n           <p><var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-update-via-cache\" id=\"ref-for-dfn-update-via-cache④\">update via cache mode</a> is not \"<code>all</code>\".</p>\n          </li><li data-md=\"\">\n           <p><var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-force-bypass-cache-flag\" id=\"ref-for-dfn-job-force-bypass-cache-flag\">force bypass cache flag</a> is set.</p>\n          </li><li data-md=\"\">\n           <p><var>newestWorker</var> is not null and <var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-stale\" id=\"ref-for-service-worker-registration-stale①\">stale</a>.</p>\n         </li></ul>"
            },
            {
              "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-service-workers-mode\" id=\"ref-for-request-service-workers-mode②\">service-workers mode</a> to \"<code>none</code>\".</p>"
            },
            {
              "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#fetching-scripts-is-top-level\" id=\"ref-for-fetching-scripts-is-top-level\">isTopLevel</a> flag is unset, then return the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch①⓪\">fetching</a> <var>request</var>.</p>"
            },
            {
              "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-redirect-mode\" id=\"ref-for-concept-request-redirect-mode\">redirect mode</a> to \"<code>error</code>\".</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch①①\">Fetch</a> <var>request</var>, and asynchronously wait to run the remaining steps as part of fetch’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#process-response\" id=\"ref-for-process-response①\">processResponse</a> for the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response⑨\">response</a> <var>response</var>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-extract-mime-type\" id=\"ref-for-concept-header-extract-mime-type①\">Extract a MIME type</a> from the <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list③\">header list</a>. If this MIME type (ignoring parameters) is not a <a data-link-type=\"dfn\" href=\"https://mimesniff.spec.whatwg.org/#javascript-mime-type\" id=\"ref-for-javascript-mime-type②\">JavaScript MIME type</a>, then:",
              "rationale": "invoke",
              "steps": [
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise⑤\">Reject Job Promise</a> with <var>job</var> and \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror④\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑧\">DOMException</a></code>.</p>"
                },
                {
                  "html": "<p>Asynchronously complete these steps with a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error④\">network error</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>serviceWorkerAllowed</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#extract-header-list-values\" id=\"ref-for-extract-header-list-values\">extracting header list values</a> given `<code>Service-Worker-Allowed</code>` and <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list④\">header list</a>.</p>"
            },
            {
              "html": "<p>Set <var>policyContainer</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/origin.html#creating-a-policy-container-from-a-fetch-response\" id=\"ref-for-creating-a-policy-container-from-a-fetch-response\">creating a policy container from a fetch response</a> given <var>response</var>.</p>"
            },
            {
              "html": "<p>If <var>serviceWorkerAllowed</var> is failure, then:</p>",
              "ignored": [
                "Asynchronously complete these steps with a network error."
              ]
            },
            {
              "html": "<p>Let <var>scopeURL</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-url\" id=\"ref-for-dfn-scope-url①③\">scope url</a>.</p>"
            },
            {
              "html": "<p>Let <var>maxScopeString</var> be null.</p>"
            },
            {
              "html": "If <var>serviceWorkerAllowed</var> is null, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>resolvedScope</var> be the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser⑥\">parsing</a> \"<code>./</code>\" using <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url⑧\">script url</a> as the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-script-base-url\" id=\"ref-for-concept-script-base-url\">base URL</a>.</p>"
                },
                {
                  "html": "<p>Set <var>maxScopeString</var> to \"<code>/</code>\", followed by the strings in <var>resolvedScope</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path③\">path</a> (including empty strings), separated from each other by \"<code>/</code>\".</p>"
                }
              ]
            },
            {
              "html": "Else:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>maxScope</var> be the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser⑦\">parsing</a> <var>serviceWorkerAllowed</var> using <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url⑨\">script url</a> as the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-script-base-url\" id=\"ref-for-concept-script-base-url①\">base URL</a>.</p>"
                },
                {
                  "html": "If <var>maxScope</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin⑥\">origin</a> is <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url①⓪\">script url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin⑦\">origin</a>, then:",
                  "rationale": "set",
                  "steps": [
                    {
                      "html": "<p>Set <var>maxScopeString</var> to \"<code>/</code>\", followed by the strings in <var>maxScope</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path⑤\">path</a> (including empty strings), separated from each other by \"<code>/</code>\".</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Let <var>scopeString</var> be \"<code>/</code>\", followed by the strings in <var>scopeURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path⑥\">path</a> (including empty strings), separated from each other by \"<code>/</code>\".</p>"
            },
            {
              "html": "If <var>maxScopeString</var> is null or <var>scopeString</var> does not start with <var>maxScopeString</var>, then:",
              "rationale": "invoke",
              "steps": [
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise⑥\">Reject Job Promise</a> with <var>job</var> and \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror⑤\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑨\">DOMException</a></code>.</p>"
                },
                {
                  "html": "<p>Asynchronously complete these steps with a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑥\">network error</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>url</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑤\">url</a>.</p>"
            },
            {
              "html": "<p>Set <var>updatedResourceMap</var>[<var>url</var>] to <var>response</var>.</p>"
            },
            {
              "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-cache-state\" id=\"ref-for-concept-response-cache-state①\">cache state</a> is not \"<code>local</code>\", set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-last-update-check-time\" id=\"ref-for-dfn-last-update-check-time③\">last update check time</a> to the current time.</p>"
            },
            {
              "html": "<p>Set <var>hasUpdatedResources</var> to true if any of the following are true:</p>\n         <ul>\n          <li data-md=\"\">\n           <p><var>newestWorker</var> is null.</p>\n          </li><li data-md=\"\">\n           <p><var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url④\">script url</a> is not <var>url</var> or <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-type\" id=\"ref-for-dfn-type②\">type</a> is not <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-worker-type\" id=\"ref-for-dfn-job-worker-type⑥\">worker type</a>.</p>\n          </li><li data-md=\"\">\n           <p><var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource-map\" id=\"ref-for-dfn-script-resource-map②\">script resource map</a>[<var>url</var>]'s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body⑨\">body</a> is not byte-for-byte identical with <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body①⓪\">body</a>.</p>\n         </li></ul>"
            },
            {
              "html": "If <var>hasUpdatedResources</var> is false and <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-classic-scripts-imported-flag\" id=\"ref-for-dfn-classic-scripts-imported-flag①\">classic scripts imported flag</a> is set, then:",
              "rationale": "for",
              "steps": [
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate④\">For each</a> <var>importUrl</var> → <var>storedResponse</var> of <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource-map\" id=\"ref-for-dfn-script-resource-map③\">script resource map</a>:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>importUrl</var> is <var>url</var>, then continue.</p>"
                    },
                    {
                      "html": "<p>Let <var>importRequest</var> be a new <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request⑥\">request</a> whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑥\">url</a> is <var>importUrl</var>, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client②\">client</a> is <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client①⑨\">client</a>, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination①\">destination</a> is \"<code>script</code>\", <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-parser-metadata\" id=\"ref-for-concept-request-parser-metadata\">parser metadata</a> is \"<code>not parser-inserted</code>\", and whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-use-url-credentials-flag\" id=\"ref-for-concept-request-use-url-credentials-flag\">use-URL-credentials flag</a> is set.</p>"
                    },
                    {
                      "html": "<p>Set <var>importRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-cache-mode\" id=\"ref-for-concept-request-cache-mode②\">cache mode</a> to \"<code>no-cache</code>\" if any of the following are true:</p>\n             <ul>\n              <li data-md=\"\">\n               <p><var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-update-via-cache\" id=\"ref-for-dfn-update-via-cache⑤\">update via cache mode</a> is \"<code>none</code>\".</p>\n              </li><li data-md=\"\">\n               <p><var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-force-bypass-cache-flag\" id=\"ref-for-dfn-job-force-bypass-cache-flag①\">force bypass cache flag</a> is set.</p>\n              </li><li data-md=\"\">\n               <p><var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-stale\" id=\"ref-for-service-worker-registration-stale②\">stale</a>.</p>\n             </li></ul>"
                    },
                    {
                      "html": "<p>Let <var>fetchedResponse</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch①②\">fetching</a> <var>importRequest</var>.</p>"
                    },
                    {
                      "html": "<p>Set <var>updatedResourceMap</var>[<var>importRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑦\">url</a>] to <var>fetchedResponse</var>.</p>"
                    },
                    {
                      "html": "<p>Set <var>fetchedResponse</var> to <var>fetchedResponse</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/urls-and-fetching.html#unsafe-response\" id=\"ref-for-unsafe-response①\">unsafe response</a>.</p>"
                    },
                    {
                      "html": "<p>If <var>fetchedResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-cache-state\" id=\"ref-for-concept-response-cache-state②\">cache state</a> is not \"<code>local</code>\", set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-last-update-check-time\" id=\"ref-for-dfn-last-update-check-time④\">last update check time</a> to the current time.</p>"
                    },
                    {
                      "html": "<p>If <var>fetchedResponse</var> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-bad-import-script-response\" id=\"ref-for-dfn-bad-import-script-response①\">bad import script response</a>, continue.</p>"
                    },
                    {
                      "html": "<p>If <var>fetchedResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body①①\">body</a> is not byte-for-byte identical with <var>storedResponse</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/urls-and-fetching.html#unsafe-response\" id=\"ref-for-unsafe-response②\">unsafe response</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body①②\">body</a>, set <var>hasUpdatedResources</var> to true.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Asynchronously complete these steps with <var>response</var>.</p>"
            }
          ]
        },
        {
          "html": "If <var>script</var> is null or <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#is-async-module\" id=\"ref-for-is-async-module\">Is Async Module</a> with <var>script</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-script-record\" id=\"ref-for-concept-script-record\">record</a>, <var>script</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-script-base-url\" id=\"ref-for-concept-script-base-url②\">base URL</a>, and « » is true, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise⑦\">Reject Job Promise</a> with <var>job</var> and <code>TypeError</code>.</p>"
            },
            {
              "html": "<p>If <var>newestWorker</var> is null, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove①\">remove</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map④\">registration map</a>[(<var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key⑧\">storage key</a>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-serializer\" id=\"ref-for-concept-url-serializer①⓪\">serialized</a> <var>scopeURL</var>)].</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job⑥\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "If <var>hasUpdatedResources</var> is false, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-update-via-cache\" id=\"ref-for-dfn-update-via-cache⑥\">update via cache mode</a> to <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-update-via-cache-mode\" id=\"ref-for-dfn-job-update-via-cache-mode④\">update via cache mode</a>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#resolve-job-promise\" id=\"ref-for-resolve-job-promise①\">Resolve Job Promise</a> with <var>job</var> and <var>registration</var>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job⑦\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>worker</var> be a new <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker\" id=\"ref-for-dfn-service-worker⑨⑥\">service worker</a>.</p>"
        },
        {
          "html": "<p>Set <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url⑤\">script url</a> to <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-script-url\" id=\"ref-for-dfn-job-script-url①①\">script url</a>, <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource\" id=\"ref-for-dfn-script-resource④\">script resource</a> to <var>script</var>, <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-type\" id=\"ref-for-dfn-type③\">type</a> to <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-worker-type\" id=\"ref-for-dfn-job-worker-type⑦\">worker type</a>, and <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource-map\" id=\"ref-for-dfn-script-resource-map④\">script resource map</a> to <var>updatedResourceMap</var>.</p>"
        },
        {
          "html": "<p>Append <var>url</var> to <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-used-scripts\" id=\"ref-for-dfn-set-of-used-scripts③\">set of used scripts</a>.</p>"
        },
        {
          "html": "<p>Set <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource\" id=\"ref-for-dfn-script-resource⑤\">script resource</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-policy-container\" id=\"ref-for-dfn-policy-container\">policy container</a> to <var>policyContainer</var>.</p>"
        },
        {
          "html": "<p>Let <var>forceBypassCache</var> be true if <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-force-bypass-cache-flag\" id=\"ref-for-dfn-job-force-bypass-cache-flag②\">force bypass cache flag</a> is set, and false otherwise.</p>"
        },
        {
          "html": "<p>Let <var>runResult</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-service-worker\" id=\"ref-for-run-service-worker③\">Run Service Worker</a> algorithm with <var>worker</var> and <var>forceBypassCache</var>.</p>"
        },
        {
          "html": "If <var>runResult</var> is <em>failure</em> or an <a data-link-type=\"dfn\" data-refhint-key=\"49ea2b41\" href=\"http://tc39.github.io/ecma262/#sec-completion-record-specification-type\" id=\"ref-for-sec-completion-record-specification-type①\">abrupt completion</a>, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise⑨\">Reject Job Promise</a> with <var>job</var> and <code>TypeError</code>.</p>"
            },
            {
              "html": "<p>If <var>newestWorker</var> is null, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove②\">remove</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map⑤\">registration map</a>[(<var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key⑨\">storage key</a>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-serializer\" id=\"ref-for-concept-url-serializer①①\">serialized</a> <var>scopeURL</var>)].</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job⑧\">Finish Job</a> with <var>job</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Else, invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#install\" id=\"ref-for-install②\">Install</a> algorithm with <var>job</var>, <var>worker</var>, and <var>registration</var> as its arguments.</p>"
        }
      ]
    },
    {
      "name": "Soft Update",
      "href": "https://www.w3.org/TR/service-workers/#soft-update",
      "html": "The user agent <em>may</em> call this as often as it likes to check for updates.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>newestWorker</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-newest-worker\" id=\"ref-for-get-newest-worker③\">Get Newest Worker</a> algorithm passing <var>registration</var> as its argument.</p>"
        },
        {
          "html": "<p>If <var>newestWorker</var> is null, abort these steps.</p>"
        },
        {
          "html": "<p>Let <var>job</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-job\" id=\"ref-for-create-job③\">Create Job</a> with <em>update</em>, <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key①⓪\">storage key</a>, <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-url\" id=\"ref-for-dfn-scope-url①④\">scope url</a>, <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url⑥\">script url</a>, null, and null.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-worker-type\" id=\"ref-for-dfn-job-worker-type⑧\">worker type</a> to <var>newestWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-type\" id=\"ref-for-dfn-type④\">type</a>.</p>"
        },
        {
          "html": "<p>Set <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-force-bypass-cache-flag\" id=\"ref-for-dfn-job-force-bypass-cache-flag③\">force bypass cache flag</a> if <var>forceBypassCache</var> is true.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#schedule-job\" id=\"ref-for-schedule-job③\">Schedule Job</a> with <var>job</var>.</p>"
        }
      ]
    },
    {
      "name": "Install",
      "href": "https://www.w3.org/TR/service-workers/#install",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>installFailed</var> be false.</p>"
        },
        {
          "html": "<p>Let <var>newestWorker</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-newest-worker\" id=\"ref-for-get-newest-worker④\">Get Newest Worker</a> algorithm passing <var>registration</var> as its argument.</p>"
        },
        {
          "html": "<p>Set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-update-via-cache\" id=\"ref-for-dfn-update-via-cache⑦\">update via cache mode</a> to <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-update-via-cache-mode\" id=\"ref-for-dfn-job-update-via-cache-mode⑤\">update via cache mode</a>.</p>"
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>installing</code>\" and <var>worker</var> as the arguments.</p>"
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker⑧\">installing worker</a> and \"<code>installing</code>\" as the arguments.</p>"
        },
        {
          "html": "<p class=\"assertion\">Assert: <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-promise\" id=\"ref-for-dfn-job-promise⑥\">job promise</a> is not null.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#resolve-job-promise\" id=\"ref-for-resolve-job-promise②\">Resolve Job Promise</a> with <var>job</var> and <var>registration</var>.</p>"
        },
        {
          "html": "<p>Let <var>settingsObjects</var> be all <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②⓪\">environment settings objects</a> whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①④\">origin</a> is <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-url\" id=\"ref-for-dfn-scope-url①⑤\">scope url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin⑧\">origin</a>.</p>"
        },
        {
          "html": "For each <var>settingsObject</var> of <var>settingsObjects</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②⑦\">queue a task</a> on <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①⑤\">responsible event loop</a> in the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⓪\">DOM manipulation task source</a> to run the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>registrationObjects</var> be every <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerregistration\" id=\"ref-for-serviceworkerregistration①④\">ServiceWorkerRegistration</a></code> object in <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object's-realm\" id=\"ref-for-environment-settings-object's-realm⑨\">realm</a>, whose <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerregistration-service-worker-registration\" id=\"ref-for-serviceworkerregistration-service-worker-registration⑦\">service worker registration</a> is <var>registration</var>.</p>"
            },
            {
              "html": "<p>For each <var>registrationObject</var> of <var>registrationObjects</var>, <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire①\">fire an event</a> on <var>registrationObject</var> named <code>updatefound</code>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>installingWorker</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker⑨\">installing worker</a>.</p>"
        },
        {
          "html": "If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#should-skip-event\" id=\"ref-for-should-skip-event①\">Should Skip Event</a> algorithm with <var>installingWorker</var> and \"install\" is false, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>forceBypassCache</var> be true if <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-force-bypass-cache-flag\" id=\"ref-for-dfn-job-force-bypass-cache-flag④\">force bypass cache flag</a> is set, and false otherwise.</p>"
            },
            {
              "html": "If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-service-worker\" id=\"ref-for-run-service-worker④\">Run Service Worker</a> algorithm with <var>installingWorker</var> and <var>forceBypassCache</var> is <em>failure</em>, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>installFailed</var> to true.</p>"
                }
              ]
            },
            {
              "html": "Else:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②⑧\">Queue a task</a> <var>task</var> on <var>installingWorker</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop①⓪\">event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②①\">DOM manipulation task source</a> to run the following steps:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>e</var> be the result of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-create\" id=\"ref-for-concept-event-create②\">creating an event</a> with <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#installevent\" id=\"ref-for-installevent②\">InstallEvent</a></code>.</p>"
                    },
                    {
                      "html": "<p>Initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#dom-event-type\" id=\"ref-for-dom-event-type\">type</a></code> attribute to <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://www.w3.org/TR/service-workers/#service-worker-global-scope-install-event\" id=\"ref-for-service-worker-global-scope-install-event⑤\">install</a></code>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-dispatch\" id=\"ref-for-concept-event-dispatch④\">Dispatch</a> <var>e</var> at <var>installingWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①\">global object</a>.</p>"
                    },
                    {
                      "html": "<em>WaitForAsynchronousExtensions</em>: Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③⓪\">in parallel</a>:",
                      "rationale": "wait",
                      "steps": [
                        {
                          "html": "<p><span id=\"install-settle-step\">Wait until <var>e</var> is not <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-active\" id=\"ref-for-extendableevent-active①\">active</a>.</span></p>"
                        },
                        {
                          "html": "<p>If <var>e</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-timed-out-flag\" id=\"ref-for-extendableevent-timed-out-flag①\">timed out flag</a> is set, set <var>installFailed</var> to true.</p>"
                        },
                        {
                          "html": "<p>Let <var>p</var> be the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#waiting-for-all-promise\" id=\"ref-for-waiting-for-all-promise①\">getting a promise to wait for all</a> of <var>e</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-extend-lifetime-promises\" id=\"ref-for-extendableevent-extend-lifetime-promises⑥\">extend lifetime promises</a>.</p>"
                        },
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection③\">Upon rejection</a> of <var>p</var>, set <var>installFailed</var> to true.</p>"
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "<p>Wait for <var>task</var> to have executed or been discarded.</p>"
                },
                {
                  "html": "<p>Wait for the step labeled <em>WaitForAsynchronousExtensions</em> to complete.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "If <var>installFailed</var> is true, then:",
          "rationale": "run",
          "steps": [
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state①\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①⓪\">installing worker</a> and \"<code>redundant</code>\" as the arguments.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state①\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>installing</code>\" and null as the arguments.</p>"
            },
            {
              "html": "<p>If <var>newestWorker</var> is null, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove③\">remove</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map⑥\">registration map</a>[(<var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key①①\">storage key</a>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-serializer\" id=\"ref-for-concept-url-serializer①②\">serialized</a> <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-url\" id=\"ref-for-dfn-scope-url①⑥\">scope url</a>)].</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job⑨\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>map</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①①\">installing worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource-map\" id=\"ref-for-dfn-script-resource-map⑤\">script resource map</a>.</p>"
        },
        {
          "html": "<p>Let <var>usedSet</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①②\">installing worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-used-scripts\" id=\"ref-for-dfn-set-of-used-scripts④\">set of used scripts</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑤\">For each</a> <var>url</var> of <var>map</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>usedSet</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain①\">contain</a> <var>url</var>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove④\">remove</a> <var>map</var>[<var>url</var>].</p>"
            }
          ]
        },
        {
          "html": "If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker⑤\">waiting worker</a> is not null, then:",
          "rationale": "terminate",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#terminate-service-worker\" id=\"ref-for-terminate-service-worker③\">Terminate</a> <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker⑥\">waiting worker</a>.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state②\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker⑦\">waiting worker</a> and \"<code>redundant</code>\" as the arguments.</p>"
            }
          ]
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state②\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>waiting</code>\" and <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①③\">installing worker</a> as the arguments.</p>"
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state③\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>installing</code>\" and null as the arguments.</p>"
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state③\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker⑧\">waiting worker</a> and \"<code>installed</code>\" as the arguments.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job①⓪\">Finish Job</a> with <var>job</var>.</p>"
        },
        {
          "html": "<p>Wait for all the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task\" id=\"ref-for-concept-task④\">tasks</a> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task②⑨\">queued</a> by <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state④\">Update Worker State</a> invoked in this algorithm to have executed.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#try-activate\" id=\"ref-for-try-activate②\">Try Activate</a> with <var>registration</var>.</p>"
        }
      ]
    },
    {
      "name": "Activate",
      "href": "https://www.w3.org/TR/service-workers/#activate",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker⑨\">waiting worker</a> is null, abort these steps.</p>"
        },
        {
          "html": "If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker②②\">active worker</a> is not null, then:",
          "rationale": "terminate",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#terminate-service-worker\" id=\"ref-for-terminate-service-worker④\">Terminate</a> <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker②③\">active worker</a>.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state⑤\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker②④\">active worker</a> and \"<code>redundant</code>\" as the arguments.</p>"
            }
          ]
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state④\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>active</code>\" and <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①⓪\">waiting worker</a> as the arguments.</p>"
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state⑤\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>waiting</code>\" and null as the arguments.</p>"
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state⑥\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker②⑤\">active worker</a> and \"<code>activating</code>\" as the arguments.</p>"
        },
        {
          "html": "<p>Let <var>matchedClients</var> be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②②\">list</a> of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client③⑨\">service worker clients</a> whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url⑦\">creation URL</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-service-worker-registration\" id=\"ref-for-match-service-worker-registration⑥\">matches</a> <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key①②\">storage key</a> and <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-url\" id=\"ref-for-dfn-scope-url①⑦\">scope url</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①⑤\">For each</a> <var>client</var> of <var>matchedClients</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③⓪\">queue a task</a> on <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①⑥\">responsible event loop</a>, using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②②\">DOM manipulation task source</a>, to run the following substeps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>readyPromise</var> be <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global\" id=\"ref-for-concept-settings-object-global⑨\">global object</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer\" id=\"ref-for-serviceworkercontainer①⑤\">ServiceWorkerContainer</a></code> object’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-ready-promise\" id=\"ref-for-serviceworkercontainer-ready-promise④\">ready promise</a>.</p>"
            },
            {
              "html": "<p>If <var>readyPromise</var> is null, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑧\">continue</a>.</p>"
            },
            {
              "html": "<p><span id=\"activate-resolve-ready-step\">If <var>readyPromise</var> is pending, resolve <var>readyPromise</var> with the the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-registration-object\" id=\"ref-for-get-the-service-worker-registration-object⑥\">getting the service worker registration object</a> that represents <var>registration</var> in <var>readyPromise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②⑦\">relevant settings object</a></span>.</p>"
            }
          ]
        },
        {
          "html": "For each <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client④⓪\">service worker client</a> <var>client</var> who is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-use\" id=\"ref-for-dfn-use②\">using</a> <var>registration</var>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker②⑥\">active worker</a> to <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker②⑦\">active worker</a>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#notify-controller-change\" id=\"ref-for-notify-controller-change①\">Notify Controller Change</a> algorithm with <var>client</var> as the argument.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>activeWorker</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker②⑧\">active worker</a>.</p>"
        },
        {
          "html": "If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#should-skip-event\" id=\"ref-for-should-skip-event②\">Should Skip Event</a> algorithm with <var>activeWorker</var> and \"activate\" is false, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-service-worker\" id=\"ref-for-run-service-worker⑤\">Run Service Worker</a> algorithm with <var>activeWorker</var> is not <em>failure</em>, then:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③①\">Queue a task</a> <var>task</var> on <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop①①\">event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②③\">DOM manipulation task source</a> to run the following steps:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>e</var> be the result of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-create\" id=\"ref-for-concept-event-create③\">creating an event</a> with <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#extendableevent\" id=\"ref-for-extendableevent①⑥\">ExtendableEvent</a></code>.</p>"
                    },
                    {
                      "html": "<p>Initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#dom-event-type\" id=\"ref-for-dom-event-type①\">type</a></code> attribute to <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://www.w3.org/TR/service-workers/#service-worker-global-scope-activate-event\" id=\"ref-for-service-worker-global-scope-activate-event⑤\">activate</a></code>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-dispatch\" id=\"ref-for-concept-event-dispatch⑤\">Dispatch</a> <var>e</var> at <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object②\">global object</a>.</p>"
                    },
                    {
                      "html": "<p><span id=\"activate-settle-step\"><em>WaitForAsynchronousExtensions</em>: Wait, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③①\">in parallel</a>, until <var>e</var> is not <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-active\" id=\"ref-for-extendableevent-active②\">active</a>.</span></p>"
                    }
                  ]
                },
                {
                  "html": "<p>Wait for <var>task</var> to have executed or been discarded.</p>"
                },
                {
                  "html": "<p>Wait for the step labeled <em>WaitForAsynchronousExtensions</em> to complete.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state⑦\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker②⑨\">active worker</a> and \"<code>activated</code>\" as the arguments.</p>"
        }
      ]
    },
    {
      "name": "Try Activate",
      "href": "https://www.w3.org/TR/service-workers/#try-activate",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①①\">waiting worker</a> is null, return.</p>"
        },
        {
          "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③⓪\">active worker</a> is not null and <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③①\">active worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state⑦\">state</a> is \"<code>activating</code>\", return.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#activate\" id=\"ref-for-activate⑤\">Activate</a> with <var>registration</var> if either of the following is true:</p>\n       <ul>\n        <li data-md=\"\">\n         <p><var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③②\">active worker</a> is null.</p>\n        </li><li data-md=\"\">\n         <p>The result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-has-no-pending-events\" id=\"ref-for-service-worker-has-no-pending-events①\">Service Worker Has No Pending Events</a> with <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③③\">active worker</a> is true, and no <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client④①\">service worker client</a> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-use\" id=\"ref-for-dfn-use③\">using</a> <var>registration</var> or <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①②\">waiting worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-skip-waiting-flag\" id=\"ref-for-dfn-skip-waiting-flag②\">skip waiting flag</a> is set.</p>\n       </li></ul>"
        }
      ]
    },
    {
      "name": "Setup ServiceWorkerGlobalScope",
      "href": "https://www.w3.org/TR/service-workers/#setup-serviceworkerglobalscope",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>unsafeCreationTime</var> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-unsafe-shared-current-time\" id=\"ref-for-dfn-unsafe-shared-current-time\">unsafe shared current time</a>.</p>"
        },
        {
          "html": "<p>If <var>serviceWorker</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-running\" id=\"ref-for-service-worker-running\">running</a>, then return <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object③\">global object</a>.</p>"
        },
        {
          "html": "<p>If <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state⑧\">state</a> is \"<code>redundant</code>\", then return null.</p>"
        },
        {
          "html": "<p>If <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object④\">global object</a> is not null, then return <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object⑤\">global object</a>.</p>"
        },
        {
          "html": "<p class=\"assertion\">Assert: <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-start-status\" id=\"ref-for-service-worker-start-status\">start status</a> is null.</p>"
        },
        {
          "html": "<p>Let <var>setupFailed</var> be false.</p>"
        },
        {
          "html": "<p>Let <var>globalObject</var> be null.</p>"
        },
        {
          "html": "Let <var>agent</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#obtain-a-service-worker-agent\" id=\"ref-for-obtain-a-service-worker-agent\">obtaining a service worker agent</a>, and run the following steps in that context:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>realmExecutionContext</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#creating-a-new-javascript-realm\" id=\"ref-for-creating-a-new-javascript-realm\">creating a new realm</a> given <var>agent</var> and the following customizations:</p>\n         <ul>\n          <li data-md=\"\">\n           <p>For the global object, create a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope\" id=\"ref-for-serviceworkerglobalscope②①\">ServiceWorkerGlobalScope</a></code> object. Let <var>workerGlobalScope</var> be the created object.</p>\n         </li></ul>"
            },
            {
              "html": "<p>Let <var>settingsObject</var> be a new <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②①\">environment settings object</a> whose algorithms are defined as follows:</p>\n         <dl>\n          <dt data-md=\"\">The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#realm-execution-context\" id=\"ref-for-realm-execution-context\">realm execution context</a>\n          </dt><dd data-md=\"\">\n           <p>Return <var>realmExecutionContext</var>.</p>\n          </dd><dt data-md=\"\">The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-module-map\" id=\"ref-for-concept-settings-object-module-map\">module map</a>\n          </dt><dd data-md=\"\">\n           <p>Return <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-module-map\" id=\"ref-for-concept-workerglobalscope-module-map\">module map</a>.</p>\n          </dd><dt data-md=\"\">The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#api-base-url\" id=\"ref-for-api-base-url⑤\">API base URL</a>\n          </dt><dd data-md=\"\">\n           <p>Return <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url⑦\">script url</a>.</p>\n          </dd><dt data-md=\"\">The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①⑤\">origin</a>\n          </dt><dd data-md=\"\">\n           <p>Return its registering <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client④②\">service worker client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①⑥\">origin</a>.</p>\n          </dd><dt data-md=\"\">The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-policy-container\" id=\"ref-for-concept-settings-object-policy-container\">policy container</a>\n          </dt><dd data-md=\"\">\n           <p>Return <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-policy-container\" id=\"ref-for-concept-workerglobalscope-policy-container\">policy container</a>.</p>\n          </dd><dt data-md=\"\">The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-time-origin\" id=\"ref-for-concept-settings-object-time-origin\">time origin</a>\n          </dt><dd data-md=\"\">\n           <p>Return the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-coarsen-time\" id=\"ref-for-dfn-coarsen-time\">coarsening</a> <var>unsafeCreationTime</var> given <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-cross-origin-isolated-capability\" id=\"ref-for-concept-workerglobalscope-cross-origin-isolated-capability\">cross-origin isolated capability</a>.</p>\n         </dd></dl>"
            },
            {
              "html": "<p>Set <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id\" id=\"ref-for-concept-environment-id②\">id</a> to a new unique opaque string, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url⑧\">creation URL</a> to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url⑧\">script url</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-creation-url\" id=\"ref-for-concept-environment-top-level-creation-url\">top-level creation URL</a> to null, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin\">top-level origin</a> to an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined\">implementation-defined</a> value, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context①\">target browsing context</a> to null, and <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker②⑤\">active service worker</a> to null.</p>"
            },
            {
              "html": "<p>Set <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-url\" id=\"ref-for-concept-workerglobalscope-url\">url</a> to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url⑨\">script url</a>.</p>"
            },
            {
              "html": "<p>Set <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-policy-container\" id=\"ref-for-concept-workerglobalscope-policy-container①\">policy container</a> to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource\" id=\"ref-for-dfn-script-resource⑥\">script resource</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-policy-container\" id=\"ref-for-dfn-policy-container①\">policy container</a>.</p>"
            },
            {
              "html": "<p>Set <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-type\" id=\"ref-for-concept-workerglobalscope-type\">type</a> to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-type\" id=\"ref-for-dfn-type⑤\">type</a>.</p>"
            },
            {
              "html": "<p>Create a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/workers.html#workerlocation\" id=\"ref-for-workerlocation\">WorkerLocation</a></code> object and associate it with <var>workerGlobalScope</var>.</p>"
            },
            {
              "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/CSP3/#run-global-object-csp-initialization\" id=\"ref-for-run-global-object-csp-initialization\">run CSP initialization for a global object</a> algorithm returns \"<code>Blocked</code>\" when executed upon <var>workerGlobalScope</var>, set <var>setupFailed</var> to true and abort these steps.</p>"
            },
            {
              "html": "<p>Set <var>globalObject</var> to <var>workerGlobalScope</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Wait for <var>globalObject</var> is not null, or for <var>setupFailed</var> to be true.</p>"
        },
        {
          "html": "<p>If <var>setupFailed</var> is true, then return null.</p>"
        },
        {
          "html": "<p>Return <var>globalObject</var>.</p>"
        }
      ]
    },
    {
      "name": "Run Service Worker",
      "href": "https://www.w3.org/TR/service-workers/#run-service-worker",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>serviceWorker</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-running\" id=\"ref-for-service-worker-running②\">running</a>, then return <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-start-status\" id=\"ref-for-service-worker-start-status①\">start status</a>.</p>"
        },
        {
          "html": "<p>If <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state⑨\">state</a> is \"<code>redundant</code>\", then return <em>failure</em>.</p>"
        },
        {
          "html": "<p class=\"assertion\">Assert: <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-start-status\" id=\"ref-for-service-worker-start-status②\">start status</a> is null.</p>"
        },
        {
          "html": "<p>Let <var>script</var> be <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-resource\" id=\"ref-for-dfn-script-resource⑦\">script resource</a>.</p>"
        },
        {
          "html": "<p class=\"assertion\">Assert: <var>script</var> is not null.</p>"
        },
        {
          "html": "<p>Let <var>startFailed</var> be false.</p>"
        },
        {
          "html": "<p>Let <var>workerGlobalScope</var> be <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object⑥\">global object</a>.</p>"
        },
        {
          "html": "If <var>workerGlobalScope</var> is null:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>workerGlobalScope</var> to be the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#setup-serviceworkerglobalscope\" id=\"ref-for-setup-serviceworkerglobalscope\">Setup ServiceWorkerGlobalScope</a> algorithm with <var>serviceWorker</var>.</p>"
            },
            {
              "html": "<p>If <var>workerGlobalScope</var> is null, then return <em>failure</em>.</p>"
            },
            {
              "html": "<p>Set <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object⑦\">global object</a> to <var>workerGlobalScope</var>.</p>"
            }
          ]
        },
        {
          "html": "Obtain agent for <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#realm-execution-context\" id=\"ref-for-realm-execution-context①\">realm execution context</a>, and run the following steps in that context:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-force-bypass-cache-for-import-scripts-flag\" id=\"ref-for-serviceworkerglobalscope-force-bypass-cache-for-import-scripts-flag①\">force bypass cache for import scripts flag</a> if <var>forceBypassCache</var> is true.</p>"
            },
            {
              "html": "<p>If <var>serviceWorker</var> is an <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③④\">active worker</a>, and there are any <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task\" id=\"ref-for-concept-task⑤\">tasks</a> queued in <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration①⑥\">containing service worker registration</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration-task-queue\" id=\"ref-for-dfn-service-worker-registration-task-queue②\">task queues</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③②\">queue</a> them to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop①②\">event loop</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#task-queue\" id=\"ref-for-task-queue③\">task queues</a> in the same order using their original <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#task-source\" id=\"ref-for-task-source⑤\">task sources</a>.</p>"
            },
            {
              "html": "<p>Let <var>evaluationStatus</var> be null.</p>"
            },
            {
              "html": "If <var>script</var> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#classic-script\" id=\"ref-for-classic-script\">classic script</a>, then:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>evaluationStatus</var> to the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#run-a-classic-script\" id=\"ref-for-run-a-classic-script\">running the classic script</a> <var>script</var>.</p>"
                },
                {
                  "html": "<p>If <var>evaluationStatus</var>.[[Value]] is empty, this means the script was not evaluated. Set <var>startFailed</var> to true and abort these steps.</p>"
                }
              ]
            },
            {
              "html": "Otherwise, if <var>script</var> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#module-script\" id=\"ref-for-module-script\">module script</a>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>evaluationPromise</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#run-a-module-script\" id=\"ref-for-run-a-module-script\">running the module script</a> <var>script</var>, with report errors set to false.</p>"
                },
                {
                  "html": "<p class=\"assertion\">Assert: <var>evaluationPromise</var>.[[PromiseState]] is not \"pending\".</p>"
                },
                {
                  "html": "If <var>evaluationPromise</var>.[[PromiseState]] is \"rejected\":",
                  "rationale": "set",
                  "steps": [
                    {
                      "html": "<p>Set <var>evaluationStatus</var> to <a data-link-type=\"abstract-op\" href=\"http://tc39.github.io/ecma262/#sec-throwcompletion\" id=\"ref-for-sec-throwcompletion\">ThrowCompletion</a>(<var>evaluationPromise</var>.[[PromiseResult]]).</p>"
                    }
                  ]
                },
                {
                  "html": "Otherwise:",
                  "rationale": "set",
                  "steps": [
                    {
                      "html": "<p>Set <var>evaluationStatus</var> to <a data-link-type=\"abstract-op\" href=\"http://tc39.github.io/ecma262/#sec-normalcompletion\" id=\"ref-for-sec-normalcompletion\">NormalCompletion</a>(undefined).</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>If the script was aborted by the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#terminate-service-worker\" id=\"ref-for-terminate-service-worker⑤\">Terminate Service Worker</a> algorithm, set <var>startFailed</var> to true and abort these steps.</p>"
            },
            {
              "html": "<p>Set <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-start-status\" id=\"ref-for-service-worker-start-status③\">start status</a> to <var>evaluationStatus</var>.</p>"
            },
            {
              "html": "If <var>script</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-has-ever-been-evaluated-flag\" id=\"ref-for-dfn-has-ever-been-evaluated-flag\">has ever been evaluated flag</a> is unset, then:",
              "rationale": "for",
              "steps": [
                {
                  "html": "For each <var>eventType</var> of <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global\" id=\"ref-for-concept-settings-object-global①⓪\">global object</a>’s associated list of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-listener\" id=\"ref-for-concept-event-listener①\">event listeners</a>' event types:",
                  "rationale": "append",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append②\">Append</a> <var>eventType</var> to <var>workerGlobalScope</var>’s associated <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-service-worker\" id=\"ref-for-serviceworkerglobalscope-service-worker②⑤\">service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-event-types-to-handle\" id=\"ref-for-dfn-set-of-event-types-to-handle①\">set of event types to handle</a>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Set <var>script</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-has-ever-been-evaluated-flag\" id=\"ref-for-dfn-has-ever-been-evaluated-flag①\">has ever been evaluated flag</a>.</p>"
                },
                {
                  "html": "<p>Unset the <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-all-fetch-listeners-are-empty-flag\" id=\"ref-for-service-worker-all-fetch-listeners-are-empty-flag\">all fetch listeners are empty flag</a>.</p>"
                },
                {
                  "html": "<p>The user agent may, if the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#all-fetch-listeners-are-empty\" id=\"ref-for-all-fetch-listeners-are-empty\">All Fetch Listeners Are Empty</a> algorithm with <var>workerGlobalScope</var> returns true, set <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-all-fetch-listeners-are-empty-flag\" id=\"ref-for-service-worker-all-fetch-listeners-are-empty-flag①\">all fetch listeners are empty flag</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①⑦\">responsible event loop</a> specified by <var>settingsObject</var> until it is destroyed.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-clear\" id=\"ref-for-map-clear\">Clear</a> <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#map-of-active-timers\" id=\"ref-for-map-of-active-timers\">map of active timers</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Wait for <var>serviceWorker</var> to be <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-running\" id=\"ref-for-service-worker-running③\">running</a>, or for <var>startFailed</var> to be true.</p>"
        },
        {
          "html": "<p>If <var>startFailed</var> is true, then return <em>failure</em>.</p>"
        },
        {
          "html": "<p>Return <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-start-status\" id=\"ref-for-service-worker-start-status④\">start status</a>.</p>"
        }
      ]
    },
    {
      "name": "All Fetch Listeners Are Empty",
      "href": "https://www.w3.org/TR/service-workers/#all-fetch-listeners-are-empty",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-event-types-to-handle\" id=\"ref-for-dfn-set-of-event-types-to-handle③\">set of event types to handle</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain②\">contain</a> <code>fetch</code>, then return true.</p>"
        },
        {
          "html": "<p>Let <var>eventHandler</var> be <var>workerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-map\" id=\"ref-for-event-handler-map\">event handler map</a>[\"onfetch\"]'s value.</p>"
        },
        {
          "html": "<p>Let <var>eventListenerCallbacks</var> be the result of calling <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#legacy-obtain-service-worker-fetch-event-listener-callbacks\" id=\"ref-for-legacy-obtain-service-worker-fetch-event-listener-callbacks\">legacy-obtain service worker fetch event listener callbacks</a> given <var>workerGlobalScope</var>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①⑥\">For each</a> <var>eventListenerCallback</var> of <var>eventListenerCallbacks</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>callback</var> be null.</p>"
            },
            {
              "html": "<p>If <var>eventHandler</var> is not null and <var>eventListenerCallback</var> equals <var>eventHandler</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-listener\" id=\"ref-for-event-handler-listener\">listener</a>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#event-listener-callback\" id=\"ref-for-event-listener-callback\">callback</a>, then set <var>callback</var> to the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-convert-idl-to-javascript-value\" id=\"ref-for-dfn-convert-idl-to-javascript-value\">converting to an ECMAScript value</a> <var>eventHandler</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-value\" id=\"ref-for-event-handler-value\">value</a>.</p>"
            },
            {
              "html": "<p>Otherwise, set <var>callback</var> to the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-convert-idl-to-javascript-value\" id=\"ref-for-dfn-convert-idl-to-javascript-value①\">converting to an ECMAScript value</a> <var>eventListenerCallback</var>.</p>"
            },
            {
              "html": "<p>If <a data-link-type=\"abstract-op\" href=\"http://tc39.github.io/ecma262/#sec-iscallable\" id=\"ref-for-sec-iscallable\">IsCallable</a>(<var>callback</var>) is false, then return false.</p>"
            },
            {
              "html": "<p>If <var>callback</var>’s <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#prod-FunctionBody\" id=\"ref-for-prod-FunctionBody\">function body</a> is not empty (i.e. either a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-ecmascript-language-statements-and-declarations\" id=\"ref-for-sec-ecmascript-language-statements-and-declarations\">statement</a> or <a data-link-type=\"dfn\" data-refhint-key=\"4bf6be53\" href=\"http://tc39.github.io/ecma262/#sec-ecmascript-language-statements-and-declarations\" id=\"ref-for-sec-ecmascript-language-statements-and-declarations①\">declaration</a> exist), then return false.</p>"
            }
          ]
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "Terminate Service Worker",
      "href": "https://www.w3.org/TR/service-workers/#terminate-service-worker",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③②\">in parallel</a> with <var>serviceWorker</var>’s main loop:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>serviceWorkerGlobalScope</var> be <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object⑨\">global object</a>.</p>"
            },
            {
              "html": "<p>Set <var>serviceWorkerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#dom-workerglobalscope-closing\" id=\"ref-for-dom-workerglobalscope-closing\">closing</a> flag to true.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove\">Remove</a> all the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item①⓪\">items</a> from <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-extended-events\" id=\"ref-for-dfn-set-of-extended-events\">set of extended events</a>.</p>"
            },
            {
              "html": "<p>If there are any <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task\" id=\"ref-for-concept-task⑥\">tasks</a>, whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#task-source\" id=\"ref-for-task-source⑥\">task source</a> is either the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-handle-fetch-task-source\" id=\"ref-for-dfn-handle-fetch-task-source①\">handle fetch task source</a> or the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-handle-functional-event-task-source\" id=\"ref-for-dfn-handle-functional-event-task-source①\">handle functional event task source</a>, queued in <var>serviceWorkerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop①③\">event loop</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#task-queue\" id=\"ref-for-task-queue④\">task queues</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③③\">queue</a> them to <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration①⑦\">containing service worker registration</a>’s corresponding <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration-task-queue\" id=\"ref-for-dfn-service-worker-registration-task-queue③\">task queues</a> in the same order using their original <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#task-source\" id=\"ref-for-task-source⑦\">task sources</a>, and discard all the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task\" id=\"ref-for-concept-task⑦\">tasks</a> (including <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task\" id=\"ref-for-concept-task⑧\">tasks</a> whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#task-source\" id=\"ref-for-task-source⑧\">task source</a> is neither the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-handle-fetch-task-source\" id=\"ref-for-dfn-handle-fetch-task-source②\">handle fetch task source</a> nor the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-handle-functional-event-task-source\" id=\"ref-for-dfn-handle-functional-event-task-source②\">handle functional event task source</a>) from <var>serviceWorkerGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop①④\">event loop</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#task-queue\" id=\"ref-for-task-queue⑤\">task queues</a> without processing them.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#abort-a-running-script\" id=\"ref-for-abort-a-running-script\">Abort the script</a> currently running in <var>serviceWorker</var>.</p>"
            },
            {
              "html": "<p>Set <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-start-status\" id=\"ref-for-service-worker-start-status⑤\">start status</a> to null.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "Handle Fetch",
      "href": "https://www.w3.org/TR/service-workers/#handle-fetch",
      "html": "The <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#handle-fetch\" id=\"ref-for-handle-fetch⑦\">Handle Fetch</a> algorithm is the entry point for the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch①③\">fetch</a> handling handed to the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker\" id=\"ref-for-dfn-service-worker①⓪①\">service worker</a> context.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>registration</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>client</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client③\">client</a>.</p>"
        },
        {
          "html": "<p>Let <var>reservedClient</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client\">reserved client</a>.</p>"
        },
        {
          "html": "<p>Let <var>preloadResponse</var> be a new <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-promise-objects\" id=\"ref-for-sec-promise-objects③①\">promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>workerRealm</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>timingInfo</var> be a new <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-timing-info\" id=\"ref-for-service-worker-timing-info\">service worker timing info</a>.</p>"
        },
        {
          "html": "<p class=\"assertion\">Assert: <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination②\">destination</a> is not \"<code>serviceworker</code>\".</p>"
        },
        {
          "html": "If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination③\">destination</a> is either \"<code>embed</code>\" or \"<code>object</code>\", then:",
          "rationale": "return",
          "steps": [
            {
              "html": "<p>Return null.</p>"
            }
          ]
        },
        {
          "html": "Else if <var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#non-subresource-request\" id=\"ref-for-non-subresource-request\">non-subresource request</a>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>reservedClient</var> is not null and is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②②\">environment settings object</a>, then:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>reservedClient</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context\" id=\"ref-for-secure-context④\">secure context</a>, return null.</p>"
                }
              ]
            },
            {
              "html": "Else:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑧\">url</a> is not a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/secure-contexts/#potentially-trustworthy-url\" id=\"ref-for-potentially-trustworthy-url\">potentially trustworthy URL</a>, return null.</p>"
                }
              ]
            },
            {
              "html": "<p>If <var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#navigation-request\" id=\"ref-for-navigation-request\">navigation request</a> and the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate\" id=\"ref-for-navigate⑥\">navigation</a> triggering it was initiated with a shift+reload or equivalent, return null.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-algorithm-conventions\" id=\"ref-for-sec-algorithm-conventions\">Assert</a> <var>reservedClient</var> is not null.</p>"
            },
            {
              "html": "<p>Let <var>storage key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key①⓪\">obtain a storage key</a> given <var>reservedClient</var>.</p>"
            },
            {
              "html": "<p>Set <var>registration</var> to the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-service-worker-registration\" id=\"ref-for-match-service-worker-registration⑦\">Match Service Worker Registration</a> given <var>storage key</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url⑨\">url</a>.</p>"
            },
            {
              "html": "<p>If <var>registration</var> is null or <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③⑤\">active worker</a> is null, return null.</p>"
            },
            {
              "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination④\">destination</a> is not <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#dom-requestdestination-report\" id=\"ref-for-dom-requestdestination-report\">\"report\"</a></code>, set <var>reservedClient</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker②⑥\">active service worker</a> to <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③⑥\">active worker</a>.</p>"
            }
          ]
        },
        {
          "html": "Else if <var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#subresource-request\" id=\"ref-for-subresource-request\">subresource request</a>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker②⑧\">active service worker</a> is non-null, set <var>registration</var> to <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker②⑨\">active service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration①⑨\">containing service worker registration</a>.</p>"
            },
            {
              "html": "<p>Else, return null.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>activeWorker</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③⑦\">active worker</a>.</p>"
        },
        {
          "html": "<p>Let <var>shouldSoftUpdate</var> be true if any of the following are true, and false otherwise:</p>\n       <ul>\n        <li data-md=\"\">\n         <p><var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#non-subresource-request\" id=\"ref-for-non-subresource-request①\">non-subresource request</a>.</p>\n        </li><li data-md=\"\">\n         <p><var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#subresource-request\" id=\"ref-for-subresource-request①\">subresource request</a> and <var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-stale\" id=\"ref-for-service-worker-registration-stale③\">stale</a>.</p>\n       </li></ul>"
        },
        {
          "html": "If <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-list-of-router-rules\" id=\"ref-for-service-worker-list-of-router-rules②\">list of router rules</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty③\">is not empty</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>source</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-router-source\" id=\"ref-for-get-router-source\">Get Router Source</a> algorithm with <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③⑧\">active worker</a> and <var>request</var>.</p>"
            },
            {
              "html": "If <var>source</var> is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourceenum-network\" id=\"ref-for-dom-routersourceenum-network\">\"network\"</a></code>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>shouldSoftUpdate</var> is true, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③③\">in parallel</a> run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update①\">Soft Update</a> algorithm with <var>registration</var>.</p>"
                },
                {
                  "html": "<p>Return null.</p>"
                }
              ]
            },
            {
              "html": "Else if <var>source</var> is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourceenum-cache\" id=\"ref-for-dom-routersourceenum-cache\">\"cache\"</a></code>, or <var>source</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourcedict-cachename\" id=\"ref-for-dom-routersourcedict-cachename\">cacheName</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑦\">exists</a>, then:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>shouldSoftUpdate</var> is true, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③④\">in parallel</a> run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update②\">Soft Update</a> algorithm with <var>registration</var>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑥\">For each</a> <var>cacheName</var> → <var>cache</var> of the <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key①③\">storage key</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-name-to-cache-map\" id=\"ref-for-dfn-name-to-cache-map⑥\">name to cache map</a>.",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>source</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourcedict-cachename\" id=\"ref-for-dom-routersourcedict-cachename①\">cacheName</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑧\">exists</a> and <var>source</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourcedict-cachename\" id=\"ref-for-dom-routersourcedict-cachename②\">cacheName</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-is\" id=\"ref-for-string-is\">is</a> not <var>cacheName</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑨\">continue</a>.</p>"
                    },
                    {
                      "html": "<p>Let <var>requestResponses</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#query-cache\" id=\"ref-for-query-cache②\">Query Cache</a> with <var>request</var>, a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dictdef-cachequeryoptions\" id=\"ref-for-dictdef-cachequeryoptions⑥\">CacheQueryOptions</a></code>, and <var>cache</var>.</p>"
                    },
                    {
                      "html": "<p>If <var>requestResponses</var> is an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②③\">list</a>, return null.</p>"
                    },
                    {
                      "html": "Else:",
                      "rationale": "let",
                      "steps": [
                        {
                          "html": "<p>Let <var>requestResponse</var> be the first element of <var>requestResponses</var>.</p>"
                        },
                        {
                          "html": "<p>Let <var>response</var> be <var>requestResponse</var>’s response.</p>"
                        },
                        {
                          "html": "<p>Let <var>globalObject</var> be <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①⓪\">global object</a>.</p>"
                        },
                        {
                          "html": "If <var>globalObject</var> is null:",
                          "rationale": "set",
                          "steps": [
                            {
                              "html": "<p>Set <var>globalObject</var> to the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#setup-serviceworkerglobalscope\" id=\"ref-for-setup-serviceworkerglobalscope①\">Setup ServiceWorkerGlobalScope</a> with <var>activeWorker</var>.</p>"
                            }
                          ]
                        },
                        {
                          "html": "<p>If <var>globalObject</var> is null, return null.</p>"
                        }
                      ],
                      "additional": [
                        {
                          "html": "Else:",
                          "rationale": "if",
                          "steps": [
                            {
                              "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-type\" id=\"ref-for-concept-response-type③\">type</a> is \"<code>opaque</code>\", and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#cross-origin-resource-policy-check\" id=\"ref-for-cross-origin-resource-policy-check①\">cross-origin resource policy check</a> with <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①⑦\">origin</a>, <var>globalObject</var>, \"\", and <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-internal-response\" id=\"ref-for-concept-internal-response①\">internal response</a> returns <b>blocked</b>, then return null.</p>"
                            },
                            {
                              "html": "<p>Return <var>response</var>.</p>"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "<p>Return null.</p>"
                }
              ]
            },
            {
              "html": "Else if <var>source</var> is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourceenum-race-network-and-fetch-handler\" id=\"ref-for-dom-routersourceenum-race-network-and-fetch-handler②\">\"race-network-and-fetch-handler\"</a></code>, and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method⑤\">method</a> is `<code>GET</code>` then:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>shouldSoftUpdate</var> is true, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③⑤\">in parallel</a> run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update③\">Soft Update</a> algorithm with <var>registration</var>.</p>"
                },
                {
                  "html": "<p>Let <var>queue</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue\" id=\"ref-for-queue①\">queue</a> of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response①①\">response</a>.</p>"
                },
                {
                  "html": "<p>Let <var>raceFetchController</var> be null.</p>"
                },
                {
                  "html": "<p>Let <var>raceResponse</var> be a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-race-response\" id=\"ref-for-dfn-race-response①\">race response</a> whose <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value\">value</a> is \"<code>pending</code>\".</p>"
                },
                {
                  "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③⑥\">in parallel</a>, but <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#abort-when\" id=\"ref-for-abort-when\">abort when</a> <var>fetchController</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-state\" id=\"ref-for-fetch-controller-state\">state</a> is \"<code>terminated</code>\" or \"<code>aborted</code>\":",
                  "rationale": "set",
                  "steps": [
                    {
                      "html": "Set <var>raceFetchController</var> to the result of calling <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch①④\">fetch</a> given <var>request</var>, with <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#process-response\" id=\"ref-for-process-response②\">processResponse</a> set to the following steps given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response①②\">response</a> <var>raceNetworkRequestResponse</var>:",
                      "rationale": "if",
                      "steps": [
                        {
                          "html": "If <var>raceNetworkRequestResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status③\">status</a> is <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#ok-status\" id=\"ref-for-ok-status②\">ok status</a>, then:",
                          "rationale": "set",
                          "steps": [
                            {
                              "html": "<p>Set <var>raceResponse</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value①\">value</a> to <var>raceNetworkRequestResponse</var>.</p>"
                            },
                            {
                              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-enqueue\" id=\"ref-for-queue-enqueue③\">Enqueue</a> <var>raceNetworkRequestResponse</var> to <var>queue</var>.</p>"
                            }
                          ]
                        },
                        {
                          "html": "<p>Otherwise, set <var>raceResponse</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value②\">value</a> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑦\">network error</a>.</p>"
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#if-aborted\" id=\"ref-for-if-aborted\">If aborted</a> and <var>raceFetchController</var> is not null, then:",
                  "rationale": "abort",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-abort\" id=\"ref-for-fetch-controller-abort②\">Abort</a> <var>raceFetchController</var>.</p>"
                    },
                    {
                      "html": "<p>Set <var>raceResponse</var> to a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-race-response\" id=\"ref-for-dfn-race-response②\">race response</a> whose <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value③\">value</a> is null.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Resolve <var>preloadResponse</var> with undefined.</p>"
                },
                {
                  "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③⑦\">in parallel</a>:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>fetchHandlerResponse</var> be the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-fetch-event-and-dispatch\" id=\"ref-for-create-fetch-event-and-dispatch\">Create Fetch Event and Dispatch</a> with <var>request</var>, <var>registration</var>, <var>useHighResPerformanceTimers</var>, <var>timingInfo</var>, <var>workerRealm</var>, <var>reservedClient</var>, <var>preloadResponse</var>, and <var>raceResponse</var>.</p>"
                    },
                    {
                      "html": "<p>If <var>fetchHandlerResponse</var> is not null and not a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑧\">network error</a>, and <var>raceFetchController</var> is not null, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-abort\" id=\"ref-for-fetch-controller-abort③\">abort</a> <var>raceFetchController</var>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-enqueue\" id=\"ref-for-queue-enqueue④\">Enqueue</a> <var>fetchHandlerResponse</var> to <var>queue</var>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Wait until <var>queue</var> is not empty.</p>"
                },
                {
                  "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-dequeue\" id=\"ref-for-queue-dequeue①\">dequeue</a> <var>queue</var>.</p>"
                }
              ]
            },
            {
              "html": "<p class=\"assertion\">Assert: <var>source</var> is \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routersourceenum-fetch-event\" id=\"ref-for-dom-routersourceenum-fetch-event①\">fetch-event</a></code>\"</p>"
            }
          ]
        },
        {
          "html": "If <var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#navigation-request\" id=\"ref-for-navigation-request①\">navigation request</a>, <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-navigation-preload-enabled-flag\" id=\"ref-for-service-worker-registration-navigation-preload-enabled-flag③\">navigation preload enabled flag</a> is set, <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method⑥\">method</a> is `<code>GET</code>`, <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker③⑨\">active worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-event-types-to-handle\" id=\"ref-for-dfn-set-of-event-types-to-handle④\">set of event types to handle</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain③\">contains</a> <code>fetch</code>, and <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker④⓪\">active worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-all-fetch-listeners-are-empty-flag\" id=\"ref-for-service-worker-all-fetch-listeners-are-empty-flag②\">all fetch listeners are empty flag</a> is not set then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>preloadRequest</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-clone\" id=\"ref-for-concept-request-clone\">cloning</a> the request <var>request</var>.</p>"
            },
            {
              "html": "<p>Let <var>preloadRequestHeaders</var> be <var>preloadRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list①\">header list</a>.</p>"
            },
            {
              "html": "<p>Let <var>preloadResponseObject</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#response\" id=\"ref-for-response①④\">Response</a></code> object associated with a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#headers\" id=\"ref-for-headers②\">Headers</a></code> object whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-headers-guard\" id=\"ref-for-concept-headers-guard②\">guard</a> is \"<code>immutable</code>\".</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-append\" id=\"ref-for-concept-header-list-append\">Append</a> to <var>preloadRequestHeaders</var> a new <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header\" id=\"ref-for-concept-header②\">header</a> whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-name\" id=\"ref-for-concept-header-name②\">name</a> is `<code>Service-Worker-Navigation-Preload</code>` and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-value\" id=\"ref-for-concept-header-value\">value</a> is <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-navigation-preload-header-value\" id=\"ref-for-service-worker-registration-navigation-preload-header-value②\">navigation preload header value</a>.</p>"
            },
            {
              "html": "<p>Set <var>preloadRequest</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-service-workers-mode\" id=\"ref-for-request-service-workers-mode③\">service-workers mode</a> to \"<code>none</code>\".</p>"
            },
            {
              "html": "<p>Let <var>preloadFetchController</var> be null.</p>"
            },
            {
              "html": "Run the following substeps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③⑧\">in parallel</a>, but <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#abort-when\" id=\"ref-for-abort-when①\">abort when</a> <var>fetchController</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-state\" id=\"ref-for-fetch-controller-state①\">state</a> is \"<code>terminated</code>\" or \"<code>aborted</code>\":",
              "rationale": "set",
              "steps": [
                {
                  "html": "To <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#process-response\" id=\"ref-for-process-response③\">processResponse</a> for <var>navigationPreloadResponse</var>, run these substeps:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>navigationPreloadResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-type\" id=\"ref-for-concept-response-type④\">type</a> is \"<code>error</code>\", reject <var>preloadResponse</var> with a <code>TypeError</code> and terminate these substeps.</p>"
                    },
                    {
                      "html": "<p>Associate <var>preloadResponseObject</var> with <var>navigationPreloadResponse</var>.</p>"
                    },
                    {
                      "html": "<p>Resolve <var>preloadResponse</var> with <var>preloadResponseObject</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#if-aborted\" id=\"ref-for-if-aborted①\">If aborted</a>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>deserializedError</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#deserialize-a-serialized-abort-reason\" id=\"ref-for-deserialize-a-serialized-abort-reason\">deserialize a serialized abort reason</a> given null and <var>workerRealm</var>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-abort\" id=\"ref-for-fetch-controller-abort④\">Abort</a> <var>preloadFetchController</var> with <var>deserializedError</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Else, resolve <var>preloadResponse</var> with undefined.</p>"
        },
        {
          "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-fetch-event-and-dispatch\" id=\"ref-for-create-fetch-event-and-dispatch①\">Create Fetch Event and Dispatch</a> with <var>request</var>, <var>registration</var>, <var>useHighResPerformanceTimers</var>, <var>timingInfo</var>, <var>workerRealm</var>, <var>reservedClient</var>, <var>preloadResponse</var>, and null.</p>"
        }
      ]
    },
    {
      "name": "Create Fetch Event and Dispatch",
      "href": "https://www.w3.org/TR/service-workers/#create-fetch-event-and-dispatch",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>response</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>eventCanceled</var> be false.</p>"
        },
        {
          "html": "<p>Let <var>client</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client④\">client</a>.</p>"
        },
        {
          "html": "<p>Let <var>activeWorker</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker④②\">active worker</a>.</p>"
        },
        {
          "html": "<p>Let <var>eventHandled</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>handleFetchFailed</var> be false.</p>"
        },
        {
          "html": "<p>Let <var>respondWithEntered</var> be false.</p>"
        },
        {
          "html": "<p>Let <var>shouldSoftUpdate</var> be true if any of the following are true, and false otherwise:</p>\n       <ul>\n        <li data-md=\"\">\n         <p><var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#non-subresource-request\" id=\"ref-for-non-subresource-request②\">non-subresource request</a>.</p>\n        </li><li data-md=\"\">\n         <p><var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#subresource-request\" id=\"ref-for-subresource-request②\">subresource request</a> and <var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-stale\" id=\"ref-for-service-worker-registration-stale④\">stale</a>.</p>\n       </li></ul>"
        },
        {
          "html": "If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#should-skip-event\" id=\"ref-for-should-skip-event③\">Should Skip Event</a> algorithm with \"fetch\" and <var>activeWorker</var> is true, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>shouldSoftUpdate</var> is true, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel③⑨\">in parallel</a> run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update④\">Soft Update</a> algorithm with <var>registration</var>.</p>"
            },
            {
              "html": "<p>Return null.</p>"
            }
          ]
        },
        {
          "html": "If <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-all-fetch-listeners-are-empty-flag\" id=\"ref-for-service-worker-all-fetch-listeners-are-empty-flag③\">all fetch listeners are empty flag</a> is set:",
          "rationale": "in parallel",
          "steps": [
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel④⓪\">In parallel</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state①⓪\">state</a> is \"activating\", then wait for <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state①①\">state</a> to become \"activated\".</p>"
                },
                {
                  "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-service-worker\" id=\"ref-for-run-service-worker⑦\">Run Service Worker</a> algorithm with <var>activeWorker</var>.</p>"
                },
                {
                  "html": "<p>If <var>shouldSoftUpdate</var> is true, then run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update⑤\">Soft Update</a> algorithm with <var>registration</var>.</p>"
                }
              ]
            },
            {
              "html": "<p>Return null.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>useHighResPerformanceTimers</var> is true, then set <var>useHighResPerformanceTimers</var> to <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①②\">global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-cross-origin-isolated-capability\" id=\"ref-for-concept-workerglobalscope-cross-origin-isolated-capability①\">cross-origin isolated capability</a>.</p>"
        },
        {
          "html": "<p>Let <var>timingInfo</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-timing-info-start-time\" id=\"ref-for-service-worker-timing-info-start-time\">start time</a> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-coarsened-shared-current-time\" id=\"ref-for-dfn-coarsened-shared-current-time\">coarsened shared current time</a> given <var>useHighResPerformanceTimers</var>.</p>"
        },
        {
          "html": "<p>If <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state①②\">state</a> is \"<code>activating</code>\", wait for <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state①③\">state</a> to become \"<code>activated</code>\".</p>"
        },
        {
          "html": "<p>If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-service-worker\" id=\"ref-for-run-service-worker⑧\">Run Service Worker</a> algorithm with <var>activeWorker</var> is <em>failure</em>, then set <var>handleFetchFailed</var> to true.</p>"
        },
        {
          "html": "Else:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>workerRealm</var> to the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm①⓪\">relevant realm</a> of the <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①③\">global object</a>.</p>"
            },
            {
              "html": "<p>Set <var>eventHandled</var> to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise②⓪\">a new promise</a> in <var>workerRealm</var>.</p>"
            },
            {
              "html": "<p>If <var>raceResponse</var> is not null, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set③\">set</a> <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①④\">global object</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-race-response-map\" id=\"ref-for-serviceworkerglobalscope-race-response-map\">race response map</a>[<var>request</var>] to <var>raceResponse</var>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③④\">Queue a task</a> <var>task</var> to run the following substeps:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>e</var> be the result of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-create\" id=\"ref-for-concept-event-create④\">creating an event</a> with <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#fetchevent\" id=\"ref-for-fetchevent④\">FetchEvent</a></code>.</p>"
                },
                {
                  "html": "<p>Let <var>abortController</var> be a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#new\" id=\"ref-for-new\">new</a> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#abortcontroller\" id=\"ref-for-abortcontroller\">AbortController</a></code> object with <var>workerRealm</var>.</p>"
                },
                {
                  "html": "<p>Let <var>requestObject</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-create\" id=\"ref-for-request-create\">creating</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#request\" id=\"ref-for-request①④\">Request</a></code> object, given <var>request</var>, a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#headers\" id=\"ref-for-headers③\">Headers</a></code> object’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-headers-guard\" id=\"ref-for-concept-headers-guard③\">guard</a> which is \"<code>immutable</code>\", <var>abortController</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#abortcontroller-signal\" id=\"ref-for-abortcontroller-signal\">signal</a>, and <var>workerRealm</var>.</p>"
                },
                {
                  "html": "<p>Initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#dom-event-type\" id=\"ref-for-dom-event-type②\">type</a></code> attribute to <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://www.w3.org/TR/service-workers/#service-worker-global-scope-fetch-event\" id=\"ref-for-service-worker-global-scope-fetch-event⑦\">fetch</a></code>.</p>"
                },
                {
                  "html": "<p>Initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#dom-event-cancelable\" id=\"ref-for-dom-event-cancelable\">cancelable</a></code> attribute to true.</p>"
                },
                {
                  "html": "<p>Initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-fetchevent-request\" id=\"ref-for-dom-fetchevent-request②\">request</a></code> attribute to <var>requestObject</var>.</p>"
                },
                {
                  "html": "<p>Initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-fetchevent-preloadresponse\" id=\"ref-for-dom-fetchevent-preloadresponse②\">preloadResponse</a></code> to <var>preloadResponse</var>.</p>"
                },
                {
                  "html": "<p>Initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-fetchevent-clientid\" id=\"ref-for-dom-fetchevent-clientid②\">clientId</a></code> attribute to <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id\" id=\"ref-for-concept-environment-id③\">id</a>.</p>"
                },
                {
                  "html": "<p>If <var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#non-subresource-request\" id=\"ref-for-non-subresource-request③\">non-subresource request</a> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination⑤\">destination</a> is not <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://fetch.spec.whatwg.org/#dom-requestdestination-report\" id=\"ref-for-dom-requestdestination-report①\">\"report\"</a></code>, initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-fetchevent-resultingclientid\" id=\"ref-for-dom-fetchevent-resultingclientid②\">resultingClientId</a></code> attribute to <var>reservedClient</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id\" id=\"ref-for-concept-environment-id④\">id</a>, and to the empty string otherwise.</p>"
                },
                {
                  "html": "<p>If <var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#navigation-request\" id=\"ref-for-navigation-request②\">navigation request</a>, initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-fetchevent-replacesclientid\" id=\"ref-for-dom-fetchevent-replacesclientid②\">replacesClientId</a></code> attribute to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-replaces-client-id\" id=\"ref-for-concept-request-replaces-client-id\">replaces client id</a>, and to the empty string otherwise.</p>"
                },
                {
                  "html": "<p>Initialize <var>e</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-fetchevent-handled\" id=\"ref-for-dom-fetchevent-handled②\">handled</a></code> to <var>eventHandled</var>.</p>"
                },
                {
                  "html": "<p>Let <var>timingInfo</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-timing-info-fetch-event-dispatch-time\" id=\"ref-for-service-worker-timing-info-fetch-event-dispatch-time\">fetch event dispatch time</a> to the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-coarsened-shared-current-time\" id=\"ref-for-dfn-coarsened-shared-current-time①\">coarsened shared current time</a> given <var>useHighResPerformanceTimers</var>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-dispatch\" id=\"ref-for-concept-event-dispatch⑥\">Dispatch</a> <var>e</var> at <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①⑤\">global object</a>.</p>"
                },
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-service-worker-extended-events-set\" id=\"ref-for-update-service-worker-extended-events-set①\">Update Service Worker Extended Events Set</a> with <var>activeWorker</var> and <var>e</var>.</p>"
                },
                {
                  "html": "<p>If <var>e</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-respond-with-entered-flag\" id=\"ref-for-fetchevent-respond-with-entered-flag②\">respond-with entered flag</a> is set, set <var>respondWithEntered</var> to true.</p>"
                },
                {
                  "html": "If <var>e</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-wait-to-respond-flag\" id=\"ref-for-fetchevent-wait-to-respond-flag③\">wait to respond flag</a> is set, then:",
                  "rationale": "wait",
                  "steps": [
                    {
                      "html": "<p>Wait until <var>e</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-wait-to-respond-flag\" id=\"ref-for-fetchevent-wait-to-respond-flag④\">wait to respond flag</a> is unset.</p>"
                    },
                    {
                      "html": "<p>If <var>e</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-respond-with-error-flag\" id=\"ref-for-fetchevent-respond-with-error-flag③\">respond-with error flag</a> is set, set <var>handleFetchFailed</var> to true.</p>"
                    },
                    {
                      "html": "<p>Else, set <var>response</var> to <var>e</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#fetchevent-potential-response\" id=\"ref-for-fetchevent-potential-response①\">potential response</a>.</p>"
                    }
                  ]
                },
                {
                  "html": "If <var>response</var> is null, <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-body\" id=\"ref-for-concept-request-body\">body</a> is not null, and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-body\" id=\"ref-for-concept-request-body①\">body</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-body-source\" id=\"ref-for-concept-body-source\">source</a> is null, then:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-body\" id=\"ref-for-concept-request-body②\">body</a> is <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#body-unusable\" id=\"ref-for-body-unusable\">unusable</a>, set <var>handleFetchFailed</var> to true.</p>"
                    },
                    {
                      "html": "<p>Else, <a data-link-type=\"dfn\" href=\"https://streams.spec.whatwg.org/#readablestream-cancel\" id=\"ref-for-readablestream-cancel\">cancel</a> <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-body\" id=\"ref-for-concept-request-body③\">body</a> with undefined.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>If <var>response</var> is not null, then set <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#response-service-worker-timing-info\" id=\"ref-for-response-service-worker-timing-info\">service worker timing info</a> to <var>timingInfo</var>.</p>"
                },
                {
                  "html": "<p>If <var>e</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#canceled-flag\" id=\"ref-for-canceled-flag\">canceled flag</a> is set, set <var>eventCanceled</var> to true.</p>"
                },
                {
                  "html": "If <var>fetchController</var> <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-state\" id=\"ref-for-fetch-controller-state②\">state</a> is \"<code>terminated</code>\" or \"<code>aborted</code>\", then:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>deserializedError</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#deserialize-a-serialized-abort-reason\" id=\"ref-for-deserialize-a-serialized-abort-reason①\">deserialize a serialized abort reason</a> given <var>fetchController</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#fetch-controller-serialized-abort-reason\" id=\"ref-for-fetch-controller-serialized-abort-reason\">serialized abort reason</a> and <var>workerRealm</var>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③⑤\">Queue a task</a> to <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#abortcontroller-signal-abort\" id=\"ref-for-abortcontroller-signal-abort\">signal abort</a> on <var>abortController</var> with <var>deserializedError</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Wait for <var>task</var> to have executed or for <var>handleFetchFailed</var> to be true.</p>"
        },
        {
          "html": "<p>If <var>shouldSoftUpdate</var> is true, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel④①\">in parallel</a> run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update⑥\">Soft Update</a> algorithm with <var>registration</var>.</p>"
        },
        {
          "html": "<p>If <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①⑥\">global object</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-race-response-map\" id=\"ref-for-serviceworkerglobalscope-race-response-map①\">race response map</a>[<var>request</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑨\">exists</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove⑤\">remove</a> <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①⑦\">global object</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-race-response-map\" id=\"ref-for-serviceworkerglobalscope-race-response-map②\">race response map</a>[<var>request</var>].</p>"
        },
        {
          "html": "If <var>respondWithEntered</var> is false, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>eventCanceled</var> is true, then:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>eventHandled</var> is not null, then <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject③\">reject</a> <var>eventHandled</var> with a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#networkerror\" id=\"ref-for-networkerror\">NetworkError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②①\">DOMException</a></code> in <var>workerRealm</var>.</p>"
                },
                {
                  "html": "<p>Return a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error⑨\">network error</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>If <var>eventHandled</var> is not null, then <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve\">resolve</a> <var>eventHandled</var>.</p>"
            },
            {
              "html": "If <var>raceResponse</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value④\">value</a> is not null, then:",
              "rationale": "wait",
              "steps": [
                {
                  "html": "<p>Wait until <var>raceResponse</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value⑤\">value</a> is not \"<code>pending</code>\".</p>"
                },
                {
                  "html": "<p>If <var>raceResponse</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value⑥\">value</a> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response①④\">response</a>, return <var>raceResponse</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value⑦\">value</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Return null.</p>"
            }
          ]
        },
        {
          "html": "If <var>handleFetchFailed</var> is true, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>eventHandled</var> is not null, then <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject④\">reject</a> <var>eventHandled</var> with a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#networkerror\" id=\"ref-for-networkerror①\">NetworkError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②②\">DOMException</a></code> in <var>workerRealm</var>.</p>"
            },
            {
              "html": "<p>Return a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error①⓪\">network error</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>eventHandled</var> is not null, then <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①\">resolve</a> <var>eventHandled</var>.</p>"
        },
        {
          "html": "<p>Return <var>response</var>.</p>"
        }
      ]
    },
    {
      "name": "Parse URL Pattern",
      "href": "https://www.w3.org/TR/service-workers/#parse-url-pattern",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>baseURL</var> be <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url①⓪\">script url</a>.</p>"
        },
        {
          "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://urlpattern.spec.whatwg.org/#build-a-url-pattern-from-a-web-idl-value\" id=\"ref-for-build-a-url-pattern-from-a-web-idl-value\">building a URL pattern from a Web IDL value</a> <var>rawPattern</var> given <var>baseURL</var>.</p>"
        }
      ]
    },
    {
      "name": "Verify Router Condition",
      "href": "https://www.w3.org/TR/service-workers/#verify-router-condition",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>hasCondition</var> be false.</p>"
        },
        {
          "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-urlpattern\" id=\"ref-for-dom-routercondition-urlpattern\">urlPattern</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⓪\">exists</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>rawPattern</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-urlpattern\" id=\"ref-for-dom-routercondition-urlpattern①\">urlPattern</a></code>\"].</p>"
            },
            {
              "html": "<p>Let <var>pattern</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#parse-url-pattern\" id=\"ref-for-parse-url-pattern\">Parse URL Pattern</a> algorithm passing <var>rawPattern</var> and <var>serviceWorker</var>. If this throws an exception, catch it and return false.</p>"
            },
            {
              "html": "<p>If <var>pattern</var> <a data-link-type=\"dfn\" href=\"https://urlpattern.spec.whatwg.org/#url-pattern-has-regexp-groups\" id=\"ref-for-url-pattern-has-regexp-groups\">has regexp groups</a>, then return false.</p>"
            },
            {
              "html": "<p>Set <var>hasCondition</var> to true.</p>"
            }
          ]
        },
        {
          "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestmethod\" id=\"ref-for-dom-routercondition-requestmethod\">requestMethod</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①①\">exists</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>method</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestmethod\" id=\"ref-for-dom-routercondition-requestmethod①\">requestMethod</a></code>\"].</p>"
            },
            {
              "html": "<p>If <var>method</var> is not a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-method\" id=\"ref-for-concept-method\">method</a>, then return false.</p>"
            },
            {
              "html": "<p>If <var>method</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#forbidden-method\" id=\"ref-for-forbidden-method\">forbidden method</a>, then return false.</p>"
            },
            {
              "html": "<p>Set <var>hasCondition</var> to true.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestmode\" id=\"ref-for-dom-routercondition-requestmode\">requestMode</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①②\">exists</a>, set <var>hasCondition</var> to true.</p>"
        },
        {
          "html": "<p>If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestdestination\" id=\"ref-for-dom-routercondition-requestdestination\">requestDestination</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①③\">exists</a>, set <var>hasCondition</var> to true.</p>"
        },
        {
          "html": "<p>If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-runningstatus\" id=\"ref-for-dom-routercondition-runningstatus\">runningStatus</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①④\">exists</a>, set <var>hasCondition</var> to true.</p>"
        },
        {
          "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-or\" id=\"ref-for-dom-routercondition-or\">_or</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑤\">exists</a>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>hasCondition</var> is true, return false.</p>"
            },
            {
              "html": "<p>Let <var>orConditions</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-or\" id=\"ref-for-dom-routercondition-or①\">_or</a></code>\"].</p>"
            },
            {
              "html": "For each <var>orCondition</var> of <var>orConditions</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#verify-router-condition\" id=\"ref-for-verify-router-condition①\">Verify Router Condition</a> algorithm with <var>orCondition</var> and <var>serviceWorker</var> returns false, return false.</p>"
                }
              ]
            },
            {
              "html": "<p>Set <var>hasCondition</var> to true.</p>"
            }
          ]
        },
        {
          "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-not\" id=\"ref-for-dom-routercondition-not\">not</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑥\">exists</a>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>hasCondition</var> is true, return false.</p>"
            },
            {
              "html": "<p>If running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#verify-router-condition\" id=\"ref-for-verify-router-condition②\">Verify Router Condition</a> algorithm with <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-not\" id=\"ref-for-dom-routercondition-not①\">not</a></code>\"] and <var>serviceWorker</var> returns false, return false.</p>"
            },
            {
              "html": "<p>Set <var>hasCondition</var> to true.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>hasCondition</var>.</p>"
        }
      ]
    },
    {
      "name": "Match Router Condition",
      "href": "https://www.w3.org/TR/service-workers/#match-router-condition",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-or\" id=\"ref-for-dom-routercondition-or②\">or</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑦\">exists</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>orConditions</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-or\" id=\"ref-for-dom-routercondition-or③\">or</a></code>\"].</p>"
            },
            {
              "html": "For each <var>orCondition</var> of <var>orConditions</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-router-condition\" id=\"ref-for-match-router-condition\">Match Router Condition</a> algorithm with <var>orCondition</var>, <var>serviceWorker</var> and <var>request</var> returns true, then return true.</p>"
                }
              ]
            },
            {
              "html": "<p>Return false.</p>"
            }
          ]
        },
        {
          "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-not\" id=\"ref-for-dom-routercondition-not②\">not</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑧\">exists</a>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-router-condition\" id=\"ref-for-match-router-condition①\">Match Router Condition</a> algorithm with <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-not\" id=\"ref-for-dom-routercondition-not③\">not</a></code>\"], <var>serviceWorker</var> and <var>request</var> returns true, then return false.</p>"
            },
            {
              "html": "<p>Return true.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-urlpattern\" id=\"ref-for-dom-routercondition-urlpattern②\">urlPattern</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑨\">exists</a>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>rawPattern</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-urlpattern\" id=\"ref-for-dom-routercondition-urlpattern③\">urlPattern</a></code>\"].</p>"
                },
                {
                  "html": "<p>Let <var>pattern</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#parse-url-pattern\" id=\"ref-for-parse-url-pattern①\">Parse URL Pattern</a> algorithm passing <var>rawPattern</var> and <var>serviceWorker</var>.</p>"
                },
                {
                  "html": "<p>If running <a data-link-type=\"dfn\" href=\"https://urlpattern.spec.whatwg.org/#url-pattern-match\" id=\"ref-for-url-pattern-match\">match</a> with <var>pattern</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①⓪\">URL</a> returns null, return false.</p>"
                }
              ]
            },
            {
              "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestmethod\" id=\"ref-for-dom-routercondition-requestmethod②\">requestMethod</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②⓪\">exists</a>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>method</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestmethod\" id=\"ref-for-dom-routercondition-requestmethod③\">requestMethod</a></code>\"].</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-method-normalize\" id=\"ref-for-concept-method-normalize\">Normalize</a> <var>method</var>.</p>"
                },
                {
                  "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method⑦\">method</a> is not <var>method</var>, return false.</p>"
                }
              ]
            },
            {
              "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestmode\" id=\"ref-for-dom-routercondition-requestmode①\">requestMode</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②①\">exists</a>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>mode</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestmode\" id=\"ref-for-dom-routercondition-requestmode②\">requestMode</a></code>\"].</p>"
                },
                {
                  "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-mode\" id=\"ref-for-concept-request-mode\">mode</a> is not <var>mode</var>, return false.</p>"
                }
              ]
            },
            {
              "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestdestination\" id=\"ref-for-dom-routercondition-requestdestination①\">requestDestination</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②②\">exists</a>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>destination</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-requestdestination\" id=\"ref-for-dom-routercondition-requestdestination②\">requestDestination</a></code>\"].</p>"
                },
                {
                  "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination⑥\">destination</a> is not <var>destination</var>, return false.</p>"
                }
              ]
            },
            {
              "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-runningstatus\" id=\"ref-for-dom-routercondition-runningstatus①\">runningStatus</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②③\">exists</a>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>runningStatus</var> be <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-runningstatus\" id=\"ref-for-dom-routercondition-runningstatus②\">runningStatus</a></code>\"].</p>"
                },
                {
                  "html": "<p>If <var>runningStatus</var> is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-runningstatus-running\" id=\"ref-for-dom-runningstatus-running\">\"running\"</a></code>, and <var>serviceWorker</var> is not <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-running\" id=\"ref-for-service-worker-running④\">running</a>, return false.</p>"
                },
                {
                  "html": "<p>If <var>runningStatus</var> is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-runningstatus-not-running\" id=\"ref-for-dom-runningstatus-not-running\">\"not-running\"</a></code>, and <var>serviceWorker</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-running\" id=\"ref-for-service-worker-running⑤\">running</a>, return false.</p>"
                }
              ]
            },
            {
              "html": "<p>Return true.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "Check Router Registration Limit",
      "href": "https://www.w3.org/TR/service-workers/#check-router-registration-limit",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>result</var> be a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-count-router-condition-result\" id=\"ref-for-dfn-count-router-condition-result\">count router condition result</a>.</p>"
        },
        {
          "html": "<p>Set <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-count-router-condition-result-condition-count\" id=\"ref-for-dfn-count-router-condition-result-condition-count\">condition count</a> to 1024.</p>"
        },
        {
          "html": "<p>Set <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-dfn-count-router-condition-result-quota-exceeded\" id=\"ref-for-dfn-dfn-count-router-condition-result-quota-exceeded\">quota exceeded</a> to false.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①⑦\">For each</a> <var>rule</var> of <var>routerRules</var>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>result</var> to be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#count-router-inner-conditions\" id=\"ref-for-count-router-inner-conditions\">Count Router Inner Conditions</a> with <var>rule</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routerrule-condition\" id=\"ref-for-dom-routerrule-condition①\">condition</a></code>\"], <var>result</var>, and 10.</p>"
            },
            {
              "html": "<p>If <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-dfn-count-router-condition-result-quota-exceeded\" id=\"ref-for-dfn-dfn-count-router-condition-result-quota-exceeded①\">quota exceeded</a> is true, return false.</p>"
            }
          ]
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "Count Router Inner Conditions",
      "href": "https://www.w3.org/TR/service-workers/#count-router-inner-conditions",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Decrement <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-count-router-condition-result-condition-count\" id=\"ref-for-dfn-count-router-condition-result-condition-count①\">condition count</a> by one.</p>"
        },
        {
          "html": "If <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-count-router-condition-result-condition-count\" id=\"ref-for-dfn-count-router-condition-result-condition-count②\">condition count</a> is zero, or <var>depth</var> is zero, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-dfn-count-router-condition-result-quota-exceeded\" id=\"ref-for-dfn-dfn-count-router-condition-result-quota-exceeded②\">quota exceeded</a> to be true.</p>"
            },
            {
              "html": "<p>Return <var>result</var>.</p>"
            }
          ]
        },
        {
          "html": "If <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-or\" id=\"ref-for-dom-routercondition-or⑥\">_or</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②④\">exists</a>, then:",
          "rationale": "decrement",
          "steps": [
            {
              "html": "<p>Decrement <var>depth</var> by one.</p>"
            },
            {
              "html": "For each <var>orCondition</var> of <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-or\" id=\"ref-for-dom-routercondition-or⑦\">_or</a></code>\"]:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>result</var> to be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#count-router-inner-conditions\" id=\"ref-for-count-router-inner-conditions①\">Count Router Inner Conditions</a> with <var>orCondition</var>, <var>result</var>, and <var>depth</var>.</p>"
                },
                {
                  "html": "<p>If <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-dfn-count-router-condition-result-quota-exceeded\" id=\"ref-for-dfn-dfn-count-router-condition-result-quota-exceeded③\">quota exceeded</a> is true, return <var>result</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "Else if <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-not\" id=\"ref-for-dom-routercondition-not⑥\">not</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②⑤\">exists</a>, then:",
          "rationale": "decrement",
          "steps": [
            {
              "html": "<p>Decrement <var>depth</var> by one.</p>"
            },
            {
              "html": "<p>Set <var>result</var> to be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#count-router-inner-conditions\" id=\"ref-for-count-router-inner-conditions②\">Count Router Inner Conditions</a> with <var>condition</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routercondition-not\" id=\"ref-for-dom-routercondition-not⑦\">not</a></code>\"], <var>result</var>, and <var>depth</var>.</p>"
            },
            {
              "html": "<p>If <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-dfn-count-router-condition-result-quota-exceeded\" id=\"ref-for-dfn-dfn-count-router-condition-result-quota-exceeded④\">quota exceeded</a> is true, return <var>result</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>result</var>.</p>"
        }
      ]
    },
    {
      "name": "Get Router Source",
      "href": "https://www.w3.org/TR/service-workers/#get-router-source",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①⑧\">For each</a> <var>rule</var> of <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-list-of-router-rules\" id=\"ref-for-service-worker-list-of-router-rules④\">list of router rules</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-router-condition\" id=\"ref-for-match-router-condition②\">Match Router Condition</a> algorithm with <var>rule</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routerrule-condition\" id=\"ref-for-dom-routerrule-condition②\">condition</a></code>\"], <var>serviceWorker</var> and <var>request</var> returns true, then return <var>rule</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-routerrule-source\" id=\"ref-for-dom-routerrule-source①\">source</a></code>\"].</p>"
            }
          ]
        },
        {
          "html": "<p>Return null.</p>"
        }
      ]
    },
    {
      "name": "Should Skip Event",
      "href": "https://www.w3.org/TR/service-workers/#should-skip-event",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>serviceWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-event-types-to-handle\" id=\"ref-for-dfn-set-of-event-types-to-handle⑥\">set of event types to handle</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain④\">contain</a> <var>eventName</var>, then the user agent <em>may</em> return true.</p>"
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "Fire Functional Event",
      "href": "https://www.w3.org/TR/service-workers/#fire-functional-event",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p class=\"assertion\">Assert: <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker④④\">active worker</a> is not null.</p>"
        },
        {
          "html": "<p>Let <var>activeWorker</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker④⑤\">active worker</a>.</p>"
        },
        {
          "html": "If the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#should-skip-event\" id=\"ref-for-should-skip-event④\">Should Skip Event</a> with <var>eventName</var> and <var>activeWorker</var> is true, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-stale\" id=\"ref-for-service-worker-registration-stale⑤\">stale</a>, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel④②\">in parallel</a> run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update⑦\">Soft Update</a> algorithm with <var>registration</var>.</p>"
            },
            {
              "html": "<p>Return.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state①④\">state</a> is \"<code>activating</code>\", wait for <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state①⑤\">state</a> to become \"<code>activated</code>\".</p>"
        },
        {
          "html": "If the result of running the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#run-service-worker\" id=\"ref-for-run-service-worker⑨\">Run Service Worker</a> algorithm with <var>activeWorker</var> is <em>failure</em>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-stale\" id=\"ref-for-service-worker-registration-stale⑥\">stale</a>, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel④③\">in parallel</a> run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update⑧\">Soft Update</a> algorithm with <var>registration</var>.</p>"
            },
            {
              "html": "<p>Return.</p>"
            }
          ]
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③⑥\">Queue a task</a> <var>task</var> to run these substeps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>event</var> be the result of <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-create\" id=\"ref-for-concept-event-create⑤\">creating an event</a> with <var>eventConstructor</var> and the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm①①\">relevant realm</a> of <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①⑧\">global object</a>.</p>"
            },
            {
              "html": "<p>If <var>initialization</var> is not null, then initialize <var>event</var> with <var>initialization</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-dispatch\" id=\"ref-for-concept-event-dispatch⑧\">Dispatch</a> <var>event</var> on <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object①⑨\">global object</a>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-service-worker-extended-events-set\" id=\"ref-for-update-service-worker-extended-events-set②\">Update Service Worker Extended Events Set</a> with <var>activeWorker</var> and <var>event</var>.</p>"
            },
            {
              "html": "<p>If <var>postDispatchSteps</var> is not null, then run <var>postDispatchSteps</var> passing <var>event</var> as <var>dispatchedEvent</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Wait for <var>task</var> to have executed or been discarded.</p>"
        },
        {
          "html": "<p>If <var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-stale\" id=\"ref-for-service-worker-registration-stale⑦\">stale</a>, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel④④\">in parallel</a> run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#soft-update\" id=\"ref-for-soft-update⑨\">Soft Update</a> algorithm with <var>registration</var>.</p>"
        }
      ]
    },
    {
      "name": "Handle Service Worker Client Unload",
      "href": "https://www.w3.org/TR/service-workers/#handle-service-worker-client-unload",
      "html": "The user agent <em>must</em> run these steps as part of when a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client④④\">service worker client</a> unloads via <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-lifecycle.html#unloading-document-cleanup-steps\" id=\"ref-for-unloading-document-cleanup-steps\">unloading document cleanup steps</a> or <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#terminate-service-worker\" id=\"ref-for-terminate-service-worker⑥\">termination</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Run the following steps atomically.</p>"
        },
        {
          "html": "<p>Let <var>registration</var> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\" id=\"ref-for-dfn-service-worker-registration⑤⑨\">service worker registration</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-use\" id=\"ref-for-dfn-use⑤\">used</a> by <var>client</var>.</p>"
        },
        {
          "html": "<p>If <var>registration</var> is null, abort these steps.</p>"
        },
        {
          "html": "<p>If any other <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client④⑥\">service worker client</a> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-use\" id=\"ref-for-dfn-use⑥\">using</a> <var>registration</var>, abort these steps.</p>"
        },
        {
          "html": "<p>If <var>registration</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration-unregistered\" id=\"ref-for-dfn-service-worker-registration-unregistered③\">unregistered</a>, invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#try-clear-registration\" id=\"ref-for-try-clear-registration①\">Try Clear Registration</a> with <var>registration</var>.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#try-activate\" id=\"ref-for-try-activate④\">Try Activate</a> with <var>registration</var>.</p>"
        }
      ]
    },
    {
      "name": "Handle User Agent Shutdown",
      "href": "https://www.w3.org/TR/service-workers/#handle-user-agent-shutdown",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①⑨\">For each</a> <var>registration</var> of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map⑦\">registration map</a>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-getting-the-values\" id=\"ref-for-map-getting-the-values④\">values</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①④\">installing worker</a> is not null, then:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①③\">waiting worker</a> is null and <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker④⑥\">active worker</a> is null, invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#clear-registration\" id=\"ref-for-clear-registration\">Clear Registration</a> with <var>registration</var> and continue to the next iteration of the loop.</p>"
                },
                {
                  "html": "<p>Else, set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①⑤\">installing worker</a> to null.</p>"
                }
              ]
            },
            {
              "html": "If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①④\">waiting worker</a> is not null, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel④⑤\">in parallel</a>:",
              "rationale": "invoke",
              "steps": [
                {
                  "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#activate\" id=\"ref-for-activate⑥\">Activate</a> with <var>registration</var>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "Update Service Worker Extended Events Set",
      "href": "https://www.w3.org/TR/service-workers/#update-service-worker-extended-events-set",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p class=\"assertion\">Assert: <var>event</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#dispatch-flag\" id=\"ref-for-dispatch-flag②\">dispatch flag</a> is unset.</p>"
        },
        {
          "html": "For each <var>item</var> of <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-extended-events\" id=\"ref-for-dfn-set-of-extended-events①\">set of extended events</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>item</var> is not <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-active\" id=\"ref-for-extendableevent-active③\">active</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove①\">remove</a> <var>item</var> from <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-extended-events\" id=\"ref-for-dfn-set-of-extended-events②\">set of extended events</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>event</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-active\" id=\"ref-for-extendableevent-active④\">active</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append③\">append</a> <var>event</var> to <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-extended-events\" id=\"ref-for-dfn-set-of-extended-events③\">set of extended events</a>.</p>"
        }
      ]
    },
    {
      "name": "Unregister",
      "href": "https://www.w3.org/TR/service-workers/#unregister",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①⑧\">origin</a> of <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url⑧\">scope url</a> is not <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-client\" id=\"ref-for-dfn-job-client②⓪\">client</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①⑨\">origin</a>, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#reject-job-promise\" id=\"ref-for-reject-job-promise①⓪\">Reject Job Promise</a> with <var>job</var> and \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror⑦\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②③\">DOMException</a></code>.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job①①\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>registration</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-registration\" id=\"ref-for-get-registration②\">Get Registration</a> given <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#job-storage-key\" id=\"ref-for-job-storage-key④\">storage key</a> and <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url⑨\">scope url</a>.</p>"
        },
        {
          "html": "If <var>registration</var> is null, then:",
          "rationale": "invoke",
          "steps": [
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#resolve-job-promise\" id=\"ref-for-resolve-job-promise③\">Resolve Job Promise</a> with <var>job</var> and false.</p>"
            },
            {
              "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job①②\">Finish Job</a> with <var>job</var> and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove⑥\">Remove</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map⑧\">registration map</a>[(<var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key①④\">storage key</a>, <var>job</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-job-scope-url\" id=\"ref-for-dfn-job-scope-url①⓪\">scope url</a>)].</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#resolve-job-promise\" id=\"ref-for-resolve-job-promise④\">Resolve Job Promise</a> with <var>job</var> and true.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#try-clear-registration\" id=\"ref-for-try-clear-registration②\">Try Clear Registration</a> with <var>registration</var>.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#finish-job\" id=\"ref-for-finish-job①③\">Finish Job</a> with <var>job</var>.</p>"
        }
      ]
    },
    {
      "name": "Set Registration",
      "href": "https://www.w3.org/TR/service-workers/#set-registration",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Run the following steps atomically.</p>"
        },
        {
          "html": "<p>Let <var>scopeString</var> be <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-serializer\" id=\"ref-for-concept-url-serializer①③\">serialized</a> <var>scope</var> with the <em>exclude fragment flag</em> set.</p>"
        },
        {
          "html": "<p>Let <var>registration</var> be a new <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\" id=\"ref-for-dfn-service-worker-registration⑥①\">service worker registration</a> whose <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-registration-storage-key\" id=\"ref-for-service-worker-registration-storage-key①⑤\">storage key</a> is set to <var>storage key</var>, <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-url\" id=\"ref-for-dfn-scope-url①⑧\">scope url</a> is set to <var>scope</var>, and <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-update-via-cache\" id=\"ref-for-dfn-update-via-cache⑨\">update via cache mode</a> is set to <var>updateViaCache</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set④\">Set</a> <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map⑨\">registration map</a>[(<var>storage key</var>, <var>scopeString</var>)] to <var>registration</var>.</p>"
        },
        {
          "html": "<p>Return <var>registration</var>.</p>"
        }
      ]
    },
    {
      "name": "Clear Registration",
      "href": "https://www.w3.org/TR/service-workers/#clear-registration",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Run the following steps atomically.</p>"
        },
        {
          "html": "If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①⑥\">installing worker</a> is not null, then:",
          "rationale": "terminate",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#terminate-service-worker\" id=\"ref-for-terminate-service-worker⑦\">Terminate</a> <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①⑦\">installing worker</a>.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state⑧\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①⑧\">installing worker</a> and \"<code>redundant</code>\" as the arguments.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state⑥\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>installing</code>\" and null as the arguments.</p>"
            }
          ]
        },
        {
          "html": "If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①⑤\">waiting worker</a> is not null, then:",
          "rationale": "terminate",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#terminate-service-worker\" id=\"ref-for-terminate-service-worker⑧\">Terminate</a> <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①⑥\">waiting worker</a>.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state⑨\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①⑦\">waiting worker</a> and \"<code>redundant</code>\" as the arguments.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state⑦\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>waiting</code>\" and null as the arguments.</p>"
            }
          ]
        },
        {
          "html": "If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker④⑦\">active worker</a> is not null, then:",
          "rationale": "terminate",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#terminate-service-worker\" id=\"ref-for-terminate-service-worker⑨\">Terminate</a> <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker④⑧\">active worker</a>.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-worker-state\" id=\"ref-for-update-worker-state①⓪\">Update Worker State</a> algorithm passing <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker④⑨\">active worker</a> and \"<code>redundant</code>\" as the arguments.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#update-registration-state\" id=\"ref-for-update-registration-state⑧\">Update Registration State</a> algorithm passing <var>registration</var>, \"<code>active</code>\" and null as the arguments.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "Try Clear Registration",
      "href": "https://www.w3.org/TR/service-workers/#try-clear-registration",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Invoke <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#clear-registration\" id=\"ref-for-clear-registration③\">Clear Registration</a> with <var>registration</var> if no <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client\" id=\"ref-for-dfn-service-worker-client④⑦\">service worker client</a> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-use\" id=\"ref-for-dfn-use⑧\">using</a> <var>registration</var> and all of the following conditions are true:</p>\n       <ul>\n        <li data-md=\"\">\n         <p><var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker①⑨\">installing worker</a> is null or the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-has-no-pending-events\" id=\"ref-for-service-worker-has-no-pending-events②\">Service Worker Has No Pending Events</a> with <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker②⓪\">installing worker</a> is true.</p>\n        </li><li data-md=\"\">\n         <p><var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①⑧\">waiting worker</a> is null or the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-has-no-pending-events\" id=\"ref-for-service-worker-has-no-pending-events③\">Service Worker Has No Pending Events</a> with <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker①⑨\">waiting worker</a> is true.</p>\n        </li><li data-md=\"\">\n         <p><var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑤⓪\">active worker</a> is null or the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-has-no-pending-events\" id=\"ref-for-service-worker-has-no-pending-events④\">Service Worker Has No Pending Events</a> with <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑤①\">active worker</a> is true.</p>\n       </li></ul>"
        }
      ]
    },
    {
      "name": "Update Registration State",
      "href": "https://www.w3.org/TR/service-workers/#update-registration-state",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>registrationObjects</var> be an array containing all the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerregistration\" id=\"ref-for-serviceworkerregistration①⑤\">ServiceWorkerRegistration</a></code> objects associated with <var>registration</var>.</p>"
        },
        {
          "html": "If <var>target</var> is \"<code>installing</code>\", then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker②①\">installing worker</a> to <var>source</var>.</p>"
            },
            {
              "html": "For each <var>registrationObject</var> in <var>registrationObjects</var>:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③⑦\">Queue a task</a> to set the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-installing\" id=\"ref-for-dom-serviceworkerregistration-installing④\">installing</a></code> attribute of <var>registrationObject</var> to null if <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker②②\">installing worker</a> is null, or the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object⑦\">getting the service worker object</a> that represents <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker②③\">installing worker</a> in <var>registrationObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②⑨\">relevant settings object</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "Else if <var>target</var> is \"<code>waiting</code>\", then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker②⓪\">waiting worker</a> to <var>source</var>.</p>"
            },
            {
              "html": "For each <var>registrationObject</var> in <var>registrationObjects</var>:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③⑧\">Queue a task</a> to set the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-waiting\" id=\"ref-for-dom-serviceworkerregistration-waiting④\">waiting</a></code> attribute of <var>registrationObject</var> to null if <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker②①\">waiting worker</a> is null, or the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object⑧\">getting the service worker object</a> that represents <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker②②\">waiting worker</a> in <var>registrationObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③⓪\">relevant settings object</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "Else if <var>target</var> is \"<code>active</code>\", then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑤②\">active worker</a> to <var>source</var>.</p>"
            },
            {
              "html": "For each <var>registrationObject</var> in <var>registrationObjects</var>:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task③⑨\">Queue a task</a> to set the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworkerregistration-active\" id=\"ref-for-dom-serviceworkerregistration-active④\">active</a></code> attribute of <var>registrationObject</var> to null if <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑤③\">active worker</a> is null, or the result of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-the-service-worker-object\" id=\"ref-for-get-the-service-worker-object⑨\">getting the service worker object</a> that represents <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑤④\">active worker</a> in <var>registrationObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③①\">relevant settings object</a>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "Update Worker State",
      "href": "https://www.w3.org/TR/service-workers/#update-worker-state",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p class=\"assertion\">Assert: <var>state</var> is not \"<code>parsed</code>\".</p>"
        },
        {
          "html": "<p>Set <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-state\" id=\"ref-for-dfn-state①⑦\">state</a> to <var>state</var>.</p>"
        },
        {
          "html": "<p>Let <var>settingsObjects</var> be all <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②③\">environment settings objects</a> whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②⓪\">origin</a> is <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-script-url\" id=\"ref-for-dfn-script-url①①\">script url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin⑨\">origin</a>.</p>"
        },
        {
          "html": "For each <var>settingsObject</var> of <var>settingsObjects</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task④⓪\">queue a task</a> on <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop①⑨\">responsible event loop</a> in the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑤\">DOM manipulation task source</a> to run the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>objectMap</var> be <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#environment-settings-object-service-worker-object-map\" id=\"ref-for-environment-settings-object-service-worker-object-map①\">service worker object map</a>.</p>"
            },
            {
              "html": "<p>If <var>objectMap</var>[<var>worker</var>] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②⑥\">exist</a>, then abort these steps.</p>"
            },
            {
              "html": "<p>Let <var>workerObj</var> be <var>objectMap</var>[<var>worker</var>].</p>"
            },
            {
              "html": "<p>Set <var>workerObj</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-serviceworker-state\" id=\"ref-for-dom-serviceworker-state④\">state</a></code> to <var>state</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire②\">Fire an event</a> named <code class=\"idl\"><a class=\"idl-code\" data-link-type=\"event\" href=\"https://www.w3.org/TR/service-workers/#eventdef-serviceworker-statechange\" id=\"ref-for-eventdef-serviceworker-statechange①\">statechange</a></code> at <var>workerObj</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "Notify Controller Change",
      "href": "https://www.w3.org/TR/service-workers/#notify-controller-change",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p class=\"assertion\">Assert: <var>client</var> is not null.</p>"
        },
        {
          "html": "<p>If <var>client</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②④\">environment settings object</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task④①\">queue a task</a> to <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-fire\" id=\"ref-for-concept-event-fire③\">fire an event</a> named <code>controllerchange</code> at the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer\" id=\"ref-for-serviceworkercontainer①⑥\">ServiceWorkerContainer</a></code> object that <var>client</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkercontainer-service-worker-client\" id=\"ref-for-serviceworkercontainer-service-worker-client⑨\">associated</a> with.</p>"
        }
      ]
    },
    {
      "name": "Match Service Worker Registration",
      "href": "https://www.w3.org/TR/service-workers/#match-service-worker-registration",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Run the following steps atomically.</p>"
        },
        {
          "html": "<p>Let <var>clientURLString</var> be <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-serializer\" id=\"ref-for-concept-url-serializer①④\">serialized</a> <var>clientURL</var>.</p>"
        },
        {
          "html": "<p>Let <var>matchingScopeString</var> be the empty string.</p>"
        },
        {
          "html": "<p>Let <var>scopeStringSet</var> be an empty list.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②⓪\">For each</a> (<var>entry storage key</var>, <var>entry scope</var>) of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map①⓪\">registration map</a>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-getting-the-keys\" id=\"ref-for-map-getting-the-keys⑤\">keys</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>storage key</var> <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-key-equal\" id=\"ref-for-storage-key-equal⑤\">equals</a> <var>entry storage key</var>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑧\">append</a> <var>entry scope</var> to the end of <var>scopeStringSet</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Set <var>matchingScopeString</var> to the longest value in <var>scopeStringSet</var> which the value of <var>clientURLString</var> starts with, if it exists.</p>"
        },
        {
          "html": "<p>Let <var>matchingScope</var> be null.</p>"
        },
        {
          "html": "If <var>matchingScopeString</var> is not the empty string, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>matchingScope</var> to the result of <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser⑧\">parsing</a> <var>matchingScopeString</var>.</p>"
            },
            {
              "html": "<p class=\"assertion\">Assert: <var>matchingScope</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①⓪\">origin</a> and <var>clientURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①①\">origin</a> are <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin⑥\">same origin</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-registration\" id=\"ref-for-get-registration③\">Get Registration</a> given <var>storage key</var> and <var>matchingScope</var>.</p>"
        }
      ]
    },
    {
      "name": "Get Registration",
      "href": "https://www.w3.org/TR/service-workers/#get-registration",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Run the following steps atomically.</p>"
        },
        {
          "html": "<p>Let <var>scopeString</var> be the empty string.</p>"
        },
        {
          "html": "<p>If <var>scope</var> is not null, set <var>scopeString</var> to <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-serializer\" id=\"ref-for-concept-url-serializer①⑥\">serialized</a> <var>scope</var> with the <em>exclude fragment flag</em> set.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑦\">For each</a> (<var>entry storage key</var>, <var>entry scope</var>) → <var>registration</var> of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-scope-to-registration-map\" id=\"ref-for-dfn-scope-to-registration-map①①\">registration map</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>storage key</var> <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-key-equal\" id=\"ref-for-storage-key-equal⑥\">equals</a> <var>entry storage key</var> and <var>scopeString</var> matches <var>entry scope</var>, then return <var>registration</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return null.</p>"
        }
      ]
    },
    {
      "name": "Get Newest Worker",
      "href": "https://www.w3.org/TR/service-workers/#get-newest-worker",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Run the following steps atomically.</p>"
        },
        {
          "html": "<p>Let <var>newestWorker</var> be null.</p>"
        },
        {
          "html": "<p>If <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker②④\">installing worker</a> is not null, set <var>newestWorker</var> to <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-installing-worker\" id=\"ref-for-dfn-installing-worker②⑤\">installing worker</a>.</p>"
        },
        {
          "html": "<p>Else if <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker②③\">waiting worker</a> is not null, set <var>newestWorker</var> to <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-waiting-worker\" id=\"ref-for-dfn-waiting-worker②④\">waiting worker</a>.</p>"
        },
        {
          "html": "<p>Else if <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑤⑤\">active worker</a> is not null, set <var>newestWorker</var> to <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑤⑥\">active worker</a>.</p>"
        },
        {
          "html": "<p>Return <var>newestWorker</var>.</p>"
        }
      ]
    },
    {
      "name": "Service Worker Has No Pending Events",
      "href": "https://www.w3.org/TR/service-workers/#service-worker-has-no-pending-events",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "For each <var>event</var> of <var>worker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-set-of-extended-events\" id=\"ref-for-dfn-set-of-extended-events④\">set of extended events</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>event</var> is <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-active\" id=\"ref-for-extendableevent-active⑤\">active</a>, return false.</p>"
            }
          ]
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "Create Client",
      "href": "https://www.w3.org/TR/service-workers/#create-client",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>clientObject</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#client\" id=\"ref-for-client①②\">Client</a></code> object.</p>"
        },
        {
          "html": "<p>Set <var>clientObject</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client①③\">service worker client</a> to <var>client</var>.</p>"
        },
        {
          "html": "<p>Return <var>clientObject</var>.</p>"
        }
      ]
    },
    {
      "name": "Create Window Client",
      "href": "https://www.w3.org/TR/service-workers/#create-window-client",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>windowClient</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#windowclient\" id=\"ref-for-windowclient①①\">WindowClient</a></code> object.</p>"
        },
        {
          "html": "<p>Set <var>windowClient</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-service-worker-client\" id=\"ref-for-dfn-service-worker-client-service-worker-client①④\">service worker client</a> to <var>client</var>.</p>"
        },
        {
          "html": "<p>Set <var>windowClient</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-frame-type\" id=\"ref-for-dfn-service-worker-client-frame-type①\">frame type</a> to <var>frameType</var>.</p>"
        },
        {
          "html": "<p>Set <var>windowClient</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-visibilitystate\" id=\"ref-for-dfn-service-worker-client-visibilitystate①\">visibility state</a> to <var>visibilityState</var>.</p>"
        },
        {
          "html": "<p>Set <var>windowClient</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-client-focusstate\" id=\"ref-for-dfn-service-worker-client-focusstate②\">focus state</a> to <var>focusState</var>.</p>"
        },
        {
          "html": "<p>Set <var>windowClient</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#windowclient-ancestor-origins-array\" id=\"ref-for-windowclient-ancestor-origins-array①\">ancestor origins array</a> to a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-frozen-array-type\" id=\"ref-for-dfn-frozen-array-type④\">frozen array</a> created from <var>ancestorOriginsList</var>.</p>"
        },
        {
          "html": "<p>Return <var>windowClient</var>.</p>"
        }
      ]
    },
    {
      "name": "Get Frame Type",
      "href": "https://www.w3.org/TR/service-workers/#get-frame-type",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-parent\" id=\"ref-for-nav-parent\">parent</a> is not null, then return \"<code>nested</code>\".</p>"
        },
        {
          "html": "<p>If <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-bc\" id=\"ref-for-nav-bc\">active browsing context</a> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#auxiliary-browsing-context\" id=\"ref-for-auxiliary-browsing-context\">auxiliary browsing context</a>, then return \"<code>auxiliary</code>\".</p>"
        },
        {
          "html": "<p>Return \"<code>top-level</code>\".</p>"
        }
      ]
    },
    {
      "name": "Resolve Get Client Promise",
      "href": "https://www.w3.org/TR/service-workers/#resolve-get-client-promise",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>client</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②⑤\">environment settings object</a>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>client</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context\" id=\"ref-for-secure-context⑤\">secure context</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task④②\">queue a task</a> to reject <var>promise</var> with a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror⑧\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②④\">DOMException</a></code>, on <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③③\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop②①\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑦\">DOM manipulation task source</a>, and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-creation-url\" id=\"ref-for-concept-environment-creation-url⑨\">creation URL</a> is not a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/secure-contexts/#potentially-trustworthy-url\" id=\"ref-for-potentially-trustworthy-url①\">potentially trustworthy URL</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task④③\">queue a task</a> to reject <var>promise</var> with a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#securityerror\" id=\"ref-for-securityerror⑨\">SecurityError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②⑤\">DOMException</a></code>, on <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③④\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop②②\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑧\">DOM manipulation task source</a>, and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "If <var>client</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②⑥\">environment settings object</a> and is not a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-window-client\" id=\"ref-for-dfn-window-client①③\">window client</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>clientObject</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-client\" id=\"ref-for-create-client①\">Create Client</a> algorithm with <var>client</var> as the argument.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task④④\">Queue a task</a> to resolve <var>promise</var> with <var>clientObject</var>, on <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③⑤\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop②③\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑨\">DOM manipulation task source</a>, and abort these steps.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>browsingContext</var> be null.</p>"
            },
            {
              "html": "<p>If <var>client</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object②⑦\">environment settings object</a>, set <var>browsingContext</var> to <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global\" id=\"ref-for-concept-settings-object-global①①\">global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context\" id=\"ref-for-browsing-context⑦\">browsing context</a>.</p>"
            },
            {
              "html": "<p>Else, set <var>browsingContext</var> to <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context②\">target browsing context</a>.</p>"
            },
            {
              "html": "<p>Let <var>navigable</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable①\">navigable</a> with a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-bc\" id=\"ref-for-nav-bc①\">active browsing context</a> of <var>browsingContext</var>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task④⑤\">Queue a task</a> to run the following steps on <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop\" id=\"ref-for-event-loop①⑦\">event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source\" id=\"ref-for-user-interaction-task-source④\">user interaction task source</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>frameType</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#get-frame-type\" id=\"ref-for-get-frame-type④\">Get Frame Type</a> with <var>navigable</var>.</p>"
                },
                {
                  "html": "<p>Let <var>visibilityState</var> be <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①④\">active document</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/page-visibility/#dom-document-visibilitystate\" id=\"ref-for-dom-document-visibilitystate⑤\">visibilityState</a></code> attribute value.</p>"
                },
                {
                  "html": "<p>Let <var>focusState</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#has-focus-steps\" id=\"ref-for-has-focus-steps④\">has focus steps</a> with <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①⑤\">active document</a> as the argument.</p>"
                },
                {
                  "html": "<p>Let <var>ancestorOriginsList</var> be the empty list.</p>"
                },
                {
                  "html": "<p>If <var>client</var> is a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-window-client\" id=\"ref-for-dfn-window-client①④\">window client</a>, set <var>ancestorOriginsList</var> to <var>browsingContext</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①⑥\">active document</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global⑨\">relevant global object</a>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#location\" id=\"ref-for-location④\">Location</a></code> object’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-location-ancestor-origins-list\" id=\"ref-for-concept-location-ancestor-origins-list④\">ancestor origins list</a>’s associated list.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task④⑥\">Queue a task</a> to run the following steps on <var>promise</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③⑥\">relevant settings object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop\" id=\"ref-for-responsible-event-loop②④\">responsible event loop</a> using the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source③⓪\">DOM manipulation task source</a>:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#service-worker-client-discarded-flag\" id=\"ref-for-service-worker-client-discarded-flag⑤\">discarded flag</a> is set, resolve <var>promise</var> with undefined and abort these steps.</p>"
                    },
                    {
                      "html": "<p>Let <var>windowClient</var> be the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#create-window-client\" id=\"ref-for-create-window-client④\">Create Window Client</a> with <var>client</var>, <var>frameType</var>, <var>visibilityState</var>, <var>focusState</var>, and <var>ancestorOriginsList</var>.</p>"
                    },
                    {
                      "html": "<p>Resolve <var>promise</var> with <var>windowClient</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "Query Cache",
      "href": "https://www.w3.org/TR/service-workers/#query-cache",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>resultList</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②④\">list</a>.</p>"
        },
        {
          "html": "<p>Let <var>storage</var> be null.</p>"
        },
        {
          "html": "<p>If the optional argument <var>targetStorage</var> is omitted, set <var>storage</var> to the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-request-response-list\" id=\"ref-for-dfn-relevant-request-response-list②\">relevant request response list</a>.</p>"
        },
        {
          "html": "<p>Else, set <var>storage</var> to <var>targetStorage</var>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②①\">For each</a> <var>requestResponse</var> of <var>storage</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>cachedRequest</var> be <var>requestResponse</var>’s request.</p>"
            },
            {
              "html": "<p>Let <var>cachedResponse</var> be <var>requestResponse</var>’s response.</p>"
            },
            {
              "html": "If <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#request-matches-cached-item\" id=\"ref-for-request-matches-cached-item\">Request Matches Cached Item</a> with <var>requestQuery</var>, <var>cachedRequest</var>, <var>cachedResponse</var>, and <var>options</var> returns true, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>requestCopy</var> be a copy of <var>cachedRequest</var>.</p>"
                },
                {
                  "html": "<p>Let <var>responseCopy</var> be a copy of <var>cachedResponse</var>.</p>"
                },
                {
                  "html": "<p>Add <var>requestCopy</var>/<var>responseCopy</var> to <var>resultList</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>resultList</var>.</p>"
        }
      ]
    },
    {
      "name": "Request Matches Cached Item",
      "href": "https://www.w3.org/TR/service-workers/#request-matches-cached-item",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cachequeryoptions-ignoremethod\" id=\"ref-for-dom-cachequeryoptions-ignoremethod\">ignoreMethod</a></code>\"] is false and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method⑧\">method</a> is not `<code>GET</code>`, return false.</p>"
        },
        {
          "html": "<p>Let <var>queryURL</var> be <var>requestQuery</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①①\">url</a>.</p>"
        },
        {
          "html": "<p>Let <var>cachedURL</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①②\">url</a>.</p>"
        },
        {
          "html": "If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cachequeryoptions-ignoresearch\" id=\"ref-for-dom-cachequeryoptions-ignoresearch\">ignoreSearch</a></code>\"] is true, then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>cachedURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-query\" id=\"ref-for-concept-url-query\">query</a> to the empty string.</p>"
            },
            {
              "html": "<p>Set <var>queryURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-query\" id=\"ref-for-concept-url-query①\">query</a> to the empty string.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>queryURL</var> does not <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-equals\" id=\"ref-for-concept-url-equals②\">equal</a> <var>cachedURL</var> with the <em>exclude fragment flag</em> set, then return false.</p>"
        },
        {
          "html": "<p>If <var>response</var> is null, <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://www.w3.org/TR/service-workers/#dom-cachequeryoptions-ignorevary\" id=\"ref-for-dom-cachequeryoptions-ignorevary\">ignoreVary</a></code>\"] is true, or <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list⑤\">header list</a> does not <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#header-list-contains\" id=\"ref-for-header-list-contains\">contain</a> `<code>Vary</code>`, then return true.</p>"
        },
        {
          "html": "<p>Let <var>fieldValues</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②⑤\">list</a> containing the elements corresponding to the <a data-link-type=\"dfn\" href=\"https://tools.ietf.org/html/rfc7230#section-3.2\" id=\"ref-for-section-3.2②\">field-values</a> of the <a data-link-type=\"dfn\" href=\"https://tools.ietf.org/html/rfc7231#section-7.1.4\" id=\"ref-for-section-7.1.4②\">Vary</a> header for the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-value\" id=\"ref-for-concept-header-value①\">value</a> of the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header\" id=\"ref-for-concept-header③\">header</a> with <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-name\" id=\"ref-for-concept-header-name③\">name</a> `<code>Vary</code>`.</p>"
        },
        {
          "html": "For each <var>fieldValue</var> in <var>fieldValues</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>fieldValue</var> matches \"<code>*</code>\", or the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-combine\" id=\"ref-for-concept-header-list-combine\">combined value</a> given <var>fieldValue</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list②\">header list</a> does not match the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-combine\" id=\"ref-for-concept-header-list-combine①\">combined value</a> given <var>fieldValue</var> and <var>requestQuery</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list③\">header list</a>, then return false.</p>"
            }
          ]
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "Batch Cache Operations",
      "href": "https://www.w3.org/TR/service-workers/#batch-cache-operations",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>cache</var> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-request-response-list\" id=\"ref-for-dfn-relevant-request-response-list③\">relevant request response list</a>.</p>"
        },
        {
          "html": "<p>Let <var>backupCache</var> be a new <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-request-response-list\" id=\"ref-for-dfn-request-response-list⑨\">request response list</a> that is a copy of <var>cache</var>.</p>"
        },
        {
          "html": "<p>Let <var>addedItems</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②⑦\">list</a>.</p>"
        },
        {
          "html": "Try running the following substeps atomically:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>resultList</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②⑧\">list</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②②\">For each</a> <var>operation</var> in <var>operations</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-type\" id=\"ref-for-dfn-cache-batch-operation-type③\">type</a> matches neither \"<code>delete</code>\" nor \"<code>put</code>\", <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①④\">throw</a> a <code>TypeError</code>.</p>"
                },
                {
                  "html": "<p>If <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-type\" id=\"ref-for-dfn-cache-batch-operation-type④\">type</a> matches \"<code>delete</code>\" and <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-response\" id=\"ref-for-dfn-cache-batch-operation-response②\">response</a> is not null, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑤\">throw</a> a <code>TypeError</code>.</p>"
                },
                {
                  "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#query-cache\" id=\"ref-for-query-cache③\">Query Cache</a> with <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request③\">request</a>, <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-options\" id=\"ref-for-dfn-cache-batch-operation-options①\">options</a>, and <var>addedItems</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty④\">is not empty</a>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑥\">throw</a> an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\" id=\"ref-for-invalidstateerror①⓪\">InvalidStateError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②⑥\">DOMException</a></code>.</p>"
                },
                {
                  "html": "<p>Let <var>requestResponses</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②⑨\">list</a>.</p>"
                },
                {
                  "html": "If <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-type\" id=\"ref-for-dfn-cache-batch-operation-type⑤\">type</a> matches \"<code>delete</code>\", then:",
                  "rationale": "set",
                  "steps": [
                    {
                      "html": "<p>Set <var>requestResponses</var> to the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#query-cache\" id=\"ref-for-query-cache④\">Query Cache</a> with <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request④\">request</a> and <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-options\" id=\"ref-for-dfn-cache-batch-operation-options②\">options</a>.</p>"
                    },
                    {
                      "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②③\">For each</a> <var>requestResponse</var> in <var>requestResponses</var>:",
                      "rationale": "remove",
                      "steps": [
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove②\">Remove</a> the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item①①\">item</a> whose value matches <var>requestResponse</var> from <var>cache</var>.</p>"
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "Else if <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-type\" id=\"ref-for-dfn-cache-batch-operation-type⑥\">type</a> matches \"<code>put</code>\", then:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-response\" id=\"ref-for-dfn-cache-batch-operation-response③\">response</a> is null, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑦\">throw</a> a <code>TypeError</code>.</p>"
                    },
                    {
                      "html": "<p>Let <var>r</var> be <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request⑤\">request</a>’s associated <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-request\" id=\"ref-for-concept-request-request①⓪\">request</a>.</p>"
                    },
                    {
                      "html": "<p>If <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①③\">url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme⑤\">scheme</a> is not one of \"<code>http</code>\" and \"<code>https</code>\", <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑧\">throw</a> a <code>TypeError</code>.</p>"
                    },
                    {
                      "html": "<p>If <var>r</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method⑨\">method</a> is not `<code>GET</code>`, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑨\">throw</a> a <code>TypeError</code>.</p>"
                    },
                    {
                      "html": "<p>If <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-options\" id=\"ref-for-dfn-cache-batch-operation-options③\">options</a> is not null, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw②⓪\">throw</a> a <code>TypeError</code>.</p>"
                    },
                    {
                      "html": "<p>Set <var>requestResponses</var> to the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#query-cache\" id=\"ref-for-query-cache⑤\">Query Cache</a> with <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request⑥\">request</a>.</p>"
                    },
                    {
                      "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②④\">For each</a> <var>requestResponse</var> of <var>requestResponses</var>:",
                      "rationale": "remove",
                      "steps": [
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove③\">Remove</a> the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item①②\">item</a> whose value matches <var>requestResponse</var> from <var>cache</var>.</p>"
                        }
                      ]
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑨\">Append</a> <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request⑦\">request</a>/<var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-response\" id=\"ref-for-dfn-cache-batch-operation-response④\">response</a> to <var>cache</var>.</p>"
                    },
                    {
                      "html": "<p>If the cache write operation in the previous two steps failed due to exceeding the granted quota limit, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw②①\">throw</a> a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#quotaexceedederror\" id=\"ref-for-quotaexceedederror①\">QuotaExceededError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②⑦\">DOMException</a></code>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append①⓪\">Append</a> <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request⑧\">request</a>/<var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-response\" id=\"ref-for-dfn-cache-batch-operation-response⑤\">response</a> to <var>addedItems</var>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append①①\">Append</a> <var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-request\" id=\"ref-for-dfn-cache-batch-operation-request⑨\">request</a>/<var>operation</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-cache-batch-operation-response\" id=\"ref-for-dfn-cache-batch-operation-response⑥\">response</a> to <var>resultList</var>.</p>"
                }
              ]
            },
            {
              "html": "<p>Return <var>resultList</var>.</p>"
            }
          ]
        },
        {
          "html": "And then, if an exception was <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw②②\">thrown</a>, then:",
          "rationale": "remove",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove④\">Remove</a> all the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item①③\">items</a> from the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-request-response-list\" id=\"ref-for-dfn-relevant-request-response-list④\">relevant request response list</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②⑤\">For each</a> <var>requestResponse</var> of <var>backupCache</var>:",
              "rationale": "append",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append①②\">Append</a> <var>requestResponse</var> to the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-relevant-request-response-list\" id=\"ref-for-dfn-relevant-request-response-list⑤\">relevant request response list</a>.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw②③\">Throw</a> the exception.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "Is Async Module",
      "href": "https://www.w3.org/TR/service-workers/#is-async-module",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>record</var> is not a <a data-link-type=\"dfn\" href=\"http://tc39.github.io/ecma262/#sec-cyclic-module-records\" id=\"ref-for-sec-cyclic-module-records\">Cyclic Module Record</a>, then:",
          "rationale": "return",
          "steps": [
            {
              "html": "<p>Return false.</p>"
            }
          ]
        },
        {
          "html": "If <var>record</var>.[[Async]] is true, then:",
          "rationale": "return",
          "steps": [
            {
              "html": "<p>Return true.</p>"
            }
          ]
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②⑥\">For each</a> string <var>requested</var> of <var>record</var>.[[RequestedModules]]:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>url</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#resolve-a-module-specifier\" id=\"ref-for-resolve-a-module-specifier\">resolving a module specifier</a> given <var>base</var> and <var>requested</var>.</p>"
            },
            {
              "html": "<p class=\"assertion\">Assert: <var>url</var> is never failure, because <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#resolve-a-module-specifier\" id=\"ref-for-resolve-a-module-specifier①\">resolving a module specifier</a> must have been previously successful with these same two arguments.</p>"
            },
            {
              "html": "If <var>seen</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain⑤\">contain</a> <var>url</var>, then:",
              "rationale": "append",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append④\">Append</a> <var>url</var> to <var>seen</var>.</p>"
                },
                {
                  "html": "If <var>moduleMap</var>[<var>url</var>] does not have a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-script-record\" id=\"ref-for-concept-script-record①\">record</a>, then:",
                  "rationale": "return",
                  "steps": [
                    {
                      "html": "<p>Return false.</p>"
                    }
                  ]
                },
                {
                  "html": "If <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#is-async-module\" id=\"ref-for-is-async-module①\">Is Async Module</a> for <var>moduleMap</var>[<var>url</var>]'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-script-record\" id=\"ref-for-concept-script-record②\">record</a>, <var>moduleMap</var>, <var>base</var>, and <var>seen</var> is true, then:",
                  "rationale": "return",
                  "steps": [
                    {
                      "html": "<p>Return true.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "Lookup Race Response",
      "href": "https://www.w3.org/TR/service-workers/#lookup-race-response",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>registration</var> be null.</p>"
        },
        {
          "html": "If <var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#non-subresource-request\" id=\"ref-for-non-subresource-request④\">non-subresource request</a>, then:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client②\">reserved client</a> is null, return null.</p>"
            },
            {
              "html": "<p>Let <var>storage key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#obtain-a-storage-key\" id=\"ref-for-obtain-a-storage-key①①\">obtain a storage key</a> given <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-reserved-client\" id=\"ref-for-concept-request-reserved-client③\">reserved client</a>.</p>"
            },
            {
              "html": "<p>Set <var>registration</var> to the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#match-service-worker-registration\" id=\"ref-for-match-service-worker-registration⑧\">Match Service Worker Registration</a> given <var>storage key</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①④\">url</a>.</p>"
            }
          ]
        },
        {
          "html": "Else if <var>request</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#subresource-request\" id=\"ref-for-subresource-request③\">subresource request</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>client</var> be <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client⑤\">client</a>.</p>"
            },
            {
              "html": "<p>If <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker③⓪\">active service worker</a> is null, return null.</p>"
            },
            {
              "html": "<p>Set <var>registration</var> to <var>client</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-active-service-worker\" id=\"ref-for-concept-environment-active-service-worker③①\">active service worker</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-containing-service-worker-registration\" id=\"ref-for-dfn-containing-service-worker-registration②⓪\">containing service worker registration</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Otherwise, return null.</p>"
        },
        {
          "html": "<p>Let <var>activeWorker</var> be <var>registration</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\" id=\"ref-for-dfn-active-worker⑤⑦\">active worker</a>.</p>"
        },
        {
          "html": "<p>Let <var>map</var> be <var>activeWorker</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-global-object\" id=\"ref-for-dfn-service-worker-global-object②⓪\">global object</a>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#serviceworkerglobalscope-race-response-map\" id=\"ref-for-serviceworkerglobalscope-race-response-map③\">race response map</a>.</p>"
        },
        {
          "html": "If <var>map</var>[<var>request</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②⑦\">exists</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>entry</var> be <var>map</var>[<var>request</var>].</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove⑦\">Remove</a> <var>map</var>[<var>request</var>].</p>"
            },
            {
              "html": "<p>Wait until <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value⑧\">value</a> is not \"<code>pending</code>\"</p>"
            },
            {
              "html": "<p>If <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value⑨\">value</a> is <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response①⑦\">response</a>, return <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#race-response-value\" id=\"ref-for-race-response-value①⓪\">value</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return null.</p>"
        }
      ]
    }
  ]
}