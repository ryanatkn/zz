{
  "spec": {
    "title": "Viewport Capture",
    "url": "https://www.w3.org/TR/mediacapture-viewport/"
  },
  "algorithms": [
    {
      "name": "MediaDevices/getViewportMedia()",
      "href": "https://www.w3.org/TR/mediacapture-viewport/#dom-mediadevices-getviewportmedia",
      "html": "When the <a data-link-type=\"idl\" data-lt=\"getViewportMedia()\" href=\"https://www.w3.org/TR/mediacapture-viewport/#dom-mediadevices-getviewportmedia\" class=\"internalDFN\" id=\"ref-for-dom-mediadevices-getviewportmedia-3\"><code>getViewportMedia</code></a><code>()</code> method is called, the user agent <em class=\"rfc2119\">MUST</em> run the following\n              steps:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>\n                  If the <a data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-settings-object\">current settings object</a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-cross-origin-isolated-capability\">cross-origin isolated capability</a> is false, return a promise <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose\n                  <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value <a data-link-type=\"idl\" data-lt=\"SecurityError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#securityerror\"><code>SecurityError</code></a>.\n                </p>"
        },
        {
          "html": "<p>\n                  If the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\">associated <code>Document</code></a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context\">top-level browsing context</a>'s\n                  <a href=\"https://wicg.github.io/document-policy/#required-document-policy\">\n                    required document policy</a>\n                  does not contain <code>Require-Document-Policy: viewport-capture</code> and <code>Document-Policy: viewport-capture</code>\n                  (TODO: use correct algorithm), return a promise <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose\n                  <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value <a data-link-type=\"idl\" data-lt=\"SecurityError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#securityerror\"><code>SecurityError</code></a>.\n                </p>"
        },
        {
          "html": "<p>\n                  If the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a> of <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\">this</a> does not have <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation\">transient activation</a>, return a promise\n                  <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value\n                  <a data-link-type=\"idl\" data-lt=\"InvalidStateError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\"><code>InvalidStateError</code></a>.\n                </p>"
        },
        {
          "html": "<p>Let <var>options</var> be the method's first argument.</p>"
        },
        {
          "html": "<p>\n                  If <code>options.video</code> is <code>false</code>, return a promise <a data-link-type=\"dfn|abstract-op\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a newly\n                  <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\">created</a> <a data-link-type=\"idl\" data-lt=\"TypeError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\"><code>TypeError</code></a>.\n                </p>"
        },
        {
          "html": "For each <a data-link-type=\"dfn|abstract-op\" data-lt=\"exist\" data-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\">existing</a> member in <var>options</var> whose value, <var>CS</var>, is a\n                  dictionary, run the following steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>\n                      If <var>CS</var> contains a member named <code>advanced</code>, return a promise\n                      <a data-link-type=\"dfn|abstract-op\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a newly <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\">created</a> <a data-link-type=\"idl\" data-lt=\"TypeError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\"><code>TypeError</code></a>.\n                    </p>"
            },
            {
              "html": "<p>\n                      If <var>CS</var> contains a member whose name specifies a constrainable property applicable to\n                      <a href=\"https://www.w3.org/TR/screen-capture/#dfn-display-surface\">display surface</a>s, and whose value in turn is\n                      a dictionary containing a member named either <code>min</code> or <code>exact</code>, return a\n                      promise <a data-link-type=\"dfn|abstract-op\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a newly <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\">created</a> <a data-link-type=\"idl\" data-lt=\"TypeError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\"><code>TypeError</code></a>.\n                    </p>"
            },
            {
              "html": "<p>\n                      If <var>CS</var> contains a member whose name specifies a constrainable property applicable to\n                      <a href=\"https://www.w3.org/TR/screen-capture/#dfn-display-surface\">display surface</a>s, and whose value in turn is\n                      a dictionary containing a member named <code>max</code>, and that member's value in turn is less\n                      than the constrainable property's <a href=\"https://www.w3.org/TR/screen-capture/#dfn-floor-value\">floor value</a>,\n                      then let <var>failedConstraint</var> be the name of the member, let <var>message</var> be either\n                      <code>undefined</code> or an informative human-readable message, and return a promise\n                      <a data-link-type=\"dfn|abstract-op\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a new <code>OverconstrainedError</code> created by calling\n                      <code>OverconstrainedError(<var>failedConstraint</var>, <var>message</var>)</code>.\n                    </p>"
            }
          ]
        },
        {
          "html": "<p>\n                  Let <var>requestedMediaTypes</var> be the set of media types in <var>options</var> with either a\n                  dictionary value or a value of <code>true</code>.\n                </p>"
        },
        {
          "html": "<p>\n                  If the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\">associated <code>Document</code></a> is NOT <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\">fully active</a> or does\n                  NOT <a href=\"https://html.spec.whatwg.org/multipage/#gains-focus\">have focus</a>, return a promise <a data-link-type=\"dfn|abstract-op\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a\n                  <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value <a data-link-type=\"idl\" data-lt=\"InvalidStateError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\"><code>InvalidStateError</code></a>.\n                </p>"
        },
        {
          "html": "<p>Let <var>p</var> be a new promise.</p>"
        },
        {
          "html": "Run the following steps in parallel:",
          "rationale": "for",
          "steps": [
            {
              "html": "For each media type <var>T</var> in <var>requestedMediaTypes</var>,",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>\n                          If no sources of type <var>T</var> are available, <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>p</var> with a new\n                          <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value <a data-link-type=\"idl\" data-lt=\"NotFoundError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notfounderror\"><code>NotFoundError</code></a>.\n                        </p>"
                },
                {
                  "html": "<p>\n                          Read the current <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://www.w3.org/TR/permissions/#dfn-permission-state\">permission state</a> for obtaining sources of type <var>T</var> in the\n                          current browsing context. If the permission state is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-denied\"><code>denied</code></a>\", jump to the\n                          step labeled <em>PermissionFailure</em> below.\n                        </p>"
                }
              ]
            },
            {
              "html": "<p>\n                      Optionally, e.g., based on a previously-established user preference, for security reasons, or due\n                      to platform limitations, jump to the step labeled <em>Permission Failure</em> below.\n                    </p>"
            },
            {
              "html": "<p>\n                      <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://www.w3.org/TR/permissions/#dfn-request-permission-to-use\">Request permission to use</a> viewport capture, for a <a data-link-type=\"idl\" data-lt=\"PermissionDescriptor\" data-type=\"dictionary\" href=\"https://www.w3.org/TR/permissions/#dom-permissiondescriptor\"><code>PermissionDescriptor</code></a> with its\n                      <a data-link-type=\"idl\" data-type=\"dict-member\" href=\"https://www.w3.org/TR/permissions/#dom-permissiondescriptor-name\"><code>name</code></a> set to <a href=\"https://www.w3.org/TR/mediacapture-viewport/#dfn-viewport-capture\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-viewport-capture-1\"><code>\"viewport-capture\"</code></a>, resulting in a set of provided\n                      media.\n                    </p>\n                    <p>\n                      The provided media <em class=\"rfc2119\">MUST</em> include precisely one video track, which <em class=\"rfc2119\">MUST</em> be a live-capture of the\n                      <a href=\"https://www.w3.org/TR/screen-capture/#dfn-browser\">browser</a>\n                      <a href=\"https://www.w3.org/TR/screen-capture/#dfn-display-surface\">display surface</a>\n                      of the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\">associated <code>Document</code></a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context\">top-level browsing context</a>'s\n                      <a href=\"https://html.spec.whatwg.org/multipage/#viewport\">viewport</a>.\n                    </p>\n                    <p>\n                      The provided media <em class=\"rfc2119\">MUST</em> include at most one audio track, which, if provided, <em class=\"rfc2119\">MUST</em> be the combined\n                      audio produced by the sum of documents that consist of the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s\n                      <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\">associated <code>Document</code></a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context\">top-level browsing context</a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\">active document</a>, and\n                      all <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\">active documents</a> in nested <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context\">browsing context</a>s of the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\">associated <code>Document</code></a>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context\">top-level browsing context</a>. This audio track <em class=\"rfc2119\">MUST NOT</em>\n                      be included if audio was not specified in <var>requestedMediaTypes</var>, or if it was specified\n                      as <code>false</code>.\n                    </p>\n                    <p>The source of a <a data-link-type=\"idl\" data-lt=\"MediaStreamTrack\" data-type=\"interface\" href=\"https://www.w3.org/TR/mediacapture-streams/#dom-mediastreamtrack\"><code>MediaStreamTrack</code></a> <em class=\"rfc2119\">MUST NOT</em> change.</p>\n                    <p>\n                      If the result of the request is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-granted\"><code>granted</code></a>\", then for each device that is\n                      sourcing the provided media, using a stable and private id for the device, <var>deviceId</var>,\n                      set [[devicesLiveMap]]<var>[deviceId]</var> to <code>true</code>, if it isn’t already\n                      <code>true</code>, and set the [[devicesAccessibleMap]]<var>[deviceId]</var> to\n                      <code>true</code>, if it isn’t already <code>true</code>.\n                    </p>\n                    <p>The user agent <em class=\"rfc2119\">MUST NOT</em> store a \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-granted\"><code>granted</code></a>\" permission entry.</p>\n                    <p>\n                      If the result is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-denied\"><code>denied</code></a>\", jump to the step labeled\n                      <em>Permission Failure</em> below. If the user never responds, this algorithm stalls on this step.\n                    </p>\n                    <p>\n                      If the user grants permission but a hardware error such as an OS/program/webpage lock prevents\n                      access, <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>p</var> with a new <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a>\n                      attribute has the value <a data-link-type=\"idl\" data-lt=\"NotReadableError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notreadableerror\"><code>NotReadableError</code></a> and abort these steps.\n                    </p>\n                    <p>\n                      If the result is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-granted\"><code>granted</code></a>\" but device access fails for any reason other than\n                      those listed above, <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>p</var> with a new <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose\n                      <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value <a data-link-type=\"idl\" data-lt=\"AbortError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#aborterror\"><code>AbortError</code></a> and abort these steps.\n                    </p>"
            },
            {
              "html": "<p>Let <var>stream</var> be the <a data-link-type=\"idl\" data-lt=\"MediaStream\" data-type=\"interface\" href=\"https://www.w3.org/TR/mediacapture-streams/#dom-mediastream\"><code>MediaStream</code></a> object for which the user granted permission.</p>"
            },
            {
              "html": "<p>\n                      Run the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://www.w3.org/TR/mediacapture-streams/#dfn-applyconstraints-algorithm\">ApplyConstraints algorithm</a> on all tracks in <var>stream</var> with the appropriate\n                      constraints. Should this fail, let <var>failedConstraint</var>\n                      be the result of the algorithm that failed, and let\n                      <var>message</var> be either <code>undefined</code> or an informative human-readable message, and\n                      then <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>p</var> with a new <code>OverconstrainedError</code>\n                      created by calling\n                      <code>OverconstrainedError(<var>failedConstraint</var>, <var>message</var>)</code>.\n                    </p>"
            },
            {
              "html": "Let <var>videoTrack</var> be the video track in <var>stream</var>."
            },
            {
              "html": "Set <var>videoTrack</var>.<a data-link-type=\"attribute\" data-lt=\"[[Restrictable]]\" data-type=\"attribute\" href=\"https://www.w3.org/TR/mediacapture-streams/#dfn-restrictable\"><code>[[Restrictable]]</code></a> to <code>true</code>."
            },
            {
              "html": "<p><a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\">Resolve</a> <var>p</var> with <var>stream</var> and abort these steps.</p>"
            },
            {
              "html": "<p>\n                      <em>Permission Failure</em>: <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">Reject</a> <var>p</var> with a new <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose\n                      <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value <a data-link-type=\"idl\" data-lt=\"NotAllowedError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notallowederror\"><code>NotAllowedError</code></a>.\n                    </p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>p</var>.</p>"
        }
      ]
    }
  ]
}